<!DOCTYPE html>
<html lang="ja">
   {{> dashboard-header}}
<body>
    {{> dashboard-nav}}

    <style>
    .animated.fadeInDown .swal2-image{
        margin:0;
    }
    .animated.fadeInDown .swal2-close{
        border:0;
    }
    /* Custom animation for sliding in from the bottom */
    .swal2-bottom-slide-in {
        animation: bottom-slide-in 0.5s;
    }

    .swal2-bottom-slide-out {
        animation: bottom-slide-out 0.5s;
    }

    @keyframes bottom-slide-in {
        0% {
            transform: translateY(100%);
            opacity: 0;
        }
        100% {
            transform: translateY(0);
            opacity: 1;
        }
    }

    @keyframes bottom-slide-out {
        0% {
            transform: translateY(0);
            opacity: 1;
        }
        100% {
            transform: translateY(100%);
            opacity: 0;
        }
    }
    .custom-gradient-bg {
        background: linear-gradient(90.9deg, #D2B8FF 2.74%, #8240FF 102.92%);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        transition: color 0.3s ease-in-out;
    }

    .custom-gradient-bg::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 300%;
        height: 300%;
        background: radial-gradient(circle, rgba(255,255,255,0.5) 0%, rgba(255,255,255,0) 80%);
        transform: translate(-50%, -50%) scale(0);
        transition: transform 0.5s ease-in-out;
        z-index: 0;
    }

    .custom-gradient-bg:hover::before {
        transform: translate(-50%, -50%) scale(1);
    }

    .custom-gradient-bg:hover {
        color: #fff;
    }
    #chatImage{
        width: 100px;
        height: 100px; 
        object-fit:cover;
        object-position:top;
    }
    #chatImage.on{
        width: auto !important;
        height: 270px !important;
    }
    .btn-gradient-radius {
        display: inline-block;
        padding: 7px 20px;
        border-radius: 25px;
        text-decoration: none;
        color: #FFF;
        background-image: linear-gradient(45deg, #FFC107 0%, #ff8b5f 100%);
        transition: .4s;
        font-size: 21px;
    }
    label{
        font-size: 14px;
        color: #aaaaaa;
    }
    #sendMessage,
    #chatInput .load {
        border-left: 0 !important;
        border-radius: 0px 30px 30px 0px !important;
        box-shadow: none;
    }
    #userMessage {
        border-radius: 30px 0px 0px 30px !important;
        background-color: #f8f9fa;
    }
    #userMessage:focus {
        outline: none;
        box-shadow: none; /* If there is a box shadow applied on focus */
    }
    .button-group{
        top:0;
        right: 15px;
    }
    .scroll-container {
      display: flex;
      flex-wrap: nowrap;
      overflow-x: auto;
    }
    .scroll-container > * {
      flex: 0 0 auto;
      width: auto;
    }
    .card-text.template{
        font-size: 12px;
    }
    /*Custom css*/
    label{
        font-size: 12px;
        color: #8d8b8b;
    }
    .avatar-xl img {
        width: 110px;
    }
    .rounded-circle {
        border-radius: 50%;
    }
    .rounded-circle.on {
        border-radius: 15px !important;
    }
    img {
        vertical-align: middle;
        border-style: none;
    }
    .text-muted {
        color: #aeb0b4 !important;
    }
    .text-muted {
        font-weight: 300;
    }
    .form-control {
        display: block;
        width: 100%;
        height: calc(1.5em + 0.75rem + 2px);
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        font-weight: 400;
        line-height: 1.5;
        color: #4d5154;
        background-color: #ffffff;
        background-clip: padding-box;
        border: 1px solid #eef0f3;
        border-radius: 0.25rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    #markdownContainer {
        margin-bottom: 20px;
        padding: 20px;
        border: 1px solid #eef0f3;
        border-radius: 4px;
    }
    .auto-gen{
        font-size: 10px;
        border-radius: 50px;
    }
    </style>

<div class="container my-4 px-0">
    <!-- ステップの進行状況を表示 -->
    <div class="progress mb-4 mx-3">
        <div class="progress-bar" role="progressbar" style="width: 50%;" id="progressBar">ステップ 1/3</div>
    </div>

    <!-- 1. キャラクター画像 -->
    <div id="step1" class="step">
    <h4 class="mb-4 text-center">キャラクター作成フォーム</h4>

            <!-- Character Creation Form -->
            <div id="characterCreationForm" class="container mt-3">
                
                <div class="row">
                    <!-- Left Column: Prompts and Button -->
                    <div class="col-lg-6 mb-4">
                        <!-- 1. Character Prompt Input -->
                        <div class="mb-4">
                            <label for="characterPrompt" class="form-label">キャラクタープロンプト</label>
                            <textarea
                                class="form-control"
                                id="characterPrompt"
                                name="characterPrompt"
                                rows="4"
                                maxlength="500"
                                placeholder="キャラクターの詳細な説明を入力してください..."
                            ></textarea>
                        </div>
                        
                        <!-- 2. Enhanced Prompt Display -->
                        <div class="mb-4">
                            <label for="enhancedPrompt" class="form-label">AI強化プロンプト</label>
                            <textarea
                                class="form-control"
                                id="enhancedPrompt"
                                name="enhancedPrompt"
                                rows="3"
                                readonly
                                placeholder="AIによって強化されたプロンプトがここに表示されます..."
                            ></textarea>
                        </div>
                        
                        <!-- 4. Single Action Button -->
                        <div class="d-grid">
                            <button type="button" id="generateButton" class="btn custom-gradient-bg btn-lg text-white">
                                <i class="fas fa-magic me-2"></i>AIで生成
                            </button>
                        </div>
                    </div>
                    
                    <!-- Right Column: Generated Image -->
                    <div class="col-lg-6 mb-4 d-flex flex-column align-items-center">
                        <!-- 3. Generated Image Display -->
                        <div class="mb-4 w-100">
                            <label class="form-label d-block mb-2 text-center">生成されたキャラクター画像</label>
                            <img
                                id="generatedImage"
                                src="/img/default-character.png"
                                alt="Generated Character Image"
                                class="img-fluid rounded"
                                style="max-height: 300px; width: 100%; object-fit: contain;"
                            >
                        </div>
                    </div>
                </div>
                <button type="button" id="nextStep1" class="btn btn-primary w-100 nextStep">次へ</button>
            </div>

    </div>

    <!-- 2. キャラクターの性格 -->
    <div id="step2" class="step d-none">

        <div class="mb-3 mx-3 row justify-content-between">
            
            <h4>キャラクターの性格を設定</h4>
            <div class="col-auto ps-0">
                <label for="visibility" class="form-label"><i class="fas fa-eye"></i> 公開設定:</label>
                <select class="form-select w-auto" id="visibility" name="visibility">
                    <option value="public" selected><i class="fas fa-globe"></i> 公開</option>
                    <option value="private"><i class="fas fa-lock"></i> 非公開</option>
                </select>
            </div>
            <div class="col-auto">
                <label for="language" class="form-label"><i class="fas fa-language"></i> 言語:</label>
                <select class="form-select w-auto" id="language" name="language">
                    <option value="japanese" selected><i class="fas fa-flag"></i> 日本語</option>
                </select>
            </div>
            <div class="col-auto pe-0">
                <label for="gender" class="form-label"><i class="fas fa-user"></i> 性別:</label>
                <select class="form-select w-auto" id="gender" name="gender">
                    <option value="female" selected><i class="fas fa-female"></i> 女性</option>
                    <option value="male"><i class="fas fa-male"></i> 男性</option>
                </select>
            </div>
        </div>

        <div id="chatPurpose-container" class="mb-3 mx-3">

            <div class="d-flex justify-content-between">
                <label for="chatPurpose" class="form-label">キャラクターの詳細</label>
            </div>
            <textarea class="form-control mb-2" id="chatPurpose" name="content" rows="3" placeholder="キャラクターの詳細を記入してください"></textarea>

            <input type="text" class="form-control mb-2" id="chatName" name="chatName" placeholder="名前" contenteditable="false" disabled="true" required style="display:none;">
            <textarea class="form-control mb-2" id="chatDescription" style="display:none;" name="chatDescription" rows="3" placeholder="簡単な説明" disabled="true" required></textarea>
            <textarea class="d-none form-control" id="chatRule" name="content" rows="5" placeholder="話し方" disabled="true" hidden></textarea>

            <div id="markdownContainer" class="border-0 py-2 px-3 text-start text-muted mb-2" style="font-size:15px;background-color: #e9ecef; display:none;" contenteditable="false"></div>
       
            <button type="button" id="ai-assist" class="btn btn-lg custom-gradient-bg shadow-0 mb-2 w-100">
                <i class="fa fa-spinner fa-spin fa-fw fa-hidden me-2" style="display: none;"></i>
                <i class="fa fa-magic me-2"></i>AIで生成
            </button>

            <button type="button" id="prevStep2" class="btn btn-secondary w-100 mb-2 prevStep">戻る</button>
            <button type="submit" id="submitForm" class="btn custom-gradient-bg btn-large w-100">完了</button>     

        </div>
    
    </div>
</div>

 {{> dashboard-footer}}
<link type="text/css" rel="stylesheet" href="/css/image-uploader.css">
<script type="text/javascript" src="/js/image-uploader.js"></script>
<script type="text/javascript" src="/js/stability.js"></script>

<script>
    $(document).ready(function() {
        let currentStep = 1;
        
        function showStep(step) {
            $('.step').addClass('d-none');
            $('#step' + step).removeClass('d-none');
            $('#progressBar')
            .css('width', (step * 50) + '%')
            .text('ステップ '+ step + '/2');
        }

        function validateStep(step) {
            if (step === 1) {
                return $('#generatedImage').attr('src') !== '/img/default-character.png';
            } else if (step === 2) {
                return $('#chatPurpose').val().trim() !== '' && $('#chatName').val().trim() !== '' && $('#chatDescription').val().trim() !== '' && $('#chatRule').val().trim() !== '';
            }
            return true;
        }

        $('.nextStep').click(function() {
            if (validateStep(currentStep)) {
                currentStep++;
                showStep(currentStep);
            } else {
                showNotification('すべてのフィールドを入力してください', 'error');
            }
        });

        $('.prevStep').click(function() {
            currentStep--;
            showStep(currentStep);
        });

        showStep(currentStep);
    });
</script>
<script>
    
    // Store modified galleries
    const modifiedGalleries = new Set();
    $(document).ready(function() {
        $('.dropdown-toggle').each(function(e) {
            new mdb.Dropdown($(this)[0]);
        });
        var count = 0
        let chatId = '{{chatId}}';
        const isTemporaryChat = '{{isTemporaryChat}}'
        const user = {{{json user}}}
        const subscriptionStatus = user.subscriptionStatus == 'active'
        let isAutoGen = false
        if(subscriptionStatus){
            $('.is-premium').each(function(){$(this).toggleClass('d-none')})
        }
        $('input, textarea').val('');
        $('#resetForm').on('click',function(){
            $('input, textarea').val('');
            $('input, textarea').prop('disabled', false);
            $('#chatName').hide()
            $('#chatDescription').hide()
            $('#chatPurpose').show()
            $('#chatPurpose-markdownContainer').hide()
            $('#markdownContainer').hide()
            $('#chatPurpose-markdownContainer').html('')
            $('#markdownContainer').html('')
            $('#sendForm').hide()
            $('#sendForm span').html('チャット')
        })

    const urlParams = new URLSearchParams(window.location.search);
    const chatImageUrl = urlParams.get('chatImage');
    if (chatImageUrl) {
        setTimeout(function(){
            $('#chatImageUrl').val(chatImageUrl).change();
        },500)
        $('#chatImage').attr('src', chatImageUrl).show().addClass('on');
    }

    function checkFieldsAndShowForm() {
        if ($('#chatName').val().trim() !== '' && 
            $('#chatDescription').val().trim() !== '' && 
            $('#chatPurpose').val().trim() !== '') {
            $('#sendForm').show();
        } else {
            $('#sendForm').hide();
        }
    }
    $('#chatName, #chatDescription, #chatPurpose').on('input', checkFieldsAndShowForm);

        if (isTemporaryChat == 'false') {
            fetchchatData(chatId,function(){
                function observeGalleryChanges(galleryIndex) {
                    const galleryElement = document.querySelector(`#imageGallery-${galleryIndex}`);
                    if (!galleryElement) return;

                    const observer = new MutationObserver(function(mutationsList, observer) {
                        modifiedGalleries.add(galleryIndex);
                    });

                    observer.observe(galleryElement, { childList: true, subtree: true });
                }

                $('#galleries .imageGalleryWrapper').each(function(index) {
                    observeGalleryChanges(index);
                });
            });
        }else{
            $('#imageGallery-0').imageUploader({
                maxSize: 2 * 1024 * 1024,
                maxFiles: 100
            });
        }
        $('textarea').each(function() {
            resizeTextarea(this);
            $(this).on('input change', function() {
                resizeTextarea(this);
            });
        });

        $('#visibility').val('public')
        $('#visibility').change(function() {
            
            const user = {{{json user}}}
            const userId = user._id
            if(!user){
                fetchUser(function(error, user){
                    user = localStorage.setItem('user',JSON.stringify(user))
                    if(user.subscriptionStatus == 'active'){
                        return
                    }else{
                        if ($(this).val() === 'private') {
                            showUpgradePopup('chat-private');
                            $(this).val('public');
                        }
                    }
                })
            }
            if(user.subscriptionStatus == 'active'){
                return
            }else{
                if ($(this).val() === 'private') {
                    showUpgradePopup('chat-private');
                    $(this).val('public');
                }
            }
        });

        function resizeTextarea(element){
            if($(element).val().trim()!=''){
                element.style.height = 'auto';
                element.style.height = (element.scrollHeight) + 'px';  
            }else{
                element.style.height = 'auto'; 
            }
        }

        function addNewGallery(init = false) {
            let galleryIndex = $('.imageGalleryWrapper').length;
            let newGalleryWrapper = $('.imageGalleryWrapper').eq(0).clone();

            newGalleryWrapper.find('[for^="imageGallery-"]').each(function() {
                const currentFor = $(this).attr('for');
                const newFor = currentFor.replace(/\d+/, galleryIndex);
                $(this).attr('for', newFor);
            });

            newGalleryWrapper.find('[id^="imageGallery-"]').each(function() {
                const currentId = $(this).attr('id');
                const newId = currentId.replace(/\d+/, galleryIndex);
                $(this).attr('id', newId);
            });

            newGalleryWrapper.find('[name^="imageGallery_"]').each(function() {
                const currentName = $(this).attr('name');
                const newName = currentName.replace(/\d+/, galleryIndex);
                $(this).attr('name', newName);
            });

            newGalleryWrapper.find('input[type="text"], input[type="number"]').val('');
            newGalleryWrapper.find(`#imageGallery-${galleryIndex}`).empty();

            $('#galleries').prepend(newGalleryWrapper);

            if(init){
                $(`#imageGallery-${galleryIndex}`).imageUploader({
                    maxSize: 2 * 1024 * 1024,
                    maxFiles: 100
                });
                modifiedGalleries.add(galleryIndex);
            }

        }

        $('#addMoreGallery').on('click', function(){addNewGallery(true);});

        $(document).on('click', '.resetGallery', function() {

            const galleryWrapper = $(this).closest('.imageGalleryWrapper');
            const galleryIndex = galleryWrapper.index(); 

            galleryWrapper.find('input[type="text"]').val('');
            galleryWrapper.find('textarea').val('');

            const galleryId = galleryWrapper.find('div[id^="imageGallery-"]').attr('id');
            const uploader = $(`#${galleryId}`).data('imageUploader'); 
            
            if (uploader) {
                uploader.reset();
            }

            $.ajax({
                url: '/api/reset-gallery',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ chatId, galleryIndex }),
                success: function(response) {
                    showNotification('ギャラリーがリセットされました。', 'success');
                },
                error: function(error) {
                    console.error('ギャラリーリセットエラー:', error);
                    showNotification('ギャラリーのリセットに失敗しました。', 'error');
                }
            });
        });

        function getFilesFromGallery(galleryId) {
            let files = [];
            $(galleryId).find('.image-uploader input[type="file"]').each(function() {
                $.each(this.files, function(_, file) {
                    files.push(file);
                });
            });
            if(files.length == 0){
                $(galleryId).find('.uploaded-image img').each(function() {
                    files.push($(this).attr('src'));
                });
            }
            return files;
        }
        function fetchchatData(chatId, callback) {
            $.ajax({
                url: `/api/chat-data/${chatId}`,
                type: 'GET',
                dataType: 'json',
                success: function(chatData) {
                    console.log('Fetched chat data:', chatData);

                    // Populate Step 1: キャラクターの外見
                    if (chatData.characterPrompt) {
                        $('#characterPrompt').val(chatData.characterPrompt);
                        resizeTextarea($('#characterPrompt')[0]);
                    }

                    if (chatData.imageDescription) {
                      $('#enhancedPrompt').val(chatData.imageDescription);
                    }

                    if (chatData.chatImageUrl) {
                        $('#generatedImage').attr('src', chatData.chatImageUrl).show().addClass('on');
                    }

                    // Populate Step 2: キャラクターの性格
                    if (chatData.visibility) {
                        $('#visibility').val(chatData.visibility);
                    }

                    if (chatData.language) {
                        $('#language').val(chatData.language);
                    }

                    if (chatData.gender) {
                        $('#gender').val(chatData.gender);
                    }

                    if (chatData.purpose) {
                        $('#chatPurpose').val(chatData.purpose);
                        resizeTextarea($('#chatPurpose')[0]);
                    }

                    if (chatData.name) {
                        $('#chatName').val(chatData.name).show();
                        $('#sendForm span').text(`${chatData.name}とチャットする`);
                    }

                    if (chatData.description) {
                        $('#chatDescription').val(chatData.description).show();
                        resizeTextarea($('#chatDescription')[0]);
                    }

                    if (chatData.rule) {
                        $('#chatRule').val(chatData.rule);
                        $('#markdownContainer').html(marked.parse(chatData.rule)).show();
                    }

                    // Populate Step 3: 画像ギャラリー
                    if (chatData.galleries && chatData.galleries.length > 0) {
                        chatData.galleries.forEach((gallery, index) => {
                            if (index === 0) {
                                // Populate the first gallery
                                $(`#imageGallery-0-name`).val(gallery.name);
                                $(`#imageGallery-0-description`).val(gallery.description);
                                initializeImageUploader(`#imageGallery-0`, gallery.images);
                            } else {
                                // Add and populate additional galleries
                                addNewGallery(true);
                                $(`#imageGallery-${index}-name`).val(gallery.name);
                                $(`#imageGallery-${index}-description`).val(gallery.description);
                                initializeImageUploader(`#imageGallery-${index}`, gallery.images);
                            }
                        });
                    } else {
                        initializeImageUploader(`#imageGallery-0`, []);
                    }

                    // Callback if provided
                    if (typeof callback === 'function') {
                        callback();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching chat data:', error);
                    showNotification('チャットデータの取得に失敗しました。再試行してください。', 'error');
                }
            });
        }

        function initializeImageUploader(gallerySelector, images) {
            const preloaded = images.map((url, idx) => ({
                id: idx + 1,
                src: url
            }));

            $(gallerySelector).imageUploader({
                preloaded: preloaded,
                imagesInputName: 'photos',
                preloadedInputName: 'old',
                maxSize: 2 * 1024 * 1024,
                maxFiles: 100
            });

            modifiedGalleries.add(gallerySelector.replace('#imageGallery-', ''));
        }

        // Form Submission
        $('#submitForm').on('click', function(e) {
            e.preventDefault();
            $('#sendForm .fa-spinner').toggleClass('d-none');

            const formData = new FormData();
            formData.append('name', $('#chatName').val());
            formData.append('purpose', $('#chatPurpose').val());
            formData.append('language', $('#language').val());
            formData.append('gender', $('#gender').val());
            formData.append('description', $('#chatDescription').val());
            formData.append('rule', $('#chatRule').val());
            formData.append('visibility', $('#visibility').val());
            formData.append('isAutoGen', isAutoGen);

            if (chatId) {
                formData.append('chatId', chatId);
            }

            // Loop through all galleries and append their data only if not empty or not just whitespace
            $('#galleries .imageGalleryWrapper').each(function(index) {
                const galleryIndex = index; // Use the loop index to handle multiple galleries
                const name = $(`#imageGallery-${galleryIndex}-name`).val().trim();
                const description = $(`#imageGallery-${galleryIndex}-description`).val().trim();
                if (name) formData.append(`imageGallery_${galleryIndex}_name`, name);
                if (description) formData.append(`imageGallery_${galleryIndex}_description`, description);

                if (modifiedGalleries.has(galleryIndex)) {

                    const galleryFiles = getFilesFromGallery(`#imageGallery-${galleryIndex}`);
                    if (galleryFiles.length) {
                        galleryFiles.forEach(file => formData.append(`imageGallery_${galleryIndex}_Images[]`, file)); // Append gallery files
                    }
                }
            });
            
            $.ajax({
                url: '/api/add-chat',
                type: 'POST',
                processData: false,
                contentType: false,
                data: formData,
                success: function(response) {
                    console.log('Success:', response);
                    $('#sendForm .fa-spinner').toggleClass('d-none');
                    const { chatId } = response;
                    window.location = '/chat/' + chatId;
                },
                error: function(error) {
                    console.log('Error:', error);
                    $('#sendForm .fa-spinner').toggleClass('d-none');
                    Swal.fire(
                        'エラー!',
                        'チャットの追加に失敗しました: ' + error.responseJSON.error,
                        'error'
                    );
                }
            });
        });
        
      
        function fetchTaskId(enhancedPrompt, aspectRatio, chatId) {
            return $.ajax({
                url: '/novita/generate-image',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    prompt: enhancedPrompt,
                    aspectRatio: aspectRatio,
                    chatId: chatId
                })
            });
        }
        function checkTaskStatus(taskId) {
            const POLLING_INTERVAL = 3000; // 3秒
            const MAX_ATTEMPTS = 30; // 最大90秒までポーリング
            let attempts = 0;

            const intervalId = setInterval(async () => {
                attempts++;
                try {
                    const statusResponse = await $.ajax({
                        url: `/novita/chat-thumb-task-status/${taskId}`,
                        method: 'GET',
                        dataType: 'json'
                    });

                    console.log(`Polling task status:`, statusResponse);

                    if (statusResponse.status === 'completed') {
                        clearInterval(intervalId);
                        const { imageUrl } = statusResponse.result;

                        $('#generatedImage').attr('src', imageUrl);

                        showNotification('画像が正常に生成されました。', 'success');
                        // ボタンを有効化し、初期状態のテキストに戻す
                        $('#generateButton').prop('disabled', false);
                        $('#generateButton').html('<i class="fas fa-magic me-2"></i>AIで画像生成');
                    } else if (statusResponse.status === 'failed') {
                        clearInterval(intervalId);
                        $('#generatedImage').attr('src', '/img/default-character.png');
                        showNotification(`画像の生成に失敗しました: ${statusResponse.error}`, 'error');
                        // ボタンを有効化し、初期状態のテキストに戻す
                        $('#generateButton').prop('disabled', false);
                        $('#generateButton').html('<i class="fas fa-magic me-2"></i>AIで画像生成');
                    } else {
                        console.log('タスクはまだ処理中です...');
                    }

                    if (attempts >= MAX_ATTEMPTS) {
                        clearInterval(intervalId);
                        $('#generatedImage').attr('src', '/img/timeout-placeholder.png');
                        showNotification('画像の生成がタイムアウトしました。再試行してください。', 'error');
                        // ボタンを有効化し、初期状態のテキストに戻す
                        $('#generateButton').prop('disabled', false);
                        $('#generateButton').html('<i class="fas fa-magic me-2"></i>AIで画像生成');
                    }

                } catch (error) {
                    console.error('タスクステータスポーリングエラー:', error);
                    clearInterval(intervalId);
                    $('#generatedImage').attr('src', '/img/default-character.png');
                    showNotification('画像の生成中にエラーが発生しました。', 'error');
                        // ボタンを有効化し、初期状態のテキストに戻す
                        $('#generateButton').prop('disabled', false);
                        $('#generateButton').html('<i class="fas fa-magic me-2"></i>AIで画像生成');
                }
            }, POLLING_INTERVAL);
        }
        $('#generateButton').on('click', async function() {
            const prompt = $('#characterPrompt').val().trim();

            if (!prompt || !chatId) {
                showNotification('すべてのフィールドを入力してください', 'error');
                return;
            }

            const $button = $(this);
            $button.prop('disabled', true);
            $button.html('<i class="fas fa-spinner fa-spin me-2"></i>プロンプトを強化中...');

            try {
                let enhanceResponse = {enhancedPrompt:''}

                if($('#enhancedPrompt').val().trim() != ''){
                    enhanceResponse.enhancedPrompt = $('#enhancedPrompt').val()
                }else{
                    // プロンプトを強化するリクエスト
                    enhanceResponse = await $.ajax({
                        url: '/api/enhance-prompt',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ prompt, chatId })
                    });
                }

                if (enhanceResponse && enhanceResponse.enhancedPrompt) {
                    $('#enhancedPrompt').val(enhanceResponse.enhancedPrompt);

                    // ボタンテキストを「画像を生成中...」に更新
                    $button.html('<i class="fas fa-spinner fa-spin me-2"></i>画像を生成中...');

                    // タスクIDを取得するリクエスト
                    const taskResponse = await fetchTaskId(enhanceResponse.enhancedPrompt, '9:16', chatId);

                    if (taskResponse && taskResponse.taskId) {
                        showNotification('画像生成タスクを開始しました。ステータスを確認中...', 'info');

                        // タスクステータスをポーリング
                        checkTaskStatus(taskResponse.taskId);
                    } else {
                        showNotification('画像生成タスクの開始に失敗しました。再試行してください。', 'error');
                        // ボタンを有効化し、初期状態のテキストに戻す
                        $button.prop('disabled', false);
                        $button.html('<i class="fas fa-magic me-2"></i>AIで画像生成');
                    }
                } else {
                    showNotification('プロンプトの生成に失敗しました。再試行してください。', 'error');
                    // ボタンを有効化し、初期状態のテキストに戻す
                    $button.prop('disabled', false);
                    $button.html('<i class="fas fa-magic me-2"></i>AIで画像生成');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('プロンプトの生成中または画像の生成中にエラーが発生しました。', 'error');
            }
        });

        $('#ai-assist').on('click', function() {

            $('#ai-assist .fa-spinner').show();
            $('#ai-assist .fa-magic').hide();

            if ($('#chatPurpose').val().trim() == '') {
                showNotification('キャラクターの説明は必須項目です。入力してください。', 'error');
                $('#ai-assist .fa-spinner').hide();
                $('#ai-assist .fa-magic').show();
                return;
            }

            $('#chatPurpose').prop('disabled', false);
            $('#chatName').prop('disabled', true);
            $('#chatDescription').prop('disabled', true);

            $('#chatName').val('')
            $('#chatDescription').val('')
            $('#markdownContainer').html('')
            generateCompletion(function() {
                $('#sendForm').show();
                $('.sendForm-text').show();
                $('#ai-assist .fa-spinner').hide();
                $('#ai-assist .fa-magic').show();
            });
        });

        function generateCompletion(callback) {

            const apiUrl = '/api/openai-chat-creation';

            let prompt = $('#chatPurpose').val().trim();
            let gender = $('#gender').val()

            prompt = prompt + '\n YOU MUST respond in japanese'
              console.log({prompt})
            if(prompt.length == 0){
                return
            } 

            $.ajax({
                url: apiUrl,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ prompt, gender}),
                success: function(response) {
                    console.log(response)
                    const  { name, short_desc, long_desc } = response
                    $('#markdownContainer').show()
                    $('#chatDescription').show()
                    $('#chatName').show()

                    $('#chatDescription').val(short_desc)

                    $('#markdownContainer').html(marked.parse(long_desc));
                    $('#chatRule').val(long_desc)

                    $('#chatName').val(name)
                    updateButtonText()

                    if (typeof callback === 'function') {
                        callback();
                    }
                },
                error: function(error) {
                    console.error('Error:', error);
                    $('#ai-assist .fa-spinner').hide();
                    $('#ai-assist .fa-magic').show();
                }
            });
        }



        // Helper function to create the message payload
        function createMessagePayload(base64Image) {
            return [
                {
                    "type": "image_url",
                    "image_url": {
                        "url": `data:image/png;base64,${base64Image}`
                    }
                }
            ];
        }


        function updateButtonText() {
            let chatName = $('#chatName').val().trim();
            $('#sendForm span').html(`${chatName}とチャットする`);
        }
        
       
});
</script>
</body>
</html>
