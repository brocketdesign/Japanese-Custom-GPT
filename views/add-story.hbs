<!DOCTYPE html>
<html lang="ja">
   {{> dashboard-header}}
<body>
    {{> dashboard-nav}}

<div class="container mt-4">
    <h2>{{#if storyId}}ストーリーを編集{{else}}新しいストーリーを追加{{/if}}</h2>
    <div class="text-center mb-4" id="imageSection" style="cursor: pointer;">
        <img id="storyImage" src="/img/logo.webp" alt="Story Thumbnail" class="rounded-circle m-auto" style="width: 150px; height: 150px; object-fit: cover;">
    </div>
    <form id="storyForm">
        <div class="mb-3" id="thumbnailInputContainer" style="display: none;">
            <label for="storyThumbnail" class="form-label">ストーリーのサムネイルをアップロード</label>
            <input type="file" class="form-control" id="storyThumbnail" name="thumbnail" accept="image/*">
        </div>
        <div class="mb-3">
            <label for="storyName" class="form-label">ストーリー名</label>
            <input type="text" class="form-control" id="storyName" name="name" required>
        </div>
        <div class="mb-3">
            <label for="storyContent" class="form-label">ストーリーコンテンツ (JSON形式)</label>
            <textarea class="form-control" id="storyContent" name="content" rows="5" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">送信</button>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        const storyId = '{{storyId}}';
        if (storyId) {
            fetchStoryData(storyId);
        }

        $('#imageSection').click(function() {
            $('#storyThumbnail').click();
        });

        $('#storyThumbnail').change(function(event) {
            const reader = new FileReader();
            reader.onload = function(e) {
                $('#storyImage').attr('src', e.target.result).show();
            }
            reader.readAsDataURL(event.target.files[0]);
        });

        function fetchStoryData(storyId) {
            $.ajax({
                url: `/api/story/${storyId}`,
                type: 'GET',
                dataType: 'json',
                success: function(storyData) {
                    $('#storyName').val(storyData.name);
                    $('#storyContent').val(JSON.stringify(storyData.content));

                    if (storyData.thumbnailUrl) {
                        $('#storyImage').attr('src', storyData.thumbnailUrl).show();
                    } else {
                        $('#storyImage').attr('src', 'placeholder.jpg').show();
                    }
                },
                error: function(xhr, status, error) {
                    Swal.fire({
                        title: 'エラー!',
                        text: 'ストーリーの読み込みに失敗しました: ' + error,
                        icon: 'error',
                        confirmButtonText: 'Ok',
                        showCancelButton: true,
                        cancelButtonText: '一覧を見る'
                    }).then((result) => {
                        if (result.dismiss === Swal.DismissReason.cancel) {
                            window.location.href = '/stories';
                        }
                    });
                }
            });
        }
        $('#storyForm').on('submit', function(e) {
            e.preventDefault();

            const formData = new FormData();
            const name = $('#storyName').val();
            const content = $('#storyContent').val();
            const thumbnail = $('#storyThumbnail')[0].files[0];

            formData.append('name', name);
            formData.append('content', content);
            
            if(thumbnail){
                formData.append('thumbnail', thumbnail);
            }
            if(storyId){
                formData.append('storyId', storyId)
            }
            $.ajax({
                url: '/api/add-story',
                type: 'POST',
                processData: false,
                contentType: false,
                data: formData,
                success: function(response) {
                    Swal.fire(
                        '成功!',
                        'ストーリーが正常に追加されました!',
                        'success'
                    ).then(()=>{
                        window.location = '/chat-list'
                    });
                },
                error: function(error) {
                    Swal.fire(
                        'エラー!',
                        'ストーリーの追加に失敗しました: ' + error.responseJSON.error,
                        'error'
                    );
                }
            });
        });
    });
</script>
</body>
</html>
