<!DOCTYPE html>
<html lang="{{lang}}">
{{> dashboard-header}}
<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #b58afe 0%, #6c5ce7 100%);
        --secondary-gradient: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
        --success-gradient: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
        --warning-gradient: linear-gradient(135deg, #fdcb6e 0%, #f39c12 100%);
        --danger-gradient: linear-gradient(135deg, #e17055 0%, #d63031 100%);
        --dark-bg: #0f0f1a;
        --card-bg: rgba(255, 255, 255, 0.05);
        --card-border: rgba(255, 255, 255, 0.1);
        --text-primary: #ffffff;
        --text-secondary: rgba(255, 255, 255, 0.7);
        --text-muted: rgba(255, 255, 255, 0.5);
    }

    * {
        box-sizing: border-box;
    }

    body {
        background: var(--dark-bg);
        background-image: 
            radial-gradient(ellipse at top left, rgba(181, 138, 254, 0.15) 0%, transparent 50%),
            radial-gradient(ellipse at bottom right, rgba(108, 92, 231, 0.15) 0%, transparent 50%);
        min-height: 100vh;
        color: var(--text-primary);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    }

    .favorites-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px 16px 100px;
    }

    /* Page Header */
    .page-header {
        padding: 20px 0 30px;
        text-align: center;
    }

    .page-title {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 8px;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
    }

    .page-title i {
        font-size: 1.5rem;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .page-subtitle {
        color: var(--text-secondary);
        font-size: 0.95rem;
    }

    /* Section Headers */
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .section-title {
        font-size: 1.15rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .section-title i {
        color: #b58afe;
    }

    .section-link {
        font-size: 0.85rem;
        color: #b58afe;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    /* Chat Tabs */
    .chats-section {
        margin-bottom: 24px;
    }

    .chat-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        background: var(--card-bg);
        padding: 4px;
        border-radius: 12px;
        border: 1px solid var(--card-border);
    }

    .chat-tab {
        flex: 1;
        padding: 12px 16px;
        background: transparent;
        border: none;
        border-radius: 10px;
        color: var(--text-secondary);
        font-weight: 500;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .chat-tab.active {
        background: var(--primary-gradient);
        color: white;
    }

    .chat-tab:not(.active):hover {
        background: rgba(255, 255, 255, 0.05);
    }

    .chat-tab-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.75rem;
    }

    .chat-list-container {
        display: none;
    }

    .chat-list-container.active {
        display: block;
    }

    .chat-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .chat-item {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 14px;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        color: inherit;
    }

    .chat-item:hover {
        background: rgba(181, 138, 254, 0.1);
        border-color: rgba(181, 138, 254, 0.3);
        transform: translateX(4px);
    }

    .chat-avatar {
        width: 56px;
        height: 56px;
        border-radius: 14px;
        object-fit: cover;
        flex-shrink: 0;
        border: 2px solid rgba(181, 138, 254, 0.3);
    }

    .chat-info {
        flex: 1;
        min-width: 0;
    }

    .chat-name {
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .chat-preview {
        font-size: 0.85rem;
        color: var(--text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .chat-meta {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 6px;
    }

    .chat-time {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .chat-badge {
        background: var(--primary-gradient);
        color: white;
        font-size: 0.7rem;
        padding: 2px 8px;
        border-radius: 10px;
    }

    .favorite-btn {
        background: none;
        border: none;
        color: var(--text-muted);
        font-size: 1.2rem;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    .favorite-btn:hover,
    .favorite-btn.active {
        color: #fdcb6e;
        background: rgba(253, 203, 110, 0.1);
    }

    .favorite-btn.active i {
        animation: heartBeat 0.5s ease;
    }

    @keyframes heartBeat {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.2); }
    }

    /* Empty States */
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 20px;
    }

    .empty-state-icon {
        font-size: 3rem;
        color: var(--text-muted);
        margin-bottom: 16px;
    }

    .empty-state-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .empty-state-text {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-bottom: 20px;
    }

    .empty-state-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 24px;
        background: var(--primary-gradient);
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 500;
        cursor: pointer;
        text-decoration: none;
        transition: all 0.3s ease;
    }

    .empty-state-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 24px rgba(181, 138, 254, 0.4);
        color: white;
    }

    /* Loading States */
    .loading-skeleton {
        background: linear-gradient(90deg, 
            rgba(255, 255, 255, 0.05) 25%, 
            rgba(255, 255, 255, 0.1) 50%, 
            rgba(255, 255, 255, 0.05) 75%
        );
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: 8px;
    }

    @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
    }

    .chat-skeleton {
        height: 84px;
        border-radius: 16px;
    }

    /* Bottom Navigation */
    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(15, 15, 26, 0.95);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-top: 1px solid var(--card-border);
        padding: 8px 0 calc(8px + env(safe-area-inset-bottom));
        z-index: 1000;
    }

    .bottom-nav-inner {
        display: flex;
        justify-content: space-around;
        max-width: 500px;
        margin: 0 auto;
    }

    .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 8px 16px;
        color: var(--text-muted);
        text-decoration: none;
        transition: all 0.3s ease;
        border-radius: 12px;
    }

    .nav-item:hover,
    .nav-item.active {
        color: #b58afe;
    }

    .nav-item i {
        font-size: 1.4rem;
        margin-bottom: 4px;
    }

    .nav-item span {
        font-size: 0.7rem;
        font-weight: 500;
    }

    .nav-item-create {
        background: var(--primary-gradient);
        color: white;
        border-radius: 50%;
        width: 52px;
        height: 52px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: -20px;
        box-shadow: 0 4px 20px rgba(181, 138, 254, 0.4);
    }

    .nav-item-create:hover {
        transform: scale(1.1);
        color: white;
    }

    .nav-item-create i {
        font-size: 1.6rem;
        margin: 0;
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
        width: 6px;
    }

    ::-webkit-scrollbar-track {
        background: transparent;
    }

    ::-webkit-scrollbar-thumb {
        background: rgba(181, 138, 254, 0.3);
        border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: rgba(181, 138, 254, 0.5);
    }

    /* Toast notifications */
    .toast-container {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 2000;
    }

    .custom-toast {
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(10px);
        padding: 12px 24px;
        border-radius: 12px;
        color: white;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 10px;
        animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Back button */
    .back-button {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 12px;
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        margin-bottom: 16px;
    }

    .back-button:hover {
        background: rgba(181, 138, 254, 0.1);
        border-color: rgba(181, 138, 254, 0.3);
        color: var(--text-primary);
    }
</style>
<body>

    {{> dashboard-nav}}
    
    <div class="favorites-container">
        <!-- Back Button -->
        <a href="/dashboard" class="back-button">
            <i class="bi bi-arrow-left"></i>
            {{translations.back}}
        </a>

        <!-- Page Header -->
        <section class="page-header">
            <h1 class="page-title">
                <i class="bi bi-heart-fill"></i>
                {{translations.favorite.favorites}}
            </h1>
            <p class="page-subtitle">{{translations.favorite.favoritesDescription}}</p>
        </section>

        <!-- Chats Section -->
        <section class="chats-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="bi bi-chat-left-heart"></i>
                    {{translations.chatList}}
                </h2>
                <a href="/chat" class="section-link">
                    {{translations.view_all_character}} <i class="bi bi-chevron-right"></i>
                </a>
            </div>

            <!-- Tabs - Favorites is default active -->
            <div class="chat-tabs">
                <button class="chat-tab" data-tab="recent" onclick="switchFavoritesTab('recent')">
                    <i class="bi bi-clock-history"></i>
                    {{translations.recent}}
                    <span class="chat-tab-badge" id="recent-count">0</span>
                </button>
                <button class="chat-tab active" data-tab="favorites" onclick="switchFavoritesTab('favorites')">
                    <i class="bi bi-star"></i>
                    {{translations.favorite.favorites}}
                    <span class="chat-tab-badge" id="favorites-count">0</span>
                </button>
            </div>

            <!-- Recent Chats List -->
            <div class="chat-list-container" id="recent-chats-container">
                <div class="chat-list" id="recent-chats-list">
                    <!-- Loading skeletons -->
                    <div class="loading-skeleton chat-skeleton"></div>
                    <div class="loading-skeleton chat-skeleton"></div>
                    <div class="loading-skeleton chat-skeleton"></div>
                </div>
            </div>

            <!-- Favorites Chats List - Default active -->
            <div class="chat-list-container active" id="favorites-chats-container">
                <div class="chat-list" id="favorites-chats-list">
                    <!-- Loading skeletons -->
                    <div class="loading-skeleton chat-skeleton"></div>
                    <div class="loading-skeleton chat-skeleton"></div>
                </div>
            </div>
        </section>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="bottom-nav-inner">
            <a href="/dashboard" class="nav-item">
                <i class="bi bi-house"></i>
                <span>{{translations.home}}</span>
            </a>
            <a href="/chat" class="nav-item">
                <i class="bi bi-chat-dots"></i>
                <span>{{translations.chats}}</span>
            </a>
            <a href="/dashboard/generation" class="nav-item nav-item-create">
                <i class="bi bi-plus-lg"></i>
            </a>
            <a href="/character" class="nav-item">
                <i class="bi bi-grid-3x3-gap"></i>
                <span>{{translations.explore}}</span>
            </a>
            {{#if user.isTemporary}}
            <a href="#" class="nav-item" onclick="openLoginForm(); return false;">
                <i class="bi bi-person-circle"></i>
                <span>{{translations.signIn}}</span>
            </a>
            {{else}}
            <a href="/user/{{user._id}}" class="nav-item">
                <i class="bi bi-person-circle"></i>
                <span>{{translations.avatar.profile}}</span>
            </a>
            {{/if}}
        </div>
    </nav>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

{{> dashboard-avatar}}
{{> dashboard-footer}}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize favorites page
    initFavoritesPage();
});

// Global favorites page state
const favoritesState = {
    recentChats: [],
    favoriteChats: [],
    isLoading: false
};

// Helpers for chat state management
const getChatId = (chat = {}) => {
    const id = chat._id || chat.chatId || chat.id;
    return id && typeof id.toString === 'function' ? id.toString() : id;
};

function normalizeChatData(chat = {}, isFavorite = false) {
    const base = chat.chat || chat;
    const id = getChatId(base);
    if (!id) return null;

    return {
        ...base,
        _id: base._id || id,
        chatId: base.chatId || id,
        name: base.name || base.chatName || 'Unknown Character',
        chatImageUrl: base.chatImageUrl || base.imageUrl || '/img/default-avatar.webp',
        lastMessage: chat.lastMessage || base.lastMessage || base.description || '',
        updatedAt: base.updatedAt || base.createdAt || new Date(),
        createdAt: base.createdAt,
        isFavorite: isFavorite || base.isFavorite === true
    };
}

function syncFavoriteFlagsOnRecent() {
    const favoriteIds = new Set(favoritesState.favoriteChats.map(chat => getChatId(chat)));
    favoritesState.recentChats = favoritesState.recentChats.map(chat => ({
        ...chat,
        isFavorite: favoriteIds.has(getChatId(chat))
    }));
}

function renderRecentChatList() {
    const container = document.getElementById('recent-chats-list');
    if (!container) return;

    document.getElementById('recent-count').textContent = favoritesState.recentChats.length;

    if (favoritesState.recentChats.length === 0) {
        container.innerHTML = renderEmptyState('recent');
        return;
    }

    container.innerHTML = favoritesState.recentChats
        .map(chat => renderChatItem(chat, chat.isFavorite))
        .join('');
}

function renderFavoriteChatList() {
    const container = document.getElementById('favorites-chats-list');
    if (!container) return;

    document.getElementById('favorites-count').textContent = favoritesState.favoriteChats.length;

    if (favoritesState.favoriteChats.length === 0) {
        container.innerHTML = renderEmptyState('favorites');
        return;
    }

    container.innerHTML = favoritesState.favoriteChats
        .map(chat => renderChatItem(chat, true))
        .join('');
}

function findChatById(chatId) {
    return favoritesState.recentChats.find(chat => getChatId(chat) === chatId)
        || favoritesState.favoriteChats.find(chat => getChatId(chat) === chatId);
}

function applyFavoriteToggle(chatId, isFavorited, chatData) {
    const normalizedChat = normalizeChatData(chatData || { _id: chatId }, true);

    // Update recent list flag
    favoritesState.recentChats = favoritesState.recentChats.map(chat =>
        getChatId(chat) === chatId ? { ...chat, isFavorite: isFavorited } : chat
    );

    if (isFavorited) {
        const alreadyInFavorites = favoritesState.favoriteChats.some(chat => getChatId(chat) === chatId);
        if (!alreadyInFavorites && normalizedChat) {
            favoritesState.favoriteChats.unshift({ ...normalizedChat, isFavorite: true });
        }
    } else {
        favoritesState.favoriteChats = favoritesState.favoriteChats.filter(chat => getChatId(chat) !== chatId);
    }

    syncFavoriteFlagsOnRecent();
    renderFavoriteChatList();
    renderRecentChatList();
}

// Initialize favorites page
async function initFavoritesPage() {
    await Promise.all([
        loadRecentChats(),
        loadFavoriteChats()
    ]);
}

// Load recent chats
async function loadRecentChats() {
    try {
        const response = await fetch('/api/recent-chats?limit=20');
        if (!response.ok) throw new Error('Failed to load chats');
        
        const data = await response.json();
        const chats = Array.isArray(data?.chats) ? data.chats : [];
        favoritesState.recentChats = chats
            .map(chat => normalizeChatData(chat, false))
            .filter(Boolean);

        syncFavoriteFlagsOnRecent();
        renderRecentChatList();
    } catch (error) {
        console.error('Error loading recent chats:', error);
        favoritesState.recentChats = [];
        renderRecentChatList();
    }
}

// Load favorite chats
async function loadFavoriteChats() {
    try {
        const response = await fetch('/favorites/list?page=1&limit=50');
        if (!response.ok) throw new Error('Failed to load favorites');
        
        const data = await response.json();
        const favorites = Array.isArray(data?.data)
            ? data.data
            : Array.isArray(data?.favorites)
                ? data.favorites
                : Array.isArray(data)
                    ? data
                    : [];

        favoritesState.favoriteChats = favorites
            .map(fav => normalizeChatData(fav, true))
            .filter(Boolean);

        syncFavoriteFlagsOnRecent();
        renderFavoriteChatList();
        renderRecentChatList();
    } catch (error) {
        console.error('Error loading favorites:', error);
        favoritesState.favoriteChats = [];
        renderFavoriteChatList();
    }
}

// Render chat item
function renderChatItem(chat, isFavorite = false) {
    const chatId = chat._id || chat.chatId;
    const name = chat.name || chat.chatName || 'Unknown Character';
    const imageUrl = chat.chatImageUrl || chat.imageUrl || '/img/default-avatar.webp';
    const lastMessage = chat.lastMessage || chat.description || '';
    const updatedAt = chat.updatedAt || chat.createdAt || new Date();
    const timeAgo = formatTimeAgo(new Date(updatedAt));
    const isFavorited = isFavorite || (chat.isFavorite === true);
    
    return `
        <div class="chat-item" onclick="openChat('${chatId}')" data-chat-id="${chatId}">
            <img src="${imageUrl}" alt="${escapeHtml(name)}" class="chat-avatar" onerror="this.src='/img/default-avatar.webp'" loading="lazy">
            <div class="chat-info">
                <div class="chat-name">${escapeHtml(name)}</div>
                <div class="chat-preview">${escapeHtml(truncateText(lastMessage, 50))}</div>
            </div>
            <div class="chat-meta">
                <span class="chat-time">${timeAgo}</span>
                <button class="favorite-btn ${isFavorited ? 'active' : ''}" onclick="event.stopPropagation(); toggleFavorite('${chatId}', this)">
                    <i class="bi bi-star${isFavorited ? '-fill' : ''}"></i>
                </button>
            </div>
        </div>
    `;
}

// Render empty state
function renderEmptyState(type) {
    if (type === 'favorites') {
        return `
            <div class="empty-state">
                <div class="empty-state-icon"><i class="bi bi-star"></i></div>
                <div class="empty-state-title">${translations.favorite?.emptyFavorites || 'No favorites yet'}</div>
                <div class="empty-state-text">${translations.favorite?.emptyFavoritesDescription || 'Star your favorite chats to find them here'}</div>
                <a href="/character" class="empty-state-btn">
                    <i class="bi bi-compass"></i>
                    ${translations.explore || 'Explore Characters'}
                </a>
            </div>
        `;
    }
    
    return `
        <div class="empty-state">
            <div class="empty-state-icon"><i class="bi bi-chat-left-heart"></i></div>
            <div class="empty-state-title">${translations.noChats || 'No chats yet'}</div>
            <div class="empty-state-text">${translations.startChatting || 'Start chatting with AI characters'}</div>
            <a href="/character" class="empty-state-btn">
                <i class="bi bi-plus-circle"></i>
                ${translations.startNow || 'Start Now'}
            </a>
        </div>
    `;
}

// Switch favorites tab
function switchFavoritesTab(tab) {
    // Update tab buttons
    document.querySelectorAll('.chat-tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
    });
    
    // Update containers
    document.getElementById('recent-chats-container').classList.toggle('active', tab === 'recent');
    document.getElementById('favorites-chats-container').classList.toggle('active', tab === 'favorites');
}

// Open chat
function openChat(chatId) {
    if (!chatId) return;
    
    // Store chat ID for navigation
    sessionStorage.setItem('pendingChatId', chatId);
    
    // Navigate to chat page
    window.location.href = `/chat/${chatId}`;
}

// Toggle favorite
async function toggleFavorite(chatId, buttonEl) {
    if (!chatId) return;
    
    const icon = buttonEl.querySelector('i');
    const chatData = findChatById(chatId);
    
    try {
        // Use the existing toggle endpoint
        const response = await fetch('/favorites/toggle', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ chatId })
        });
        
        if (!response.ok) throw new Error('Failed to toggle favorite');
        
        const result = await response.json();
        
        // Update UI based on response
        if (result.isFavorited) {
            buttonEl.classList.add('active');
            icon.classList.remove('bi-star');
            icon.classList.add('bi-star-fill');
        } else {
            buttonEl.classList.remove('active');
            icon.classList.remove('bi-star-fill');
            icon.classList.add('bi-star');
        }
        
        // Show toast
        showToast(result.isFavorited 
            ? (translations.favorite?.added || 'Added to favorites')
            : (translations.favorite?.removed || 'Removed from favorites')
        );
        
        // Update in-memory lists for immediate UI changes
        applyFavoriteToggle(chatId, result.isFavorited, chatData);
        
    } catch (error) {
        console.error('Error toggling favorite:', error);
        showToast(translations.error || 'Something went wrong', 'error');
    }
}

// Show toast notification
function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = 'custom-toast';
    
    const icon = type === 'success' ? 'bi-check-circle' : 'bi-exclamation-circle';
    toast.innerHTML = `<i class="bi ${icon}"></i> ${escapeHtml(message)}`;
    
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideUp 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Helper: Format time ago
function formatTimeAgo(date) {
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    
    if (seconds < 60) return translations.justNow || 'Just now';
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h`;
    if (seconds < 604800) return `${Math.floor(seconds / 86400)}d`;
    
    return date.toLocaleDateString();
}

// Helper: Truncate text
function truncateText(text, maxLength) {
    if (!text) return '';
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength) + '...';
}

// Helper: Escape HTML
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Pull to refresh functionality
let touchStartY = 0;
let touchEndY = 0;

document.addEventListener('touchstart', (e) => {
    touchStartY = e.touches[0].clientY;
}, { passive: true });

document.addEventListener('touchmove', (e) => {
    touchEndY = e.touches[0].clientY;
}, { passive: true });

document.addEventListener('touchend', () => {
    const swipeDistance = touchEndY - touchStartY;
    const scrollTop = window.scrollY || document.documentElement.scrollTop;
    
    if (swipeDistance > 100 && scrollTop === 0) {
        // Pull to refresh
        initFavoritesPage();
        showToast(translations.refreshing || 'Refreshing...');
    }
});
</script>
</body>
</html>
