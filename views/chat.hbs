<!DOCTYPE html>
<html lang="{{user.lang}}">
    {{> dashboard-header}}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
<body>
    <!-- Fullscreen overlay with loading spinner -->
    <div class="fullscreen-overlay justify-content-center align-items-center" id="loadingOverlay">
        <div style="position: relative; display: inline-block;"> <!-- Wrapper for logo and spinner -->
            <div class="loading-circle shadow" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <img src="/img/logo.png" alt="Logo" class="logo" style="width: 100px; height: auto; display: block;">
        </div>
    </div>
    <div id="swup-none">
        <div class="sidebar-history hidden shadow">
            <div class="d-flex justify-content-between">
                <h5 class="my-2 mx-3">チャット履歴</h5>
                <button type="button" class="btn btn-light history-chat">
                    <i class="bi bi-chevron-left"></i>
                </button>
            </div>
            <div id="chat-history"></div>
        </div>
        <div class="sidebar hidden bg-light shadow-0 d-flex flex-column">
            <div class="tools d-flex align-items-start flex-column sticky-top bg-light py-2">
                <div class="d-none w-100 m-2">
                    <button class="menu-chat-sm d-sm-none btn bg-dark shadow-0"><i class="bi bi-list"></i></button>
                    <button 
                    class="new-chat d-sm-none btn btn-light"
                    onclick="handleChatReset(this)"
                    ><i class="bi bi-pencil-square"></i></button>
                </div>
                <div>
                    <span onclick="showDiscovery()" class="m-2 btn px-4 py-2 border shadow-0 btn-outline-secondary" style="border-radius: 40px;">
                        <i class="bi bi-chat me-2"></i>{{translations.chatList}}
                    </span>
                    <a href="/character" class="{{default isAdmin 'd-inline-block'}} m-2 btn px-4 py-2 border shadow-0 btn-outline-secondary" style="border-radius:40px;">
                        <i class="bi bi-globe me-2"></i>{{translations.explore}}
                    </a>
                    <a href="#" onclick="loadCharacterCreationPage()" class="{{default isAdmin 'd-inline-block'}} m-2 btn px-4 py-2 border shadow-0 btn-outline-secondary text-start" style="border-radius:40px;">
                        <i class="bi bi-plus me-2"></i>{{translations.createCharacter}}
                    </a>
                </div>
                <span class="text-dark ps-4 fw-bold" style="font-size: 12px;">{{translations.chatList}} <span id="user-chat-count" >{{chats.length}}</span></span>
            </div>
            <div id="chat-list" class="mt-1 pb-3 position-relative" style="flex-grow: 1;overflow-y: scroll;overflow-x: hidden;border-top:1px solid #cccccc6b;">
                <!-- Spinner -->
                <div id="chat-list-spinner" class="spinner-border text-secondary" role="status" style="position: absolute; top: 45%; left: 45%; display: none;">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
        <div id="overlay" class="d-sm-none bg-dark" style="position: fixed; inset: 0; z-index: 1033; display: none; opacity: 0.4; overflow: hidden;"></div>
        <div class="content collapsed">
            <nav class="navbar navbar-expand-lg navbar-white bg-transparent fixed-top shadow-0 flex-column">
                <div class="container-fluid">
                    <div class="d-flex align-items-center justify-content-center m-auto">
                        <div style="position: absolute;left: 20px;top: 10px;">

                            <button 
                            class="btn btn-dark onchat-on" 
                            style="display: none;"
                            onclick="showDiscovery()"><i class="bi bi-arrow-left"></i></button>

                            <button class="menu-chat-sm d-sm-none btn btn-dark"><i class="bi bi-list"></i></button>
                            <button id="menu-chat" class="d-none d-sm-inline-block btn btn-dark"><i class="bi bi-list"></i></button>

                        </div>
                        <div class="d-flex flex-row" style="cursor:pointer" onclick="showDiscovery()">
                            <img src="/img/logo.webp" alt="" class="mx-3" width="40px">
                        </div>  
                        <div>
                            <div class="navbar-collapse" id="navbarNav" style="position: absolute;right: 20px;top: 10px;">
                                <ul class="navbar-nav ms-auto flex-row mb-lg-0">
                                    {{> dashboard-avatar}}
                                </ul>
                            </div>
                        </div>   
                    </div>
                </div>
            {{> chat-header}}
            </nav>
            <section id="chat-discovery" class="onchat-off mt-5 pt-3" style="display: block;">
                <!-- Search form to /search?q={query} -->
                <div class="container text-center">
                    <h2 class="text-center text-secondary mb-4" style="font-size: 1rem;">{{translations.welcomeMessage}}</h2>
                    <form id="search-form" action="/search" method="GET" class="mb-3">
                        <div class="input-group input-group-lg justify-content-center" style="max-width: 500px; margin: 0 auto;">
                            <span class="input-group-text bg-white border-0 rounded-start-pill shadow-sm px-3">
                                <i class="bi bi-search text-secondary"></i>
                            </span>
                            <input 
                                type="text" 
                                name="q" 
                                id="search-input" 
                                class="form-control rounded-end-pill shadow-sm border-0" 
                                placeholder="{{translations.searchPlaceholder}}" 
                                aria-label="Search"
                                style="background: #f8f9fa;font-size: 14px;"
                            >
                        </div>
                    </form>
                </div>
                <!-- Card menu -->
                <div class="card-menu-container my-3">
                    <div class="d-flex overflow-auto px-3 py-5" style="scrollbar-width: thin;justify-content: space-between;">
                        <!-- Create Character Card -->
                        <div class="character-create-card shadow-sm rounded p-3 text-center mx-2 flex-shrink-0" 
                             onclick="loadCharacterCreationPage()"
                             style="cursor: pointer; transition: all 0.3s ease; border: 1px solid rgba(0,0,0,0.1); width: 220px;">
                            <div class="character-create-icon bg-light rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" 
                                 style="width: 80px; height: 80px; transition: all 0.3s ease;">
                                <i class="bi bi-plus-lg fs-2 text-primary"></i>
                            </div>
                            <h5 class="mb-2">{{translations.createCharacter}}</h5>
                            <p class="text-muted small mb-0">{{translations.createCharacterDescription}}</p>
                        </div>
                        
                        <!-- Explore Characters Card -->
                        <div class="character-create-card shadow-sm rounded p-3 text-center mx-2 flex-shrink-0" 
                             onclick="window.location.href='/character'"
                             style="cursor: pointer; transition: all 0.3s ease; border: 1px solid rgba(0,0,0,0.1); width: 220px;">
                            <div class="character-create-icon bg-light rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" 
                                 style="width: 80px; height: 80px; transition: all 0.3s ease;">
                                <i class="bi bi-globe fs-2 text-success"></i>
                            </div>
                            <h5 class="mb-2">{{translations.explore}}</h5>
                            <p class="text-muted small mb-0">{{translations.exploreDescription}}</p>
                        </div>
                        
                        <!-- User Profile Card -->
                        <div class="character-create-card shadow-sm rounded p-3 text-center mx-2 flex-shrink-0" 
                             onclick="window.location.href='/user/{{user._id}}'"
                             style="cursor: pointer; transition: all 0.3s ease; border: 1px solid rgba(0,0,0,0.1); width: 220px;">
                            <div class="character-create-icon bg-light rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" 
                                 style="width: 80px; height: 80px; transition: all 0.3s ease;">
                                <i class="bi bi-person fs-2 text-info"></i>
                            </div>
                            <h5 class="mb-2">{{translations.userProfile}}</h5>
                            <p class="text-muted small mb-0">{{translations.userProfileDescription}}</p>
                        </div>
                    </div>
                </div>

                <!-- Promo Section -->
                <section class="is-free-user animate__animated m-3 p-3 bg-light" style="display: none; overflow-x: hidden;" data-animate="animate__fadeInLeft" data-delay="0.3s">
                    <div class="container text-center">
                        <h2 class="pricing-title fw-bold animate__animated" data-animate="animate__fadeInLeft" style="animation-delay: 0.3s;">
                            <span class="u-font-manrope u-color-grad" style="font-size: 100%;">{{translations.promo.title}}</span>
                        </h2>
                        <h3 class="fw-bold mb-1 px-3 animate__animated" data-animate="animate__fadeInLeft" style="animation-delay: 0.5s;">
                            {{translations.promo.subtitle}}
                        </h3>
                        <h3 class="mb-3 px-3 u-font-manrope animate__animated animate__fadeInRight" data-animate="animate__fadeInRight" style="font-size: 1.5em; animation-delay: 0.7s;">
                            {{translations.promo.description}}
                        </h3>
                    </div>
                    <div class="is-free-user sticky-bottom py-2 mx-auto text-center animate__animated" style="display:none; bottom:0; left:0; right:0;" data-animate="animate__fadeInLeft" style="animation-delay: 0.9s;">
                        <a href="#" onclick="loadPlanPage()" class="m-2 btn border shadow-0 btn-secondary px-5 py-2 m-auto animate__animated" data-animate="animate__zoomIn" style="border-radius:40px; background: linear-gradient(90.9deg, rgba(110, 32, 244, 0.5) 2.74%, #6E20F4 102.92%);">
                            <i class="bi bi-plus me-2"></i>{{translations.promo.details}}
                        </a>
                    </div>
                </section>

                <!-- Latest Chats Section -->
                <div class="mx-4 my-4" id="latest-chats-section">
                    <h5 class="fw-bold mb-3">{{translations.latestChatsHeader}}
                        <i class="bi bi-arrow-counterclockwise" onclick="loadLatestChats(1, true)" style="cursor: pointer;"></i>
                    </h5>
                    <div id="latest-chats-gallery" class="row latest-chats-gallery flex-nowrap overflow-auto mx-0" style="flex-wrap: nowrap; overflow-x: auto; white-space: nowrap;"></div>
                </div>

                <!-- Popular chat -->
                <div class="mx-4 my-4" id="popular-chats-section">
                    <h5 class="fw-bold mb-3">{{translations.popularChats}}</h5>
                    <!-- Sorting Tools: Premium/Free, Gender & NSFW Filters (Responsive) -->
                    <div class="sorting-tools mb-3">
                        <div class="row g-3 align-items-center">
                            <!-- Premium/Free Toggle -->
                            <div class="d-none col-12 col-md-auto d-flex align-items-center gap-2 justify-content-start justify-content-md-start">
                                <span class="me-2 text-muted" style="font-size: 15px;">
                                    {{translations.sort.premiumLabel}}
                                </span>
                                <button id="popular-chats-premium" class="btn btn-outline-secondary px-3 py-1 flex-shrink-0" style="border-radius: 30px; font-size: 14px;">
                                    {{translations.sort.hidePremium}}
                                </button>
                            </div>
                            <!-- Gender Filter Buttons -->
                            <div class="d-none col-12 col-md d-flex align-items-center gap-2 flex-wrap justify-content-between justify-content-md-start">
                                <span class="me-2 text-muted" style="font-size: 15px;">
                                    <i class="bi bi-gender-ambiguous"></i> {{translations.sort.genderLabel}}
                                </span>
                                <div class="d-flex flex-wrap gap-2">
                                    <button id="popular-chats-gender-female" class="btn btn-outline-primary px-3 py-1" style="border-radius: 30px; font-size: 14px;">
                                        <i class="bi bi-gender-female me-1"></i>{{translations.sort.female}}
                                    </button>
                                    <button id="popular-chats-gender-male" class="btn btn-outline-info px-3 py-1" style="border-radius: 30px; font-size: 14px;">
                                        <i class="bi bi-gender-male me-1"></i>{{translations.sort.male}}
                                    </button>
                                    <button id="popular-chats-gender-nonbinary" class="btn btn-outline-success px-3 py-1" style="border-radius: 30px; font-size: 14px;">
                                        <i class="bi bi-gender-trans me-1"></i>{{translations.sort.nonBinary}}
                                    </button>
                                </div>
                            </div>
                            <!-- NSFW Filter Button -->
                            <div class="col-12 col-md-auto d-flex align-items-center gap-2 justify-content-start justify-content-md-start mb-2 mb-md-0">
                                <span class="me-2 text-muted" style="font-size: 15px;">
                                    <i class="bi bi-exclamation-triangle"></i> NSFW
                                </span>
                                <button id="popular-chats-nsfw" class="btn btn-outline-danger px-3 py-1 flex-shrink-0" style="border-radius: 30px; font-size: 14px;">
                                    {{translations.sort.hideNSFW}}
                                </button>
                            </div>
                            <!-- Style Filter Buttons -->
                            <div class="col-12 col-md-auto d-flex align-items-center gap-2 justify-content-start justify-content-md-start">
                                <span class="me-2 text-muted" style="font-size: 15px;">
                                    <i class="bi bi-palette"></i> {{translations.sort.styleLabel}}
                                </span>
                                <div class="d-flex flex-wrap gap-2">
                                    <button id="popular-chats-style-anime" class="btn p-0 border-0" style="border-radius: 50%; width: 50px; height: 50px; overflow: hidden;" data-bs-toggle="tooltip" data-bs-placement="top" title="{{translations.sort.anime}}">
                                        <img src="/img/image-placeholder-anime.jpeg" alt="Anime" class="img-fluid" style="width: 100%; height: 100%; object-fit: cover;">
                                    </button>
                                    <button id="popular-chats-style-photorealistic" class="btn p-0 border-0" style="border-radius: 50%; width: 50px; height: 50px; overflow: hidden;" data-bs-toggle="tooltip" data-bs-placement="top" title="{{translations.sort.photorealistic}}">
                                        <img src="/img/image-placeholder-real.jpeg" alt="Photorealistic" class="img-fluid" style="width: 100%; height: 100%; object-fit: cover;">
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="chat-gallery" class="row popular-chats-gallery mx-0"></div>
                    <div id="popular-chats-pagination-controls" class="my-3"></div>
                </div>
            </section>
            <div class="container chat-contain px-0 onchat-on">
                <div id="chat-container" class="card shadow-0 border-0 rounded-0" style="background-position: top center;background-repeat: no-repeat;">
                    <div class="card-body text-center p-0 container" style="min-height:250px;overflow-y:hidden;display: flex;flex-direction: column;">
                        <div id="chatContainer" data-id="" class="pt-2 fade-content" style="padding-bottom: 180px !important;"></div>
                    </div>
                </div>  
            </div>  
        </div>
    </div>
 {{> dashboard-footer}}
<script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.19.0/js/md5.min.js"></script>
<script src="/js/chat.js"></script>
<!-- Include the Swiper JS library -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
    const newSubscription = {{newSubscription}};
$(document).ready(function() {
    
    function adjustHeight() {
        const newHeight = $(window).height() * 0.97;
        $('.chat-contain .card-body').height(newHeight);
    }
    $(document).ready(adjustHeight);
    $(window).resize(adjustHeight);

    function resizeIframe() {
        var iframe = $('#user-profile-page');
        if(iframe.length == 0 ){return}
        const newHeight = iframe[0].contentWindow.document.body.scrollHeight
        if( newHeight > 0) { iframe.height(newHeight); }
    }  
    window.addEventListener('message', function(event) {
        if (event.data === 'resizeIframe') {
            resizeIframe();
        }
    });

    window.addEventListener('message', function(event) {
        if (event.data.event === 'openChat') {
            redirectToChat(event.data.chatId)
        }
    });

    window.addEventListener('message', function(event) {
        if (event.data.event === 'updatePersona') {
             updatePersona(event.data.personaId,event.data.isAdding)
        }
    });
    
    window.addEventListener('message', function(event) {
        if (event.data.event === 'updateCoins') {
             updateCoins()
        }
    });

    // Initialize user preference from cookie
    if (Cookies.get('sidebarState') === 'expanded') {
        $('.sidebar').removeClass('hidden');
        $('.content').removeClass('collapsed');
        $('nav.navbar').addClass('move');
        $('#overlay').show()
    
        if(userId){ 
            displayChatList(null, userId) 
        }
    }

    $('#menu-chat').on('click', function(){

        $('.sidebar-history').addClass('hidden');
        const sidebar = $('.sidebar');
        const content = $('.content');
        const navbar = $('nav.navbar');
        const stickyBottom = $('.sticky-bottom')
        if (sidebar.hasClass('hidden')) {
            sidebar.removeClass('hidden');
            content.removeClass('collapsed');
            navbar.addClass('move');
            stickyBottom.addClass('move');
            $('#overlay').show()
        } else {
            sidebar.addClass('hidden');
            content.addClass('collapsed');
            navbar.removeClass('move');
            stickyBottom.removeClass('move');
            $('#overlay').hide()
        }
        
        // Update the cookie based on the new state
        if ($('.sidebar').hasClass('hidden')) {
            Cookies.set('sidebarState', 'collapsed', { expires: 7 }); // Cookie expires in 7 days
        } else {
            Cookies.set('sidebarState', 'expanded', { expires: 7 });
        }
    });

    $(document).on('click','.history-chat', function(){
        const chatId = $(this).data('id')
        const userId = sessionStorage.getItem('userId');
        if(chatId && userId){ 
            getUserChatHistory(chatId, userId) 
        }
        $('.sidebar-history').toggleClass('hidden');
        $('.sidebar').removeClass('hidden');
        $('.content').removeClass('collapsed');
        $('nav.navbar').addClass('move');
        $('#overlay').show()
        $('.content').toggleClass('noscroll');
    })

    $('.menu-chat-sm').on('click', function(){
        $('.sidebar').toggleClass('hidden');
        $('#overlay').toggle()
        $('.content').toggleClass('noscroll');
    });

    $('#overlay').on('click', function(){
        $('#overlay').toggle()
        $('.sidebar').toggleClass('hidden');
        $('.sidebar-history').addClass('hidden');
        $('.content').toggleClass('noscroll');
        // Update the cookie based on the new state
        if ($('.sidebar').hasClass('hidden')) {
            Cookies.set('sidebarState', 'collapsed', { expires: 7 }); // Cookie expires in 7 days
        } else {
            Cookies.set('sidebarState', 'expanded', { expires: 7 });
        }
    });

    $(document).on('click','.user-chat-content .dropdown-menu',function(){
        $('#overlay').click()
    })
    
    window.showImagePreview = function(el) {
    if($(el).hasClass('isBlurred')){
        loadPlanPage();
            return;
        }

        // Get all images from the chat
        const images = $('.assistant-image-box img').map(function() {
            return $(this).attr('src');
        }).get();

        const clickedImageUrl = $(el).find('img').attr('src') || $(el).attr('data-src');
        
        // Create modal if it doesn't exist yet
        if ($('#imagePreviewModal').length === 0) {
            const modalHTML = `
                <div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-labelledby="imagePreviewModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-fullscreen">
                        <div class="modal-content mx-auto w-100" style="background: rgba(24, 24, 24, 0.72);">
                            <div class="modal-header border-0 position-absolute" style="top: 0; right: 0;z-index:10000;">
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body p-0">
                                <div class="swiper-container" style="height: 100%; width: 100%;">
                                    <div class="swiper-wrapper"></div>
                                    <div class="swiper-button-next text-white" style="opacity:0.8;"></div>
                                    <div class="swiper-button-prev text-white" style="opacity:0.8;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            $('body').append(modalHTML);
            
            // Only add the event listener once when creating the modal
            $('#imagePreviewModal').on('shown.bs.modal', function() {
                if (window.imageSwiper) {
                    window.imageSwiper.destroy(true, true);
                }
                
                window.imageSwiper = new Swiper('.swiper-container', {
                    loop: images.length > 1,
                    initialSlide: 0, // Always start at first slide
                    navigation: {
                        nextEl: '.swiper-button-next', 
                        prevEl: '.swiper-button-prev',
                    },
                    zoom: {
                        maxRatio: 3,
                        toggle: true,
                    },
                    slidesPerView: 1,
                    spaceBetween: 0,
                });
                
                // Show all slides immediately
                $('.swiper-slide').show();
            });
        }
        
        // Clear existing slides and add new ones
        const swiperWrapper = $('#imagePreviewModal .swiper-wrapper');
        swiperWrapper.empty();
        
        // Reorder images to put the clicked image first
        const orderedImages = [clickedImageUrl];
        images.forEach(imageUrl => {
            if (imageUrl !== clickedImageUrl) {
                orderedImages.push(imageUrl);
            }
        });
        
        // Now add the slides in the correct order
        orderedImages.forEach(imageUrl => {
            swiperWrapper.append(`
                <div class="swiper-slide d-flex align-items-center justify-content-center">
                    <img src="${imageUrl}" class="img-fluid" style="max-height: 100vh; object-fit: contain;">
                </div>
            `);
        });
        
        // Initialize the modal
        const imageModal = new bootstrap.Modal(document.getElementById('imagePreviewModal'));
        imageModal.show();
    }

    $(document).on('click', '.tag-button', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const user = {{{json user}}}
        const isTemporary = !!user.isTemporary
        const subscriptionStatus = user.subscriptionStatus == 'active'
        if(isTemporary || !subscriptionStatus){
            showUpgradePopup()
            return
        }
        var dataId = $(this).attr('data-id');
        var codeToCopy = `<div id="lamix-chat-widget" data-id="${dataId}"></div><script src="https://lamix.hatoltd.com/js/chat-widget.js"></` + `script>`;

        // Create a temporary textarea element to copy the text
        var $temp = $('<textarea>');
        $('body').append($temp);
        $temp.val(codeToCopy).select();
        document.execCommand('copy');
        $temp.remove();

        // Show SweetAlert2 notification
        Swal.fire({
            title: 'コピー完了',
            text: 'タグをコピーしました。チャットボットを設置したい場所にタグを貼り付けてください。',
            icon:'success',
            confirmButtonText: 'OK'
        });
    });
    $(document).on('click', '.delete-chat', function(e) {
        e.preventDefault()
        e.stopPropagation();
        const chatId = $(this).data('id');
        const user = {{{json user}}}
        const userId = user._id
        Swal.fire({
            title: '本当に削除しますか？',
            text: "この操作は元に戻せません！",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'はい、削除します！',
            cancelButtonText: 'キャンセル'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: `/api/delete-chat/${chatId}`,
                    type: 'DELETE',
                    data: { chatId },
                    success: function(response) {
                        renderChatList(userId)
                    },
                    error: function(xhr, status, error) {
                        Swal.fire(
                            'エラー',
                            'チャットの削除に失敗しました。',
                            'error'
                        );
                    }
                });
            }
        });
    });
    $(document).on('click', '.delete-chat-history', function(e) {
        e.preventDefault()
        e.stopPropagation();
        const selectedChatId = $(this).data('id');
        Swal.fire({
            title: '本当に削除しますか？',
            text: "この操作は元に戻せません！",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'はい、削除します！',
            cancelButtonText: 'キャンセル'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: `/api/delete-chat-history/${selectedChatId}`,
                    type: 'DELETE',
                    success: function(response) {
                        $(document).find(`.user-chat-history[data-chat="${selectedChatId}"]`).fadeOut().remove()
                    },
                    error: function(xhr, status, error) {
                        Swal.fire(
                            'エラー',
                            'チャットの削除に失敗しました。',
                            'error'
                        );
                    }
                });
            }
        });
    });

    $('.nav-link').on('click', function(e) {
        e.preventDefault();
        $('.nav-link').removeClass('active');
        $(this).addClass('active');
        
        if ($(this).text().trim() === 'ペルソナ') {
            $('.custom-card').hide();
            $('.custom-card .persona.on').closest('.custom-card').show();
        } else {
            $('.custom-card').show();
        }
    });

    // --- Popular Chats Infinite Scroll with Session Storage Caching ---
    let popularChatsPage = 1;
    let popularChatsLoading = false;
    let popularChatsTotalPages = 1;
    const POPULAR_CHATS_CACHE_KEY = 'popularChatsCache';
    const POPULAR_CHATS_CACHE_TIME_KEY = 'popularChatsCacheTime';
    const POPULAR_CHATS_CACHE_TTL = 24 * 60 * 60 * 1000; // 24 hours in ms

    // Helper to get cache
    function getPopularChatsCache() {
        const cache = sessionStorage.getItem(POPULAR_CHATS_CACHE_KEY);
        const cacheTime = sessionStorage.getItem(POPULAR_CHATS_CACHE_TIME_KEY);
        if (!cache || !cacheTime) return null;
        if (Date.now() - parseInt(cacheTime, 10) > POPULAR_CHATS_CACHE_TTL) {
            sessionStorage.removeItem(POPULAR_CHATS_CACHE_KEY);
            sessionStorage.removeItem(POPULAR_CHATS_CACHE_TIME_KEY);
            return null;
        }
        try {
            return JSON.parse(cache);
        } catch {
            return null;
        }
    }

    // Helper to set cache
    function setPopularChatsCache(page, data) {
        let cache = getPopularChatsCache() || {};
        cache[page] = data;
        sessionStorage.setItem(POPULAR_CHATS_CACHE_KEY, JSON.stringify(cache));
        sessionStorage.setItem(POPULAR_CHATS_CACHE_TIME_KEY, Date.now().toString());
    }

    async function loadPopularChats(page = 1, reload = false) {
        if (popularChatsLoading && !reload) return; // Added !reload to allow forced reload
        popularChatsLoading = true;
        // Show spinner for popular chats
        $('#popular-chats-pagination-controls').html('<div class="text-center my-3"><div class="spinner-border text-secondary spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div></div>');

        if (reload) { // Added reload logic for popular chats as well
            popularChatsPage = 1;
            $('#chat-gallery').empty(); // 'chat-gallery' is the popular chats container
            sessionStorage.removeItem(POPULAR_CHATS_CACHE_KEY);
            sessionStorage.removeItem(POPULAR_CHATS_CACHE_TIME_KEY);
        }

        let cache = getPopularChatsCache(); // Ensure this function exists or adapt
        let data = cache && cache[page];
        if (data) {
            // console.log(`Loading popular chats page ${page} from cache`);
            window.displayChats(data.chats, 'chat-gallery', false); // Corrected target ID
            popularChatsTotalPages = data.totalPages || 1;
            if (page >= popularChatsTotalPages) {
                $('#popular-chats-pagination-controls').html('');
            } else {
                $('#popular-chats-pagination-controls').html('<div class="text-center my-3"><div class="spinner-border text-secondary spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div></div>');
            }
            popularChatsLoading = false;
            return;
        }

        try {
            // console.log(`Fetching popular chats page ${page} from API`);
            const res = await fetch(`/api/popular-chats?page=${page}`); // Ensure this API endpoint exists
            if (!res.ok) {
                $('#popular-chats-pagination-controls').html('<div class="text-center text-danger my-3">Failed to load popular chats.</div>');
                popularChatsLoading = false;
                return;
            }
            data = await res.json();
            setPopularChatsCache(page, data); // Ensure this function exists or adapt

            // Shuffle popular chats if desired (example from your existing code)
            if (Array.isArray(data.chats)) {
                data.chats = data.chats
                    .map(value => ({ value, sort: Math.random() }))
                    .sort((a, b) => a.sort - b.sort)
                    .map(({ value }) => value);
            }
            window.displayChats(data.chats, 'chat-gallery', false); // Corrected target ID
            popularChatsTotalPages = data.totalPages || 1;
            if (page >= popularChatsTotalPages) {
                $('#popular-chats-pagination-controls').html('');
            } else {
                $('#popular-chats-pagination-controls').html('<div class="text-center my-3"><div class="spinner-border text-secondary spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div></div>');
            }
        } catch (e) {
            $('#popular-chats-pagination-controls').html('<div class="text-center text-danger my-3">Error loading popular chats.</div>');
        }
        popularChatsLoading = false;
    }

    // Initial load (always loads page 1)
    loadPopularChats();

    // Infinite scroll for popular chats
    $(window).on('scroll.popularChats', function() {
        if (
            !popularChatsLoading &&
            popularChatsPage < popularChatsTotalPages &&
            $(window).scrollTop() + $(window).height() >= $(document).height() - 200
        ) {
            popularChatsPage++;
            loadPopularChats(popularChatsPage);
        }
    });

    // Global states for Latest Chats
    var latestChatsPage = 1;
    var latestChatsLoading = false;
    var latestChatsTotalPages = 1;
    const LATEST_CHATS_CACHE_KEY = 'latestChatsCache';
    const LATEST_CHATS_CACHE_TIME_KEY = 'latestChatsCacheTime';
    const LATEST_CHATS_CACHE_TTL = 1 * 60 * 60 * 1000; // 1 hour in milliseconds

    // --- Latest Chats ---
    function getLatestChatsCache() {
        const cache = sessionStorage.getItem(LATEST_CHATS_CACHE_KEY);
        const cacheTime = sessionStorage.getItem(LATEST_CHATS_CACHE_TIME_KEY);
        if (!cache || !cacheTime) return null;
        if (Date.now() - parseInt(cacheTime, 10) > LATEST_CHATS_CACHE_TTL) {
            sessionStorage.removeItem(LATEST_CHATS_CACHE_KEY);
            sessionStorage.removeItem(LATEST_CHATS_CACHE_TIME_KEY);
            return null;
        }
        try {
            return JSON.parse(cache);
        } catch {
            return null;
        }
    }

    function setLatestChatsCache(page, data) {
        let cache = getLatestChatsCache() || {};
        cache[page] = data;
        sessionStorage.setItem(LATEST_CHATS_CACHE_KEY, JSON.stringify(cache));
        sessionStorage.setItem(LATEST_CHATS_CACHE_TIME_KEY, Date.now().toString());
    }
    window.loadLatestChats = async function(page = 1, reload = false) {
        if (latestChatsLoading && !reload) {
            return;
        }
        latestChatsLoading = true;
        //$('#latest-chats-pagination-controls').html('<div class="text-center my-3"><div class="spinner-border text-secondary spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div></div>');

        if (reload) {
            latestChatsPage = 1;
            $('#latest-chats-gallery').empty();
            sessionStorage.removeItem(LATEST_CHATS_CACHE_KEY);
            sessionStorage.removeItem(LATEST_CHATS_CACHE_TIME_KEY);
        }

        let cache = getLatestChatsCache();
        let data = cache && cache[page];

        if (data) { // Disable cache for now
            window.displayLatestChats(data.chats, 'latest-chats-gallery', false);
            latestChatsTotalPages = data.totalPages || 1;
            if (page >= latestChatsTotalPages) {
                $('#latest-chats-pagination-controls').html('');
            }
            latestChatsLoading = false;
            return;
        }

        try {
            const res = await fetch(`/api/latest-chats?page=${page}`);
            if (!res.ok) {
                $('#latest-chats-pagination-controls').html('<div class="text-center text-danger my-3">Failed to load chats.</div>');
                latestChatsLoading = false;
                return;
            }
            data = await res.json();
            setLatestChatsCache(page, data);

            window.displayLatestChats(data.chats, 'latest-chats-gallery', false);
            latestChatsTotalPages = data.totalPages || 1;

            if (page >= latestChatsTotalPages) {
                $('#latest-chats-pagination-controls').html('');
            } else {
                //$('#latest-chats-pagination-controls').html('<div class="text-center my-3"><div class="spinner-border text-secondary spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div></div>');
            }
        } catch (e) {
            console.error('[LatestChats] Error loading chats:', e);
            $('#latest-chats-pagination-controls').html('<div class="text-center text-danger my-3">Error loading chats.</div>');
        }
        latestChatsLoading = false;
    }

    // Initial load for Latest Chats
    if ($('#latest-chats-section').length) {
        loadLatestChats();
    }

    // Optional: reload on tab switch or other triggers
    // Example: $('#reload-popular-chats').on('click', function(){ popularChatsPage=1; loadPopularChats(1, true); });

});
/* --- Sorting and Filtering for Popular Chats --- */

// Premium filter state
let premiumChatsHidden = false; //Cookies.get('premiumChatsHidden') === 'true' || (isTemporary || !subscriptionStatus);
let currentGenderFilter = Cookies.get('currentGenderFilter') || null;

// NSFW filter state
let nsfwChatsHidden = Cookies.get('nsfwChatsHidden') === 'true';

// Style filter state
let currentStyleFilter = Cookies.get('currentStyleFilter') || null;
/*
 * Comprehensive log before calling updateChatFilters
 */
function logChatFilterStates(context) {
    return
    console.log('[ChatFilter] Context:', context);
    console.log('[ChatFilter] premiumChatsHidden:', premiumChatsHidden);
    console.log('[ChatFilter] currentGenderFilter:', currentGenderFilter);
    console.log('[ChatFilter] nsfwChatsHidden:', nsfwChatsHidden);
    console.log('[ChatFilter] currentStyleFilter:', currentStyleFilter);
    // Optionally log cookies for debugging
    console.log('[ChatFilter] Cookies:', {
        premiumChatsHidden: Cookies.get('premiumChatsHidden'),
        currentGenderFilter: Cookies.get('currentGenderFilter'),
        nsfwChatsHidden: Cookies.get('nsfwChatsHidden'),
        currentStyleFilter: Cookies.get('currentStyleFilter')
    });
}

// Restore button states on page load
$(function() {
    // Set premium button text and state
    $('#popular-chats-premium').text(
        premiumChatsHidden ? '{{translations.sort.showPremium}}' : '{{translations.sort.hidePremium}}'
    );
    // Set gender button active state
    if (currentGenderFilter) {
        $('.sorting-tools button').removeClass('active');
        $(`#popular-chats-gender-${currentGenderFilter}`).addClass('active');
    }
    // Set NSFW button text and state
    $('#popular-chats-nsfw').text(
        nsfwChatsHidden ? '{{translations.sort.showNSFW}}' : '{{translations.sort.hideNSFW}}'
    );
    // Set style button active state
    if (currentStyleFilter) {
        $('.sorting-tools button').removeClass('active');
        $(`#popular-chats-style-${currentStyleFilter}`).addClass('active');
    }
    logChatFilterStates('on page load');
    updateChatFilters();
});
$(document).on('click', '#popular-chats-premium', function() {
    premiumChatsHidden = !premiumChatsHidden;
    Cookies.set('premiumChatsHidden', premiumChatsHidden, { expires: 7 });
    logChatFilterStates('premium toggle');
    updateChatFilters();
    $(this).text(premiumChatsHidden ? '{{translations.sort.showPremium}}' : '{{translations.sort.hidePremium}}');
});
// Gender filter state
$(document).on('click', '#popular-chats-gender-female, #popular-chats-gender-male, #popular-chats-gender-nonbinary', function() {
    currentGenderFilter = this.id.replace('popular-chats-gender-', '');
    Cookies.set('currentGenderFilter', currentGenderFilter, { expires: 7 });
    $('.sorting-tools button').removeClass('active');
    $(this).addClass('active');
    logChatFilterStates('gender filter');
    updateChatFilters();
});
// Reset gender filter
$(document).on('click', '.sorting-tools .btn:not([id^="popular-chats-gender-"])', function() {
    currentGenderFilter = null;
    Cookies.remove('currentGenderFilter');
    $('.sorting-tools button').removeClass('active');
    logChatFilterStates('reset gender filter');
    updateChatFilters();
});
// NSFW filter state
$(document).on('click', '#popular-chats-nsfw', function() {
    nsfwChatsHidden = !nsfwChatsHidden;
    Cookies.set('nsfwChatsHidden', nsfwChatsHidden, { expires: 7 });
    logChatFilterStates('nsfw toggle');
    updateChatFilters();
    $(this).text(nsfwChatsHidden ? '{{translations.sort.showNSFW}}' : '{{translations.sort.hideNSFW}}');
});
// Style filter state
$(document).on('click', '#popular-chats-style-anime, #popular-chats-style-photorealistic', function() {
    currentStyleFilter = this.id.replace('popular-chats-style-', '');
    Cookies.set('currentStyleFilter', currentStyleFilter, { expires: 7 });
    $('.sorting-tools button').removeClass('active');
    $(this).addClass('active');
    logChatFilterStates('style filter');
    updateChatFilters();
});
// Reset style filter
$(document).on('click', '.sorting-tools .btn:not([id^="popular-chats-style-"])', function() {
    currentStyleFilter = null;
    Cookies.remove('currentStyleFilter');
    $('.sorting-tools button').removeClass('active');
    logChatFilterStates('reset style filter');
    updateChatFilters();
});
// Filtering logic
function updateChatFilters() {
    // Premium filter
    $('.popular-chats-gallery .gallery-card').each(function(index) {
        const isPremium = $(this).hasClass('premium-chat');
        const genderClass = $(this).attr('class').match(/chat-gender-([a-z]+)/);
        const gender = genderClass ? genderClass[1] : null;
        const isNSFW = $(this).hasClass('nsfw-true');
        const styleClass = $(this).attr('class').match(/chat-style-([a-z]+)/);
        const style = styleClass ? styleClass[1] : null;

        let show = true;
        let reasons = [];

        if (premiumChatsHidden && isPremium) {
            show = false;
            reasons.push('premiumChatsHidden && isPremium');
        }
        // Temporarily disable gender filter
        // if (currentGenderFilter && gender !== currentGenderFilter) {
        //     show = false;
        //     reasons.push(`currentGenderFilter (${currentGenderFilter}) && gender (${gender}) !== currentGenderFilter`);
        // }
        if (nsfwChatsHidden && isNSFW) {
            show = false;
            reasons.push('nsfwChatsHidden && isNSFW');
        }
        if (currentStyleFilter && style !== currentStyleFilter) {
            show = false;
            reasons.push(`currentStyleFilter (${currentStyleFilter}) && style (${style}) !== currentStyleFilter`);
        }

        $(this).toggle(show);
    });
}

// Ensure filters are applied after chats are rendered
const _displayChats = window.displayChats;
window.displayChats = function() {
    if (typeof _displayChats === 'function') _displayChats.apply(this, arguments);
    logChatFilterStates('after displayChats');
    updateChatFilters();
};
/* --- End Sorting and Filtering --- */
$('.date-time').each(function() {
    var dateText = $(this).text();
    var trimmedDate = dateText.split(' ')[0]; // Get the date part only
    $(this).text(trimmedDate); // Update the element's content
});
function initiateCheckout(buttonId) {
    const user = {{{json user}}}
    const userId = user._id
    let stripe
    if(window.location.href.indexOf('https://') >= 0){
        stripe = Stripe('pk_live_51PjtRbE5sP7DA1XvCkdmezori9qPGoO21y7yKSVvgkQVyrhWZfHAUkNsjPMnbwpPlp4zzoYsRjn79Ad7XN7HTHcc00UjBA9adF'); // Use your publishable key here
    }else{
        stripe = Stripe('pk_test_51PjtRbE5sP7DA1XvD68v7X7Qj7pG6ZJpQmvuNodJjxc7MbH1ss2Te2gahFAS9nms4pbmEdMYdfCPxFDWHBbu9CxR003ikTnRES'); // Use your publishable key here
    }
    $.ajax({
        url: '/plan/create-checkout-session',
        method: 'POST',
        data: { buttonId, userId },
        success: function(session) {
            return stripe.redirectToCheckout({ sessionId: session.id });
        },
        error: function(xhr, status, error) {
            console.error('Error creating Stripe checkout session:', error);
        }
    });
}
    function renderCircleGrid(cardInfos,container){
        cardInfos.forEach(function(item) {
            var card = $(`
                <div class="card custom-card bg-transparent shadow-0 border-0 px-1 col-3 col-sm-4 col-lg-2" style="cursor:pointer;" data-id="${item._id}">
                    <div style="background-image:url(${item.chatImageUrl})" class="card-img-top rounded-avatar position-relative m-auto" alt="${item.name}">
                    </div>
                </div>
            `);
            card.on('click', function() {
                redirectToChat($(this).attr('data-id'))
            });
            container.append(card);
        });   
    }
</script>
</body>
</html>
