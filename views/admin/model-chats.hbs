<!DOCTYPE html>
<html lang="{{lang}}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Model Chats Management - Admin</title>
  {{>dashboard-header}}
</head>
<body>
  {{>dashboard-nav}}
  
  <div class="container-fluid mt-4">
    <div class="row">
      <div class="col-12">
        <h2>Model Chats Management</h2>
        <p>Generate daily AI character chats for each model in your system.</p>
        
        <div class="card mb-4">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Available Models</h5>
              <button id="generateAllChats" class="btn btn-primary">Generate All Model Chats</button>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Thumbnail</th>
                    <th>Model</th>
                    <th>Style</th>
                    <th>Version</th>
                    <th>Recent Chats</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {{#each models}}
                    <tr>
                      <td>
                        <img src="{{image}}" alt="{{model}}" class="rounded-circle img-thumbnail" style="width: 60px;height:60px; object-fit: cover;">
                      </td>
                      <td>{{model}}</td>
                      <td>{{style}}</td>
                      <td>{{version}}</td>
                      <td>
                        <span class="badge {{#if hasRecentChat}}bg-success{{else}}bg-danger{{/if}}">
                          {{#if hasRecentChat}}Generated today{{else}}Not generated today{{/if}}
                        </span>
                        <span class="ms-2">{{chats.length}} recent chats</span>
                      </td>
                      <td>
                        <button class="btn btn-sm btn-outline-primary generate-chat-btn" 
                                data-model-id="{{modelId}}"
                                data-model-name="{{model}}">
                          Generate Chat
                        </button>
                      </td>
                    </tr>
                  {{/each}}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Recently Generated Chats</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Thumbnail</th>
                    <th>Character Name</th>
                    <th>Model</th>
                    <th>Created</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {{#each recentChats}}
                    <tr>
                      <td>
                        <img src="{{chatImageUrl}}" alt="{{model}}" class="rounded-circle img-thumbnail" style="width: 60px;height:60px; object-fit: cover;">
                      </td>
                      <td>{{name}}</td>
                      <td>{{imageModel}}</td>
                      <td>{{formatDate createdAt}}</td>
                      <td>
                        <a href="/chat/{{_id}}" class="btn btn-sm btn-outline-secondary" target="_blank">
                          View Chat
                        </a>
                      </td>
                    </tr>
                  {{/each}}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal for character generation preview -->
  <div class="modal fade" id="generateChatModal" tabindex="-1" aria-labelledby="generateChatModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg mx-0">
      <div class="modal-content mx-auto">
        <div class="modal-header">
          <h5 class="modal-title" id="generateChatModalLabel">Generating Chat</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="text-center mb-3" id="modelInfo">
            <strong>Model:</strong> <span id="modelName"></span>
          </div>
          
          <div id="loadingPrompt" class="text-center">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p>Fetching prompt...</p>
          </div>
          
          <div id="promptPreview" class="d-none">
            <div class="row">
              <div class="col-md-6">
                <div class="card mb-3">
                  <img id="promptImage" src="" class="card-img-top" alt="Character preview">
                  <div class="card-body">
                    <h5 class="card-title">Preview</h5>
                    <p class="card-text"><small class="text-muted">Source: Civitai</small></p>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <h5>Prompt:</h5>
                <div class="border p-3 mb-3" style="max-height: 300px; overflow-y: auto;">
                  <p id="promptText"></p>
                </div>
              </div>
            </div>
          </div>
          
          <div id="noPrompt" class="alert alert-warning d-none">
            No prompt available.
          </div>
          
          <div id="errorFetching" class="alert alert-danger d-none">
            Error fetching prompt.
          </div>
          
          <div id="generationResult" class="alert d-none">
            <p id="generationMessage"></p>
            <a id="viewCharacterLink" href="#" class="btn btn-primary d-none">
              View Character
            </a>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" id="generateBtn" class="btn btn-primary d-none">Generate</button>
        </div>
      </div>
    </div>
  </div>
  
  {{>dashboard-footer}}
  
  <script>
    $(document).ready(function() {
      // Single model chat generation
      $('.generate-chat-btn').on('click', function() {
        const modelId = $(this).data('model-id');
        const modelName = $(this).data('model-name');
        const btn = $(this);
        
        // Ask user about NSFW setting first
        Swal.fire({
          title: 'Generate Chat Settings',
          html: 'Include NSFW content?',
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Yes, include NSFW',
          cancelButtonText: 'No, SFW only',
          showCloseButton: true,
          closeButtonHtml: '&times;'
        }).then((result) => {
          let nsfw = false;
          if(result.isConfirmed){
            nsfw = true;
          }          
          // Show loading indicator
          $('#loadingModal').modal('show');
          btn.prop('disabled', true);
          
          $.ajax({
            url: '/admin/model-chats/generate',
            type: 'POST',
            data: { modelId, nsfw },
            dataType: 'json',
            success: function(data) {
              $('#loadingModal').modal('hide');
              btn.prop('disabled', false);

              if (data.success) {
                resetPeopleChatCache(null, data.chat.imageModel)
                Swal.fire({
                  title: 'Success!',
                  html: `<div class="text-center">
                    <p>Successfully generated chat for <strong>${modelName}</strong>.</p>
                    <h4> Civitai Data </h4>
                    <p> <strong> Prompt: </strong> ${data.chat.characterPrompt} </p>
                    <p> <strong> Image: </strong> <img src="${data.chat.civitaiData.imageUrl}" class="img-fluid" style="max-height: 300px;"> </p>
                    </div>`,
                  icon: 'success',
                  confirmButtonText: 'Great!'
                }).then(() => {
                });
              } else {
                Swal.fire({
                  title: 'Error!',
                  text: data.error || 'Failed to generate chat',
                  icon: 'error',
                  confirmButtonText: 'OK'
                });
              }
            },
            error: function(xhr) {
              $('#loadingModal').modal('hide');
              btn.prop('disabled', false);
              
              Swal.fire({
                title: 'Error!',
                text: xhr.responseJSON?.error || 'An unknown error occurred',
                icon: 'error',
                confirmButtonText: 'OK'
              });
            }
          });
        });
      });
      
      // Generate all chats
      $('#generateAllChats').on('click', function() {
        Swal.fire({
          title: 'Generate All Chats?',
          text: 'This will generate chats for all models and may take some time.',
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Yes, generate all',
          cancelButtonText: 'Cancel'
        }).then((result) => {
          if (result.isConfirmed) {
            // Ask user about NSFW setting first
            Swal.fire({
              title: 'NSFW Setting',
              text: 'Include NSFW content in generated chats?',
              icon: 'question',
              showCancelButton: true,
              confirmButtonText: 'Yes, include NSFW',
              cancelButtonText: 'No, SFW only'
            }).then((nsfwResult) => {
                let nsfw = false;
                if(nsfwResult.isConfirmed){
                  nsfw = true;
                }          
                // Show loading indicator
                $('#loadingModal').modal('show');
                
                $.ajax({
                  url: '/admin/model-chats/generate',
                  type: 'POST',
                  data: { nsfw },
                  dataType: 'json',
                  success: function(data) {
                    $('#loadingModal').modal('hide');
                    
                    if (data.success) {
                      const successes = data.results.filter(r => r.status === 'success').length;
                      const failures = data.results.filter(r => r.status !== 'success').length;
                      
                      Swal.fire({
                        title: 'Generation Complete',
                        text: `Successfully generated ${successes} chats. Failed: ${failures}.`,
                        icon: 'success',
                        confirmButtonText: 'Great!'
                      }).then(() => {
                        location.reload();
                      });
                    } else {
                      Swal.fire({
                        title: 'Error!',
                        text: data.error || 'Failed to generate chats',
                        icon: 'error',
                        confirmButtonText: 'OK'
                      });
                    }
                  },
                  error: function(xhr) {
                    $('#loadingModal').modal('hide');
                    
                    Swal.fire({
                      title: 'Error!',
                      text: xhr.responseJSON?.error || 'An unknown error occurred',
                      icon: 'error',
                      confirmButtonText: 'OK'
                    });
                  }
                });
              
            });
          }
        });
      });
    });
  </script>
</body>
</html>