<!DOCTYPE html>
<html lang="ja">
   {{> dashboard-header}}
<body>
    {{> dashboard-nav}}

    <style>
    .style-option {
        width: 75px;
        cursor:pointer;
    }
    .style-option.selected {
        border: 4px solid #8849ff;
    }
    .animated.fadeInDown .swal2-image{
        margin:0;
    }
    .animated.fadeInDown .swal2-close{
        border:0;
    }
    /* Custom animation for sliding in from the bottom */
    .swal2-bottom-slide-in {
        animation: bottom-slide-in 0.5s;
    }

    .swal2-bottom-slide-out {
        animation: bottom-slide-out 0.5s;
    }

    @keyframes bottom-slide-in {
        0% {
            transform: translateY(100%);
            opacity: 0;
        }
        100% {
            transform: translateY(0);
            opacity: 1;
        }
    }

    @keyframes bottom-slide-out {
        0% {
            transform: translateY(0);
            opacity: 1;
        }
        100% {
            transform: translateY(100%);
            opacity: 0;
        }
    }
    .custom-gradient-bg {
        background: linear-gradient(90.9deg, #D2B8FF 2.74%, #8240FF 102.92%);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        transition: color 0.3s ease-in-out;
    }

    .custom-gradient-bg::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 300%;
        height: 300%;
        background: radial-gradient(circle, rgba(255,255,255,0.5) 0%, rgba(255,255,255,0) 80%);
        transform: translate(-50%, -50%) scale(0);
        transition: transform 0.5s ease-in-out;
        z-index: 0;
    }

    .custom-gradient-bg:hover::before {
        transform: translate(-50%, -50%) scale(1);
    }

    .custom-gradient-bg:hover {
        color: #fff;
    }
    #chatImage{
        width: 100px;
        height: 100px; 
        object-fit:cover;
        object-position:top;
    }
    #chatImage.on{
        width: auto !important;
        height: 270px !important;
    }
    .btn-gradient-radius {
        display: inline-block;
        padding: 7px 20px;
        border-radius: 25px;
        text-decoration: none;
        color: #FFF;
        background-image: linear-gradient(45deg, #FFC107 0%, #ff8b5f 100%);
        transition: .4s;
        font-size: 21px;
    }
    label{
        font-size: 14px;
        color: #aaaaaa;
    }
    #sendMessage,
    #chatInput .load {
        border-left: 0 !important;
        border-radius: 0px 30px 30px 0px !important;
        box-shadow: none;
    }
    #userMessage {
        border-radius: 30px 0px 0px 30px !important;
        background-color: #f8f9fa;
    }
    #userMessage:focus {
        outline: none;
        box-shadow: none; /* If there is a box shadow applied on focus */
    }
    .button-group{
        top:0;
        right: 15px;
    }
    .scroll-container {
      display: flex;
      flex-wrap: nowrap;
      overflow-x: auto;
    }
    .scroll-container > * {
      flex: 0 0 auto;
      width: auto;
    }
    .card-text.template{
        font-size: 12px;
    }
    /*Custom css*/
    label{
        font-size: 12px;
        color: #8d8b8b;
    }
    .avatar-xl img {
        width: 110px;
    }
    .rounded-circle {
        border-radius: 50%;
    }
    .rounded-circle.on {
        border-radius: 15px !important;
    }
    img {
        vertical-align: middle;
        border-style: none;
    }
    .text-muted {
        color: #aeb0b4 !important;
    }
    .text-muted {
        font-weight: 300;
    }
    .form-control {
        display: block;
        width: 100%;
        height: calc(1.5em + 0.75rem + 2px);
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        font-weight: 400;
        line-height: 1.5;
        color: #4d5154;
        background-color: #ffffff;
        background-clip: padding-box;
        border: 1px solid #eef0f3;
        border-radius: 0.25rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    #markdownContainer {
        margin-bottom: 20px;
        padding: 20px;
        border: 1px solid #eef0f3;
        border-radius: 4px;
    }
    .auto-gen{
        font-size: 10px;
        border-radius: 50px;
    }
    </style>

<div class="container position-relative rounded p-3 my-4 px-0">
    
    <!-- 1. キャラクター画像 -->
    <div id="step1" class="step">
            <h4 class="container mb-4 text-center stepTitle">{{translations.newCharacter.characterCreationForm}}</h4>

            <!-- Character Creation Form -->
            <div id="characterCreationForm" class="container mt-3">
                
                <div class="row">
                    <!-- Left Column: Prompts and Button -->
                    <div class="col-lg-6 mb-4">
                        <div class="row mb-4">
                            <!-- Image Style Selection -->
                            <div class="row bg-light border py-2 mb-3 mx-0">
                                <h4 class="mb-4 text-start">{{translations.newCharacter.imageStyleSelectionTitle}}</h4>
                                <p class="text-start">
                                    {{translations.newCharacter.imageStyleSelectionDescription}}
                                </p>
                                <label class="form-label">{{translations.newCharacter.image_style}}</label>
                                <div id="imageStyleSelection" class="d-flex flex-row flex-nowrap overflow-auto mb-4"></div>
                                <input type="hidden" id="modelId" name="modelId" required>
                                <input type="hidden" id="imageStyle" name="imageStyle" required>
                                <input type="hidden" id="imageModel" name="imageModel" required>
                                <input type="hidden" id="imageVersion" name="imageVersion" required>
                            </div>

                            <div class="row justify-content-between character-generator bg-light border py-2 mb-3 mx-0">

                                <h4 class="mb-4 text-start">{{translations.newCharacter.characterPhysicalDescriptionTitle}}</h4>
                                <p class="text-start">
                                    {{translations.newCharacter.characterPhysicalDescriptionDescription}}
                                </p>

                                <!-- Gender -->
                                <div class="col-auto mb-3">
                                    <label for="gender" class="form-label"><i class="bi bi-asterisk text-danger me-2"></i>{{translations.newCharacter.genderLabel}}:</label>
                                    <select class="form-select" id="gender" name="gender">
                                        <option value="female">{{translations.newCharacter.female}}</option>
                                        <option value="male">{{translations.newCharacter.male}}</option>
                                        <option value="nonBinary">{{translations.newCharacter.nonBinary}}</option>
                                    </select>
                                </div>

                                <!-- Character Prompt Input -->
                                <div class="mb-2">
                                    <label for="characterPrompt" class="form-label"><i class="bi bi-asterisk text-danger me-2"></i>{{translations.newCharacter.character_prompt}}</label>
                                    <!-- List of tags -->
                                    <div class="mb-2">
                                        <label for="tags" class="form-label">{{translations.newCharacter.tagsLabel}}:</label>
                                        <div class="scroll-container">
                                            {{#each tags}}
                                                <span type="button" class="badge bg-light text-secondary me-1 add-tag fw-light border">{{this}}</span>
                                            {{/each}}
                                        </div>
                                    </div>
                                    <textarea
                                        class="form-control"
                                        id="characterPrompt"
                                        name="characterPrompt"
                                        rows="4"
                                        maxlength="500"
                                        placeholder="{{translations.newCharacter.character_appearance_description}}"
                                    ></textarea>

                                    <!-- Character Personnality Input -->
                                    <div class="form-check mb-1 ms-1 mt-1">
                                        <input type="checkbox" class="form-check-input" id="enableEnhancedPrompt" name="enableEnhancedPrompt" checked>
                                        <label class="form-check-label" for="enableEnhancedPrompt">{{translations.newCharacter.enable_enhanced_prompt}}</label>
                                    </div>
                                </div>


                                <div class="mb-3">
                                    <textarea
                                        class="form-control"
                                        id="enhancedPrompt"
                                        name="enhancedPrompt"
                                        rows="3"
                                        readonly
                                    ></textarea>
                                </div>

                                <div class="accordion" id="characterDescriptionAccordion">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingOne">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                            <input class="form-check-input" type="checkbox" value="" id="characterDescriptionCheck">{{translations.newCharacter.character_overview}}
                                        </button>
                                        </h2>
                                        <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#characterDescriptionAccordion">
                                            <div class="accordion-body row">
                                                <a href="/my-plan" class="is-premium card py-2 custom-gradient-bg mb-3">{{translations.unlock_more_customization_fields}}</a>
                                                
                                                <!-- Age -->
                                                <div class="col-auto mb-3">
                                                    <label for="age" class="form-label">{{translations.newCharacter.ageLabel}}:</label>
                                                    <select class="form-select w-auto" id="age" name="age">
                                                        <option value="" disabled selected>{{translations.newCharacter.agePlaceholder}}</option>
                                                        <!-- Adult Age Range -->
                                                        <option value="18-24">{{translations.newCharacter.ageYoungAdult}}</option>
                                                        <option value="25-34">{{translations.newCharacter.ageAdultEarly}}</option>
                                                        <option value="35-44">{{translations.newCharacter.ageAdultMid}}</option>
                                                        <option value="45-54">{{translations.newCharacter.ageAdultLate}}</option>
                                                        <option value="55+">{{translations.newCharacter.ageSenior}}</option>
                                                    </select>
                                                </div>

                                                <!-- Build -->
                                                <div class="col-auto mb-3">
                                                    <label for="build" class="form-label">{{translations.newCharacter.buildLabel}}:</label>
                                                    <select class="form-select" id="build" name="build">
                                                        <option value="slim">{{translations.newCharacter.slim}}</option>
                                                        <option value="muscular">{{translations.newCharacter.muscular}}</option>
                                                        <option value="athletic">{{translations.newCharacter.athletic}}</option>
                                                        <option value="stocky">{{translations.newCharacter.stocky}}</option>
                                                    </select>
                                                </div>

                                                <!-- Skin Tone -->
                                                <div class="col-auto mb-3">
                                                    <label for="skinTone" class="form-label">{{translations.newCharacter.skinToneLabel}}:</label>
                                                    <select class="form-select" id="skinTone" name="skinTone">
                                                        <option value="fair">{{translations.newCharacter.fair}}</option>
                                                        <option value="medium">{{translations.newCharacter.medium}}</option>
                                                        <option value="dark">{{translations.newCharacter.dark}}</option>
                                                    </select>
                                                </div>

                                                <!-- Eye Color -->
                                                <div class="col-auto mb-3">
                                                    <label for="eyeColor" class="form-label">{{translations.newCharacter.eyeColorLabel}}:</label>
                                                    <select class="form-select" id="eyeColor" name="eyeColor">
                                                        <option value="blue">{{translations.newCharacter.blue}}</option>
                                                        <option value="brown">{{translations.newCharacter.brown}}</option>
                                                        <option value="green">{{translations.newCharacter.green}}</option>
                                                        <option value="gray">{{translations.newCharacter.gray}}</option>
                                                    </select>
                                                </div>

                                                <!-- Hair Color -->
                                                <div class="col-auto mb-3">
                                                    <label for="hairColor" class="form-label">{{translations.newCharacter.hairColorLabel}}:</label>
                                                    <select class="form-select" id="hairColor" name="hairColor">
                                                        <option value="blonde">{{translations.newCharacter.blonde}}</option>
                                                        <option value="black">{{translations.newCharacter.black}}</option>
                                                        <option value="red">{{translations.newCharacter.red}}</option>
                                                        <option value="brown">{{translations.newCharacter.brown}}</option>
                                                        <option value="gray">{{translations.newCharacter.gray}}</option>
                                                    </select>
                                                </div>

                                                <!-- Hair Length -->
                                                <div class="col-auto mb-3">
                                                    <label for="hairLength" class="form-label">{{translations.newCharacter.hairLengthLabel}}:</label>
                                                    <select class="form-select" id="hairLength" name="hairLength">
                                                        <option value="short">{{translations.newCharacter.short}}</option>
                                                        <option value="medium">{{translations.newCharacter.medium}}</option>
                                                        <option value="long">{{translations.newCharacter.long}}</option>
                                                        <option value="bald">{{translations.newCharacter.bald}}</option>
                                                    </select>
                                                </div>

                                                <!-- Hair Style -->
                                                <div class="col-12 col-sm-6 mb-3">
                                                    <label for="hairStyle" class="form-label">{{translations.newCharacter.hairStyleLabel}}:</label>
                                                    <textarea class="form-control" id="hairStyle" name="hairStyle" placeholder="{{translations.newCharacter.hairStylePlaceholder}}"></textarea>
                                                </div>

                                                <!-- Facial Features -->
                                                <div class="col-12 col-sm-6 mb-3">
                                                    <label for="facialFeatures" class="form-label">{{translations.newCharacter.facialFeaturesLabel}}:</label>
                                                    <textarea class="form-control" id="facialFeatures" name="facialFeatures" placeholder="{{translations.newCharacter.facialFeaturesPlaceholder}}"></textarea>
                                                </div>

                                                <!-- Clothing Style -->
                                                <div class="col-12 col-sm-6 mb-3">
                                                    <label for="clothingStyle" class="form-label">{{translations.newCharacter.clothingStyleLabel}}:</label>
                                                    <textarea class="form-control" id="clothingStyle" name="clothingStyle" placeholder="{{translations.newCharacter.clothingStylePlaceholder}}"></textarea>
                                                </div>

                                                <!-- Accessories -->
                                                <div class="col-12 col-sm-6 mb-3">
                                                    <label for="accessories" class="form-label">{{translations.newCharacter.accessoriesLabel}}:</label>
                                                    <textarea class="form-control" id="accessories" name="accessories" placeholder="{{translations.newCharacter.accessoriesPlaceholder}}"></textarea>
                                                </div>

                                                <!-- Tattoos/Body Art -->
                                                <div class="col-12 col-sm-6 mb-3">
                                                    <label for="tattoos" class="form-label">{{translations.newCharacter.tattoosLabel}}:</label>
                                                    <textarea class="form-control" id="tattoos" name="tattoos" placeholder="{{translations.newCharacter.tattoosPlaceholder}}"></textarea>
                                                </div>

                                                <!-- Special Features -->
                                                <div class="col-12 col-sm-6 mb-3">
                                                    <label for="specialFeatures" class="form-label">{{translations.newCharacter.specialFeaturesLabel}}:</label>
                                                    <textarea class="form-control" id="specialFeatures" name="specialFeatures" placeholder="{{translations.newCharacter.specialFeaturesPlaceholder}}"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                              
                            </div>

                            <div class="row justify-content-between bg-light border py-2 mb-3 mx-0 character-personnality-">

                                <!-- 3. CHaracter Personnalityy -->
                                <h4 class="mb-4 text-start">{{translations.newCharacter.characterPersonalityTitle}}</h4>
                                <p class="text-start">
                                    {{translations.newCharacter.characterPersonalityDescription}}
                                </p>

                                <!-- Name -->
                                <div class="row mx-0 px-0">
                                    <div class="col-12 col-sm-6 mb-3">
                                        <label for="name" class="form-label">{{translations.newCharacter.nameLabel}}:</label>
                                        <input type="text" class="form-control" id="name" name="name" placeholder="{{translations.newCharacter.namePlaceholder}}">
                                    </div>
                                </div>
                                    
                                <div id="chatPurpose-container" class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <label for="chatPurpose" class="form-label">{{translations.newCharacter.characterDetailsLabel}}</label>
                                    </div>
                                    <textarea class="form-control mb-2" id="chatPurpose" name="content" rows="3" placeholder="{{translations.newCharacter.characterDetailsPlaceholder}}"></textarea>
                                </div>

                                <div class="accordion" id="personalityAccordion">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="personalityHeadingOne">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#personalityCollapseOne" aria-expanded="true" aria-controls="personalityCollapseOne">
                                            <input class="form-check-input" type="checkbox" value="" id="personalityCheck">{{translations.newCharacter.detailed_personality}}
                                        </button>
                                        </h2>
                                        <div id="personalityCollapseOne" class="accordion-collapse collapse" aria-labelledby="personalityHeadingOne" data-bs-parent="#personalityAccordion">
                                            <div class="accordion-body row">
                                                <a href="/my-plan" class="is-premium  card py-2  custom-gradient-bg  mb-3">{{translations.unlock_more_customization_fields}}</a>
                                            
                                                <!-- Personality Feature -->
                                                <div class="col-auto mb-3">
                                                    <label for="personality" class="form-label">{{translations.newCharacter.personalityLabel}}:</label>
                                                    <select class="form-select" id="personality" name="personality">
                                                        <option value="optimistic">{{translations.newCharacter.optimistic}}</option>
                                                        <option value="pessimistic">{{translations.newCharacter.pessimistic}}</option>
                                                        <option value="realistic">{{translations.newCharacter.realistic}}</option>
                                                        <option value="idealistic">{{translations.newCharacter.idealistic}}</option>
                                                    </select>
                                                </div>

                                                <!-- Tone Feature -->
                                                <div class="col-auto mb-3">
                                                    <label for="tone" class="form-label">{{translations.newCharacter.toneLabel}}:</label>
                                                    <select class="form-select" id="tone" name="tone">
                                                        <option value="friendly">{{translations.newCharacter.friendly}}</option>
                                                        <option value="serious">{{translations.newCharacter.serious}}</option>
                                                        <option value="sarcastic">{{translations.newCharacter.sarcastic}}</option>
                                                        <option value="humorous">{{translations.newCharacter.humorous}}</option>
                                                    </select>
                                                </div>

                                                <!-- Morality -->
                                                <div class="col-auto mb-3">
                                                    <label for="morality" class="form-label">{{translations.newCharacter.moralityLabel}}:</label>
                                                    <select class="form-select" id="morality" name="morality">
                                                        <option value="good">{{translations.newCharacter.good}}</option>
                                                        <option value="neutral">{{translations.newCharacter.neutral}}</option>
                                                        <option value="evil">{{translations.newCharacter.evil}}</option>
                                                    </select>
                                                </div>

                                                <!-- Motivation -->
                                                <div class="col-12 col-sm-6 mb-3">
                                                    <label for="motivation" class="form-label">{{translations.newCharacter.motivationLabel}}:</label>
                                                    <textarea class="form-control" id="motivation" name="motivation" placeholder="{{translations.newCharacter.motivationPlaceholder}}"></textarea>
                                                </div>

                                                <!-- Strengths -->
                                                <div class="col-12 col-sm-6 mb-3">
                                                    <label for="strengths" class="form-label">{{translations.newCharacter.strengthsLabel}}:</label>
                                                    <textarea class="form-control" id="strengths" name="strengths" placeholder="{{translations.newCharacter.strengthsPlaceholder}}"></textarea>
                                                </div>

                                                <!-- Weaknesses -->
                                                <div class="col-12 col-sm-6 mb-3">
                                                    <label for="weaknesses" class="form-label">{{translations.newCharacter.weaknessesLabel}}:</label>
                                                    <textarea class="form-control" id="weaknesses" name="weaknesses" placeholder="{{translations.newCharacter.weaknessesPlaceholder}}"></textarea>
                                                </div>

                                                <!-- Fears -->
                                                <div class="col-12 col-sm-6 mb-3">
                                                    <label for="fears" class="form-label">{{translations.newCharacter.fearsLabel}}:</label>
                                                    <textarea class="form-control" id="fears" name="fears" placeholder="{{translations.newCharacter.fearsPlaceholder}}"></textarea>
                                                </div>

                                                <!-- Secrets -->
                                                <div class="col-12 col-sm-6 mb-3">
                                                    <label for="secrets" class="form-label">{{translations.newCharacter.secretsLabel}}:</label>
                                                    <textarea class="form-control" id="secrets" name="secrets" placeholder="{{translations.newCharacter.secretsPlaceholder}}"></textarea>
                                                </div>
                                        </div>
                                    </div>
                                </div>
                                </div>
                            </div>
                                                    
                            <!-- 4. Single Action Button -->
                            <div class="row mx-0">
                                <button type="button" id="generateButton" class="btn custom-gradient-bg btn-lg text-white">
                                    <i class="fas fa-magic me-2"></i>{{translations.newCharacter.generate_with_AI}}
                                </button>
                                <span class="w-100 text-center text-muted genexp" style="font-size: 12px;display:none;">{{translations.newCharacter.image_generation_message}}</span>
                            </div>

                        </div>
                    </div>

                    <!-- Right Column: Generated Image -->
                    <div class="col-lg-6 mb-4 d-flex flex-column align-items-center">
                        <!-- 3. Generated Image Display -->
                        <label class="form-label d-block mb-2 text-center">{{translations.newCharacter.generatedImageLabel}}</label>
                        <div id="imageContainer" class="row mb-4 w-100">
                            <img
                                id="generatedImage"
                                src="/img/default-character.png"
                                alt="{{translations.newCharacter.generatedImageAlt}}"
                                class="img-fluid rounded"
                                style="max-height: 300px; width: 100%; object-fit: contain;"
                            >
                        </div>
                        <div id="imageUploaderContainer" class="w-100" style="cursor: pointer;">
                            <!-- You can add an image uploader here if needed -->
                        </div>
                        <div class="row w-100 chatRedirection" style="display:none;">
                            <a type="button" id="redirectToChat" href="#" class="btn custom-gradient-bg  mt-3">{{translations.newCharacter.start_chat_and_image_generation}}</a>
                            <p class="text-center text-muted mt-2">{{translations.newCharacter.start_chat_and_image_generation_description}}</p>
                        </div>
                      
                    </div>
                </div> 
        </div>
    </div>
</div>

    <style>footer{display: inline !important;}</style>
 {{> dashboard-footer}}
<link type="text/css" rel="stylesheet" href="/css/image-uploader.css">
<script type="text/javascript" src="/js/image-uploader.js"></script>
<script type="text/javascript" src="/js/stability.js"></script>
<script>
    $(document).ready(function () {
        $('#characterDescriptionAccordion, #personalityAccordion').on('show.bs.collapse hide.bs.collapse', function (e) {
            const checkId = $(this).attr('id').replace('Accordion','Check')
            $('#' + checkId).prop('checked', e.type === 'show');
        });
        $('#enableEnhancedPrompt').on('click',function(){
            $('#enhancedPrompt').toggle()
        })
    });
    $(document).on('click', '.add-tag', function() {
        const tag = $(this).text();
        const $characterPrompt = $('#characterPrompt');
        const prompt = $characterPrompt.val();
        $characterPrompt.val(prompt + ',' + tag);
    });
</script>

<script>
    $(document).ready(function() {
        $('#language').val(lang)

        $('#characterPrompt').on('input change', function() {
            $('#enhancedPrompt').val('');
        });
        
        $(document).on('click', '.style-option', function () {
            if($(this).hasClass('is-premium')){
                showUpgradePopup('image-generation')
                return
            }
            $('.style-option').removeClass('selected');
            $(this).addClass('selected');
            updateFields($(this));
        });

        updateFields($(document).find('.style-option.selected'));

    });

    function updateFields(element) {
        const fields = ['id', 'style', 'model', 'version'];
        fields.forEach(field => {
            $(`#${field === 'id' ? 'modelId' : 'image' + field.charAt(0).toUpperCase() + field.slice(1)}`).val(element.data(field));
        });
    }
</script>
<script>
    
window.chatId = '{{chatId}}';
window.isTemporaryChat = '{{isTemporaryChat}}';

$(document).ready(function() {
    if (chatId) {
        $('#redirectToChat').attr('href', `/chat/${chatId}`);
    }
});

$(document).ready(function() {
        
    $('.dropdown-toggle').each(function(e) {
        new mdb.Dropdown($(this)[0]);
    });

    var count = 0
    const subscriptionStatus = user.subscriptionStatus == 'active'
    let isAutoGen = false

    if(subscriptionStatus){
        $('.is-premium').each(function(){$(this).toggleClass('d-none')})
    }else{
        function disableInputs(containerId) {
            $(containerId).find('input, select, textarea').each(function () {
                $(this).prop('disabled', true);
            });
        }
        disableInputs('#characterDescriptionAccordion');
        disableInputs('#personalityAccordion');
    }
    $('input, textarea').val('');

    const urlParams = new URLSearchParams(window.location.search);
    const chatImageUrl = urlParams.get('chatImage');
    if (chatImageUrl) {
        setTimeout(function(){
            $('#chatImageUrl').val(chatImageUrl).change();
        },500)
        $('#chatImage').attr('src', chatImageUrl).show().addClass('on');
    }

    if (isTemporaryChat == 'false') {
        fetchchatData(chatId);
    }

    $('textarea').each(function() {
        resizeTextarea(this);
        $(this).on('input change', function() {
            resizeTextarea(this);
        });
    });

    function resizeTextarea(element){
        if($(element).val().trim()!=''){
            element.style.height = 'auto';
            element.style.height = (element.scrollHeight) + 'px';  
        }else{
            element.style.height = 'auto'; 
        }
    }

     function fetchchatData(chatId, callback) {
            $.ajax({
                url: `/api/chat-data/${chatId}`,
                type: 'GET',
                dataType: 'json',
                success: function(chatData) {
                    console.log('Fetched chat data:', chatData);

                    // Populate Step 1: キャラクターの外見
                    if (chatData.modelId) {
                        $('#modelId').val(chatData.modelId);
                    }

                    if (chatData.imageStyle) {
                        $('#imageStyle').val(chatData.imageStyle);
                    }
                    if (chatData.imageModel) {
                        $('#imageModel').val(chatData.imageModel);
                    }
                    if (chatData.imageVersion) {
                        $('#imageVersion').val(chatData.imageVersion);
                    }

                    if (chatData.characterPrompt) {
                        $('#characterPrompt').val(chatData.characterPrompt);
                        resizeTextarea($('#characterPrompt')[0]);
                    }

                    if (chatData.enhancedPrompt && chatData.enhancedPrompt !== '') {
                        $('#enhancedPrompt').val(chatData.enhancedPrompt);
                    }

                    if (chatData.imageDescription) {
                      $('#enhancedPrompt').val(chatData.imageDescription);
                    }

                    if (chatData.chatImageUrl) {
                        $('#generatedImage').attr('src', chatData.chatImageUrl).show().addClass('on');
                    }

                    if (chatData.language) {
                        $('#language').val(chatData.language);
                    }

                    if (chatData.gender) {
                        $('#gender').val(chatData.gender);
                    }

                    if (chatData.purpose) {
                        $('#chatPurpose').val(chatData.purpose);
                        resizeTextarea($('#chatPurpose')[0]);
                    }

                    if (chatData.name) {
                        $('#chatName').val(chatData.name).show();
                        $('#sendForm span').text(`${chatData.name}とチャットする`);
                    }

                    if (chatData.description) {
                        $('#chatDescription').val(chatData.description).show();
                        resizeTextarea($('#chatDescription')[0]);
                    }

                    if (chatData.base_personality.story) {
                        $('#chatStory').val(chatData.base_personality.story).show();
                        resizeTextarea($('#chatStory')[0]);
                    }

                    // Callback if provided
                    if (typeof callback === 'function') {
                        callback();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching chat data:', error);
                    showNotification('チャットデータの取得に失敗しました。再試行してください。', 'error');
                }
            });
        }
      


        function saveModeration(moderationResult, chatId, callback){

            $.ajax({
            url: '/novita/save-moderation',
            method: 'POST',
            dataType: 'json',
            contentType: 'application/json',
            data: JSON.stringify({
            moderation: moderationResult,
            chatId
            }),
            success: function(response) {
            if (typeof callback === 'function') {
            callback(null, response);
            }
            },
            error: function(error) {
            if (typeof callback === 'function') {
            callback(error);
            }
            }
            });
        }
        // Save selected image model
        function saveSelectedImageModel(chatId, callback) {
            
            const modelId = $('.style-option.selected').data('id')
            const imageStyle = $('.style-option.selected').data('style')
            const imageModel = $('.style-option.selected').data('model')
            const imageVersion = $('.style-option.selected').data('version')

            $.ajax({
            url: '/novita/save-image-model',
            method: 'POST',
            dataType: 'json',
            data: {
                chatId,
                modelId,
                imageStyle,
                imageModel,
                imageVersion
            },
            success: function(response) {
                if (typeof callback === 'function') {
                callback(null, response);
                }
            },
            error: function(error) {
                if (typeof callback === 'function') {
                callback(error);
                }
            }
            });
        }
   
        function returnDetails(containerId) {
            const details = {};
            $(containerId).find('input, select, textarea').each(function () {
                const element = $(this), name = element.attr('name');
                if (name) {
                    let value = element.is(':checkbox') ? element.is(':checked')
                            : element.is(':radio') ? (element.is(':checked') ? element.val() : null)
                            : element.val()?.trim();
                    if (value !== null && value !== '') details[name] = value;
                }
            });
            return details;
        }

        function returnCharacterDetails() {
            return returnDetails('#characterDescriptionAccordion');
        }

        function returnCharacterPersonalityDetails() {
            return returnDetails('#personalityAccordion');
        }

        async function checkChat(chatId) {
            try {
                const response = await $.post('/api/check-chat', { chatId });
                if (response.message === 'Chat exists') {
                    return false;
                } else {
                    return response.chatId;
                }
            } catch (error) {
                console.error('Request failed:', error);
                throw error;
            }
        }
    window.moderateContent = async function(chatId, content) {
        try {
            const response = await $.ajax({
                url: '/novita/moderate',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ chatId, content })
            });
            return response.results[0];
        } catch (error) {
            console.error('Moderation request failed:', error);
            throw error;
        }
    }
    $('#generateButton').on('click', async function() {
        // Clear the container
        $('#imageContainer').empty();

        let newchatId = await checkChat(chatId)
        if(newchatId){
            window.chatId = newchatId
            $('#redirectToChat').attr('href', `/chat/${newchatId}`)
        }

        const prompt = characterPrompt = $('#characterPrompt').val().trim();
        const gender = $('#gender').val();
        let modelId = $('#modelId').val();

        if(!modelId){
            const initial_modelId = `{{modelId}}`
            if(initial_modelId){
                modelId = initial_modelId
                $(document).find(`.style-option[data-id=${initial_modelId}]`).click();
            }
        }

        await saveSelectedImageModel(chatId, function(error, response) {
            if (error) {
                console.error('Error saving image model:', error);
            }
        });

        if (!modelId || !prompt || !gender || !chatId) {
            showNotification(translations.newCharacter.allFieldsRequired, 'error');
            return;
        }

        const characterDetails = returnCharacterDetails();
        const isEnhanceEnabled = $('#enableEnhancedPrompt').is(':checked');

        const $button = $(this);
        $button.prop('disabled', true);

        // ボタンテキストを更新
        if(isEnhanceEnabled){
            $button.html(`<i class="fas fa-spinner fa-spin me-2"></i>${translations.newCharacter.enhancing_prompt}`);
        } else {
            $button.html(`<i class="fas fa-spinner fa-spin me-2"></i>${translations.imageForm.generatingImages}`);
        }

        $('#characterPrompt').prop('disabled', true);
        let moderationResult = {flagged: false};
        try {

            // Call moderation function on enhancedPrompt content
            moderationResult = await moderateContent(chatId,prompt);
            // Check if the content is NSFW
            if (moderationResult.flagged) {
                if (false && !subscriptionStatus) { // Allow user to generate NSFW prompt
                    showUpgradePopup('nsfw-prompt');
                    // Enable buttons and reset text
                    $button.prop('disabled', false);
                    $button.html('<i class="fas fa-magic me-2"></i>' + translations.newCharacter.generate_with_AI);
                    $('#characterPrompt').prop('disabled', false);
                    return
                }
            }

            let enhanceResponse = {enhancedPrompt:''}

            if(isEnhanceEnabled){
                if($('#enhancedPrompt').val().trim() != ''){
                    enhanceResponse.enhancedPrompt = $('#enhancedPrompt').val()
                }else{
                    let customData = {
                        prompt,
                        gender,
                        chatId,
                    };

                    if (subscriptionStatus && $('#characterDescriptionCheck').is(':checked')) {
                        customData.details_description = characterDetails;
                    }

                    customData = JSON.stringify(customData);

                    // プロンプトを強化するリクエスト
                    enhanceResponse = await $.ajax({
                        url: '/api/enhance-prompt',
                        method: 'POST',
                        contentType: 'application/json',
                        data: customData
                    });
                }

                if (enhanceResponse && enhanceResponse.enhancedPrompt) {
                    $('#enhancedPrompt').val(enhanceResponse.enhancedPrompt);
                } else {
                    $button.prop('disabled', false);
                    $button.html(`<i class="fas fa-magic me-2"></i>${translations.newCharacter.generate_with_AI}`);
                    $('#characterPrompt').prop('disabled', false);
                    return;
                }
            } else {
                // プロンプトをそのまま使用
                enhanceResponse.enhancedPrompt = prompt;
            }
						
			generateCharacterPersonnality();
            // ボタンテキストを「画像を生成中...」に更新
            $button.html(`<i class="fas fa-spinner fa-spin me-2"></i>${translations.imageForm.generatingImages}`);
            $('.genexp').fadeIn()

            const imageType = moderationResult.flagged ? 'nsfw' : 'sfw';
            txt2ImageNovita(userId, chatId, null, { prompt:enhanceResponse.enhancedPrompt, imageType, chatCreation: true})
            .catch((error) => {
                console.error('Error generating image:', error);
            })

        } catch (error) {
            console.error('Error:', error);
            $button.prop('disabled', false);
            $button.html('<i class="fas fa-magic me-2"></i>'+translations.newCharacter.generate_with_AI);
            $('#characterPrompt').prop('disabled', false);
        }
    });


        async function generateCharacterPersonnality(callback) {
            const personalityDetails = returnCharacterPersonalityDetails();        
            let name = $('#name').val()
            let prompt = $('#chatPurpose').val().trim() || $('#characterPrompt').val().trim();
            let gender = $('#gender').val()

            if(prompt.length == 0){
                return
            } 
            let customData = {
                prompt,
                name,
                gender,
                chatId,
            };

            if (subscriptionStatus && $('#personalityCheck').is(':checked')) {
                customData.details_personality = personalityDetails;
            }

            customData = JSON.stringify(customData);

            $.ajax({
                url: '/api/openai-chat-creation',
                method: 'POST',
                contentType: 'application/json',
                data: customData,
                success: function(response) {

                    $('#chatName').val(response.name);
                    $('#chatDescription').val(response.short_intro);
                    $('#chatStory').val(response.base_personality.story);


                    if (typeof callback === 'function') {
                        callback();
                    }
                },
                error: function(error) {
                    console.error('Error:', error);
                }
            });
        }
       
});
window.saveSelectedImage = function(imageUrl, callback) {
    $.ajax({
    url: '/novita/save-image',
    method: 'POST',
    dataType: 'json',
    data: {
        imageUrl,
        chatId
    },
    success: function(response) {
        if (typeof callback === 'function') {
        callback(null, response);
        }
    },
    error: function(error) {
        if (typeof callback === 'function') {
        callback(error);
        }
    }
    });
}
window.generateCharacterImage = function(url, nsfw) {
    // For each image URL, create an image element and append to the container
    const colDiv = $('<div>').addClass('col-12 col-md-6 mb-3');
    const imgElement = $('<img>')
        .attr('src', url)
        .addClass('img-fluid img-thumbnail')
        .css('cursor', 'pointer');

    // Add click handler to each image
    imgElement.on('click', function() {
        $('.img-thumbnail').each(function(){
        $(this).removeClass('select')
        });
        $(this).addClass('select');
        
        // Save the selected image
        saveSelectedImage(url,function(error, response){
        if (error) {
            showNotification(translations.imageForm.image_save_failed, 'error');
        } else {
            showNotification(translations.imageForm.image_saved, 'success');
        }
        });
    });

    colDiv.append(imgElement);
    $('#imageContainer').append(colDiv);
}

// After the image is generated, save the image and redirect to the chat
window.resetCharacterForm = function(){
    // Enable buttons and reset text
    $('.chatRedirection').show();
    $('#characterPrompt').prop('disabled', false);
    $('#generateButton').prop('disabled', false);
    $('#generateButton').html('<i class="fas fa-magic me-2"></i>'+translations.newCharacter.generate_with_AI);
}

window.updateCharacterGenerationMessage = function(message){
    $('.genexp').text(message)
}
</script>
</body>
</html>
