<!DOCTYPE html>
<html lang="{{lang}}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Model Chats Management - Admin</title>
  {{>dashboard-header}}
</head>
<body>
  {{>dashboard-nav}}
  
  <div class="container-fluid mt-4">
    <div class="row">
      <div class="col-12">
        <h2>Model Chats Management</h2>
        <p>Generate daily AI character chats for each model in your system.</p>
        
        <div class="card mb-4">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Cron Job Settings</h5>
            </div>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <form id="cronSettingsForm">
                  <div class="mb-3">
                    <label for="cronSchedule" class="form-label">Cron Schedule</label>
                    <input type="text" class="form-control" id="cronSchedule" value="{{cronSettings.schedule}}" placeholder="0 */2 * * *">
                    <div class="form-text">Format: minute hour day_of_month month day_of_week (e.g. "0 */2 * * *" for every 2 hours)</div>
                  </div>
                  <div class="mb-3">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="cronEnabled" {{#if cronSettings.enabled}}checked{{/if}}>
                      <label class="form-check-label" for="cronEnabled">Enable automatic generation</label>
                    </div>
                  </div>
                  <div class="mb-3">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="cronNsfw" {{#if cronSettings.nsfw}}checked{{/if}}>
                      <label class="form-check-label" for="cronNsfw">Include NSFW content</label>
                    </div>
                  </div>
                  <button type="submit" class="btn btn-primary">Save Settings</button>
                </form>
              </div>
              <div class="col-md-6">
                <div class="card">
                  <div class="card-body">
                    <h5 class="card-title">Schedule Information</h5>
                    <p><strong>Status:</strong> <span id="jobStatus" class="badge {{#if cronSettings.enabled}}bg-success{{else}}bg-danger{{/if}}">{{#if cronSettings.enabled}}Active{{else}}Inactive{{/if}}</span></p>
                    <p><strong>Next Run:</strong> <span id="nextRun">{{cronSettings.nextRun}}</span></p>
                    <p><strong>Last Run:</strong> <span id="lastRun">{{cronSettings.lastRun}}</span></p>
                    <p><strong>Content Type:</strong> <span id="contentType">{{#if cronSettings.nsfw}}NSFW Included{{else}}SFW Only{{/if}}</span></p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card mb-4">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Available Models</h5>
              <button id="generateAllChats" class="btn btn-primary">Generate All Model Chats</button>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Thumbnail</th>
                    <th>Model</th>
                    <th>Style</th>
                    <th>Version</th>
                    <th>Recent Chats</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {{#each models}} 
                    <tr>
                      <td>
                        <img src="{{image}}" alt="{{model}}" class="rounded-circle img-thumbnail" style="width: 60px;height:60px; object-fit: cover;">
                      </td>
                      <td>{{model}}</td>
                      <td>{{style}}</td>
                      <td>{{version}}</td>
                      <td>
                        <span class="badge {{#if hasRecentChat}}bg-success{{else}}bg-danger{{/if}}">
                          {{#if hasRecentChat}}Generated today{{else}}Not generated today{{/if}}
                        </span>
                        <span class="ms-2">{{chats.length}} recent chats</span>
                      </td>
                      <td>
                        <button class="btn btn-sm btn-outline-primary generate-chat-btn" 
                                data-model-id="{{modelId}}"
                                data-model-name="{{model}}">
                          Generate Chat
                        </button>
                      </td>
                    </tr>
                  {{/each}}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Recently Generated Chats</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Thumbnail</th>
                    <th>Character Name</th>
                    <th>Model</th>
                    <th>Created</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {{#each recentChats}}
                    <tr>
                      <td>
                        <img src="{{chatImageUrl}}" alt="{{model}}" class="rounded-circle img-thumbnail" style="width: 60px;height:60px; object-fit: cover;">
                      </td>
                      <td>{{name}}</td>
                      <td>{{imageModel}}</td>
                      <td>{{formatDate createdAt}}</td>
                      <td>
                        <a href="/chat/{{_id}}" class="btn btn-sm btn-outline-secondary" target="_blank">
                          View Chat
                        </a>
                      </td>
                    </tr>
                  {{/each}}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal for character generation preview -->
  <div class="modal fade" id="generateChatModal" tabindex="-1" aria-labelledby="generateChatModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg mx-0">
      <div class="modal-content mx-auto">
        <div class="modal-header">
          <h5 class="modal-title" id="generateChatModalLabel">Generating Chat</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body bg-light">
          <div class="text-center mb-3" id="modelInfo">
            <strong>Model:</strong> <span id="modelName"></span>
          </div>
          
          <div id="loadingPrompt" class="text-center">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p>Fetching prompt...</p>
          </div>
          
          <div id="promptPreview" class="d-none">
            <div class="row">
              <div class="col-md-6">
                <div class="card mb-3">
                  <img id="promptImage" src="" class="card-img-top" alt="Character preview">
                  <div class="card-body">
                    <h5 class="card-title">Preview</h5>
                    <p class="card-text"><small class="text-muted">Source: Civitai</small></p>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <h5>Prompt:</h5>
                <div class="border p-3 mb-3" style="max-height: 300px; overflow-y: auto;">
                  <p id="promptText"></p>
                </div>
                <h5>Negative Prompt:</h5>
                <div class="border p-3" style="max-height: 300px; overflow-y: auto;">
                  <p id="promptNegative"></p> 
                </div>
              </div>
            </div>
          </div>
          
          <div id="noPrompt" class="alert alert-warning d-none">
            No prompt available.
          </div>
          
          <div id="errorFetching" class="alert alert-danger d-none">
            Error fetching prompt.
          </div>
          
          <div id="generationResult" class="alert d-none">
            <p id="generationMessage"></p>
            <a id="viewCharacterLink" href="#" class="btn btn-primary d-none">
              View Character
            </a>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" id="generateBtn" class="btn btn-primary d-none">Generate</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading modal for generate all -->
  <div class="modal fade" id="loadingModal" tabindex="-1" aria-labelledby="loadingModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg mx-0">
      <div class="modal-content mx-auto">
        <div class="modal-body text-center py-5">
          <div class="spinner-border mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <h5>Generating chats for all models...</h5>
          <p>This may take several minutes. Please don't close this window.</p>
        </div>
      </div>
    </div>
  </div>
  
  {{>dashboard-footer}}
  
  <script>
    $(document).ready(function() {
      // Cron settings form submission
      $('#cronSettingsForm').on('submit', function(e) {
        e.preventDefault();
        
        const settings = {
          schedule: $('#cronSchedule').val(),
          enabled: $('#cronEnabled').is(':checked'),
          nsfw: $('#cronNsfw').is(':checked')
        };
        
        $.ajax({
          url: '/admin/model-chats/cron-settings',
          type: 'POST',
          data: settings,
          dataType: 'json',
          success: function(data) {
            if (data.success) {
              Swal.fire({
                title: 'Success!',
                text: 'Cron settings updated successfully.',
                icon: 'success',
                confirmButtonText: 'Great!'
              });
              
              // Update status display
              $('#jobStatus').removeClass('bg-success bg-danger')
                .addClass(settings.enabled ? 'bg-success' : 'bg-danger')
                .text(settings.enabled ? 'Active' : 'Inactive');
              
              $('#contentType').text(settings.nsfw ? 'NSFW Included' : 'SFW Only');
              $('#nextRun').text(data.nextRun || 'N/A');
              $('#lastRun').text(data.lastRun || 'N/A');
            } else {
              Swal.fire({
                title: 'Error!',
                text: data.error || 'Failed to update cron settings',
                icon: 'error',
                confirmButtonText: 'OK'
              });
            }
          },
          error: function(xhr) {
            Swal.fire({
              title: 'Error!',
              text: xhr.responseJSON?.error || 'An unknown error occurred',
              icon: 'error',
              confirmButtonText: 'OK'
            });
          }
        });
      });
      
      // Generate individual chat button click
      $('.generate-chat-btn').on('click', function() {
        const modelId = $(this).data('model-id');
        const modelName = $(this).data('model-name');
        let promptKey = null;
        
        // Ask about NSFW first
        Swal.fire({
          title: 'Include NSFW Content?',
          text: 'Do you want to include NSFW content in this chat?',
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Yes, include NSFW',
          cancelButtonText: 'No, SFW only'
        }).then((nsfwResult) => {
          const nsfw = nsfwResult.isConfirmed;
          
          // After NSFW choice, show modal and fetch preview
          $('#modelName').text(modelName);
          $('#loadingPrompt').removeClass('d-none');
          $('#promptPreview').addClass('d-none');
          $('#noPrompt').addClass('d-none');
          $('#errorFetching').addClass('d-none');
          $('#generationResult').addClass('d-none');
          $('#generateBtn').addClass('d-none');
          $('#viewCharacterLink').addClass('d-none');
          
          $('#generateChatModal').modal('show');
          
          // Fetch a preview prompt with NSFW parameter
          $.ajax({
            url: '/api/preview-prompt',
            type: 'POST',
            data: { modelId, modelName, nsfw },
            dataType: 'json',
            success: function(data) {
              $('#loadingPrompt').addClass('d-none');
              
              if (data.error) {
                $('#errorFetching').removeClass('d-none').text(data.error);
                return;
              }
              
              if (!data.prompt) {
                $('#noPrompt').removeClass('d-none');
                return;
              }
              
              // Store the promptKey for later use
              promptKey = data.promptKey;
              
              // Show prompt preview
              $('#promptPreview').removeClass('d-none');
              $('#promptImage').attr('src', data.prompt.imageUrl);
              $('#promptText').text(data.prompt.prompt);
              $('#promptNegative').text(data.prompt.negativePrompt);
              $('#generateBtn').removeClass('d-none')
                .data('model-id', modelId)
                .data('nsfw', nsfw)
                .data('prompt-key', promptKey); // Store the promptKey
            },
            error: function() {
              $('#loadingPrompt').addClass('d-none');
              $('#errorFetching').removeClass('d-none');
            }
          });
        });
      });
      
      // Generate button in modal click
      $('#generateBtn').on('click', function() {
        const modelId = $(this).data('model-id');
        const nsfw = $(this).data('nsfw');
        const promptKey = $(this).data('prompt-key');
        
        $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...');
        
        // Generate the chat using the same prompt as the preview
        $.ajax({
          url: '/admin/model-chats/generate',
          type: 'POST',
          data: { modelId, nsfw, promptKey },
          dataType: 'json',
          success: function(data) {
            $('#generateBtn').prop('disabled', false).text('Generate');
            
            if (data.error) {
              $('#generationResult').removeClass('d-none alert-success').addClass('alert-danger');
              $('#generationMessage').text(data.error);
              return;
            }
            
            if (data.success) {
              const chat = data.chat;
              $('#generationResult').removeClass('d-none alert-danger').addClass('alert-success');
              $('#generationMessage').text('Character generated successfully!');
              
              if (chat && chat._id) {
                $('#viewCharacterLink').removeClass('d-none').attr('href', '/chat/' + chat._id);
              }
              
              // Reload the page after a delay to show the new chat
              setTimeout(function() {
                location.reload();
              }, 3000);
            } else {
              $('#generationResult').removeClass('d-none alert-success').addClass('alert-danger');
              $('#generationMessage').text('Failed to generate character.');
            }
          },
          error: function(xhr) {
            $('#generateBtn').prop('disabled', false).text('Generate');
            $('#generationResult').removeClass('d-none alert-success').addClass('alert-danger');
            $('#generationMessage').text(xhr.responseJSON?.error || 'An unknown error occurred');
          }
        });
      });
      
      // Generate all chats button click
      $('#generateAllChats').on('click', function() {
        Swal.fire({
          title: 'Generate All Model Chats?',
          text: 'This will generate chats for all models and may take some time.',
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Yes, generate all',
          cancelButtonText: 'Cancel'
        }).then((result) => {
          if (result.isConfirmed) {
            // Ask user about NSFW setting first
            Swal.fire({
              title: 'Include NSFW Content?',
              text: 'Do you want to include NSFW content in generated chats?',
              icon: 'question',
              showCancelButton: true,
              confirmButtonText: 'Yes, include NSFW',
              cancelButtonText: 'No, SFW only'
            }).then((nsfwResult) => {
              const nsfw = nsfwResult.isConfirmed;
              
              // Show loading indicator
              $('#loadingModal').modal('show');
              
              $.ajax({
                url: '/admin/model-chats/generate',
                type: 'POST',
                data: { nsfw },
                dataType: 'json',
                success: function(data) {
                  $('#loadingModal').modal('hide');
                  
                  if (data.success) {
                    const successes = data.results.filter(r => r.status === 'success').length;
                    const failures = data.results.filter(r => r.status !== 'success').length;
                    
                    Swal.fire({
                      title: 'Generation Complete',
                      text: `Successfully generated ${successes} chats. Failed: ${failures}.`,
                      icon: 'success',
                      confirmButtonText: 'Great!'
                    }).then(() => {
                      location.reload();
                    });
                  } else {
                    Swal.fire({
                      title: 'Error!',
                      text: data.error || 'Failed to generate chats',
                      icon: 'error',
                      confirmButtonText: 'OK'
                    });
                  }
                },
                error: function(xhr) {
                  $('#loadingModal').modal('hide');
                  
                  Swal.fire({
                    title: 'Error!',
                    text: xhr.responseJSON?.error || 'An unknown error occurred',
                    icon: 'error',
                    confirmButtonText: 'OK'
                  });
                }
              });
            });
          }
        });
      });
    });
  </script>
</body>
</html>