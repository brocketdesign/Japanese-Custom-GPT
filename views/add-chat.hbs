<!DOCTYPE html>
<html lang="ja">
   {{> dashboard-header}}
<body>
    {{> dashboard-nav}}

    <style>
    .style-option {
        width: 75px;
        cursor:pointer;
    }
    .style-option.selected {
        border: 2px solid #000;
    }
    .animated.fadeInDown .swal2-image{
        margin:0;
    }
    .animated.fadeInDown .swal2-close{
        border:0;
    }
    /* Custom animation for sliding in from the bottom */
    .swal2-bottom-slide-in {
        animation: bottom-slide-in 0.5s;
    }

    .swal2-bottom-slide-out {
        animation: bottom-slide-out 0.5s;
    }

    @keyframes bottom-slide-in {
        0% {
            transform: translateY(100%);
            opacity: 0;
        }
        100% {
            transform: translateY(0);
            opacity: 1;
        }
    }

    @keyframes bottom-slide-out {
        0% {
            transform: translateY(0);
            opacity: 1;
        }
        100% {
            transform: translateY(100%);
            opacity: 0;
        }
    }
    .custom-gradient-bg {
        background: linear-gradient(90.9deg, #D2B8FF 2.74%, #8240FF 102.92%);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        transition: color 0.3s ease-in-out;
    }

    .custom-gradient-bg::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 300%;
        height: 300%;
        background: radial-gradient(circle, rgba(255,255,255,0.5) 0%, rgba(255,255,255,0) 80%);
        transform: translate(-50%, -50%) scale(0);
        transition: transform 0.5s ease-in-out;
        z-index: 0;
    }

    .custom-gradient-bg:hover::before {
        transform: translate(-50%, -50%) scale(1);
    }

    .custom-gradient-bg:hover {
        color: #fff;
    }
    #chatImage{
        width: 100px;
        height: 100px; 
        object-fit:cover;
        object-position:top;
    }
    #chatImage.on{
        width: auto !important;
        height: 270px !important;
    }
    .btn-gradient-radius {
        display: inline-block;
        padding: 7px 20px;
        border-radius: 25px;
        text-decoration: none;
        color: #FFF;
        background-image: linear-gradient(45deg, #FFC107 0%, #ff8b5f 100%);
        transition: .4s;
        font-size: 21px;
    }
    label{
        font-size: 14px;
        color: #aaaaaa;
    }
    #sendMessage,
    #chatInput .load {
        border-left: 0 !important;
        border-radius: 0px 30px 30px 0px !important;
        box-shadow: none;
    }
    #userMessage {
        border-radius: 30px 0px 0px 30px !important;
        background-color: #f8f9fa;
    }
    #userMessage:focus {
        outline: none;
        box-shadow: none; /* If there is a box shadow applied on focus */
    }
    .button-group{
        top:0;
        right: 15px;
    }
    .scroll-container {
      display: flex;
      flex-wrap: nowrap;
      overflow-x: auto;
    }
    .scroll-container > * {
      flex: 0 0 auto;
      width: auto;
    }
    .card-text.template{
        font-size: 12px;
    }
    /*Custom css*/
    label{
        font-size: 12px;
        color: #8d8b8b;
    }
    .avatar-xl img {
        width: 110px;
    }
    .rounded-circle {
        border-radius: 50%;
    }
    .rounded-circle.on {
        border-radius: 15px !important;
    }
    img {
        vertical-align: middle;
        border-style: none;
    }
    .text-muted {
        color: #aeb0b4 !important;
    }
    .text-muted {
        font-weight: 300;
    }
    .form-control {
        display: block;
        width: 100%;
        height: calc(1.5em + 0.75rem + 2px);
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        font-weight: 400;
        line-height: 1.5;
        color: #4d5154;
        background-color: #ffffff;
        background-clip: padding-box;
        border: 1px solid #eef0f3;
        border-radius: 0.25rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    #markdownContainer {
        margin-bottom: 20px;
        padding: 20px;
        border: 1px solid #eef0f3;
        border-radius: 4px;
    }
    .auto-gen{
        font-size: 10px;
        border-radius: 50px;
    }
    </style>

{{#if user.isTemporary}}
    <section>
        <div id="intro" class="bg-image shadow-1-strong">
            <div style="background-image:url(/img/pc_lg02_rotate.jpg);">
                <div class="container row align-items-center h-100 m-auto">
                    <div class="col-12 col-md-6 py-5 text-dark" data-animate="animate__slideInLeft">
                        <h1 class="mb-3 fw-bold text-dark text-start" id="headline-container" > 
                            <p class="u-color-grad" style="font-size: 54px;"><img src="/img/logo.webp" alt="" class="me-2" width="40px">Lamix</p>
                            <p>画像生成：文字から理想のAI美女をカンタン生成</p>
                        </h1>
                            <p class="generate-text" id="headline"></p>
                        <div class="text-start">
                            簡単な手順でテキストまたは画像からAI美女を生成します。
                        </div>
                        <div class="text-center d-flex flex-column justify-content-start align-items-start mt-3">
                            <a href="/authenticate" class="btn custom-gradient-bg text-white btn-lg m-2 px-5 py-3 mb-3 cta-button" role="button" style="border-radius: 50px;">
                                AI美女を生成
                            </a>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6" data-animate="animate__slideInRight">
                        <div class="container p-3 text-center">
                            <img src="/img/lp-b-1.png" class="rounded" style="width:100%;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <section class="container">
        <style>
            .before-after--section-step-container {
                position: relative;
            }.before-after--section-symbol {
            position: absolute;
            left: 29px;
            top: 65px;
            width: 100px;
            height: 2px;
            -webkit-transform: rotate(-50deg);
            transform: rotate(-50deg);
            background-color: #212529;
            }.before-after--section-step {
            font-weight: 700;
            font-size: 22px;
            line-height: 26px;
            }
            .before-after--section-symbol {
            left: 8px;
            top: 25px;
            width: 42px;
            height: 1px;
            }.before-after--section-total-step {
                display: none;
            font-size: 14px;
            line-height: 16px;
            margin-left: 35px;
            }
        </style>
        <div class="row mt-3">
            <div class="col-auto my-3">
                <div class="before-after--section-step-container">
                    <div style="display: flex;">
                        <div class="before-after--section-step u-color-grad">01</div>
                    </div>
                    <div class="before-after--section-symbol"></div>
                    <div class="before-after--section-total-step">05</div>
                </div>
            </div>
            <div class="col-auto">
                <h2 class="display-4 fw-bold">文字からAI美女の作成</h2>
                <p>テキストを入力するだけで簡単に理想のAI美女や美少女を作成。リアルな美女からアニメ風の美女まで、年齢、髪型、肌の色、服装など、あらゆるAI美女を作りあげることができます。</p>
            </div>
        </div>
    </section>
{{/if}}
<div class="container rounded shadow p-3 my-4 px-0">
    <h4 class="container mb-4 text-center stepTitle">{{translations.newCharacter.characterCreationForm}}</h4>
    
    <!-- ステップの進行状況を表示 -->
    <div class="progress mb-4 mx-3">
        <div class="progress-bar" role="progressbar" style="width: 50%;background-color: #6c757d;" id="progressBar">
            {{translations.newCharacter.stepProgress}} 1/2 <!-- e.g., "Step 1/3" -->
        </div>
    </div>
    <!-- 1. キャラクター画像 -->
    <div id="step1" class="step">
            <!-- Character Creation Form -->
            <div id="characterCreationForm" class="container mt-3">
                
                <div class="row">
                    <!-- Left Column: Prompts and Button -->
                    <div class="col-lg-6 mb-4">
                        <div class="row mb-4">
                            <!-- Image Style Selection -->
                            <div class="col-auto">
                                <label class="form-label">画像スタイル</label>
                                <div id="imageStyleSelection">
                                    <img src="/img/anime.jpeg" alt="アニメ" class="style-option rounded selected" data-value="anime">
                                    <img src="/img/real.jpeg" alt="リアリスティック" class="style-option rounded" data-value="realistic">
                                </div>
                                <input type="hidden" id="imageStyle" name="imageStyle" value="anime">
                            </div>
                            <div class="d-none col-auto">
                                <label for="gender" class="form-label"><i class="fas fa-user"></i> {{translations.newCharacter.genderLabel}}:</label>
                                <select class="form-select w-auto" id="gender" name="gender">
                                    <option value="female" selected>{{translations.newCharacter.female}}</option>
                                    <option value="male">{{translations.newCharacter.male}}</option>
                                </select>
                            </div>
                        </div>
                        <!-- 1. Character Prompt Input -->
                        <div class="mb-4">
                            <label for="characterPrompt" class="form-label">キャラクタープロンプト</label>
                            <textarea
                                class="form-control"
                                id="characterPrompt"
                                name="characterPrompt"
                                rows="4"
                                maxlength="500"
                                placeholder="キャラクターの外見や表情・ポーズを詳細に説明してください。"
                            ></textarea>
                        </div>
                        
                        <!-- 2. Enhanced Prompt Display -->
                        <div class="mb-4 d-none">
                            <label for="enhancedPrompt" class="form-label">AI強化プロンプト</label>
                            <textarea
                                class="form-control"
                                id="enhancedPrompt"
                                name="enhancedPrompt"
                                rows="3"
                                readonly
                                placeholder="AIによって強化されたプロンプトがここに表示されます..."
                            ></textarea>
                        </div>
                        
                        <!-- 4. Single Action Button -->
                        <div class="d-grid">
                            <button type="button" id="generateButton" class="btn custom-gradient-bg btn-lg text-white">
                                <i class="fas fa-magic me-2"></i>AIで生成
                            </button>
                        </div>
                    </div>
                <!-- Right Column: Generated Image -->
                <div class="col-lg-6 mb-4 d-flex flex-column align-items-center">
                    <!-- 3. Generated Image Display -->
                    <label class="form-label d-block mb-2 text-center">{{translations.newCharacter.generatedImageLabel}}</label>
                    <div id="imageContainer" class="row mb-4 w-100">
                        <img
                            id="generatedImage"
                            src="/img/default-character.png"
                            alt="{{translations.newCharacter.generatedImageAlt}}"
                            class="img-fluid rounded"
                            style="max-height: 300px; width: 100%; object-fit: contain;"
                        >
                    </div>
                    <div id="imageUploaderContainer" class="w-100" style="cursor: pointer;">
                        <!-- You can add an image uploader here if needed -->
                    </div>
                </div>
            </div>
            <button type="button" id="nextStep1" class="btn btn-secondary w-100 nextStep">
                {{translations.newCharacter.nextStep}}
            </button>
        </div>
    </div>

    <!-- 2. キャラクターの性格 -->
    <div id="step2" class="step d-none">
        <div class="mb-3 mx-3 row justify-content-between">
            <div class="d-none col-auto ps-0">
                <label for="visibility" class="form-label"><i class="fas fa-eye"></i> {{translations.newCharacter.visibilityLabel}}:</label>
                <select class="form-select w-auto" id="visibility" name="visibility">
                    <option value="public" selected>{{translations.newCharacter.public}}</option>
                    <option value="private">{{translations.newCharacter.private}}</option>
                </select>
            </div>
            <div class="d-none col-auto">
                <label for="language" class="form-label"><i class="fas fa-language"></i> {{translations.newCharacter.languageLabel}}:</label>
                <select class="form-select w-auto" id="language" name="language">
                    <option value="japanese" selected><i class="fas fa-flag"></i> {{translations.newCharacter.japanese}}</option>
                    <option value="english"><i class="fas fa-flag"></i> {{translations.newCharacter.english}}</option>
                </select>
            </div>
        </div>

        <div id="chatPurpose-container" class="mb-3 mx-3">
            <div class="d-flex justify-content-between">
                <label for="chatPurpose" class="form-label">{{translations.newCharacter.characterDetailsLabel}}</label>
            </div>
            <textarea class="form-control mb-2" id="chatPurpose" name="content" rows="3" placeholder="{{translations.newCharacter.characterDetailsPlaceholder}}"></textarea>

            <input type="text" class="form-control mb-2" id="chatName" name="chatName" placeholder="{{translations.newCharacter.namePlaceholder}}" contenteditable="false" disabled="true" required style="display:none;">
            <textarea class="form-control mb-2" id="chatDescription" style="display:none;" name="chatDescription" rows="3" placeholder="{{translations.newCharacter.descriptionPlaceholder}}" disabled="true" required></textarea>
            <textarea class="d-none form-control" id="chatRule" name="content" rows="5" placeholder="{{translations.newCharacter.speechStylePlaceholder}}" disabled="true" hidden></textarea>

            <div id="markdownContainer" class="border-0 py-2 px-3 text-start mb-2" style="font-size:15px;background-color: #e9ecef;color: #575a5d; display:none;" contenteditable="false">
                {{translations.newCharacter.markdownInfo}}
            </div>
       
            <button type="button" id="ai-assist" class="btn btn-lg custom-gradient-bg shadow-0 mb-2 w-100">
                <i class="fa fa-spinner fa-spin fa-fw fa-hidden me-2" style="display: none;"></i>
                <i class="fa fa-magic me-2"></i>{{translations.newCharacter.generateWithAI}}
            </button>

            <button type="button" id="prevStep2" class="btn btn-secondary w-100 mb-2 prevStep">
                {{translations.newCharacter.back}}
            </button>
            <button type="submit" id="submitForm" class="btn custom-gradient-bg btn-large w-100">
                {{translations.newCharacter.complete}}
            </button>     
        </div>
    </div>
</div>
{{#if user.isTemporary}}
    <section class="container">
        <div class="container row align-items-center h-100 m-auto">
            <div class="col-12 col-md-6 py-5 text-dark" data-animate="animate__slideInLeft">
                <div class="row mt-3">
                    <div class="col-auto my-3">
                        <div class="before-after--section-step-container">
                            <div style="display: flex;">
                                <div class="before-after--section-step u-color-grad">02</div>
                            </div>
                            <div class="before-after--section-symbol"></div>
                            <div class="before-after--section-total-step">05</div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <h2 class="display-4 fw-bold">AI美女とチャット</h2>
                        <p>AIの美しい女性と会話しながら、さまざまな場面で画像生成を楽しめる！もしかして恋しちゃうかも？</p>
                        <div class="text-center d-flex flex-column justify-content-start align-items-start mt-3">
                            <a href="/authenticate" class="btn custom-gradient-bg text-white btn-lg m-2 px-5 py-3 mb-3 cta-button" role="button" style="border-radius: 50px;">
                                AI美女とチャットする
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6" data-animate="animate__slideInRight">
                <div class="container p-3 text-center">
                    <img src="/img/lp-b-2.png" class="rounded" style="width:100%;">
                </div>
            </div>
        </div>
    </section>
    <section class=" bg-light ">
        <div class="container my-4 py-5">
            <h2 class="display-4 fw-bold text-center mb-3">LAMIXに関するよくある質問</h2>
            <div class="accordion" id="faqAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingOne">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                            AI美女の作り方は？
                        </button>
                    </h2>
                    <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            <p>1.「AI美女を生成」ボタンを押す。</p>
                            <p>2. あなたが思い描いているAI美女の説明やプロンプトを入力する。</p>
                            <p>3. AI美女のスタイルを選び、"生成"を押す。</p>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingTwo">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                            AI美女は無料で作れますか？
                        </button>
                    </h2>
                    <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            <p>はい、メンバー無料登録をするとクレジット（ポイント）が付与されるので、お持ちのクレジット内でAI美女を無料で作ることが出来ます。</p>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingThree">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                            AI美女とは何ですか？
                        </button>
                    </h2>
                    <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            <p>AIが生成した美しい女性の画像を指します。AI技術を用いて生成された人工的な女性のイメージや、AIが学習した美の基準に基づいて作られた女性の顔の画像を指すことが一般的です。</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
{{/if}}
    <style>footer{display: inline !important;}</style>
 {{> dashboard-footer}}
<link type="text/css" rel="stylesheet" href="/css/image-uploader.css">
<script type="text/javascript" src="/js/image-uploader.js"></script>
<script type="text/javascript" src="/js/stability.js"></script>

<script>
    $(document).ready(function() {
        let currentStep = 1;
        let translations = window.translations

        function showStep(step) {
            $('.step').addClass('d-none');
            $('#step' + step).removeClass('d-none');
            $('#progressBar')
            .css('width', (step * 50) + '%')
            .text(translations.newCharacter.stepProgress + step + '/2');
            $('.stepTitle').text(step===1?translations.newCharacter.characterCreationForm:translations.newCharacter.characterPersonalityTitle)

        }

        function validateStep(step) {
            if (step === 1) {
                return $('.img-thumbnail.select').length > 0 || $('#generatedImage').attr('src').length > 0 && $('#enhancedPrompt').val().trim() != '';
            } else if (step === 2) {
                return $('#chatPurpose').val().trim() !== '' && $('#chatName').val().trim() !== '' && $('#chatDescription').val().trim() !== '' && $('#chatRule').val().trim() !== '';
            }
            return true;
        }

        $('.nextStep').click(function() {
            if (validateStep(currentStep)) {
                currentStep++;
                showStep(currentStep);
            } else {
                showNotification(translations.newCharacter.allFieldsRequired, 'error');
            }
        });

        $('.prevStep').click(function() {
            currentStep--;
            showStep(currentStep);
        });

        showStep(currentStep);
    });
    $(document).ready(function() {
        $('#characterPrompt').on('input change', function() {
            $('#enhancedPrompt').val('');
        });
    });

    $('.style-option').click(function(){
        $('.style-option').removeClass('selected');
        $(this).addClass('selected');
        $('#imageStyle').val($(this).data('value'));
    });
        
    $('#imageStyle').val($('.style-option.selected').data('value'));
</script>
<script>
    
    // Store modified galleries
    const modifiedGalleries = new Set();
    $(document).ready(function() {
        let translations = window.translations
        $('.dropdown-toggle').each(function(e) {
            new mdb.Dropdown($(this)[0]);
        });
        var count = 0
        let chatId = '{{chatId}}';
        const isTemporaryChat = '{{isTemporaryChat}}'
        const user = {{{json user}}}
        const subscriptionStatus = user.subscriptionStatus == 'active'
        let isAutoGen = false
        if(subscriptionStatus){
            $('.is-premium').each(function(){$(this).toggleClass('d-none')})
        }
        $('input, textarea').val('');
        $('#resetForm').on('click',function(){
            $('input, textarea').val('');
            $('input, textarea').prop('disabled', false);
            $('#chatName').hide()
            $('#chatDescription').hide()
            $('#chatPurpose').show()
            $('#chatPurpose-markdownContainer').hide()
            $('#markdownContainer').hide()
            $('#chatPurpose-markdownContainer').html('')
            $('#markdownContainer').html('')
            $('#sendForm').hide()
            $('#sendForm span').html(translations.newCharacter.startChatting)
        })

        const urlParams = new URLSearchParams(window.location.search);
        const chatImageUrl = urlParams.get('chatImage');
        if (chatImageUrl) {
            setTimeout(function(){
                $('#chatImageUrl').val(chatImageUrl).change();
            },500)
            $('#chatImage').attr('src', chatImageUrl).show().addClass('on');
        }

        function checkFieldsAndShowForm() {
            if ($('#chatName').val().trim() !== '' && 
                $('#chatDescription').val().trim() !== '' && 
                $('#chatPurpose').val().trim() !== '') {
                $('#sendForm').show();
            } else {
                $('#sendForm').hide();
            }
        }
        $('#chatName, #chatDescription, #chatPurpose').on('input', checkFieldsAndShowForm);

            if (isTemporaryChat == 'false') {
                fetchchatData(chatId,function(){
                    function observeGalleryChanges(galleryIndex) {
                        const galleryElement = document.querySelector(`#imageGallery-${galleryIndex}`);
                        if (!galleryElement) return;

                        const observer = new MutationObserver(function(mutationsList, observer) {
                            modifiedGalleries.add(galleryIndex);
                        });

                        observer.observe(galleryElement, { childList: true, subtree: true });
                    }

                    $('#galleries .imageGalleryWrapper').each(function(index) {
                        observeGalleryChanges(index);
                    });
                });
            }

            $('textarea').each(function() {
                resizeTextarea(this);
                $(this).on('input change', function() {
                    resizeTextarea(this);
                });
            });

        $('#visibility').val('public')
        $('#visibility').change(function() {
            
            const user = {{{json user}}}
            const userId = user._id
            if(!user){
                fetchUser(function(error, user){
                    user = localStorage.setItem('user',JSON.stringify(user))
                    if(user.subscriptionStatus == 'active'){
                        return
                    }else{
                        if ($(this).val() === 'private') {
                            showUpgradePopup('chat-private');
                            $(this).val('public');
                        }
                    }
                })
            }
            if(user.subscriptionStatus == 'active'){
                return
            }else{
                if ($(this).val() === 'private') {
                    showUpgradePopup('chat-private');
                    $(this).val('public');
                }
            }
        });

        function resizeTextarea(element){
            if($(element).val().trim()!=''){
                element.style.height = 'auto';
                element.style.height = (element.scrollHeight) + 'px';  
            }else{
                element.style.height = 'auto'; 
            }
        }

        $(document).on('click', '.resetGallery', function() {

            const galleryWrapper = $(this).closest('.imageGalleryWrapper');
            const galleryIndex = galleryWrapper.index(); 

            galleryWrapper.find('input[type="text"]').val('');
            galleryWrapper.find('textarea').val('');

            const galleryId = galleryWrapper.find('div[id^="imageGallery-"]').attr('id');
            const uploader = $(`#${galleryId}`).data('imageUploader'); 
            
            if (uploader) {
                uploader.reset();
            }

            $.ajax({
                url: '/api/reset-gallery',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ chatId, galleryIndex }),
                success: function(response) {
                    showNotification('ギャラリーがリセットされました。', 'success');
                },
                error: function(error) {
                    console.error('ギャラリーリセットエラー:', error);
                    showNotification('ギャラリーのリセットに失敗しました。', 'error');
                }
            });
        });
        function fetchchatData(chatId, callback) {
            $.ajax({
                url: `/api/chat-data/${chatId}`,
                type: 'GET',
                dataType: 'json',
                success: function(chatData) {
                    console.log('Fetched chat data:', chatData);

                    // Populate Step 1: キャラクターの外見
                    if (chatData.imageStyle) {
                        $('#imageStyle').val(chatData.imageStyle);
                    }

                    if (chatData.characterPrompt) {
                        $('#characterPrompt').val(chatData.characterPrompt);
                        resizeTextarea($('#characterPrompt')[0]);
                    }

                    if (chatData.imageDescription) {
                      $('#enhancedPrompt').val(chatData.imageDescription);
                    }

                    if (chatData.chatImageUrl) {
                        $('#generatedImage').attr('src', chatData.chatImageUrl).show().addClass('on');
                    }

                    // Populate Step 2: キャラクターの性格
                    if (chatData.visibility) {
                        $('#visibility').val(chatData.visibility);
                    }

                    if (chatData.language) {
                        $('#language').val(chatData.language);
                    }

                    if (chatData.gender) {
                        $('#gender').val(chatData.gender);
                    }

                    if (chatData.purpose) {
                        $('#chatPurpose').val(chatData.purpose);
                        resizeTextarea($('#chatPurpose')[0]);
                    }

                    if (chatData.name) {
                        $('#chatName').val(chatData.name).show();
                        $('#sendForm span').text(`${chatData.name}とチャットする`);
                    }

                    if (chatData.description) {
                        $('#chatDescription').val(chatData.description).show();
                        resizeTextarea($('#chatDescription')[0]);
                    }

                    if (chatData.rule) {
                        $('#chatRule').val(chatData.rule);
                        $('#markdownContainer').html(marked.parse(chatData.rule)).show();
                    }

                    // Callback if provided
                    if (typeof callback === 'function') {
                        callback();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching chat data:', error);
                    showNotification('チャットデータの取得に失敗しました。再試行してください。', 'error');
                }
            });
        }

        /*
        $('#imageUploaderContainer').imageUploader({
            maxSize: 2 * 1024 * 1024, // 2MB
            maxFiles: 1
        });
        */

        // Form Submission
        $('#submitForm').on('click', function(e) {
            e.preventDefault();
            $('#sendForm .fa-spinner').toggleClass('d-none');

            const formData = new FormData();
            formData.append('imageStyle', $('#imageStyle').val());
            formData.append('name', $('#chatName').val());
            formData.append('purpose', $('#chatPurpose').val());
            formData.append('language', $('#language').val());
            formData.append('gender', $('#gender').val());
            formData.append('description', $('#chatDescription').val());
            formData.append('rule', $('#chatRule').val());
            formData.append('visibility', $('#visibility').val());
            formData.append('isAutoGen', isAutoGen);

            if (chatId) {
                formData.append('chatId', chatId);
            }
            
            $.ajax({
                url: '/api/add-chat',
                type: 'POST',
                processData: false,
                contentType: false,
                data: formData,
                success: function(response) {
                    console.log('Success:', response);
                    $('#sendForm .fa-spinner').toggleClass('d-none');
                    const { chatId } = response;
                    window.location = '/chat/' + chatId;
                },
                error: function(error) {
                    console.log('Error:', error);
                    $('#sendForm .fa-spinner').toggleClass('d-none');
                    Swal.fire(
                        'エラー!',
                        'チャットの追加に失敗しました: ' + error.responseJSON.error,
                        'error'
                    );
                }
            });
        });
        
      
        function fetchTaskId(enhancedPrompt, aspectRatio, chatId, imageStyle) {
            return $.ajax({
                url: '/novita/generate-image',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    prompt: enhancedPrompt,
                    aspectRatio: aspectRatio,
                    chatId: chatId,
                    imageStyle: imageStyle
                })
            });
        }

        function saveSelectedImage(imageUrl) {
            const chatId = '{{chatId}}'; // Replace with actual chat ID

            $.ajax({
                url: '/novita/save-image',
                method: 'POST',
                dataType: 'json',
                data: {
                    imageUrl: imageUrl,
                    chatId: chatId
                },
                success: function(response) {
                    showNotification('画像が保存されました。', 'success');
                },
                error: function(error) {
                    showNotification('画像の保存に失敗しました。', 'error');
                }
            });
        }

        function displayGeneratedImages(imageUrls) {
            // Clear the container
            $('#imageContainer').empty();

            // For each image URL, create an image element and append to the container
            imageUrls.forEach(function(data) {
                const url = data.imageUrl
                const colDiv = $('<div>').addClass('col-12 col-md-6 mb-3');
                const imgElement = $('<img>')
                    .attr('src', url)
                    .addClass('img-fluid img-thumbnail')
                    .css('cursor', 'pointer');

                // Add click handler to each image
                imgElement.on('click', function() {
                    $('.img-thumbnail').each(function(){
                        $(this).removeClass('select')
                    })
                    $(this).addClass('select')
                    
                    // Save the selected image (you can implement this function)
                    saveSelectedImage(url);
                });

                colDiv.append(imgElement);
                $('#imageContainer').append(colDiv);
            });
        }

        function checkTaskStatus(taskId) {
            const POLLING_INTERVAL = 10000; // 3 seconds
            const MAX_ATTEMPTS = 30; // up to 90 seconds
            let attempts = 0;

            const intervalId = setInterval(async () => {
                attempts++;
                try {
                    const statusResponse = await $.ajax({
                        url: `/novita/chat-thumb-task-status/${taskId}`,
                        method: 'GET',
                        dataType: 'json'
                    });

                    if (statusResponse.status === 'completed') {
                        clearInterval(intervalId);
                        const { imageUrls } = statusResponse.result;

                        displayGeneratedImages(imageUrls)

                        showNotification('画像が正常に生成されました。', 'success');
                        // Enable buttons and reset text
                        $('#characterPrompt').prop('disabled', false);
                        $('#generateButton').prop('disabled', false);
                        $('#generateButton').html('<i class="fas fa-magic me-2"></i>AIで画像生成');

                    } else if (statusResponse.status === 'failed') {
                        clearInterval(intervalId);
                        $('#imageContainer').empty();
                        showNotification(`画像の生成に失敗しました: ${statusResponse.error}`, 'error');
                        // Enable buttons and reset text
                        $('#characterPrompt').prop('disabled', false);
                        $('#generateButton').prop('disabled', false);
                        $('#generateButton').html('<i class="fas fa-magic me-2"></i>AIで画像生成');
                    } else {
                        console.log('タスクはまだ処理中です...');
                    }

                    if (attempts >= MAX_ATTEMPTS) {
                        clearInterval(intervalId);
                        $('#imageContainer').empty();
                        showNotification('画像の生成がタイムアウトしました。再試行してください。', 'error');
                        // Enable buttons and reset text
                        $('#characterPrompt').prop('disabled', false);
                        $('#generateButton').prop('disabled', false);
                        $('#generateButton').html('<i class="fas fa-magic me-2"></i>AIで画像生成');
                    }

                } catch (error) {
                    console.error('タスクステータスポーリングエラー:', error);
                    clearInterval(intervalId);
                    $('#imageContainer').empty();
                    showNotification('画像の生成中にエラーが発生しました。', 'error');
                    // Enable buttons and reset text
                    $('#characterPrompt').prop('disabled', false);
                    $('#generateButton').prop('disabled', false);
                    $('#generateButton').html('<i class="fas fa-magic me-2"></i>AIで画像生成');
                }
            }, POLLING_INTERVAL);
        }
        function checkImg2ImgTaskStatus(taskId) {
            const POLLING_INTERVAL = 10000; // 3 seconds
            const MAX_ATTEMPTS = 30;
            let attempts = 0;

            const intervalId = setInterval(async () => {
                attempts++;
                try {
                    const statusResponse = await $.ajax({
                        url: `/novita/img2img-task-status/${taskId}`,
                        method: 'GET',
                        dataType: 'json'
                    });

                    if (statusResponse.status === 'completed') {
                        clearInterval(intervalId);
                        const { imageUrls } = statusResponse.result;

                        // Display the generated images for selection
                        displayGeneratedImages(imageUrls);

                        showNotification('画像が正常に生成されました。', 'success');
                        $('#characterPrompt').prop('disabled', false);
                        $('#generateButton').prop('disabled', false);
                        $('#generateButton').html('<i class="fas fa-magic me-2"></i>AIで画像生成');

                    } else if (statusResponse.status === 'failed') {
                        clearInterval(intervalId);
                        showNotification(`画像の生成に失敗しました: ${statusResponse.error}`, 'error');
                        $('#characterPrompt').prop('disabled', false);
                        $('#generateButton').prop('disabled', false);
                        $('#generateButton').html('<i class="fas fa-magic me-2"></i>AIで画像生成');
                    } else {
                        console.log('タスクはまだ処理中です...');
                    }

                    if (attempts >= MAX_ATTEMPTS) {
                        clearInterval(intervalId);
                        showNotification('画像の生成がタイムアウトしました。再試行してください。', 'error');
                        $('#characterPrompt').prop('disabled', false);
                        $('#generateButton').prop('disabled', false);
                        $('#generateButton').html('<i class="fas fa-magic me-2"></i>AIで画像生成');
                    }

                } catch (error) {
                    clearInterval(intervalId);
                    console.error('タスクステータスポーリングエラー:', error);
                    showNotification('画像の生成中にエラーが発生しました。', 'error');
                    $('#characterPrompt').prop('disabled', false);
                    $('#generateButton').prop('disabled', false);
                    $('#generateButton').html('<i class="fas fa-magic me-2"></i>AIで画像生成');

                }
            }, POLLING_INTERVAL);
        }
        $('#generateButton').on('click', async function() {
            
            const isTemporary = user.isTemporary
            if(isTemporary){
                showRegistrationForm()
                return
            }
            const prompt = $('#characterPrompt').val().trim();

            if (!prompt || !chatId) {
                showNotification('すべてのフィールドを入力してください', 'error');
                return;
            }
            const gender = $('#gender').val()

            const $button = $(this);
            $button.prop('disabled', true);
            $button.html('<i class="fas fa-spinner fa-spin me-2"></i>プロンプトを強化中...');
            $('#characterPrompt').prop('disabled', true);
            
            try {
                let enhanceResponse = {enhancedPrompt:''}

                if($('#enhancedPrompt').val().trim() != ''){
                    enhanceResponse.enhancedPrompt = $('#enhancedPrompt').val()
                }else{
                    // プロンプトを強化するリクエスト
                    enhanceResponse = await $.ajax({
                        url: '/api/enhance-prompt',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ prompt, gender, chatId })
                    });
                }
                if (enhanceResponse && enhanceResponse.enhancedPrompt) {
                    $('#enhancedPrompt').val(enhanceResponse.enhancedPrompt);

                    // ボタンテキストを「画像を生成中...」に更新
                    $button.html('<i class="fas fa-spinner fa-spin me-2"></i>画像を生成中...');
                
                    const files = $('#imageUploaderContainer')?.find('input[type="file"]')[0]?.files;
                    if (files && files.length > 0) {
                        const file = files[0];

                        // Read the file as base64
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const base64Image = e.target.result.split(',')[1]; // Remove the data:image/png;base64, part
                            // Now, send this base64 image to the backend
                            sendImageToBackend(base64Image);
                        };
                        reader.readAsDataURL(file);
                        return
                    }
                    const imageStyle = $('#imageStyle').val();
                    // タスクIDを取得するリクエスト
                    const taskResponse = await fetchTaskId(enhanceResponse.enhancedPrompt, '9:16', chatId, imageStyle);

                    if (taskResponse && taskResponse.taskId) {
                        showNotification('画像生成タスクを開始しました。ステータスを確認中...', 'info');
                        // タスクステータスをポーリング
                        checkTaskStatus(taskResponse.taskId);
                    } else {
                        showNotification('画像生成タスクの開始に失敗しました。再試行してください。', 'error');
                        // ボタンを有効化し、初期状態のテキストに戻す
                        $button.prop('disabled', false);
                        $button.html('<i class="fas fa-magic me-2"></i>AIで画像生成');
                        $('#characterPrompt').prop('disabled', false);
                    }
                } else {
                    showNotification('プロンプトの生成に失敗しました。再試行してください。', 'error');
                    // ボタンを有効化し、初期状態のテキストに戻す
                    $button.prop('disabled', false);
                    $button.html('<i class="fas fa-magic me-2"></i>AIで画像生成');
                    $('#characterPrompt').prop('disabled', false);
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('プロンプトの生成中または画像の生成中にエラーが発生しました。', 'error');
                // ボタンを有効化し、初期状態のテキストに戻す
                $button.prop('disabled', false);
                $button.html('<i class="fas fa-magic me-2"></i>AIで画像生成');
                $('#characterPrompt').prop('disabled', false);
            }
        });
        function sendImageToBackend(base64Image) {
            const prompt = $('#enhancedPrompt').val().trim();

            if (!prompt) {
                showNotification('プロンプトを入力してください。', 'error');
                return;
            }

            const data = {
                image_base64: base64Image,
                prompt: prompt,
                aspectRatio: '9:16',
                userId: '{{user._id}}', 
                chatId: '{{chatId}}',
            };

            $.ajax({
                url: '/novita/img2img',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    const taskId = response.taskId;
                    showNotification('画像生成タスクを開始しました。ステータスを確認中...', 'info');
                    // Start polling for the task status
                    checkImg2ImgTaskStatus(taskId);
                },
                error: function(error) {
                    console.error('Error starting img2img task:', error);
                    showNotification('画像生成タスクの開始に失敗しました。再試行してください。', 'error');
                    $('#characterPrompt').prop('disabled', false);
                    $('#generateButton').prop('disabled', false);
                    $('#generateButton').html('<i class="fas fa-magic me-2"></i>AIで画像生成');
                }
                
            });
        }

        $('#ai-assist').on('click', function() {

            $('#ai-assist .fa-spinner').show();
            $('#ai-assist .fa-magic').hide();

            if ($('#chatPurpose').val().trim() == '') {
                showNotification('キャラクターの説明は必須項目です。入力してください。', 'error');
                $('#ai-assist .fa-spinner').hide();
                $('#ai-assist .fa-magic').show();
                return;
            }

            $('#chatPurpose').prop('disabled', false);
            $('#chatName').prop('disabled', true);
            $('#chatDescription').prop('disabled', true);

            $('#chatName').val('')
            $('#chatDescription').val('')
            $('#markdownContainer').html('')
            generateCompletion(function() {
                $('#sendForm').show();
                $('.sendForm-text').show();
                $('#ai-assist .fa-spinner').hide();
                $('#ai-assist .fa-magic').show();
            });
        });

        function generateCompletion(callback) {

            const apiUrl = '/api/openai-chat-creation';

            let prompt = $('#chatPurpose').val().trim();
            let gender = $('#gender').val()

            prompt = prompt + '\n YOU MUST respond in japanese'
              console.log({prompt})
            if(prompt.length == 0){
                return
            } 

            $.ajax({
                url: apiUrl,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ prompt, gender}),
                success: function(response) {
                    console.log(response)
                    const  { name, short_desc, long_desc } = response
                    $('#markdownContainer').show()
                    $('#chatDescription').show()
                    $('#chatName').show()

                    $('#chatDescription').val(short_desc)

                    $('#markdownContainer').html(marked.parse(long_desc));
                    $('#chatRule').val(long_desc)

                    $('#chatName').val(name)
                    updateButtonText()

                    if (typeof callback === 'function') {
                        callback();
                    }
                },
                error: function(error) {
                    console.error('Error:', error);
                    $('#ai-assist .fa-spinner').hide();
                    $('#ai-assist .fa-magic').show();
                }
            });
        }



        // Helper function to create the message payload
        function createMessagePayload(base64Image) {
            return [
                {
                    "type": "image_url",
                    "image_url": {
                        "url": `data:image/png;base64,${base64Image}`
                    }
                }
            ];
        }


        function updateButtonText() {
            let chatName = $('#chatName').val().trim();
            $('#sendForm span').html(`${chatName}とチャットする`);
        }
        
       
});
</script>
</body>
</html>
