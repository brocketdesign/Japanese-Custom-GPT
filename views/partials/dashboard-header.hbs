<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="purple">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/img/logo.webp" type="image/webp">
    <title>{{#if seoTitle}}{{seoTitle}}{{else}}{{title}}{{/if}}</title>
    {{#if seoDescription}}
    <meta name="description" content="{{seoDescription}}">
    {{/if}}
    <!-- SEO Meta Tags -->
    {{#each seo}}
    <meta {{#if name}}name="{{name}}"{{/if}} {{#if property}}property="{{property}}"{{/if}} content="{{content}}">
    {{/each}}
    {{#if canonicalUrl}}
    <link rel="canonical" href="{{canonicalUrl}}">
    {{/if}}
    {{#if alternates}}
    {{#each alternates}}
    <link rel="alternate" hreflang="{{this.hreflang}}" href="{{this.href}}">
    {{/each}}
    {{/if}}
    {{#if structuredData}}
    <script type="application/ld+json">{{{structuredData}}}</script>
    {{/if}}
    {{#if gtmId}}
    <!-- Google Tag Manager -->
    <script async src="https://www.googletagmanager.com/gtag/js?id={{gtmId}}"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', '{{gtmId}}');
    </script>
    <!-- End Google Tag Manager -->
    {{/if}}
    
    <script>
        // Function to get the value of a specific cookie
        function getCookie(name) {
            const nameEQ = name + "=";
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                let c = cookies[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        // Function to delete a specific cookie
        function deleteCookie(name) {
            document.cookie = name + "=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/chat;";
        }

        // Immediately retrieve the 'redirect_url' cookie, delete it, and redirect
        (function() {
            const redirectUrl = getCookie('redirect_url');
            const hasQueryParams = window.location.search.length > 0;
            if (redirectUrl && !hasQueryParams) {
                deleteCookie('redirect_url');
                window.location.replace(window.location.origin + decodeURIComponent(redirectUrl));
            }
        })();
        
        document.addEventListener("DOMContentLoaded", () => {
            const lazyBgElements = new Set();

            const addLazyBgObserver = (element) => {
                if (!lazyBgElements.has(element)) {
                    observer.observe(element);
                    lazyBgElements.add(element);
                }
            };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach((entry) => {
                if (entry.isIntersecting) {
                    const element = entry.target;
                    const bgImage = element.getAttribute("data-bg");
                    if (bgImage) {
                        element.style.backgroundImage = `url(${bgImage})`;
                        observer.unobserve(element);
                        lazyBgElements.delete(element);
                    }
                }
            });
        });

        // Observe existing .lazy-bg elements
        document.querySelectorAll(".lazy-bg").forEach(addLazyBgObserver);

            // MutationObserver to track dynamically added elements
            const mutationObserver = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === Node.ELEMENT_NODE && node.classList.contains("lazy-bg")) {
                            addLazyBgObserver(node);
                        } else if (node.nodeType === Node.ELEMENT_NODE) {
                            // Check children of added nodes
                            node.querySelectorAll(".lazy-bg").forEach(addLazyBgObserver);
                        }
                    });
                });
            });

            mutationObserver.observe(document.body, {
                childList: true,
                subtree: true,
            });
        });

        document.addEventListener("DOMContentLoaded", () => {
            // Intersection Observer for lazy loading
            const observer = new IntersectionObserver((entries, observer) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        // If the element is an NSFW blurred image, call blurImage to fetch blurred blob
                        if (img.classList.contains('img-blur') && typeof blurImage === 'function') {
                            blurImage(img);
                        } else {
                            const dataSrc = img.getAttribute("data-src");
                            if (dataSrc) {
                                img.src = dataSrc; // Replace placeholder with actual image
                                img.removeAttribute("data-src");
                            }
                        }
                        observer.unobserve(img); // Stop observing once the image is loaded
                    }
                });
            });

            // Function to observe all .lazy-image elements
            const observeImages = () => {
                // Observe both regular lazy images and blurred NSFW images
                const lazyImages = document.querySelectorAll(".lazy-image, .img-blur");
                lazyImages.forEach((img) => {
                    if (img.getAttribute("data-src")) {
                        observer.observe(img);
                    }
                });
            };

            // Observe all images initially
            observeImages();

            // Mutation Observer to handle dynamically added elements
            const mutationObserver = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === "childList") {
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeType === 1) { // Ensure it's an element node
                                if (node.matches(".lazy-image") || node.matches('.img-blur')) {
                                    // Observe the newly added lazy-image element
                                    observer.observe(node);
                                } else {
                                    // Check for any .lazy-image elements inside the added node
                                    const lazyImages = node.querySelectorAll(".lazy-image, .img-blur");
                                    lazyImages.forEach((img) => {
                                        observer.observe(img);
                                    });
                                }
                            }
                        });
                    }
                });
            });

            // Observe changes in the document body or a specific container
            mutationObserver.observe(document.body, {
                childList: true, // Watch for added/removed child nodes
                subtree: true,   // Watch the entire subtree
            });
        });


        document.addEventListener("DOMContentLoaded", () => {
            const promptContainer = document.getElementById("promptContainer");
            const showPromptsBtn = document.getElementById("showPrompts"); // Button to show the container
            const lazyImages = document.querySelectorAll("#promptContainer img.lazy-image, #promptContainer img.img-blur");

            // Intersection Observer for lazy loading
            const observer = new IntersectionObserver((entries, observer) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        if (img.classList.contains('img-blur') && typeof blurImage === 'function') {
                            blurImage(img);
                        } else {
                            const dataSrc = img.getAttribute("data-src");
                            if (dataSrc) {
                                img.src = dataSrc; // Replace placeholder with actual image
                                img.removeAttribute("data-src");
                            }
                        }
                        observer.unobserve(img); // Stop observing once the image is loaded
                    }
                });
            });

            // Function to reinitialize the observer after showing the container
            const observeImages = () => {
                lazyImages.forEach((img) => {
                    if (img.getAttribute("data-src")) {
                        observer.observe(img);
                    }
                });
            };

            // Event listener to show the container and reinitialize lazy loading
            if (showPromptsBtn){
                showPromptsBtn.addEventListener("click", () => {
                    promptContainer.style.display = "block"; // Make container visible
                    observeImages(); // Start observing images again
                });
            }
        });

    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <!-- Google Fonts -->
    <link
    href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap"
    rel="stylesheet"
    />    
    <!-- MDB -->
    <link
    href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/7.3.2/mdb.min.css"
    rel="stylesheet"
    />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Other CSS -->
    <link rel="stylesheet" href="/css/personas.css">
    <link rel="stylesheet" href="/css/character-cards.css">
    <!-- User Points CSS -->
    <link rel="stylesheet" href="/css/user-points.css">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/overwrite-bootstrap.css" rel="stylesheet">
    
    <link rel="stylesheet" href="/css/chat-footer.css" />

    <script src="//code.jquery.com/jquery-3.6.0.min.js"></script>

</head>