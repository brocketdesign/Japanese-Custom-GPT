{{#if user}}
    {{#if user.isTemporary}}
        <li class="nav-item dropdown">
            <a class="btn btn-secondary custom-gradient-bg shadow-0" style="border-radius: 50px;" href="#" onclick="openLoginForm()">
                {{translations.login}}
            </a>
        </li>
        <li class="nav-item mx-2">
            <!-- Language Dropdown -->
            <div class="dropdown">
                <button data-user-lang="{{user.lang}}" class="btn btn-light dropdown-toggle" type="button" id="languageDropdownMenu" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-globe2"></i>
                </button>
                <ul class="dropdown-menu position-absolute dropdown-menu-end" aria-labelledby="languageDropdownMenu">
                    <li><a class="dropdown-item language-select" href="#" data-lang="ja">日本語</a></li>
                    <li><a class="dropdown-item language-select" href="#" data-lang="en">English</a></li>
                    <li><a class="dropdown-item language-select" href="#" data-lang="fr">Français</a></li>
                </ul>
            </div>
        </li>
                
    {{else}}
    <li class="nav-item dropdown onchat">
        <a data-mdb-dropdown-init class="d-none nav-link dropdown-toggle hidden-arrow d-inline align-items-center me-2 position-relative" href="#"
            id="notificationIcon" role="button" aria-expanded="false" data-userid="{{user._id}}">
            <div class="btn bg-white rounded-circle border-0 p-1" style="width: 35px; height: 35px;">
                <i class="bi bi-bell"></i>
            </div>
        </a>
        <ul class="d-none notifications-menu dropdown-menu dropdown-menu-end dropdown-menu-sm-end mx-3 border-0 shadow-0 bg-transparent"
            aria-labelledby="notificationIcon"
            style="max-height: 400px; overflow-y: auto;">
        </ul>
    </li>
    {{/if}}
{{else}}
        <li class="nav-item dropdown">
        <a class="btn btn-secondary custom-gradient-bg shadow-0 " style="border-radius: 50px;" href="/authenticate">
            {{translations.login}}
        </a>
    </li>
{{/if}}

<!-- Fixed Avatar Button - Outside nav structure -->
{{#if user}}
    {{#unless user.isTemporary}}
        <div id="avatarMenuContainer" 
        class="d-flex align-items-center gap-2 position-fixed" 
        style="top:0px;right:65px;z-index:1059;">
            {{#if user.isAdmin}}
                <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-danger text-white">{{translations.admin}}</span>
                </div>
            {{/if}}
            <!-- Points Balance -->
            <div id="userPointsContainer" class="d-flex align-items-center gap-2 mt-2">
                <span class="btn btn-warning text-white my-1" style="font-size: 0.9rem;" data-bs-toggle="modal" data-bs-target="#userPointsModal">
                    <i class="bi bi-coin"></i>
                    <span class="user-points-balance">0</span>
                </span>
            </div>
            <!-- Avatar Button -->
            <button id="avatarMenuBtn" 
                class="btn p-0 border-0 bg-transparent avatar-bg {{#if (eq user.subscriptionStatus 'active')}} bg-purple {{/if}}" 
                type="button" 
                data-bs-toggle="offcanvas" 
                data-bs-target="#userMenuOffcanvas" 
                aria-controls="userMenuOffcanvas"
                style="width: 35px; height: 45px; border-radius: 50%; background-size: cover; background-position: top; background-image: url('{{#if user.profileUrl}}{{user.profileUrl}}{{else}}/img/avatar.png{{/if}}');">
            </button>
        </div>
    {{/unless}}
{{/if}}

<!-- User Menu Offcanvas -->
{{#if user}}
    {{#unless user.isTemporary}}
    <div class="offcanvas offcanvas-end" tabindex="-1" id="userMenuOffcanvas" aria-labelledby="userMenuOffcanvasLabel" style="visibility: hidden;">
        <div class="offcanvas-header border-bottom">
            <div class="d-flex align-items-center w-100">
                <div class="avatar-container me-3">
                    <img src="{{#if user.profileUrl}}{{user.profileUrl}}{{else}}/img/avatar.png{{/if}}" 
                         class="rounded-circle" alt="Avatar" loading="lazy" />
                </div>
                <div class="user-info flex-grow-1">
                    <h6 class="mb-0">{{user.username}}</h6>
                    {{#if (eq user.subscriptionStatus 'active')}}
                        <small class="text-muted">
                            <i class="bi bi-gem text-warning"></i> Premium
                        </small>
                    {{/if}}
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
        </div>
        <div class="offcanvas-body px-3 mb-2">
            <div class="list-group list-group-flush">

                <a class="list-group-item list-group-item-action border-0 menu-item" href="/user/{{user._id}}">
                    <i class="bi bi-person-circle me-3"></i>{{translations.avatar.profile}}
                </a>
                
                <a class="list-group-item list-group-item-action border-0 menu-item" href="#" data-bs-toggle="modal" data-bs-target="#userPointsModal">
                    <i class="bi bi-coin me-3"></i>
                    {{userPointsTranslations.points.title}}: <span class="user-points-balance ms-1">0</span>
                </a>
                
                <a class="list-group-item list-group-item-action border-0 menu-item" href="#" onclick="redirectToChatPage()">
                    <i class="bi bi-chat me-3"></i>{{translations.chatList}}
                </a>
                
                
                <div class="d-none">
                    <a class="list-group-item list-group-item-action border-0 menu-item" href="/chat/list/{{user._id}}">
                        <i class="bi bi-people me-3"></i>{{translations.avatar.characters}}
                    </a>
                </div>
                
                <a class="list-group-item list-group-item-action border-0 menu-item" href="#" onclick="loadCharacterCreationPage()">
                    <i class="bi bi-plus-circle me-3"></i>{{translations.avatar.createCharacter}}
                </a>

                <a class="list-group-item list-group-item-action border-0 menu-item" href="/affiliation">
                    <i class="bi bi-link me-3"></i>{{translations.avatar.affiliation}}
                </a>

                {{#if isAdmin}}
                    <hr class="my-2">
                    <div class="px-3 py-2">
                        <small class="text-muted fw-bold">ADMIN</small>
                    </div>
                    
                    <a class="list-group-item list-group-item-action border-0 menu-item" href="/admin/users">
                        <i class="bi bi-people me-3"></i>{{translations.admin.users}}
                    </a>
                    
                    <a class="list-group-item list-group-item-action border-0 menu-item" href="#" data-bs-toggle="modal" data-bs-target="#analyticsModal">
                        <i class="bi bi-bar-chart me-3"></i>{{translations.image_leaderboard_title}}
                    </a>
                    
                    <a class="list-group-item list-group-item-action border-0 menu-item" href="/admin/prompts">
                        <i class="bi bi-pencil me-3"></i>{{translations.admin.prompts}}
                    </a>
                    
                    <a class="list-group-item list-group-item-action border-0 menu-item" href="/admin/system-prompts">
                        <i class="bi bi-pencil me-3"></i>{{translations.admin.system_prompts}}
                    </a>
                    
                    <a class="list-group-item list-group-item-action border-0 menu-item" href="/admin/gifts">
                        <i class="bi bi-gift me-3"></i>{{translations.admin.gifts}}
                    </a>
                    
                    <a class="list-group-item list-group-item-action border-0 menu-item" href="/admin/models">
                        <i class="bi bi-person-badge me-3"></i>{{translations.admin.models}}
                    </a>
                    
                    <a class="list-group-item list-group-item-action border-0 menu-item" href="/admin/civitai">
                        <i class="bi bi-clock me-3"></i>{{translations.admin_model_chats.title}}
                    </a>
                    
                    <a class="list-group-item list-group-item-action border-0 menu-item" href="/admin/notifications">
                        <i class="bi bi-bell me-3"></i>{{translations.admin.notifications}}
                    </a>
                {{/if}}
                
                <hr class="my-2">
                
                <a class="list-group-item list-group-item-action border-0 menu-item" href="#" onclick="openUserProfile()">
                    <i class="bi bi-pencil-square me-3"></i>{{translations.avatar.editProfile}}
                </a>
                
                <a class="list-group-item list-group-item-action border-0 menu-item" href="#" onclick="loadSettingsPage()">
                    <i class="bi bi-gear me-3"></i>{{translations.avatar.settings}}
                </a>
                
                <a class="list-group-item list-group-item-action border-0 text-danger logout menu-item" href="#">
                    <i class="bi bi-box-arrow-right me-3"></i>{{translations.avatar.logout}}
                </a>
            </div>
        </div>
    </div>
    {{/unless}}
{{/if}}

<link rel="stylesheet" href="/css/dashboard-avatar.css">

<script>
document.addEventListener('DOMContentLoaded', function() {
    const avatarMenuContainer = document.getElementById('avatarMenuContainer');
    const avatarBtn = document.getElementById('avatarMenuBtn');
    const userPointsContainer = document.getElementById('userPointsContainer');
    const offcanvasElement = document.getElementById('userMenuOffcanvas');
    const menuItems = document.querySelectorAll('.menu-item');
    const navbarContainer = document.getElementById('navbarNav');

    if (avatarMenuContainer && offcanvasElement) {
        // Remove any existing show class on page load
        offcanvasElement.classList.remove('show');
        offcanvasElement.style.visibility = 'hidden';

        // Enable body scroll when offcanvas is not shown
        document.body.style.overflow = 'auto';
        if(navbarContainer) {
            navbarContainer.style.right = '-50vw';
        }

        
        // Initialize Bootstrap offcanvas without backdrop
        const bsOffcanvas = new bootstrap.Offcanvas(offcanvasElement, {
            backdrop: true,
            keyboard: true,
            scroll: true
        });
        
        // Hide avatar button when offcanvas shows
        offcanvasElement.addEventListener('show.bs.offcanvas', function() {
            if (avatarMenuContainer) {
                avatarMenuContainer.style.opacity = '1';
                avatarMenuContainer.style.visibility = 'visible';
            }
            if(navbarContainer) {
                navbarContainer.style.right = '20px';
            }

        });
        
        // Show avatar button when offcanvas hides
        offcanvasElement.addEventListener('hidden.bs.offcanvas', function() {
            if (avatarMenuContainer) {
                avatarMenuContainer.style.opacity = '1';
                avatarMenuContainer.style.visibility = 'visible';
            }
            if(navbarContainer) {
                navbarContainer.style.right = '-50vw';
            }

            // Enable body scroll when offcanvas is hidden
            document.body.style.overflow = 'auto';
        });
        
        // Close offcanvas when clicking menu items that have onclick handlers
        menuItems.forEach(item => {
            if (item.getAttribute('onclick')) {
                item.addEventListener('click', function() {
                    setTimeout(() => {
                        bsOffcanvas.hide();
                    }, 100);
                });
            }
        });
        
        // Close offcanvas when clicking links (except modal triggers)
        menuItems.forEach(item => {
            if (item.getAttribute('href') && item.getAttribute('href') !== '#' && !item.getAttribute('data-bs-toggle')) {
                item.addEventListener('click', function() {
                    setTimeout(() => {
                        bsOffcanvas.hide();
                    }, 100);
                });
            }
        });
        
        // Close offcanvas when clicking outside
        document.addEventListener('click', function(e) {
            if (offcanvasElement.classList.contains('show') && 
                !offcanvasElement.contains(e.target) && 
                !avatarBtn.contains(e.target)) {
                bsOffcanvas.hide();
            }
        });
    }
});
</script>