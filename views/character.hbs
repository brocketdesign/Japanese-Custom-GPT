<!DOCTYPE html>
<html lang="ja">
<head>
    {{> dashboard-header}}
    <title>{{#if chat}}{{chat.name}} - {{/if}}AI Character</title>
    <meta name="description" content="{{#if chat}}{{chat.description}}{{else}}AI character chat and images{{/if}}">
</head>
<body>
    {{> dashboard-nav}}

<div class="container-fluid px-0">

  {{#if chat}}
    <!-- Hero Section -->
    <section class="hero-section text-center">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-md-6">
            {{#if image}}
              {{#if isBlur}}
                <div type="button" class="text-center mx-auto" onclick={{#if user.isTemporary}}'openLoginForm()'{{else}}'loadPlanPage()'{{/if}}>
                  <img data-src="{{image.imageUrl}}" class="img-fluid img-blur" alt="{{chat.name}} - {{translations.main_image_alt_text}}">
                </div>
              {{else}}
                <img id="mainImage" src="{{image.imageUrl}}" class="img-fluid" alt="{{chat.name}} - {{translations.main_image_alt_text}}">
              {{/if}}
            {{else}}
              <div class="d-flex flex-column align-items-center">
              <div class="position-relative mb-3">
                <img src="{{default chat.chatImageUrl '/img/avatar.png'}}" alt="{{chat.name}} - {{translations.profile_image_alt_text}}" class="rounded-circle character-avatar-large" style="object-fit: cover; object-position: top;">
              </div>
              {{#if chat.short_intro}}
                <div class="character-speech-bubble mt-2" style="min-width: 180px; max-width: 260px; background: #fff; border-radius: 16px; border: 1px solid #ddd; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 12px 18px; font-size: 1rem; color: #333;">
                {{chat.short_intro}}
                </div>
              {{/if}}
              </div>
            {{/if}}
          </div>
          <div class="col-md-6 text-md-start mt-4 mt-md-0">
            <h1 class="display-4 fw-bold u-color-grad">{{translations.meet_your_ai_companion}} {{chat.name}}</h1>
            <p class="lead">{{chat.description}}</p>
            <p class="bg-light p-2 rounded d-inline-block" style="font-size:12px;">{{translations.prompt_description}}</p>
            <a {{#if user.isTemporary}}onclick="openLoginForm()"{{else}}href="/chat/{{chat._id}}"{{/if}} class="btn custom-gradient-bg btn-lg-custom mt-3">
              <i class="bi bi-chat-dots me-2"></i> {{translations.startChattingNow}}
            </a>
            {{#if image}}
            <div class="mt-3">
                <h6 class="mt-3">{{translations.prompt}} :</h6>
                <p class="card-prompt text-muted" style="font-size: 14px;">{{image.prompt}}</p>
                <p class="text-muted"><span class="jp-date">{{image.createdAt}}</span></p>
                <div class="d-flex justify-content-start align-items-center mt-2">
                {{#if user.isTemporary}}{{else}}
                  <button 
                    class="btn btn-light shadow-0 image-fav me-2 {{#if  (includesObjectId image.likedBy user._id) }}liked{{/if}}" 
                    data-id="{{image._id}}" 
                    onclick="toggleImageFavorite(this)"
                  >
                    <i class="bi bi-heart-fill me-2"></i>{{translations.like}}<span class="ct d-none">{{default image.likes 0}}</span>
                  </button>
                {{/if}}
                  <button class="btn btn-light shadow-0 share">
                    <i class="bi bi-share me-2"></i>{{translations.share}}
                  </button>
                </div>
            </div>
            {{/if}}
          </div>
        </div>
      </div>
    </section>

    <!-- About Character Section -->
    <section class="section-padding shadow-sm">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 offset-lg-2 text-center">
            <h2>{{translations.about_the_character}} {{chat.name}}</h2>
            <hr class="w-25 mx-auto">
            <p class="text-muted seo-text mb-4">{{translations.about_character_seo_text}}</p>
            <div class="card mb-4 shadow-sm profile-card">
              <div class="card-body p-0">
                <div class="row g-0">
                  <!-- Left side - Image -->
                  <div class="col-md-4 profile-image-container">
                    <a href="/character/{{chat._id}}" class="text-decoration-none">
                      <img src="{{default chat.chatImageUrl '/img/avatar.png'}}" alt="{{chat.name}} {{translations.profile_image_alt_text}}" 
                           class="rounded-start profile-image" style="width: 100%; height: 100%; object-fit: cover; object-position: top;">
                    </a>
                  </div>
                  
                  <!-- Right side - Profile Details -->
                  <div class="col-md-8">
                    <div class="card-body py-3 shadow border-2">
                      <h3 class="card-title mb-3">{{chat.name}}</h3>
                                              
                        <ul class="list-unstyled profile-details">
                          <li class="mb-2">
                            <i class="bi bi-palette-fill text-purple me-2"></i> <strong>{{translations.profile_style}}:</strong> 
                            <span>{{default chat.imageStyle 'Standard'}}</span>
                            <p class="text-muted small mt-1">{{translations.profile_style_desc}}</p>
                          </li>
                          
                          <li class="mb-2">
                            <i class="bi bi-gender-ambiguous text-purple me-2"></i> <strong>{{translations.profile_gender}}:</strong> 
                            <span>{{default chat.gender 'Not specified'}}</span>
                            <p class="text-muted small mt-1">{{translations.profile_gender_desc}}</p>
                          </li>
                          
                          <li class="mb-2">
                            <i class="bi bi-person-badge text-purple me-2"></i> <strong>{{translations.profile_character}}:</strong> 
                            <span>{{chat.name}}</span>
                            <p class="text-muted small mt-1">{{translations.profile_character_desc}}</p>
                          </li>
                          
                          <li class="mb-2">
                            <i class="bi bi-chat-dots text-purple me-2"></i> <strong>{{translations.profile_messages}}:</strong> 
                            <span>{{default chat.messagesCount '0'}}</span>
                            <p class="text-muted small mt-1">{{translations.profile_messages_desc}}</p>
                          </li>
                          
                          <li class="mb-2">
                            <i class="bi bi-images text-purple me-2"></i> <strong>{{translations.profile_images}}:</strong> 
                            <span>{{default chat.imageCount '0'}}</span>
                            <p class="text-muted small mt-1">{{translations.profile_images_desc}}</p>
                          </li>
                          
                          {{#if chat.nsfw}}
                          <li class="mb-2">
                            <i class="bi bi-exclamation-triangle text-warning me-2"></i> <strong>{{translations.profile_content_rating}}:</strong> 
                            <span class="badge bg-warning text-dark">18+</span>
                            <p class="text-muted small mt-1">{{translations.profile_content_rating_desc}}</p>
                          </li>
                          {{/if}}
                        </ul>

                        <a {{#if user.isTemporary}}onclick="openLoginForm()"{{else}}href="/chat/{{chat._id}}"{{/if}} class="btn custom-gradient-bg btn-lg-custom mt-3">
                          <i class="bi bi-chat-dots me-2"></i> {{translations.startChattingNow}}
                        </a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
         
            <p class="description lead">{{chat.description}}</p>
            {{#if chat.rule}}
              <p class="mt-3"><strong>{{translations.character_rules_heading}}:</strong> {{chat.rule}}</p>
            {{/if}}
             <a {{#if user.isTemporary}}onclick="openLoginForm()"{{else}}href="/chat/{{chat._id}}"{{/if}} class="btn custom-gradient-bg mt-3 shadow-sm"> <i class="bi bi-chat-dots me-2"></i> {{translations.startChatting}}</a>
          </div>
        </div>
      </div>
    </section>

    <!-- Why Chat With This Character Section -->
    <section class="section-padding bg-light shadow-sm">
        <div class="container text-center">
            <h2>{{translations.why_chat_with}} {{chat.name}}?</h2>
            <hr class="w-25 mx-auto mb-4">
            <p class="text-muted seo-text mb-4">{{translations.why_chat_seo_text}}</p>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <i class="bi bi-emoji-smile feature-icon mb-2"></i>
                    <h4>{{translations.engaging_personality}}</h4>
                    <p>{{translations.engaging_personality_desc}}</p>
                </div>
                <div class="col-md-4 mb-3">
                    <i class="bi bi-chat-left-text feature-icon mb-2"></i>
                    <h4>{{translations.unique_conversations}}</h4>
                    <p>{{translations.unique_conversations_desc}}</p>
                </div>
                <div class="col-md-4 mb-3">
                    <i class="bi bi-phone feature-icon mb-2"></i>
                    <h4>{{translations.available_anytime}}</h4>
                    <p>{{translations.available_anytime_desc}}</p>
                </div>
            </div>
        </div>
    </section>

    <!-- How to Start Chatting Section -->
    <section class="section-padding shadow-sm">
        <div class="container text-center">
            <h2>{{translations.how_to_start_chatting_with}} {{chat.name}}</h2>
            <hr class="w-25 mx-auto mb-5">
            <p class="text-muted seo-text mb-4">{{translations.how_to_chat_seo_text}}</p>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body">
                            <div class="fs-1 fw-bold u-color-grad mb-2">1.</div>
                            <h4>{{#if user.isTemporary}}{{translations.create_an_account_step_title}}{{else}}{{translations.you_are_logged_in_step_title}}{{/if}}</h4>
                            <p>{{#if user.isTemporary}}{{translations.create_an_account_step_desc}}{{else}}{{translations.you_are_logged_in_step_desc}}{{/if}}</p>
                            {{#if user.isTemporary}}
                                <button onclick="openLoginForm()" class="btn custom-gradient-bg">
                                    <i class="bi bi-person-plus me-2"></i>{{translations.signUpNow}}
                                </button>
                            {{/if}}
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body">
                             <div class="fs-1 fw-bold u-color-grad mb-2">2.</div>
                            <h4>{{translations.character_selected_step_title}}</h4>
                            <p>{{chat.name}} {{translations.character_selected_step_desc}}</p>
                            <a href="/character" class="btn custom-gradient-bg">
                                <i class="bi bi-search me-2"></i> {{translations.exploreCharacters}}
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body">
                            <div class="fs-1 fw-bold u-color-grad mb-2">3.</div>
                            <h4>{{translations.start_conversation_step_title}}</h4>
                            <p>{{translations.start_conversation_step_desc}}</p>
                            <a {{#if user.isTemporary}}onclick="openLoginForm()"{{else}}href="/chat/{{chat._id}}"{{/if}} class="btn custom-gradient-bg">
                                <i class="bi bi-chat-dots me-2"></i> {{translations.startChatting}}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Users in Chat Section -->
    <section class="section-padding bg-light shadow-sm">
        <div class="container">
            <h3 class="text-center">{{translations.user_in_chat}}</h3>
            <p class="text-center text-muted mb-4">{{translations.user_in_chat_description}}</p>
            <div id="chat-users-gallery" class="d-flex overflow-auto p-2" style="white-space: nowrap;"></div>
            <div id="chat-users-pagination-controls" class="mt-3 d-flex justify-content-center"></div>
        </div>
    </section>
  {{/if}} 

  <!-- Similar Characters Section -->
  {{#if similarChats.length}}
  <section class="section-padding shadow-sm">
    <div class="container">
      <h3 class="text-center">{{translations.similar_characters_title}}</h3>
      <p class="text-center text-muted mb-4">{{translations.similar_characters_description}}</p>
      <hr class="w-25 mx-auto">
      <div class="row mx-0" id="similar-characters-gallery" style="justify-content: center;">
        <!-- Similar characters will be appended here by displayLatestChats -->
      </div>
    </div>
  </section>
  {{/if}}

  <!-- Other Images Section -->
  {{#if chatId}}
    <section id="otherImages" class="section-padding shadow-sm">
      <div class="container">
        <div class="row">
          <div class="col-12 mt-4">
            <h4 class="text-center">{{translations.other_images_of_character}}</h4>
            <p class="text-center text-muted mb-4">{{translations.other_images_description}}</p>
            <hr class="w-25 mx-auto">
            <div class="container-none">
              <div class="row mx-0" id="chat-images-gallery"></div>
              <div class="d-flex justify-content-center mt-4" id="chat-images-pagination-controls"></div>
            </div>
          </div>
        </div>
      </div>
    </section>
  {{else}}
    <!-- This section is for when there's no specific chat, e.g., a general gallery -->
    <section class="section-padding shadow-sm">
        <div class="container">
            <h1 class="my-4 text-center">{{translations.ai_gravure_special_photos}}</h1>
            <p class="text-center">{{translations.ai_gravure_description}}</p>
            
            <div id="all-chats-container">
                <!-- Chats with images will be appended here -->
            </div>
            <div class="row mx-0" id="all-chats-images-gallery"></div>
            <div class="d-flex justify-content-center mt-4" id="all-chats-images-pagination-controls"></div>
            <div class="text-center mt-3">
                <button id="back-to-top" class="btn btn-secondary" style="display: none;">{{translations.backToTop}}</button>
            </div>
        </div>
    </section>
  {{/if}}
</div>

<style>
  footer{display: inline !important;}
  .sticky-bottom{display: inline-block !important;width: 100%;}
</style>

{{> dashboard-footer}}

<script>
  $(document).ready(function () {
    const chatId = "{{#if chat}}{{chat._id}}{{else}}{{chatId}}{{/if}}";
    const characterName = "{{#if chat}}{{chat.name}}{{else}}{{/if}}";

    // If chatId exists, load images and users
    if(chatId && chatId.trim() !== ''){
      // Set description if needed
      const chat = {{#if chat}}{{{json chat}}}{{else}}null{{/if}};
      if (chat) {
        const descriptionElement = $('.description');
        if(descriptionElement.length && (!chat.description || chat.description.trim() === '')){
          const chatDataToString = function(data) {
            if (!data) return '';

            let personalityHtml = '<div class="character-personality-details mt-3">';
            let contentAdded = false;

            // Add SEO paragraph for personality profile
            personalityHtml += `<p class="seo-text text-muted mb-4">${translations.character_personality_seo || 'Discover this unique AI character\'s personality traits, preferences, and expression style. Engage in AI chat conversations that adapt to each character\'s unique persona through advanced AI character technology and AI image generation.'}</p>`;
            
            // Create accordion container
            personalityHtml += '<div class="personality-accordion" id="characterAccordion">';

            const addSection = (title, content, iconClass, isBadge = false, sectionId) => {
                if (!content || (Array.isArray(content) && content.length === 0) || content === 'undefined') return '';
                if (typeof content === 'string' && content.trim() === 'undefined') return '';

                let contentHtml = '';
                if (isBadge) {
                    contentHtml = Array.isArray(content) ?
                        content.map(item => `<span class="character-tag badge me-1 mb-1 p-2">${item}</span>`).join('') :
                        `<span class="character-tag badge me-1 mb-1 p-2">${content}</span>`;
                } else if (typeof content === 'string') {
                    contentHtml = content;
                } else {
                    return ''; // Skip if content is not a string or array for badges
                }

                contentAdded = true;
                
                // Accordion card style
                return `
                    <div class="accordion-item personality-section mb-3 shadow-sm">
                        <h2 class="accordion-header" id="heading-${sectionId}">
                            <button class="accordion-button section-title d-flex align-items-center" 
                                    type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#collapse-${sectionId}" 
                                    aria-expanded="${sectionId === 'traits' ? 'true' : 'false'}" 
                                    aria-controls="collapse-${sectionId}">
                                <i class="${iconClass} fs-5 me-2"></i>${title}
                            </button>
                        </h2>
                        <div id="collapse-${sectionId}" 
                             class="accordion-collapse collapse ${sectionId === 'traits' ? 'show' : ''}" 
                             aria-labelledby="heading-${sectionId}" 
                             data-bs-parent="#characterAccordion">
                            <div class="accordion-body">
                                <div class="${isBadge ? 'tags-container' : 'content-container'}">${contentHtml}</div>
                            </div>
                        </div>
                    </div>`;   
              };

            if (data.traits && data.traits.length > 0) {
                personalityHtml += addSection(
                    translations.characterDescription?.traits || 'Traits', 
                    data.traits, 
                    'bi bi-stars', 
                    true,
                    'traits'
                );
            }

            if (data.preferences && data.preferences.length > 0) {
                personalityHtml += addSection(
                    translations.characterDescription?.preferences || 'Preferences', 
                    data.preferences, 
                    'bi bi-heart', 
                    true,
                    'preferences'
                );
            }

            if (data.expression_style) {
                if (data.expression_style.tone && data.expression_style.tone !== 'undefined') {
                    personalityHtml += addSection(
                        translations.characterDescription?.tone || 'Tone', 
                        `<p class="mb-0">${data.expression_style.tone}</p>`, 
                        'bi bi-chat-quote', 
                        false,
                        'tone'
                    ); 
                }
                
                if (data.expression_style.vocabulary && data.expression_style.vocabulary !== 'undefined') {
                    personalityHtml += addSection(
                        translations.characterDescription?.vocabulary || 'Vocabulary', 
                        `<p class="mb-0">${data.expression_style.vocabulary}</p>`, 
                        'bi bi-journal-text', 
                        false,
                        'vocabulary'
                    );
                }
                
                if (data.expression_style.unique_feature && data.expression_style.unique_feature !== 'undefined') {
                    personalityHtml += addSection(
                        translations.characterDescription?.uniqueFeature || 'Unique Feature', 
                        `<p class="mb-0">${data.expression_style.unique_feature}</p>`, 
                        'bi bi-gem', 
                        false,
                        'unique-feature'
                    );
                }
            }

            if (data.story && data.story !== 'undefined') {
                personalityHtml += addSection(
                    translations.characterDescription?.story || 'Story', 
                    `<p class="fst-italic">${data.story}</p>`, 
                    'bi bi-book', 
                    false,
                    'story'
                );
            }

            // Tags Section
            if (chat.tags && chat.tags.length > 0) {
                const tagsHtml = chat.tags.map(tag => 
                    `<a href="/character?q=${encodeURIComponent(tag)}" class="character-tag badge me-1 mb-1 p-2">${tag}</a>`
                ).join('');
                
                personalityHtml += addSection(
                    translations.tags || 'Tags', 
                    tagsHtml, 
                    'bi bi-tags', 
                    false,
                    'tags'
                );
            }

            // Close accordion container
            personalityHtml += '</div>';

            // Add CSS for better styling
            personalityHtml += `
            <style>
                .character-personality-details {
                    background-color: #f8f9fa;
                    border-radius: 8px;
                    padding: 20px;
                    margin-bottom: 20px;
                    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
                }
                
                .seo-text {
                    font-size: 0.85rem;
                    line-height: 1.5;
                    opacity: 0.8;
                }
                
                .personality-section {
                    border: none !important;
                    border-radius: 8px;
                    overflow: hidden;
                }
                
                .accordion-button {
                    background: #fff;
                    color: #8240FF;
                    font-weight: 600;
                }
                
                .accordion-button:not(.collapsed) {
                    background: #fff;
                    color: #8240FF;
                }
                
                .accordion-button:focus {
                    box-shadow: 0 0 0 0.25rem rgba(130,64,255,0.25);
                }
                
                .section-title {
                    color: #8240FF;
                    padding: 12px 15px;
                }
                
                .accordion-body {
                    padding: 15px;
                    background-color: #fff;
                }
                
                .tags-container {
                    display: flex;
                    flex-wrap: wrap;
                }
                
                .character-tag {
                    background-color: #f0e6ff;
                    color: #6610f2;
                    border: 1px solid #d2b8ff;
                    transition: all 0.3s ease;
                    text-decoration: none;
                    display: inline-block;
                }
                
                .character-tag:hover {
                    background: linear-gradient(90.9deg, #D2B8FF 2.74%, #8240FF 102.92%);
                    color: white !important;
                    transform: translateY(-2px);
                    box-shadow: 0 3px 6px rgba(0,0,0,0.15);
                }
                
                .content-container {
                    background: #fff;
                    border-radius: 6px;
                    padding: 5px;
                }
                
                .btn.custom-gradient-bg {
                    background: linear-gradient(90.9deg, #D2B8FF 2.74%, #8240FF 102.92%);
                    border: none;
                    color: white;
                    transition: all 0.3s ease;
                    box-shadow: 0 4px 10px rgba(130,64,255,0.25);
                }
                
                .btn.custom-gradient-bg:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 6px 12px rgba(130,64,255,0.35);
                }
            </style>`;

            personalityHtml += '</div>';

            if (!contentAdded) {
                return `<div class="alert alert-info shadow-sm p-3">${translations.default_character_description || 'This character has a mysterious personality, waiting to be discovered through chat!'}</div>`;
            }

            return personalityHtml;
        };
          descriptionElement.html(chatDataToString(chat.base_personality));
        } else if (descriptionElement.length && chat.description) {
          descriptionElement.text(chat.description);
        }
      }
      loadChatImages(chatId, 1, true);
      loadChatUsers(chatId);
    }

    // Load similar characters if data is available
    const similarChatsData = {{#if similarChats}}{{{json similarChats}}}{{else}}null{{/if}};
    if (similarChatsData && similarChatsData.length > 0) {
      window.displaySimilarChats(similarChatsData, 'similar-characters-gallery');
    }

    // Function to share image and title on SNS
    if($('#mainImage').length){
      const imageUrl = $('#mainImage').attr('src');
      const shareTitle = "{{translations.share_character_intro}} " + characterName + "! {{translations.share_site_name}}";
      $('.share').on('click', function(){
        shareSns(shareTitle, imageUrl || window.location.href);
      });
    } else if (typeof chat !== 'undefined' && chat && chat.chatImageUrl) {
      const imageUrl = chat.chatImageUrl;
      const shareTitle = "{{translations.share_character_intro}} " + characterName + "! {{translations.share_site_name}}";
      $('.share').on('click', function(){
        shareSns(shareTitle, imageUrl || window.location.href);
      });
    }

    function shareSns(title, pageUrl) {
      const text = encodeURIComponent(title);
      const url = encodeURIComponent(pageUrl);
      if (navigator.share) {
        navigator.share({
          title: title,
          text: title,
          url: pageUrl,
        })
        .then(() => console.log('Successful share'))
        .catch((error) => console.log('Error sharing', error));
      } else {
        const twitterUrl = `https://twitter.com/intent/tweet?text=${text}&url=${url}`;
        window.open(twitterUrl, '_blank');
      }
    }

    // Back to top button
    var backToTopButton = $("#back-to-top");
    $(window).scroll(function() {
      if ($(window).scrollTop() > 300) {
        backToTopButton.fadeIn();
      } else {
        backToTopButton.fadeOut();
      }
    });

    backToTopButton.on("click", function(e) {
      e.preventDefault();
      $("html, body").animate({ scrollTop: 0 }, "slow");
    });
  });
</script>
</body>
</html>