<script>
    window.chatCreationId = '{{chatId}}';
    window.isTemporaryChat = {{isTemporaryChat}};
    window.characterCreationTranslations = {{{json translations.newCharacter}}};
    window.translations = {{{json translations}}};
    window.lang = '{{lang}}';
    window.user = {{{json user}}};
</script>

<!-- Character Creation CSS -->
<link rel="stylesheet" href="/css/character-creation.css">
<link rel="stylesheet" href="/css/civitai-model-search.css">

<!-- Character Creation Full Page -->
<div class="character-creation-wrapper">
    <!-- Background with gradient -->
    <div class="character-creation-bg"></div>
    
    <!-- Main Container -->
    <div class="character-creation-container">
        
        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-bar-wrapper">
                <div class="progress-bar" id="progressBar" style="width: 12.5%"></div>
            </div>
            <div class="step-indicator" id="stepIndicator">
                <span class="current-step">1</span>/<span class="total-steps">8</span>
            </div>
        </div>
        
        <!-- Steps Container -->
        <div class="steps-wrapper" id="stepsWrapper">
            
            <!-- Step 1: Style Selection (Realistic/Anime) - Female Only -->
            <div class="step-slide active" data-step="1" id="step1">
                <div class="step-content">
                    <h1 class="step-title">{{translations.newCharacter.step1_title}}</h1>
                    <p class="step-subtitle">{{translations.newCharacter.step1_subtitle}}</p>
                    
                    <!-- Style Selection -->
                    <div class="selection-section">
                        <div class="style-cards">
                            <div class="style-card selected" data-style="realistic">
                                <div class="style-card-image video-hover-container">
                                    <img src="/img/cold-onboarding/style-realistic.jpg" alt="Realistic" class="video-thumbnail">
                                    <video src="/img/cold-onboarding/style-realistic.mp4" alt="Realistic" loop muted playsinline class="video-hover"></video>
                                    <div class="style-card-overlay">
                                        <i class="bi bi-check-circle-fill"></i>
                                    </div>
                                </div>
                                <span class="style-card-label">{{translations.newCharacter.style_realistic}}</span>
                            </div>
                            <div class="style-card" data-style="anime">
                                <div class="style-card-image video-hover-container">
                                    <img src="/img/cold-onboarding/style-anime.jpg" alt="Anime" class="video-thumbnail">
                                    <video src="/img/cold-onboarding/style-anime.mp4" alt="Anime" loop muted playsinline class="video-hover"></video>
                                    <div class="style-card-overlay">
                                        <i class="bi bi-check-circle-fill"></i>
                                    </div>
                                </div>
                                <span class="style-card-label">{{translations.newCharacter.style_anime}}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 2: Ethnicity & Age -->
            <div class="step-slide" data-step="2" id="step2">
                <div class="step-content">
                    <h1 class="step-title">{{translations.newCharacter.step2_title}}</h1>
                    <p class="step-subtitle">{{translations.newCharacter.step2_subtitle}}</p>
                    
                    <!-- Ethnicity Grid -->
                    <div class="selection-section">
                        <div class="ethnicity-grid" id="ethnicityGrid">
                            <!-- Populated by JS based on style -->
                        </div>
                    </div>
                    
                    <!-- Age Slider -->
                    <div class="selection-section mt-4">
                        <h3 class="section-title">{{translations.newCharacter.age_title}}</h3>
                        <div class="age-selector">
                            <div class="age-display">
                                <span class="age-label">{{translations.newCharacter.age_label}}</span>
                                <span class="age-value" id="ageValue">21</span>
                                <span class="age-unit">{{translations.newCharacter.age_years}}</span>
                            </div>
                            <input type="range" class="age-slider" id="ageSlider" min="18" max="50" value="21">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 3: Hair Style & Color -->
            <div class="step-slide" data-step="3" id="step3">
                <div class="step-content">
                    <h1 class="step-title">{{translations.newCharacter.step3_title}}</h1>
                    <p class="step-subtitle">{{translations.newCharacter.step3_subtitle}}</p>
                    
                    <!-- Hair Style Grid -->
                    <div class="selection-section">
                        <div class="hair-style-grid" id="hairStyleGrid">
                            <!-- Populated by JS based on style -->
                        </div>
                    </div>
                    
                    <!-- Hair Color Selection -->
                    <div class="selection-section mt-4">
                        <h3 class="section-title">{{translations.newCharacter.hair_color_title}}</h3>
                        <div class="hair-color-strip" id="hairColorStrip">
                            <!-- Populated by JS based on style -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 4: Body Type & Features -->
            <div class="step-slide" data-step="4" id="step4">
                <div class="step-content">
                    <h1 class="step-title">{{translations.newCharacter.step4_title}}</h1>
                    <p class="step-subtitle">{{translations.newCharacter.step4_subtitle}}</p>
                    
                    <!-- Body Type -->
                    <div class="selection-section">
                        <div class="body-type-grid" id="bodyTypeGrid">
                            <!-- Populated by JS based on style -->
                        </div>
                    </div>
                    
                    <!-- Breast Size -->
                    <div class="selection-section mt-4" id="breastSizeSection">
                        <h3 class="section-title">{{translations.newCharacter.breast_size_title}}</h3>
                        <div class="breast-size-grid" id="breastSizeGrid">
                            <!-- Populated by JS based on style -->
                        </div>
                    </div>
                    
                    <!-- Butt Size -->
                    <div class="selection-section mt-4">
                        <h3 class="section-title">{{translations.newCharacter.butt_size_title}}</h3>
                        <div class="butt-size-grid" id="buttSizeGrid">
                            <!-- Populated by JS based on style -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 5: Personality & Name -->
            <div class="step-slide" data-step="5" id="step5">
                <div class="step-content">
                    <h1 class="step-title">{{translations.newCharacter.step5_title}}</h1>
                    <p class="step-subtitle">{{translations.newCharacter.step5_subtitle}}</p>
                    
                    <!-- Name Input -->
                    <div class="selection-section">
                        <div class="name-input-group">
                            <input type="text" class="name-input" id="characterName" placeholder="{{translations.newCharacter.name_placeholder}}">
                            <button type="button" class="generate-name-btn" id="generateNameBtn">
                                <i class="bi bi-arrow-repeat"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Personality Options Grid -->
                    <div class="personality-grid">
                        <!-- Personality -->
                        <div class="personality-option-card" data-option="personality" data-value="submissive">
                            <span class="option-label">{{translations.newCharacter.personality_title}}</span>
                            <span class="option-value">{{translations.newCharacter.personalities.submissive}}</span>
                            <button type="button" class="edit-btn"><i class="bi bi-pencil"></i></button>
                        </div>
                        
                        <!-- Relationship -->
                        <div class="personality-option-card" data-option="relationship" data-value="stranger">
                            <span class="option-label">{{translations.newCharacter.relationship_title}}</span>
                            <span class="option-value">{{translations.newCharacter.relationships.stranger}}</span>
                            <button type="button" class="edit-btn"><i class="bi bi-pencil"></i></button>
                        </div>
                        
                        <!-- Occupation -->
                        <div class="personality-option-card" data-option="occupation" data-value="student">
                            <span class="option-label">{{translations.newCharacter.occupation_title}}</span>
                            <span class="option-value">ðŸŽ“ {{translations.newCharacter.occupations.student}}</span>
                            <button type="button" class="edit-btn"><i class="bi bi-pencil"></i></button>
                        </div>
                        
                        <!-- Kinks -->
                        <div class="personality-option-card" data-option="kinks" data-value="vanilla">
                            <span class="option-label">{{translations.newCharacter.kinks_title}}</span>
                            <span class="option-value">{{translations.newCharacter.kinks.vanilla}}</span>
                            <button type="button" class="edit-btn"><i class="bi bi-pencil"></i></button>
                        </div>
                    </div>
                    
                    <!-- Custom Prompt (Optional) -->
                    <div class="selection-section mt-4">
                        <div class="custom-prompt-container">
                            <label class="custom-prompt-label">{{translations.newCharacter.custom_prompt_label}}</label>
                            <textarea class="custom-prompt-input" id="customPrompt" placeholder="{{translations.newCharacter.custom_prompt_placeholder}}" rows="3"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 6: Voice Selection -->
            <div class="step-slide" data-step="6" id="step6">
                <div class="step-content">
                    <h1 class="step-title">{{translations.newCharacter.step6_title}}</h1>
                    <p class="step-subtitle">{{translations.newCharacter.step6_subtitle}}</p>
                    
                    <!-- Voice Grid -->
                    <div class="selection-section">
                        <div class="voice-grid" id="voiceGrid">
                            <!-- Voices will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 7: Image Generation -->
            <div class="step-slide" data-step="7" id="step7">
                <div class="step-content">
                    <h1 class="step-title">{{translations.newCharacter.step7_title}}</h1>
                    <p class="step-subtitle">{{translations.newCharacter.step7_subtitle}}</p>
                    
                    <!-- Model Selection Section -->
                    <div class="model-selection-section">
                        <h3 class="section-label">{{translations.newCharacter.customModelTitle}}</h3>
                        <p class="section-description text-muted small mb-3">{{translations.newCharacter.modelSelectionDescription}}</p>
                        
                        <!-- Custom Models Container -->
                        <div class="model-tab-content">
                            <!-- Custom Models Pane -->
                            <div class="model-pane active" id="customModelsPane">
                                <!-- Premium feature notice for non-subscribers -->
                                <div id="customModelsPremiumNotice" class="premium-notice" style="display: none;">
                                    <i class="bi bi-gem"></i>
                                    <div class="premium-notice-content">
                                        <strong>{{translations.newCharacter.premiumFeature}}</strong>
                                        <p>{{translations.newCharacter.customModelsPremiumDescription}}</p>
                                        <a href="#" onclick="loadPlanPage()" class="btn-upgrade">
                                            <i class="bi bi-star me-1"></i>{{translations.upgrade_now}}
                                        </a>
                                    </div>
                                </div>
                                <div class="models-scroll-container" id="userCustomModels">
                                    <!-- Add model button -->
                                    <div class="add-model-card" id="addCustomModelBtn">
                                        <i class="bi bi-plus-lg"></i>
                                        <span>{{translations.newCharacter.addCustomModel}}</span>
                                    </div>
                                    <!-- User models will be dynamically inserted here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hidden inputs for model data -->
                        <input type="hidden" id="modelId" name="modelId">
                        <input type="hidden" id="imageStyle" name="imageStyle">
                        <input type="hidden" id="imageModel" name="imageModel">
                        <input type="hidden" id="imageVersion" name="imageVersion">
                        <input type="hidden" id="isUserModel" name="isUserModel" value="false">
                    </div>
                    
                    <!-- Custom Prompt Section -->
                    <div class="custom-prompt-section">
                        <label for="customPrompt" class="section-label">{{translations.newCharacter.custom_prompt_label}}</label>
                        <p class="custom-prompt-description">{{translations.newCharacter.custom_prompt_description}}</p>
                        <textarea 
                            class="custom-prompt-input" 
                            id="customPrompt" 
                            placeholder="{{translations.newCharacter.custom_prompt_placeholder}}"
                            rows="3"
                            maxlength="500"
                        ></textarea>
                        <div class="char-counter">
                            <span id="customPromptCounter">0</span>/500
                        </div>
                    </div>
                    
                    <!-- Image Generation Area -->
                    <div class="image-generation-section">
                        <!-- Generated Images Grid (2x2 for 4 images) -->
                        <div class="generated-images-grid" id="generatedImagesGrid">
                            <!-- Placeholder shown before generation -->
                            <div class="image-placeholder-grid row" id="imagePlaceholder">
                                <div class="placeholder-item col-6 ms-auto">
                                    <div class="placeholder-content">
                                        <i class="bi bi-image"></i>
                                    </div>
                                </div>
                                <div class="placeholder-item col-6 me-auto">
                                    <div class="placeholder-content">
                                        <i class="bi bi-image"></i>
                                    </div>
                                </div>
                                <div class="placeholder-item col-6 ms-auto">
                                    <div class="placeholder-content">
                                        <i class="bi bi-image"></i>
                                    </div>
                                </div>
                                <div class="placeholder-item col-6 me-auto">
                                    <div class="placeholder-content">
                                        <i class="bi bi-image"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Generate/Regenerate Button -->
                        <div class="image-generation-controls">
                            <button type="button" class="btn-generate-image" id="generateImageBtn">
                                <i class="bi bi-magic"></i>
                                <span>{{translations.newCharacter.generate_image}}</span>
                            </button>
                            <button type="button" class="btn-regenerate-image" id="regenerateImageBtn" style="display: none;">
                                <i class="bi bi-arrow-repeat"></i>
                                <span>{{translations.newCharacter.regenerate_image}}</span>
                            </button>
                        </div>
                        
                        <!-- Image Selection Info -->
                        <p class="image-selection-info" id="imageSelectionInfo" style="display: none;">
                            {{translations.newCharacter.select_image_info}}
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Step 8: Confirmation & Start Chat -->
            <div class="step-slide" data-step="8" id="step8">
                <div class="step-content">
                    <h1 class="step-title">{{translations.newCharacter.step8_title}}</h1>
                    <p class="step-subtitle">{{translations.newCharacter.step8_subtitle}}</p>
                    
                    <!-- Character Summary -->
                    <div class="character-summary">
                        <div class="summary-image-container">
                            <img id="summaryImage" src="/img/default-character.png" alt="Character">
                        </div>
                        <div class="summary-details">
                            <h3 class="summary-name" id="summaryName">-</h3>
                            <div class="summary-traits">
                                <span class="trait-badge" id="summaryAge">-</span>
                                <span class="trait-badge" id="summaryEthnicity">-</span>
                                <span class="trait-badge" id="summaryPersonality">-</span>
                            </div>
                            <p class="summary-description" id="summaryDescription">-</p>
                        </div>
                    </div>
                    
                    <!-- Start Chat Button -->
                    <div class="start-chat-section">
                        <button type="button" class="btn-start-chat" id="startChatBtn">
                            <i class="bi bi-chat-heart"></i>
                            <span>{{translations.newCharacter.start_chat}}</span>
                        </button>
                    </div>
                </div>
            </div>
            
        </div>
        
        <!-- Footer Navigation -->
        <footer class="character-creation-footer">
            <button type="button" class="btn btn-back" id="backBtn" style="visibility: hidden;">
                <i class="bi bi-chevron-left"></i>
                {{translations.newCharacter.back}}
            </button>
            <button type="button" class="btn btn-next" id="nextBtn">
                {{translations.newCharacter.next}}
                <i class="bi bi-chevron-right"></i>
            </button>
        </footer>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-content">
            <div class="spinner-border text-light" role="status"></div>
            <p id="loadingMessage">{{translations.newCharacter.generating_character}}</p>
            <small>{{translations.newCharacter.please_wait}}</small>
        </div>
    </div>
    
    <!-- Civitai Model Search Modal -->
    <div class="modal fade civitai-search-modal" id="civitaiSearchModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header flex-row-reverse">
                    <h5 class="modal-title ms-auto">
                        <i class="bi bi-search me-2"></i>{{translations.newCharacter.searchImageModels}}
                    </h5>
                    <button type="button" class="btn-close me-0" id="closeImageModelSearchModal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="input-group">
                            <input type="text" 
                                class="form-control" 
                                id="civitaiModalSearch" 
                                placeholder="{{translations.newCharacter.searchImageModelsPlaceholder}}"
                                autocomplete="off">
                            <button class="btn btn-primary" type="button" id="civitaiModalSearchBtn">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                        <small class="text-muted">{{translations.newCharacter.searchImageModelsDescription}}</small>
                    </div>
                    
                    <!-- Search Results -->
                    <div id="civitaiSearchResults">
                        <div class="text-center text-muted py-4" id="civitaiSearchPlaceholder">
                            <i class="bi bi-box-seam fs-1 d-block mb-2"></i>
                            <p>{{translations.newCharacter.searchImageModelsDescription}}</p>
                        </div>
                        <div class="text-center py-4 d-none" id="civitaiSearchLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">{{translations.newCharacter.searchingImageModels}}</p>
                        </div>
                        <div id="civitaiSearchResultsList"></div>
                        <div class="text-center py-4 d-none" id="civitaiNoResults">
                            <i class="bi bi-emoji-frown fs-1 d-block mb-2 text-muted"></i>
                            <p class="text-muted">{{translations.newCharacter.noModelsFound}}</p>
                            <small class="text-muted">{{translations.newCharacter.tryDifferentSearch}}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hidden audio element for voice samples -->
    <audio id="voiceSamplePlayer" preload="none"></audio>
</div>
