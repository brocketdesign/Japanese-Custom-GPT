<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="//code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
<script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
<script src="/js/dashboard.js"></script>
<script
  type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/7.3.2/mdb.umd.min.js"
></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.remove('hidden'); // Remove the hidden class
                entry.target.classList.add('animate__animated');

                const sanitizedAnimate = entry.target.dataset.animate.replace(/[^a-zA-Z0-9-_]/g, '');
                entry.target.classList.add(sanitizedAnimate); // Apply sanitized animation class

                if (entry.target.dataset.delay && entry.target.dataset.delay !== '') {
                    const sanitizedDelay = entry.target.dataset.delay.replace(/[^a-zA-Z0-9-_]/g, '');
                    entry.target.classList.add(sanitizedDelay); // Apply sanitized delay
                }

                observer.unobserve(entry.target); // Stop observing after animation
            }
        });
    }, {
        threshold: 0.1 // Adjust the threshold as needed
    });

    document.querySelectorAll('[data-animate]').forEach(element => {
        element.classList.add('hidden'); // Add the hidden class initially
        observer.observe(element);
    });
});

$(document).ready(function(){
    // Initialize user info from the Handlebars variable
    const user = {
        _id: "{{user._id}}",
        language: "{{user.lang}}",
        isTemporary: "{{user.isTemporary}}",
    };
    localStorage.setItem('currentLang',user.language)
    if(user.isTemporary == true){

    }else{
        updatePlanStatus(user)
    }
})

window.updatePlanStatus = function(user){
  $.get('/user/plan/'+user._id,function(data){
      let message = `<span class="ms-1">&#x1F381;</span>`;
      if(!data.plan){
        $('.user-current-plan').each(function(){
          $(this).html(message).show()
        })
        return
      }
      const billingCycle = data.plan.billingCycle
      const currentPlanId = data.plan.currentPlanId

      $.get('/plan/list',function(data){
          const plans = data.plans
          const plan = plans.find((plan) => plan[`${billingCycle}_id`] === currentPlanId);
          if(!plan){
            message = `<span class="ms-1">&#x1F381;</span>`;
          }else{
            switch (plan.id) {
              case 'free':
                message = `<span class="ms-1">&#x1F381;</span>`;
                break;
              case 'premium':
                message = `<span class="ms-1"> &#x1F48E;</span>`;
                break;
              case 'special':
                message = ` <span class="ms-1">&#x1F525;</span>`;
                break;
              default:
                message = `<span class="ms-1">&#x1F381;</span>`;
            }
          }
          $('.user-current-plan').each(function(){
            $(this).html(message).show()
          })
      })
  })
}
window.showNotification = function(message, icon) {
    Swal.fire({
        position: 'top',
        icon: icon,
        title: message,
        showConfirmButton: false,
        timer: 3000,
        toast: true,
        customClass: {
            title: 'swal2-custom-title',
            popup: 'swal2-custom-popup'
        },
        showClass: {
            popup: 'animate__animated animate__slideInDown'
        },
        hideClass: {
            popup: 'animate__animated animate__slideOutUp'
        }
    });
}
window.setApiUrlAndMode = async function() {
    let mode = localStorage.getItem('MODE');
    let API_URL = localStorage.getItem('API_URL');

    if (!mode || !API_URL) {
        mode = await fetchMode();
        API_URL = (mode !== 'local' && !window.location.origin.includes('lamix')) 
            ? 'https://chat.lamixapp.com' 
            : window.location.origin;

        localStorage.setItem('MODE', mode);
        localStorage.setItem('API_URL', API_URL);
    }

    return { API_URL, MODE: mode };
};

window.fetchUser = async function() {
    const { API_URL, MODE } = await window.setApiUrlAndMode();
    try {
        const response = await fetch(`${API_URL}/api/user`, { method: 'GET' });
        if (!response.ok) throw new Error('Network response was not ok');
        const data = await response.json();
        return data.user;
    } catch (error) {
        console.error('Error fetching user:', error);
        return null;
    }
};
window.fetchMode = async function() {
    try {
        const response = await fetch('/api/mode', { method: 'GET' });
        if (!response.ok) throw new Error('Network response was not ok');
        const data = await response.json();
        return data.mode;
    } catch (error) {
        console.error('Error fetching mode:', error);
        return null
    }
};

$(document).ready(function(){

// User info popup
        
    function generateRandomNickname() {
        const adjectives = ["すばやい", "静かな", "強力な", "勇敢な", "明るい", "高貴な"];
        const nouns = ["ライオン", "トラ", "ファルコン", "フェニックス", "オオカミ", "イーグル"];
        return adjectives[Math.floor(Math.random() * adjectives.length)] + nouns[Math.floor(Math.random() * nouns.length)];
    }
    
    function UserInfoForm(){
        return `
            <div class="text-center mb-3">
                <h3 class="mt-3">ご登録ありがとうございます！</h3>
                <p style="font-size:14px;color:#aaa;">よりパーソナライズされたチャット体験のために、以下の情報をご提供ください。</p>
            </div>
            <div class="form-group mb-3 text-start">
                <label for="nickname" class="form-label">
                    <span class="small" style="font-size:12px">ニックネーム</span>
                    <span class="small text-muted" style="font-size:10px">キャラクターに呼んでほしい名前</span>
                </label>
                <input id="nickname" type="text" class="form-control form-control-sm" placeholder="ニックネームを入力">
            </div>
            <div class="form-group mb-3 text-start">
                <label for="gender" class="form-label" style="font-size:12px">性別</label>
                <select class="form-select" id="gender" name="gender">
                    <option value="female" selected>女性</option>
                    <option value="male">男性</option>
                </select>
            </div>
            <div class="form-group mb-3 text-start">
                <label for="birthdate" class="form-label" style="font-size:12px">生年月日</label>
                <input id="birthdate" type="text" class="form-control" placeholder="生年月日を選択" autocomplete="off">
            </div>
            <div class="form-check text-start mb-3">
                <input class="form-check-input" type="checkbox" value="" id="ageVerification">
                <label class="form-check-label" for="ageVerification">
                    私は18歳以上です
                </label>
            </div>
        `
    }
    
    function handleUserInfo(value,callback){
        const { nickname, birthYear, birthMonth, birthDay, gender } = value;
        const formData = new FormData();
        formData.append('nickname', nickname);
        formData.append('birthYear', birthYear);
        formData.append('birthMonth', birthMonth);
        formData.append('birthDay', birthDay);
        formData.append('gender', gender);
    
        $.ajax({
            url: '/user/update-info',
            type: 'POST',
            processData: false,
            contentType: false,
            data: formData,
            success: function(response) {
                if(typeof callback == 'function'){callback()}
            },
            error: function() {
                showNotification('情報の更新中に問題が発生しました。','error')
                if(typeof callback == 'function'){callback()}
            }
        });
    }
    
    function showPopupUserInfo(callback) {
        Swal.fire({
            html: UserInfoForm(),
            focusConfirm: false,
            confirmButtonText: window.translations.setting.saveUserInfo || '送信',
            allowOutsideClick: false,
            showCancelButton: false,
            customClass: {
                confirmButton: 'bg-secondary px-5',
                popup: 'bg-white border-top-custom-gradient rounded shadow',
                confirmButton : 'btn btn-md custom-gradient-bg shadow-0 border-0'
            },
            showClass: {
                popup: 'animate__animated animate__fadeIn'
            },
            hideClass: {
                popup: 'animate__animated animate__fadeOut'
            },
            didOpen: () => {
                flatpickr("#birthdate", {
                    locale: "ja",
                    dateFormat: "Y年m月d日",
                    maxDate: new Date(),
                    defaultDate: new Date(new Date().setFullYear(new Date().getFullYear() - 18)),
                });
                if (callback) callback();
            },
            preConfirm: () => {
                const nickname = $('#nickname').val();
                const birthdate = $('#birthdate').val();
                const gender = $('#gender').val();
                const ageVerified = $('#ageVerification').is(':checked');
    
                if (!nickname || !birthdate || !gender)  {
                    Swal.showValidationMessage('すべてのフィールドを入力してください');
                    return false;
                }
    
                if (!ageVerified) {
                    Swal.showValidationMessage('18歳以上であることを確認してください');
                    return false;
                }
    
                const dateParts = birthdate.match(/(\d{4})年(\d{1,2})月(\d{1,2})日/);
                if (!dateParts) {
                    Swal.showValidationMessage('有効な生年月日を選択してください');
                    return false;
                }
                const birthYear = dateParts[1];
                const birthMonth = dateParts[2];
                const birthDay = dateParts[3];
    
                const today = new Date();
                const birthDate = new Date(birthYear, birthMonth - 1, birthDay);
                let age = today.getFullYear() - birthDate.getFullYear();
                const m = today.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
    
                if (age < 18) {
                    Swal.showValidationMessage('18歳以上である必要があります');
                    return false;
                }
    
                return { nickname, birthYear, birthMonth, birthDay, gender };
            }
        }).then((result) => {
            if (result.isConfirmed) {
                handleUserInfo(result.value,function(){
                    window.location = '/my-plan'
                });
            }
            
        });
    }
    const user = {{{json user}}};
    if(!user.isTemporary && $('#chat-widget-container').length == 0){

        const userNickname = user?.nickname ?? '';
        const userGender = user?.gender ?? '';
        const userBirthYear = user?.birthDate?.year ?? '';
        const userBirthMonth = user?.birthDate?.month ?? '';
        const userBirthDay = user?.birthDate?.day ?? '';

        if (!userNickname || !userBirthYear || !userBirthMonth || !userBirthDay || !userGender) {
            showPopupUserInfo();
            return
        }
        const subscriptionStatus = user?.subscriptionStatus == 'active'
        const currentLocation = window.location.pathname

        if(!subscriptionStatus && currentLocation !== '/my-plan'){
                window.location = '/my-plan'
        }
    }
})
</script>
<div class="sticky-bottom py-0 text-center onchat-off" style="bottom:0;left:0;right:0;">
      <a href="/discover" class="{{default isAdmin 'd-inline-block'}} m-2 btn px-4 py-2 border border-dark shadow btn-light" style="border-radius:40px;">
          <i class="fas fa-compass me-2"></i>{{translations.library}}
      </a>
      <a href="/chat/edit/" class="m-2 btn border border-dark shadow btn-secondary px-5 py-2" style="border-radius:40px;background:linear-gradient(90.9deg, rgb(222, 202, 255) 2.74%, #6E20F4 102.92%);">
          <i class="fas fa-plus me-2"></i>{{translations.createCharacter}}
      </a>
  </div>
<footer class="l-footer p-footer bg-white shadow-0 text-center onchat-off ">

  
  <div class="container mb-5 py-3">
    <div class="row">
      <div class="col-12">
        <nav class="navbar navbar-expand-lg navbar-light shadow-0 py-0 d-flex flex-column">
          <div class="row">
              <div class="d-flex justify-content-center">
                <a href="https://x.com/Lamix253843" target="_blank" class="btn btn-dark rounded text-center mb-2 mx-2">
                  <i class="bi bi-twitter-x"></i> 
                </a>
                <a href="https://www.instagram.com/aichat_lamix/" target="_blank" class="btn btn-dark rounded text-center mb-2 mx-2">
                  <i class="bi bi-instagram"></i>
                </a>
              </div>
            <p style="color: #555;">{{translations.contactUs}}</p>
          </div>
          <div class="container-fluid justify-content-center">
            <ul class="navbar-nav d-flex flex-row" style="flex-wrap: inherit;">
              <li class="nav-item m-1">
                <a class="nav-link" href="/about" target="_blank">{{translations.aboutService}}</a>
              </li>
              <li class="nav-item m-1">
                <a class="nav-link" href="https://lamix.jp/usage-policy/" target="_blank">{{translations.termsOfUse}}</a>
              </li>
              <li class="nav-item m-1">
                <a class="nav-link" href="https://lamix.jp/privacy-policy/" target="_blank">{{translations.privacyPolicy}}</a>
              </li>
              <li class="nav-item m-1">
                <a class="nav-link" href="https://lamix.jp/%e4%bc%9a%e7%a4%be%e6%a6%82%e8%a6%81/" target="_blank">{{translations.companyOverview}}</a>
              </li>
              <li class="nav-item m-1">
                <a class="nav-link" href="https://lamix.jp/%e3%83%96%e3%83%ad%e3%82%b0/" target="_blank">{{translations.blog}}</a>
              </li>
              <li class="nav-item m-1">
                <a class="nav-link" href="/character" target="_blank">{{translations.characters}}</a>
              </li>
              <li class="nav-item m-1">
                <a class="nav-link" href="/search" target="_blank">{{translations.search}}</a>
              </li>
            </ul>
          </div>
        </nav>
      </div>
    </div>
  </div>
</footer>
