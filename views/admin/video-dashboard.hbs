<!DOCTYPE html>
<html>
{{> dashboard-header}}
<body class="bg-dark">
    {{> dashboard-nav}}
    <link rel="stylesheet" href="/css/dashboard-video.css">
    
    <section class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
                    <div class="flex-grow-1">
                        <h1 class="text-white mb-1">
                            <i class="bi bi-film me-2"></i>Video Dashboard
                        </h1>
                        <p class="text-muted mb-0">Generate videos from images with AI models</p>
                    </div>
                    <div class="d-flex gap-2 w-100 w-md-auto">
                        <button class="btn btn-outline-info flex-fill flex-md-grow-0" onclick="refreshStats()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Refresh Stats
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Left Panel: Generation Controls -->
            <div class="col-lg-4 mb-4">
                <div class="card bg-dark border-secondary h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-sliders me-2"></i>Generation Settings</h5>
                    </div>
                    <div class="card-body">
                        <!-- Model Selection -->
                        <div class="mb-4">
                            <label class="form-label text-white fw-bold">Select Video Model</label>
                            <div class="model-selection">
                                {{#each models}}
                                <div class="form-check model-checkbox mb-2">
                                    <input class="form-check-input" type="radio" 
                                           name="videoModel"
                                           value="{{this.id}}" 
                                           id="model-{{this.id}}" 
                                           data-model-name="{{this.name}}"
                                           {{#if @first}}checked{{/if}}>
                                    <label class="form-check-label text-white" for="model-{{this.id}}">
                                        <span class="fw-semibold">{{this.name}}</span>
                                        <span class="badge bg-info ms-1">Async</span>
                                        <br>
                                        <small class="text-muted">{{this.description}}</small>
                                    </label>
                                </div>
                                {{/each}}
                            </div>
                        </div>

                        <!-- Base Image Upload -->
                        <div class="mb-4">
                            <label class="form-label text-white fw-bold">Base Image</label>
                            <div class="base-image-upload" id="imageUploadArea">
                                <input type="file" id="baseImageInput" accept="image/*" style="display: none;">
                                <div class="upload-placeholder" onclick="document.getElementById('baseImageInput').click()">
                                    <i class="bi bi-cloud-upload display-4 text-muted"></i>
                                    <p class="text-muted mb-0">Click to upload image</p>
                                    <small class="text-muted">Supports JPG, PNG, WebP</small>
                                </div>
                                <div class="image-preview d-none" id="imagePreview">
                                    <img id="previewImg" src="" alt="Preview" class="img-fluid rounded">
                                    <button class="btn btn-sm btn-danger mt-2" onclick="clearImageUpload()">
                                        <i class="bi bi-x me-1"></i>Clear
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Video Parameters -->
                        <div class="mb-4">
                            <label class="form-label text-white fw-bold">Duration</label>
                            <select class="form-select bg-secondary text-white border-secondary" id="durationSelect">
                                {{#each durationOptions}}
                                <option value="{{this.value}}">{{this.label}}</option>
                                {{/each}}
                            </select>
                        </div>

                        <div class="mb-4">
                            <label class="form-label text-white fw-bold">Aspect Ratio</label>
                            <select class="form-select bg-secondary text-white border-secondary" id="aspectRatioSelect">
                                {{#each aspectRatioOptions}}
                                <option value="{{this.value}}">{{this.label}}</option>
                                {{/each}}
                            </select>
                        </div>

                        <!-- Motion Prompt -->
                        <div class="mb-4">
                            <label class="form-label text-white fw-bold">Motion Prompt (Optional)</label>
                            <textarea class="form-control bg-secondary text-white border-secondary" 
                                      id="promptInput" 
                                      rows="6" 
                                      placeholder="Describe the motion or camera movement (e.g., slow zoom in, camera pans left, dramatic lighting)..."
                                      style="min-height: 120px;">Dynamic camera movement with natural motion</textarea>
                            <div class="form-text text-muted mt-1">
                                <small><i class="bi bi-info-circle me-1"></i>Leave empty for automatic motion detection</small>
                            </div>
                        </div>

                        <!-- Cost Display -->
                        <div class="mb-3 rounded-4 overflow-hidden" id="costDisplaySection" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 1px solid rgba(255,255,255,0.1);">
                            <div class="p-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="rounded-circle d-flex align-items-center justify-content-center" style="width: 36px; height: 36px; background: linear-gradient(135deg, #a855f7 0%, #6366f1 100%);">
                                            <i class="bi bi-film text-white"></i>
                                        </div>
                                        <div>
                                            <div class="text-white-50 small">Video Cost</div>
                                            <div class="text-white fw-bold fs-5" id="totalCostDisplay">{{videoCostPerUnit}}</div>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <div class="text-white-50 small">Your Balance</div>
                                        <div class="fw-bold fs-5" id="userPointsDisplay" style="color: #4ade80;">{{userPoints}}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="px-3 py-2" style="background: rgba(0,0,0,0.2); border-top: 1px solid rgba(255,255,255,0.05);">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-white-50 small">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Per video generation
                                    </span>
                                    <span class="badge rounded-pill" id="costStatusBadge" style="background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%); color: #000;">
                                        <i class="bi bi-check-circle-fill me-1"></i>Ready
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Generate Button -->
                        <button class="btn btn-primary btn-lg w-100" id="generateBtn" onclick="startGeneration()">
                            <i class="bi bi-play-fill me-2"></i>Generate Video
                        </button>
                    </div>
                </div>
            </div>

            <!-- Center Panel: Results -->
            <div class="col-lg-5 mb-4">
                <div class="card bg-dark border-secondary h-100">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-film me-2"></i>Generation Results</h5>
                        <span id="totalTimeDisplay" class="badge bg-light text-dark d-none">Total: 0s</span>
                    </div>
                    <div class="card-body" id="resultsContainer" style="min-height: 400px; max-height: 600px; overflow-y: auto;">
                        <div class="text-center text-muted py-5" id="noResultsPlaceholder">
                            <i class="bi bi-film display-1"></i>
                            <p class="mt-3">Upload an image and click "Generate Video" to begin</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Statistics -->
            <div class="col-lg-3 mb-4">
                <div class="card bg-dark border-secondary">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Model Statistics</h5>
                    </div>
                    <div class="card-body" id="statsContainer">
                        {{#each models}}
                        <div class="stat-card mb-3 p-3 rounded" data-model-id="{{this.id}}">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="text-white mb-0">{{this.name}}</h6>
                                <span class="badge bg-secondary">{{this.totalTests}} tests</span>
                            </div>
                            <div class="row text-center mb-2">
                                <div class="col-4">
                                    <small class="text-muted d-block">Avg</small>
                                    <span class="text-info fw-bold stat-avg">
                                        {{#if this.averageTime}}
                                        {{divide this.averageTime 1000}}s
                                        {{else}}
                                        --
                                        {{/if}}
                                    </span>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted d-block">Min</small>
                                    <span class="text-success fw-bold stat-min">
                                        {{#if this.minTime}}
                                        {{divide this.minTime 1000}}s
                                        {{else}}
                                        --
                                        {{/if}}
                                    </span>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted d-block">Max</small>
                                    <span class="text-danger fw-bold stat-max">
                                        {{#if this.maxTime}}
                                        {{divide this.maxTime 1000}}s
                                        {{else}}
                                        --
                                        {{/if}}
                                    </span>
                                </div>
                            </div>
                            {{#if this.averageRating}}
                            <div class="text-center mt-2 pt-2 border-top border-secondary">
                                <small class="text-muted d-block mb-1">Average Rating</small>
                                <div class="d-flex justify-content-center align-items-center gap-1">
                                    <span class="text-warning fw-bold stat-rating">{{this.averageRating}}</span>
                                    <i class="bi bi-star-fill text-warning"></i>
                                    <small class="text-muted">({{this.totalRatings}} ratings)</small>
                                </div>
                            </div>
                            {{/if}}
                        </div>
                        {{/each}}
                    </div>
                </div>
            </div>
        </div>

        <!-- Test History -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card bg-dark border-secondary">
                    <div class="card-header bg-secondary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Recent Test History</h5>
                            <button class="btn btn-sm btn-outline-light" onclick="loadHistory()">
                                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-dark table-hover" id="historyTable">
                            <thead>
                                <tr>
                                    <th style="width: 120px;">Video</th>
                                    <th>Model</th>
                                    <th>Prompt</th>
                                    <th>Duration</th>
                                    <th>Time</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                {{#each recentTests}}
                                <tr>
                                    <td>
                                        {{#if this.videos.length}}
                                        <video class="history-video cursor-pointer" 
                                               onclick="previewHistoryVideo('{{this.videos.[0].videoUrl}}', '{{this.modelName}}', {{this.generationTime}}, '{{this._id}}')"
                                               muted>
                                            <source src="{{this.videos.[0].videoUrl}}" type="video/mp4">
                                        </video>
                                        {{else}}
                                        <span class="text-muted">--</span>
                                        {{/if}}
                                    </td>
                                    <td>{{this.modelName}}</td>
                                    <td>
                                        <span class="text-truncate" style="max-width: 200px; display: inline-block;" title="{{this.prompt}}">{{this.prompt}}</span>
                                    </td>
                                    <td>{{this.params.duration}}s</td>
                                    <td>{{#if this.generationTime}}{{divide this.generationTime 1000}}s{{else}}--{{/if}}</td>
                                    <td>
                                        {{#if (eq this.status "completed")}}
                                        <span class="badge bg-success">Completed</span>
                                        {{else if (eq this.status "failed")}}
                                        <span class="badge bg-danger">Failed</span>
                                        {{else}}
                                        <span class="badge bg-warning">{{this.status}}</span>
                                        {{/if}}
                                    </td>
                                    <td>{{formatDate this.testedAt}}</td>
                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Video Preview Modal -->
    <div class="modal fade" id="videoPreviewModal" tabindex="-1" aria-labelledby="videoPreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="videoPreviewModalLabel">Video Preview</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <video id="previewVideo" controls class="img-fluid rounded" style="max-height: 70vh;">
                        <source id="previewVideoSource" src="" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    <div class="mt-3">
                        <p id="previewModelName" class="mb-1"></p>
                        <p id="previewTime" class="text-muted mb-0"></p>
                        <div class="mt-3">
                            <label class="form-label text-white mb-2">Rate this video:</label>
                            <div class="rating-stars d-flex justify-content-center gap-1" id="ratingStars">
                                <i class="bi bi-star rating-star" data-rating="1" data-bs-toggle="tooltip" title="1 star"></i>
                                <i class="bi bi-star rating-star" data-rating="2" data-bs-toggle="tooltip" title="2 stars"></i>
                                <i class="bi bi-star rating-star" data-rating="3" data-bs-toggle="tooltip" title="3 stars"></i>
                                <i class="bi bi-star rating-star" data-rating="4" data-bs-toggle="tooltip" title="4 stars"></i>
                                <i class="bi bi-star rating-star" data-rating="5" data-bs-toggle="tooltip" title="5 stars"></i>
                            </div>
                            <small class="text-muted d-block mt-2" id="ratingStatus">Click a star to rate</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {{> dashboard-footer}}
    <script>
        // Pricing configuration passed from server
        window.PRICING = {
            videoCostPerUnit: {{videoCostPerUnit}},
            userPoints: {{userPoints}}
        };
    </script>
    <script src="/js/dashboard-video.js"></script>
</body>
</html>
