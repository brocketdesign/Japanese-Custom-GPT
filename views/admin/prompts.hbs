<!DOCTYPE html>
<html lang="en">
<head>
  {{> dashboard-header}}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="/css/user-analytics.css">
  <style>
    /* Sortable styles */
    .sortable-ghost {
      opacity: 0.4;
      background-color: #f0f0f0;
    }
    .sortable-chosen {
      /* Styles for the chosen item */
    }
    .handle {
      cursor: grab;
    }
    /* Action button styles */
    .action-btn {
      cursor: pointer;
      transition: transform 0.2s ease-in-out;
    }
    .action-btn:hover {
      transform: scale(1.1);
    }
    /* Inline editing styles */
    .editable-cell {
      cursor: text;
      position: relative;
    }
    .editable-cell:hover {
      background-color: #f9fafb;
      outline: 1px dashed #d1d5db;
    }
    .editable-cell:focus {
      outline: 2px solid #0d6efd;
      background-color: #ffffff;
    }
    .saving-indicator {
      opacity: 0.5;
      pointer-events: none;
    }
    .nsfw-toggle {
      cursor: pointer;
      user-select: none;
    }
    .nsfw-toggle:hover {
      opacity: 0.8;
    }
  </style>
</head>
<body class="bg-light">
{{> dashboard-nav}}

<div class="analytics-wrapper">
  <div class="container-fluid px-4 py-4">
    <!-- Header Section -->
    <div class="dashboard-header-section mb-4">
      <div class="row align-items-center">
        <div class="col-md-6">
          <div class="page-title-wrapper">
            <div class="icon-wrapper">
              <i class="bi bi-chat-dots-fill"></i>
            </div>
            <div>
              <h1 class="dashboard-title mb-1">Prompts Management</h1>
              <p class="text-muted mb-0">Create and manage your AI prompts</p>
            </div>
          </div>
        </div>
        <div class="col-md-6 text-md-end mt-3 mt-md-0">
          <button id="reorderPromptsBtn" class="btn btn-outline-success me-2">
            <i class="bi bi-arrow-down-up me-2"></i>Change Order
          </button>
          <button id="newPromptBtn" class="btn btn-primary btn-shadow">
            <i class="bi bi-plus-circle me-2"></i>New Prompt
          </button>
        </div>
      </div>
    </div>

    <!-- Table Section -->
    <div class="section-header mb-3">
      <h5 class="section-title">
        <i class="bi bi-table me-2"></i>All Prompts
      </h5>
    </div>

    <!-- Prompts Table -->
    <div class="chart-card card-shadow">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th class="text-start">Order</th>
              <th class="text-start">Image</th>
              <th class="text-start">Title</th>
              <th class="text-start">Prompt</th>
              <th class="text-start">Cost</th>
              <th class="text-start">NSFW</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody id="promptsTableBody" class="text-gray-700 text-sm">
            {{! Prompts will be rendered here by JavaScript }}
          </tbody>
        </table>
      </div>
      <div id="emptyState" class="text-center py-5" style="display: none;">
        <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
        <p class="text-muted mt-3 mb-0">No prompts found. Create your first prompt to get started.</p>
      </div>
    </div>
  </div>
</div>

<!-- Reorder Modal -->
<div id="reorderModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="reorderModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reorderModalLabel">
          <i class="bi bi-arrow-down-up me-2"></i>Reorder Prompts
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="reorderPromptsGrid" class="row g-3">
          {{! Prompt items will be dynamically inserted here for reordering }}
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveOrderBtn">
          <i class="bi bi-check-circle me-2"></i>Save Order
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Preview Modal -->
<div id="previewModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="previewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="previewModalLabel">
          <i class="bi bi-eye me-2"></i>Prompt Preview
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <img id="previewImage" src="" alt="Preview" class="img-fluid rounded mb-3">
        <h5 id="previewTitle" class="fw-bold text-dark mb-2"></h5>
        <p id="previewPrompt" class="text-muted small"></p>
      </div>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content modal-dialog-scrollable">
      <div class="modal-header">
        <h5 class="modal-title" id="editModalLabel">
          <i class="bi bi-pencil-square me-2"></i>Edit Prompt
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editForm" enctype="multipart/form-data">
        <div class="modal-body space-y-4">
          <input type="hidden" id="editId" name="id">
          <div class="mb-3">
            <label for="editTitle" class="form-label">Title</label>
            <input type="text" class="form-control" id="editTitle" name="title" required>
          </div>
          <div class="mb-3">
            <label for="editPrompt" class="form-label">Prompt</label>
            <textarea class="form-control" id="editPrompt" name="prompt" rows="8" required></textarea>
          </div>
          <div class="mb-3">
            <label for="editImage" class="form-label">Image (Upload to change)</label>
            <input type="file" class="form-control" id="editImage" name="image" accept="image/*">
          </div>
          <div class="mb-3">
            <label for="editGender" class="form-label">Gender</label>
            <select class="form-select" id="editGender" name="gender">
              <option value="female">Female</option>
              <option value="male">Male</option>
              <option value="nonBinary">Non-Binary</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="editCost" class="form-label">Cost</label>
            <input type="number" class="form-control" id="editCost" name="cost" min="0" step="0.01" placeholder="0.00">
          </div>
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="editNsfw" name="nsfw">
            <label class="form-check-label" for="editNsfw">NSFW</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-circle me-2"></i>Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-danger" id="deleteConfirmModalLabel">
          <i class="bi bi-exclamation-triangle me-2"></i>Confirm Delete
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">Are you sure you want to delete this prompt? This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
          <i class="bi bi-trash me-2"></i>Delete
        </button>
      </div>
    </div>
  </div>
</div>

<!-- New Prompt Modal -->
<div class="modal fade" id="newPromptModal" tabindex="-1" aria-labelledby="newPromptModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newPromptModalLabel">
          <i class="bi bi-plus-circle me-2"></i>Create New Prompt
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="newPromptForm" enctype="multipart/form-data">
        <div class="modal-body space-y-4">
          <div class="mb-3">
            <label for="newTitle" class="form-label">Title <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="newTitle" name="title" required>
          </div>
          <div class="mb-3">
            <label for="newPrompt" class="form-label">Prompt <span class="text-danger">*</span></label>
            <textarea class="form-control" id="newPrompt" name="prompt" rows="8" required></textarea>
          </div>
          <div class="mb-3">
            <label for="newImage" class="form-label">Image <span class="text-danger">*</span></label>
            <input type="file" class="form-control" id="newImage" name="image" accept="image/*" required>
          </div>
          <div class="mb-3">
            <label for="newGender" class="form-label">Gender</label>
            <select class="form-select" id="newGender" name="gender">
              <option value="female">Female</option>
              <option value="male">Male</option>
              <option value="nonBinary">Non-Binary</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="newCost" class="form-label">Cost</label>
            <input type="number" class="form-control" id="newCost" name="cost" min="0" step="0.01" placeholder="0.00">
          </div>
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="newNsfw" name="nsfw">
            <label class="form-check-label" for="newNsfw">NSFW</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-plus-circle me-2"></i>Create Prompt
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3">
  <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto" id="toastTitle">Notification</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="toastMessage">
      <!-- Message will be inserted here -->
    </div>
  </div>
</div>
<style>
  .sticky-bottom, #footer-toolbar {display:none;}
</style>
{{> dashboard-footer}}

<script>
  // Helper function for notifications (using Bootstrap Toast)
  function showNotification(message, type = 'success') {
    const toast = document.getElementById('notificationToast');
    const toastTitle = document.getElementById('toastTitle');
    const toastMessage = document.getElementById('toastMessage');
    
    toastTitle.textContent = type === 'success' ? 'Success' : 'Error';
    toastMessage.textContent = message;
    
    // Add appropriate classes for styling
    toast.className = `toast ${type === 'success' ? 'text-bg-success' : 'text-bg-danger'}`;
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
  }

  // Store prompts data globally for easier access
  let currentPrompts = [];
  let reorderSortable = null;
  let deletePromptId = null;

  function renderPromptsTable(prompts) {
    const tableBody = $('#promptsTableBody');
    const emptyState = $('#emptyState');
    tableBody.empty();
    
    if (!prompts || prompts.length === 0) {
      emptyState.show();
      return;
    }
    
    emptyState.hide();
    
    // Ensure prompts are sorted by the 'order' field before rendering
    const sortedPrompts = prompts.sort((a, b) => (a.order || 0) - (b.order || 0));

    sortedPrompts.forEach(prompt => {
      const row = `
        <tr data-id="${prompt._id}">
          <td class="text-start handle"><i class="bi bi-grip-vertical"></i> ${prompt.order !== undefined ? prompt.order : 'N/A'}</td>
          <td class="text-start"><img src="${prompt.image || '/img/placeholder-image-2.gif'}" alt="${prompt.title}" class="img-thumbnail" style="width: 60px; height: 60px; object-fit: cover;"></td>
          <td class="text-start editable-cell" contenteditable="true" data-field="title" data-id="${prompt._id}" data-type="text">${prompt.title}</td>
          <td class="text-start editable-cell" contenteditable="true" data-field="prompt" data-id="${prompt._id}" data-type="text" style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">${prompt.prompt}</td>
          <td class="text-start editable-cell" contenteditable="true" data-field="cost" data-id="${prompt._id}" data-type="number">${prompt.cost || 0}</td>
          <td class="text-start nsfw-toggle" data-field="nsfw" data-id="${prompt._id}" data-value="${prompt.nsfw || false}">
            <span class="badge ${prompt.nsfw ? 'bg-danger' : 'bg-success'}">
              ${prompt.nsfw ? 'Yes' : 'No'}
            </span>
          </td>
          <td class="text-center">
            <button class="btn btn-sm btn-outline-info action-btn preview-btn" data-id="${prompt._id}" title="Preview">
              <i class="bi bi-eye"></i>
            </button>
            <button class="btn btn-sm btn-outline-primary action-btn edit-btn" data-id="${prompt._id}" title="Edit">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger action-btn delete-btn" data-id="${prompt._id}" title="Delete">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      `;
      tableBody.append(row);
    });
    
    attachActionListeners();
    attachInlineEditListeners();
  }

  // Add inline editing functionality
  function attachInlineEditListeners() {
    $(document).off('blur', '.editable-cell').on('blur', '.editable-cell', function() {
      const $cell = $(this);
      const field = $cell.data('field');
      const id = $cell.data('id');
      const type = $cell.data('type');
      let value = $cell.text().trim();
      
      // Validate number fields
      if (type === 'number') {
        const numValue = parseFloat(value);
        if (isNaN(numValue) || numValue < 0) {
          showNotification('Invalid value. Please enter a valid number.', 'error');
          const originalPrompt = currentPrompts.find(p => p._id === id);
          if (originalPrompt) {
            $cell.text(originalPrompt[field] || 0);
          }
          return;
        }
        value = numValue;
      }
      
      // Check if value actually changed
      const originalPrompt = currentPrompts.find(p => p._id === id);
      if (originalPrompt && originalPrompt[field] === value) {
        return; // No change, don't save
      }
      
      savePromptFieldUpdate(id, field, value, $cell);
    });

    // Handle NSFW toggle clicks
    $(document).off('click', '.nsfw-toggle').on('click', '.nsfw-toggle', function() {
      const $toggle = $(this);
      const id = $toggle.data('id');
      const currentValue = $toggle.data('value') === 'true' || $toggle.data('value') === true;
      const newValue = !currentValue;
      
      savePromptFieldUpdate(id, 'nsfw', newValue, $toggle);
    });

    // Prevent Enter key from creating new lines in single-line fields
    $(document).off('keydown', '.editable-cell').on('keydown', '.editable-cell', function(e) {
      const field = $(this).data('field');
      if (field === 'title' || field === 'cost') {
        if (e.key === 'Enter') {
          e.preventDefault();
          $(this).blur();
        }
      }
    });
  }

  function savePromptFieldUpdate(id, field, value, $element) {
    $element.addClass('saving-indicator');
    
    const data = {};
    data[field] = value;
    
    $.ajax({
      url: `/api/prompts/${id}/field`,
      type: 'PATCH',
      data: JSON.stringify(data),
      contentType: 'application/json',
      success: function(updatedPrompt) {
        const index = currentPrompts.findIndex(p => p._id === id);
        if (index !== -1) {
          currentPrompts[index] = updatedPrompt;
        }
        
        // Update NSFW toggle display if needed
        if (field === 'nsfw') {
          const $span = $element.find('span');
          $span.removeClass('bg-danger bg-success');
          if (value) {
            $span.addClass('bg-danger').text('Yes');
          } else {
            $span.addClass('bg-success').text('No');
          }
          $element.data('value', value);
        }
        
        $element.removeClass('saving-indicator');
        showNotification(`${field === 'nsfw' ? 'NSFW status' : field === 'prompt' ? 'Prompt' : field === 'cost' ? 'Cost' : 'Title'} updated successfully.`, 'success');
      },
      error: function() {
        $element.removeClass('saving-indicator');
        
        const originalPrompt = currentPrompts.find(p => p._id === id);
        if (originalPrompt) {
          if (field !== 'nsfw') {
            $element.text(originalPrompt[field] || '');
          }
        }
        
        showNotification(`Error updating ${field}.`, 'error');
      }
    });
  }

  function attachActionListeners() {
    $(document).off('click', '.preview-btn').on('click', '.preview-btn', function(e) {
      e.preventDefault();
      e.stopPropagation();
      const id = $(this).data('id');
      $.ajax({
        url: '/api/prompts/' + id,
        type: 'GET',
        success: function(prompt) {
          $('#previewImage').attr('src', prompt.image || '/img/placeholder-image-2.gif');
          $('#previewTitle').text(prompt.title);
          $('#previewPrompt').text(prompt.prompt);
          const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
          previewModal.show();
        },
        error: function() {
          showNotification('Error loading prompt preview.', 'error');
        }
      });
    });

    $(document).off('click', '.edit-btn').on('click', '.edit-btn', function(e) {
      e.preventDefault();
      e.stopPropagation();
      const id = $(this).data('id');
      $.ajax({
        url: '/api/prompts/' + id,
        type: 'GET',
        success: function(prompt) {
          $('#editId').val(prompt._id);
          $('#editTitle').val(prompt.title);
          $('#editPrompt').val(prompt.prompt);
          $('#editGender').val(prompt.gender || 'female');
          $('#editCost').val(prompt.cost || 0);
          $('#editNsfw').prop('checked', prompt.nsfw || false);
          const editModal = new bootstrap.Modal(document.getElementById('editModal'));
          editModal.show();
        },
        error: function() {
          showNotification('Error loading prompt.', 'error');
        }
      });
    });

    $(document).off('click', '.delete-btn').on('click', '.delete-btn', function(e) {
      e.preventDefault();
      e.stopPropagation();
      deletePromptId = $(this).data('id');
      const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
      deleteModal.show();
    });

    $('#reorderPromptsBtn').off('click').on('click', function() {
      const grid = $('#reorderPromptsGrid');
      grid.empty();
      const sortedPromptsForModal = [...currentPrompts].sort((a, b) => (a.order || 0) - (b.order || 0));

      sortedPromptsForModal.forEach(prompt => {
        const item = `
          <div class="col-sm-6 col-md-4 col-lg-3">
            <div class="card" data-id="${prompt._id}" style="cursor: grab;">
              <img src="${prompt.image || '/img/placeholder-image-2.gif'}" class="card-img-top" alt="${prompt.title}" style="height: 150px; object-fit: cover;">
              <div class="card-body p-2">
                <h6 class="card-title text-truncate">${prompt.title}</h6>
                <small class="text-muted">Order: ${prompt.order || 'N/A'}</small>
              </div>
            </div>
          </div>
        `;
        grid.append(item);
      });

      if (reorderSortable) {
        reorderSortable.destroy();
      }
      reorderSortable = new Sortable(document.getElementById('reorderPromptsGrid'), {
        animation: 150,
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
      });
      const reorderModal = new bootstrap.Modal(document.getElementById('reorderModal'));
      reorderModal.show();
    });

    $('#saveOrderBtn').off('click').on('click', function() {
      if (!reorderSortable) return;
      const orderedIds = reorderSortable.toArray();

      $.ajax({
        url: '/api/prompts/reorder',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ orderedIds: orderedIds }),
        success: function(response) {
          currentPrompts = response.sort((a, b) => (a.order || 0) - (b.order || 0));
          renderPromptsTable(currentPrompts);
          bootstrap.Modal.getInstance(document.getElementById('reorderModal')).hide();
          showNotification('Prompts reordered successfully.', 'success');
        },
        error: function(xhr) {
          showNotification('Error reordering prompts.', 'error');
        }
      });
    });
  }

  $(document).ready(function() {
    $.ajax({
      url: '/api/prompts',
      type: 'GET',
      success: function(prompts) {
        currentPrompts = prompts.sort((a, b) => (a.order || 0) - (b.order || 0));
        renderPromptsTable(currentPrompts);
      },
      error: function() {
        showNotification('Error fetching prompts.', 'error');
        renderPromptsTable([]);
      }
    });

    $('#newPromptBtn').on('click', function() {
      const newPromptModal = new bootstrap.Modal(document.getElementById('newPromptModal'));
      newPromptModal.show();
    });

    // Handle delete confirmation
    $('#confirmDeleteBtn').on('click', function() {
      if (deletePromptId) {
        $.ajax({
          url: '/api/prompts/' + deletePromptId,
          type: 'DELETE',
          success: function() {
            showNotification('Prompt deleted successfully.', 'success');
            currentPrompts = currentPrompts.filter(p => p._id !== deletePromptId);
            renderPromptsTable(currentPrompts);
            bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
          },
          error: function() {
            showNotification('Error deleting prompt.', 'error');
          }
        });
      }
    });

    // Handle new prompt form submission
    $('#newPromptForm').on('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      $.ajax({
        url: '/api/prompts/create',
        type: 'POST',
        data: formData,
        contentType: false,
        processData: false,
        success: function() {
          showNotification('Prompt created successfully.', 'success');
          bootstrap.Modal.getInstance(document.getElementById('newPromptModal')).hide();
          setTimeout(() => location.reload(), 1500);
        },
        error: function() {
          showNotification('Error creating prompt.', 'error');
        }
      });
    });

    $('#editForm').on('submit', function(e) {
      e.preventDefault();
      const id = $('#editId').val();
      const formData = new FormData(this);

      if ($('#editImage')[0].files.length === 0) {
        formData.delete('image');
      }

      $.ajax({
        url: '/api/prompts/' + id,
        type: 'PUT',
        data: formData,
        processData: false,
        contentType: false,
        success: function(updatedPrompt) {
          const index = currentPrompts.findIndex(p => p._id === id);
          if (index !== -1) {
            currentPrompts[index] = updatedPrompt;
          }
          renderPromptsTable(currentPrompts);
          bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
          showNotification('Prompt updated successfully.', 'success');
        },
        error: function() {
          showNotification('Error updating prompt.', 'error');
        }
      });
    });
  });
</script>
</body>
</html>