<!DOCTYPE html>
<html lang="{{user.lang}}">
    {{> dashboard-header}}
<body>
    
    <div class="sidebar-history hidden shadow">
        <div class="d-flex justify-content-between">
            <h5 class="my-2 mx-3">„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥</h5>
            <button type="button" class="btn btn-light history-chat">
                <i class="fas fa-angle-left"></i>
            </button>
        </div>
        <div id="chat-history"></div>
    </div>
    <div class="sidebar hidden bg-light shadow-0 d-flex flex-column">
        <div class="tools d-flex align-items-start flex-column sticky-top bg-light py-2">
            <div class="d-none w-100 m-2">
                <button class="menu-chat-sm d-sm-none btn bg-white shadow-0"><i class="fa-solid fa-bars"></i></button>
            </div>
            <div>
                <a href="/chat/edit/" class="{{default isAdmin 'd-inline-block'}} m-2 btn px-4 py-2 border shadow-0 btn-outline-secondary" style="border-radius:40px;">
                    <i class="fas fa-plus me-2"></i>{{translations.createCharacter}}
                </a>
                <a href="/discover" class="{{default isAdmin 'd-inline-block'}} m-2 btn px-4 py-2 border shadow-0 btn-outline-secondary" style="border-radius:40px;">
                   <i class="fas fa-compass me-2"></i>{{translations.library}}
                </a>
                <span onclick="showDiscovery()" class="d-none m-2 btn px-4 py-2 border shadow-0 btn-outline-secondary" style="border-radius: 40px;">
                    <i class="fas fa-compass me-2"></i>{{translations.library}}
                </span>
            </div>
            <span class="text-dark ps-4 fw-bold" style="font-size: 12px;">{{translations.chatList}} <span id="user-chat-count" >{{chats.length}}</span></span>
        </div>
        <div id="chat-list" class="mt-1 pb-3" style="flex-grow: 1;overflow-y: scroll;overflow-x: hidden;border-top:1px solid #cccccc6b;">
        </div>
    </div>
    <div id="overlay" class="d-sm-none bg-dark" style="position: fixed; inset: 0; z-index: 1033; display: none; opacity: 0.4; overflow: hidden;"></div>
    <div class="content collapsed">
        <nav class="navbar navbar-expand-lg navbar-white bg-transparent fixed-top shadow-0">
            <div class="container-fluid">
                <div class="d-flex align-items-center justify-content-center m-auto">
                    <div style="position: absolute;left: 20px;top: 10px;">
                        <button class="menu-chat-sm d-sm-none btn btn-light"><i class="fa-solid fa-bars"></i></button>
                        <button id="menu-chat" class="d-none d-sm-inline-block btn btn-light"><i class="fa-solid fa-bars"></i></button>
                    </div>
                    <div class="d-flex flex-row" style="cursor:pointer" onclick="showDiscovery()">
                        <img src="/img/logo.webp" alt="" class="mx-3" width="40px">
                        <span class="d-none">LAMIX„Éú„ÉÉ„Éà</span>
                    </div>   
                </div>
            </div>
        </nav>
        <section id="chat-discovery" class="onchat-off mt-5" style="display: block;">
            {{#if user.isTemporary}}
                    <div class="d-none container mb-3 mt-1">
                        <section class="w-100 px-0 py-2 text-center">
                            <span class="u-font-manrope u-color-grad">{{translations.discover.lamix}}</span>„ÅØ„ÄÅ
                            <p class="pb-3 mb-1" style="color: #555;">
                                {{translations.discover.content}}
                            </p>
                        </section>
                    </div>
            {{else}}
                <section class="container onchat-off">
                    <div class="row justify-content-center">
                        <div class="col-12">
                        <div class="user-profile mt-4">
                            <div class="row mb-3">
            <div id="profileSection" class="text-center">
              <div class="mx-auto p-auto text-center d-flex align-items-center justify-content-center position-relative mb-2">
                <a href="/user/{{user._id}}" class="text-secondary" style="text-decoration: none;;">
                <img id="profileImage" src="{{default userData.profileUrl '/img/avatar.png'}}" alt="{{translations.profile.thumbnailAlt}}" class="rounded-circle" 
                style="width: 100px; height: 100px; object-fit: cover; object-position: top;cursor:pointer;">
                </a>
              </div>
                                <a href="/user/{{user._id}}" class="text-secondary" style="text-decoration: none;;">
                                    <h2>{{user.nickname}}</h2>
                                </a>
              </a>
              <div class="d-flex flex-wrap justify-content-center text-center">
                <div class="mx-2">
                  <h6 class="fw-bold">{{default userData.postCount 0}}</h6>
                  <p class="text-muted small"><i class="bi bi-grid-fill"></i> {{translations.profile.posts}}</p>
                </div>
                <div class="mx-2">
                  <h6 class="fw-bold">{{default userData.imageLikeCount 0}}</h6>
                  <p class="text-muted small"><i class="bi bi-heart-fill"></i> {{translations.profile.likes}}</p>
                </div>
                <div class="mx-2">
                  <h6 class="fw-bold">{{default userData.chatCount 0}}</h6>
                  <p class="text-muted small">
                    <i class="bi bi-chat-dots-fill"></i> {{translations.profile.characters}}
                  </p>
                </div>
                <div class="mx-2">
                  <h6 class="fw-bold">{{default userData.followCount 0}}</h6>
                  <p class="text-muted small">
                    <a href="/follower/{{userData._id}}?type=following" class="text-decoration-none text-muted ">
                      <i class="bi bi-person-check-fill"></i> {{translations.profile.following}}
                    </a>
                  </p>
                </div>
                <div class="mx-2">
                  <h6 class="fw-bold">{{default userData.followerCount 0}}</h6>
                  <p class="text-muted small">
                    <a href="/follower/{{userData._id}}?type=followers" class="text-decoration-none text-muted ">
                      <i class="bi bi-people-fill"></i> {{translations.profile.followers}}
                    </a>
                  </p>
                </div>
              </div>
            </div>
                            </div>
                        </div>
                        </div>
                    </div>
                </section>
            {{/if}}
            <!-- Image Style Selection -->
            <div id="imageStyleSelection" class="d-none">
                <img src="/img/anime.jpeg" alt="„Ç¢„Éã„É°" class="style-option rounded selected" data-style="anime" data-model="novaAnimeXL_ponyV20_461138" data-version="sdxl">
                <img src="/img/real.jpeg" alt="ÂΩºÂ•≥" class="style-option rounded" data-style="realistic" data-model="kanpiromix_v20" data-version="sd">
                <img src="/img/real-2.jpeg" alt="„É™„Ç¢„É´" class="style-option rounded" data-style="realistic" data-model="ponyRealism_v22MainVAE_822476" data-version="sdxl">
            </div>

            <div class="col-auto">
                <ul class="nav nav-tabs justify-content-center" style="overflow-x: scroll; overflow-y: hidden; flex-wrap: nowrap;" id="imageStyleTabs" role="tablist">
                    <!-- Tabs will be dynamically generated here -->
                </ul>
            </div>


            <!-- Content Section -->
            <section>
                <div id="chat-gallery" class="row mx-0"></div>
                <div id="chat-pagination-controls" class="d-flex justify-content-center my-3"></div>
            </section>


            <section class="d-none is-free-user my-2" style="display: none;">
                <div class="container text-center">
                    <h2 class="pricing-title fw-bold"><span class="u-font-manrope u-color-grad">Lamix</span>„Éó„É¨„Éü„Ç¢„É†„Éó„É©„É≥</h2>   
                    <h3 class="fw-bold mb-1 px-3">ÁÑ°Âà∂Èôê„Åß„ÅäÂæó</h3>
                    <h3 class="fw-bold mb-1 px-3 u-font-manrope u-color-grad my-5">Ôø•300ÂÜÜ</h3>
                </div>
                <div class="d-none is-free-user sticky-bottom py-2 mx-auto text-center" style="display:none;bottom:0;left:0;right:0;">
                    <a href="/my-plan" class="m-2 btn border shadow-0 btn-secondary px-5 py-2 m-auto" style="border-radius:40px;background: linear-gradient(90.9deg, rgba(110, 32, 244, 0.5) 2.74%, #6E20F4 102.92%);">
                        <i class="fas fa-plus me-2"></i>„Éó„É©„É≥„ÅÆË©≥Á¥∞„ÇíÁ¢∫Ë™ç„Åô„Çã
                    </a>
                </div>
            </section>
        </section>
        <div class="container chat-contain px-0 onchat-on">
            <div id="chat-container" class="card shadow-0 border-0 rounded-0" style="background-position: top center;background-repeat: no-repeat;">
                <div class="card-body text-center py-0 container" style="min-height:250px;overflow-y:hidden;display: flex;flex-direction: column;">
                    <div id="chat-recommend" class="text-white rounded d-flex align-items-center justify-content-start scroll-horizontal" style="margin-top: 70px !important;margin-bottom:10px;min-height: 70px;">
                        <div class="characters" style="display: flex;flex-direction: row;overflow-x: scroll;"></div>
                    </div>
                    <div style="flex-grow:1;height: 100%;overflow: scroll;">
                        <div id="chatContainer" class="pt-2 fade-content" style="padding-bottom: 150px !important;"></div>
                        <div id="chatInput" class="input-group rounded-0 rounded-bottom" style="position: absolute;bottom: 0;left: 0;right: 0;padding: 0px 15px 5px 15px;">
                            <div class="d-flex justify-content-between align-items-center w-100">
                                <div>
                                    <button type="button" class="btn btn-md bg-light shadow-0 border-0 mb-2 mx-1" id="audio-play" style="display: none;">
                                        <i class="fa" id="audio-icon"></i>
                                    </button>
                                    <button type="button" class="btn btn-md bg-dark text-white shadow-0 border-0 mb-2 mx-1" id="galleries-open" style="display: none;opacity:0.8;">
                                        <i class="fas fa-th-large"></i>
                                    </button>
                                </div>
                                <div class="d-flex pe-2">
                                    <button class="d-none btn btn-dark border-light shadow-0 mx-1 my-1 img-gen-button" id="stability-gen-button-none" style="display:none;background-image:url('/img/sd.jpg')"><i class="fa fa-spinner fa-spin fa-fw fa-hidden" style="display: none;"></i><i class="far fa-image"></i></button>
                                    <button class="d-none btn btn-dark border-light shadow-0 mx-1 my-1 img-gen-button" id="novita-gen-button-none" style="display:none;background-image:url('/img/novita.jpg')"><i class="fa fa-spinner fa-spin fa-fw fa-hidden" style="display: none;"></i><i class="far fa-image"></i></button>
                                    <button type="button" class="d-none btn btn-md custom-gradient-bg danger shadow-0 border-0 mb-2 mx-1 auto-gen" id="novita-gen-button" style="display: none;">
                                        <div class="d-flex">
                                            <i class="fa fa-spinner fa-spin fa-fw fa-hidden" style="display: none;"></i>
                                            <i class="fa fa-image me-2"></i>
                                            Êàê‰∫∫Âêë„ÅëÁîªÂÉè
                                        </div>
                                    </button>
                                    <button type="button" class="d-none btn btn-md custom-gradient-bg shadow-0 border-0 mb-2 mx-1 auto-gen-none" id="huggingface-gen-button" style="display: none;">
                                        <div class="d-flex">
                                            <i class="fa fa-spinner fa-spin fa-fw fa-hidden" style="display: none;"></i>
                                            <i class="fa fa-image me-2"></i>
                                            AIÁîªÂÉè
                                        </div>
                                    </button>
                                    <div id="progress-container" style="position: absolute; width: 44px; height: 100px;bottom: 50px;right: 10px;display:none;">
                                    </div>
                                </div>
                            </div>

                            <div id="input-container" class="d-flex w-100">
                                <button id="gen-ideas" class="d-none btn btn-light px-4 border-0">üí°</button>
                                <button id="showPrompts" class="btn custom-gradient-bg px-4 border-0" data-bs-toggle="tooltip" data-bs-placement="top" title="{{translations.generateImage}}"> 
                                    <i class="bi bi-magic"></i>
                                </button>
                                <textarea id="userMessage" class="form-control py-3 border-0" placeholder="„ÉÅ„É£„ÉÉ„Éà„Åó„Çà„ÅÜ"></textarea>
                                <button id="sendMessage" class="btn btn-light px-4 border-0"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>  
    </div>

 {{> dashboard-footer}}
<script src="/js/chat.js"></script>
<script src="/js/discovery.js"></script>
<script src="/js/stability.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
<script src="https://js.stripe.com/v3/"></script>
<script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const styleSelection = document.getElementById('imageStyleSelection');
    const tabNav = document.getElementById('imageStyleTabs');

    if (styleSelection && tabNav) {
        const styleOptions = styleSelection.querySelectorAll('.style-option');

        styleOptions.forEach((option, index) => {
            const style = option.getAttribute('data-style');
            const model = option.getAttribute('data-model');
            const version = option.getAttribute('data-version');
            const imgSrc = option.getAttribute('src');
            const altText = option.getAttribute('alt');

            const isActive = index === 0 ? 'active' : '';

            const tabItem = `
                <li class="nav-item" role="presentation">
                    <button class="nav-link ${isActive}" id="${style}-tab" data-style="${model}" data-version="${version}" type="button" role="tab">
                        <img src="${imgSrc}" alt="${altText}" class="tab-thumb thumb-option rounded me-2">
                        <span class="d-none">${altText}</span>
                    </button>
                </li>
            `;
            tabNav.innerHTML += tabItem;
        });

        $('#imageStyleSelection').remove()
    }
});

$(document).ready(function() {
    const user = {{{json user}}}

    let imageType = `{{imageType}}` != 'false' ? `{{imageType}}` : false
    imageType = imageType ? imageType : localStorage.getItem('imageType')
    imageType = imageType ? imageType : 'kanpiromix_v20'

    // Handle tab clicks
    $('#imageStyleTabs button').on('click', function () {
        $('#chat-gallery').empty()
        // Remove 'active' class from all tabs
        $('#imageStyleTabs button').removeClass('active');
        // Add 'active' class to the clicked tab
        $(this).addClass('active');

        var style = $(this).data('style');
        localStorage.setItem('imageType',style)
        displayPeopleChat(1, style);
    });
    $(`#imageStyleTabs button[data-style="${imageType}"]`).click()
    function adjustHeight() {
        const newHeight = $(window).height() * 0.97;
        $('.chat-contain .card-body').height(newHeight);
    }
    $(document).ready(adjustHeight);
    $(window).resize(adjustHeight);

    function resizeIframe() {
        var iframe = $('#user-profile-page');
        if(iframe.length == 0 ){return}
        const newHeight = iframe[0].contentWindow.document.body.scrollHeight
        if( newHeight > 0) { iframe.height(newHeight); }
    }  
    window.addEventListener('message', function(event) {
        if (event.data === 'resizeIframe') {
            resizeIframe();
        }
    });

    window.addEventListener('message', function(event) {
        if (event.data.event === 'openChat') {
            redirectToChat(event.data.chatId)
        }
    });

    window.addEventListener('message', function(event) {
        if (event.data.event === 'updatePersona') {
             updatePersona(event.data.personaId,event.data.isAdding)
        }
    });
    
    window.addEventListener('message', function(event) {
        if (event.data.event === 'updateCoins') {
             updateCoins()
        }
    });

    // Initialize user preference from cookie
    if (Cookies.get('sidebarState') === 'expanded') {
        $('.sidebar').removeClass('hidden');
        $('.content').removeClass('collapsed');
        $('nav.navbar').addClass('move');
        $('#overlay').show()
    }
    $('#menu-chat').on('click', function(){

        $('.sidebar-history').addClass('hidden');
        const sidebar = $('.sidebar');
        const content = $('.content');
        const navbar = $('nav.navbar');
        const stickyBottom = $('.sticky-bottom')
        if (sidebar.hasClass('hidden')) {
            sidebar.removeClass('hidden');
            content.removeClass('collapsed');
            navbar.addClass('move');
            stickyBottom.addClass('move');
            $('#overlay').show()
        } else {
            sidebar.addClass('hidden');
            content.addClass('collapsed');
            navbar.removeClass('move');
            stickyBottom.removeClass('move');
            $('#overlay').hide()
        }
        
        // Update the cookie based on the new state
        if ($('.sidebar').hasClass('hidden')) {
            Cookies.set('sidebarState', 'collapsed', { expires: 7 }); // Cookie expires in 7 days
        } else {
            Cookies.set('sidebarState', 'expanded', { expires: 7 });
        }
    });
    $(document).on('click','.history-chat', function(){
        const chatId = $(this).data('id')
        const userId = $(this).data('user')
        if(chatId && userId){ 
            getUserChatHistory(chatId, userId) 
        }
        $('.sidebar-history').toggleClass('hidden');
        $('.sidebar').removeClass('hidden');
        $('.content').removeClass('collapsed');
        $('nav.navbar').addClass('move');
        $('#overlay').toggle()
        $('.content').toggleClass('noscroll');
    })
    $('.menu-chat-sm').on('click', function(){
        $('.sidebar').toggleClass('hidden');
        $('#overlay').toggle()
        $('.content').toggleClass('noscroll');
    });
    $('#overlay').on('click', function(){
        $('#overlay').toggle()
        $('.sidebar').toggleClass('hidden');
        $('.sidebar-history').addClass('hidden');
        $('.content').toggleClass('noscroll');
        // Update the cookie based on the new state
        if ($('.sidebar').hasClass('hidden')) {
            Cookies.set('sidebarState', 'collapsed', { expires: 7 }); // Cookie expires in 7 days
        } else {
            Cookies.set('sidebarState', 'expanded', { expires: 7 });
        }
    });

    $(document).on('click', '#gen-ideas', function() {
        const isTemporary = $('body').attr('data-temporary-user') === 'true';
        if($('#chat-widget-container').length == 0 && isTemporary){
            showRegistrationForm(); return;
        }

        const is_chatId = $(this).attr('data-chat-id');
        const is_userId = $(this).attr('data-user-id');
        const is_userChatId = $(this).attr('data-user-chat-id');
        if(is_userChatId == "false"){
            return
        }
        if($(this).hasClass('limit')){
            showUpgradePopup('chat-message-ideas');
            return
        }
        Swal.fire({
            html: `
                <div id="ideas-container" class="text-white pt-2 px-3 w-100" style="min-height:200px;">
                    <h5 class="mb-0">„Çπ„Éû„Éº„Éà„É™„Éó„É©„Ç§</h5>
                    <span id="messageIdeasLimit" class="text-muted" style="font-size:12px;opacity:0">ÊØéÊó•„ÅÆÁÑ°Êñô‰ΩøÁî®ÂõûÊï∞</span>
                    <hr class="my-1">
                    <ul class="list-unstyled list-group mb-0">
                        <li class="loading-placeholder list-group-item idea-item text-white text-start rounded my-1 py-2" style="cursor:pointer;background:#bfbfbf47;font-size:14px;">
                            <img src="/img/load-dot.gif" style="width:30px">
                        </li>
                        <li class="loading-placeholder list-group-item idea-item text-white text-start rounded my-1 py-2" style="cursor:pointer;background:#bfbfbf47;font-size:14px;">
                            <img src="/img/load-dot.gif" style="width:30px">
                        </li>
                        <li class="loading-placeholder list-group-item idea-item text-white text-start rounded my-1 py-2" style="cursor:pointer;background:#bfbfbf47;font-size:14px;">
                            <img src="/img/load-dot.gif" style="width:30px">
                        </li>
                    </ul>
                </div>
            `,
            showClass: { popup: 'animate__animated animate__slideInUp animate__faster' },
            hideClass: { popup: 'animate__animated animate__slideOutDown animate__faster' },
            position: 'bottom', backdrop: 'rgba(43, 43, 43, 0.2)',
            showCloseButton: true, showConfirmButton: false,
            customClass: { container: 'p-0', popup: 'gen-idea-container shadow', closeButton: 'position-absolute' }
        });

        if ($('#gen-ideas').hasClass('done')) {
            $('#ideas-container ul').html($('#gen-ideas').data('savedContent'));
        } else {
            $('#gen-ideas').addClass('done');
            $.ajax({
                url: `${localStorage.getItem('API_URL')}/api/openai-chat-choice/`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ userId: is_userId, userChatId: is_userChatId, chatId: is_chatId }),
                success: function(response) {
                    let ideasList = response.map(content => `
                        <li class="list-group-item idea-item text-white rounded my-1" style="cursor:pointer;background:#bfbfbf47;font-size:14px;" onclick="sendMessage('${content}')">
                            ${content}
                        </li>`).join('');
                    $('.loading-placeholder').remove();
                    $('#ideas-container ul').append(ideasList);
                    $('#gen-ideas').data('savedContent', ideasList);
                },
                error: function(xhr, status, error) {
                    if (xhr.responseJSON && xhr.responseJSON.limitIds?.includes(4)) {
                        $('#gen-ideas').addClass('limit');
                        showUpgradePopup('chat-message-ideas');
                    }
                }
            });
        }
          // Display user limits
        $.get('/user/limit/'+is_userId,function(data){
            data = data.limits
            let limitMess = data.messageIdeasLimit == 'ÁÑ°Âà∂Èôê' ? data.messageIdeasLimit : `ÊØéÊó•„ÅÆÁÑ°Êñô‰ΩøÁî®ÂõûÊï∞: ${data.messageIdeasLimit}/${data.messageIdeasLimit}`
            if(data.messageIdeasCountDoc){
                limitMess = data.messageIdeasCountDoc.limit == 'ÁÑ°Âà∂Èôê' ? data.messageIdeasCountDoc.limit : `ÊØéÊó•„ÅÆÁÑ°Êñô‰ΩøÁî®ÂõûÊï∞: ${parseInt(data.messageIdeasLimit - data.messageIdeasCountDoc.count)}/${data.messageIdeasCountDoc.limit}`
            }
            $('#messageIdeasLimit').html(limitMess).css('opacity',1)
        })
    });

    $(document).on('click', '.chart-button, .chatbot-image-chat', function(e) {
        e.preventDefault();
        e.stopPropagation();
        // data-idÂ±ûÊÄß„Åã„Çâ„ÉÅ„É£„ÉÉ„ÉàID„ÇíÂèñÂæó
        var chatId = $(this).data('id');
        const user = {{{json user}}}
        const userId = user._id
        // POST„É™„ÇØ„Ç®„Çπ„Éà„ÇíÈÄÅ‰ø°
        $.post('/api/chat-analyze/', { chatId: chatId, userId })
            .done(function(response) {
                // Âèó„ÅëÂèñ„Å£„Åü„Éá„Éº„Çø„ÅÆÈï∑„Åï„ÇíÂèñÂæó
                var dataLength = response.total;
                // SweetAlert2„Åß„Ç¢„É©„Éº„Éà„ÇíË°®Á§∫
                Swal.fire({
                    html: `
                        <div class="card border-0 shadow-0">
                            <div class="card-body">
                                <h5 class="card-title">${response.chat.name}</h5>
                                <p class="card-text text-muted" style="font-size: 16px;">${response.chat.description}</p>
                                <p class="card-text text-muted d-none" style="font-size: 14px;">‰ΩúÊàêËÄÖ: ${response.author}</p>
                                <div class="d-flex justify-content-between mb-3">
                                    <div class="card-text text-center w-100 d-none" style="flex-direction: column;"><span class="w-100">${response.chat.rating ? response.chat.rating : '...'}</span><span class="text-muted" style="font-size: 12px;">Ë©ï‰æ°</span></div>
                                    <div class="card-text text-center d-flex w-100" style="flex-direction: column;" ><span class="w-100">${response.chat.category ? response.chat.category : '...'}</span><span class="text-muted" style="font-size: 12px;">„Ç´„ÉÜ„Ç¥„É™„Éº</span></div>
                                    <div class="card-text text-center d-flex w-100" style="flex-direction: column;" ><span class="w-100">${response.total ? response.total : '0'}</span><span class="text-muted" style="font-size: 12px;">‰ºöË©±„ÅÆÂêàË®à</span></div>
                                </div>
                                <a href="/chat/${response.chat._id}" class="btn btn-dark w-100 my-4" style="border-radius:50px;">„ÉÅ„É£„ÉÉ„Éà„ÇíÂßã„ÇÅ„Çã</a>
                            </div>
                        </div>
                    `,
                    imageUrl: response.chat.chatImageUrl || response.chat.thumbnailUrl ||'/img/logo.webp',
                    imageWidth: 'auto',
                    imageHeight: 75,
                    imageAlt: 'Thumbnail',
                    showCloseButton: true,
                    showConfirmButton: false,
                    showClass: {
                        popup: 'swal2-bottom-slide-in'
                    },
                    hideClass: {
                        popup: 'swal2-bottom-slide-out'
                    },
                    customClass: {
                        popup: 'animated fadeInDown chatbot-info-card',
                        image: 'swal-image analyze'
                    }
                });
            })
            .fail(function() {
                // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
                Swal.fire({
                    title: '„Ç®„É©„Éº',
                    text: '„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ',
                    icon: 'error'
                });
            });
    });
    $(document).on('click', '.assistant-image-box', function(e) {
        e.preventDefault();
        e.stopPropagation();

        const images = $('.assistant-image-box img').map(function() {
            return $(this).attr('src');
        }).get();

        const clickedImageUrl = $(this).find('img').attr('src') || $(this).attr('data-src');
        const initialSlideIndex = images.indexOf(clickedImageUrl);

        let slides = '';
        images.forEach(imageUrl => {
            slides += `<div class="swiper-slide"><img src="${imageUrl}" style="width: 100%;object-fit: contain;max-height:90vh"></div>`;
        });

        Swal.fire({
            html: `
                <div class="swiper-container">
                    <div class="swiper-wrapper">
                        ${slides}
                    </div>
                    <div class="swiper-button-next text-white" style="opacity:0.8;"></div>
                    <div class="swiper-button-prev text-white" style="opacity:0.8;"></div>
                </div>
            `,
            showCloseButton: true,
            showConfirmButton: false,
            width: '100%',
            height: '100vh',
            background: 'rgba(0,0,0,0.85)',
            customClass: {
                popup: 'bg-transparent animated-popup image-preview p-0',
                htmlContainer: 'bg-transparent'
            },
            showClass: {
                popup: 'animate__animated animate__fadeIn'
            },
            hideClass: {
                popup: 'animate__animated animate__fadeOut'
            },
            didOpen: () => {
                new Swiper('.swiper-container', {
                    loop: true,
                    initialSlide: initialSlideIndex,
                    navigation: {
                        nextEl: '.swiper-button-next',
                        prevEl: '.swiper-button-prev',
                    },
                    autoHeight: true,
                    slideToSHow : 1,
                });
            }
        });
    });

    $(document).on('click', '.tag-button', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const user = {{{json user}}}
        const isTemporary = !!user.isTemporary
        const subscriptionStatus = user.subscriptionStatus == 'active'
        if(isTemporary || !subscriptionStatus){
            showUpgradePopup()
            return
        }
        var dataId = $(this).attr('data-id');
        var codeToCopy = `<div id="lamix-chat-widget" data-id="${dataId}"></div><script src="https://lamix.hatoltd.com/js/chat-widget.js"></` + `script>`;

        // Create a temporary textarea element to copy the text
        var $temp = $('<textarea>');
        $('body').append($temp);
        $temp.val(codeToCopy).select();
        document.execCommand('copy');
        $temp.remove();

        // Show SweetAlert2 notification
        Swal.fire({
            title: '„Ç≥„Éî„ÉºÂÆå‰∫Ü',
            text: '„Çø„Ç∞„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü„ÄÇ„ÉÅ„É£„ÉÉ„Éà„Éú„ÉÉ„Éà„ÇíË®≠ÁΩÆ„Åó„Åü„ÅÑÂ†¥ÊâÄ„Å´„Çø„Ç∞„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
            icon:'success',
            confirmButtonText: 'OK'
        });
    });
    $(document).on('click', '.delete-chat', function(e) {
        e.preventDefault()
        e.stopPropagation();
        const chatId = $(this).data('id');
        const user = {{{json user}}}
        const userId = user._id
        Swal.fire({
            title: 'Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü',
            text: "„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„ÇìÔºÅ",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: '„ÅØ„ÅÑ„ÄÅÂâäÈô§„Åó„Åæ„ÅôÔºÅ',
            cancelButtonText: '„Ç≠„É£„É≥„Çª„É´'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: `/api/delete-chat/${chatId}`,
                    type: 'DELETE',
                    data: { chatId },
                    success: function(response) {
                        renderChatList(userId)
                    },
                    error: function(xhr, status, error) {
                        Swal.fire(
                            '„Ç®„É©„Éº',
                            '„ÉÅ„É£„ÉÉ„Éà„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ',
                            'error'
                        );
                    }
                });
            }
        });
    });
    $(document).on('click', '.delete-chat-history', function(e) {
        e.preventDefault()
        e.stopPropagation();
        const selectedChatId = $(this).data('id');
        Swal.fire({
            title: 'Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü',
            text: "„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„ÇìÔºÅ",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: '„ÅØ„ÅÑ„ÄÅÂâäÈô§„Åó„Åæ„ÅôÔºÅ',
            cancelButtonText: '„Ç≠„É£„É≥„Çª„É´'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: `/api/delete-chat-history/${selectedChatId}`,
                    type: 'DELETE',
                    success: function(response) {
                        $(document).find(`.user-chat-history[data-chat="${selectedChatId}"]`).fadeOut().remove()
                    },
                    error: function(xhr, status, error) {
                        Swal.fire(
                            '„Ç®„É©„Éº',
                            '„ÉÅ„É£„ÉÉ„Éà„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ',
                            'error'
                        );
                    }
                });
            }
        });
    });

    $('.nav-link').on('click', function(e) {
        e.preventDefault();
        $('.nav-link').removeClass('active');
        $(this).addClass('active');
        
        if ($(this).text().trim() === '„Éö„É´„ÇΩ„Éä') {
            $('.custom-card').hide();
            $('.custom-card .persona.on').closest('.custom-card').show();
        } else {
            $('.custom-card').show();
        }
    });
    $(document).on('click','.redirectToChat',function(){
        const chatId = $(this).data('id');
        const chatImage = $(this).data('image');
        redirectToChat(chatId,chatImage)
    })
});
function redirectToChat(chatId,chatImage) {
    if($(`#spinner-${chatId}`).hasClass('on')){
        return
    }
    if(chatImage){
        $('#chat-container').css('background-image', chatImage);
    }
    $(`#spinner-${chatId}`).addClass('on').show()
    const user = {{{json user}}}
    const userId = user._id

    fetchChatData(chatId,userId,null,function(){
        $(`#spinner-${chatId}`).removeClass('on').hide()
    })
}
$('.date-time').each(function() {
    var dateText = $(this).text();
    var trimmedDate = dateText.split(' ')[0]; // Get the date part only
    $(this).text(trimmedDate); // Update the element's content
});
function initiateCheckout(buttonId) {
    const user = {{{json user}}}
    const userId = user._id
    let stripe
    if(window.location.href.indexOf('https://') >= 0){
        stripe = Stripe('pk_live_51PjtRbE5sP7DA1XvCkdmezori9qPGoO21y7yKSVvgkQVyrhWZfHAUkNsjPMnbwpPlp4zzoYsRjn79Ad7XN7HTHcc00UjBA9adF'); // Use your publishable key here
    }else{
        stripe = Stripe('pk_test_51PjtRbE5sP7DA1XvD68v7X7Qj7pG6ZJpQmvuNodJjxc7MbH1ss2Te2gahFAS9nms4pbmEdMYdfCPxFDWHBbu9CxR003ikTnRES'); // Use your publishable key here
    }
    $.ajax({
        url: '/plan/create-checkout-session',
        method: 'POST',
        data: { buttonId, userId },
        success: function(session) {
            return stripe.redirectToCheckout({ sessionId: session.id });
        },
        error: function(xhr, status, error) {
            console.error('Error creating Stripe checkout session:', error);
        }
    });
}
function initiateAlbumCheckout(priceId,chatId) {
    const user = {{{json user}}}
    if(user.isTemporary){
        showRegistrationForm()
        return
    }
    const userId = user._id
    let stripe
    if(window.location.href.indexOf('https://') >= 0){
        stripe = Stripe('pk_live_51PjtRbE5sP7DA1XvCkdmezori9qPGoO21y7yKSVvgkQVyrhWZfHAUkNsjPMnbwpPlp4zzoYsRjn79Ad7XN7HTHcc00UjBA9adF'); // Use your publishable key here
    }else{
        stripe = Stripe('pk_test_51PjtRbE5sP7DA1XvD68v7X7Qj7pG6ZJpQmvuNodJjxc7MbH1ss2Te2gahFAS9nms4pbmEdMYdfCPxFDWHBbu9CxR003ikTnRES'); // Use your publishable key here
    }
    $.ajax({
        url: '/album/create-checkout-session',
        method: 'POST',
        data: { priceId, userId, chatId },
        success: function(session) {
            return stripe.redirectToCheckout({ sessionId: session.id });
        },
        error: function(xhr, status, error) {
            console.error('Error creating Stripe checkout session:', error);
        }
    });
}

    function renderCircleGrid(cardInfos,container){
        cardInfos.forEach(function(item) {
            var card = $(`
                <div class="card custom-card bg-transparent shadow-0 border-0 px-1 col-3 col-sm-4 col-lg-2" style="cursor:pointer;" data-id="${item._id}">
                    <div style="background-image:url(${item.chatImageUrl})" class="card-img-top rounded-avatar position-relative m-auto" alt="${item.name}">
                    </div>
                </div>
            `);
            card.on('click', function() {
                redirectToChat($(this).attr('data-id'))
            });
            container.append(card);
        });   
    }
</script>
</body>
</html>
