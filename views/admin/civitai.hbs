<!DOCTYPE html>
<html lang="{{lang}}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Model Chats Management - Admin</title>
  {{>dashboard-header}}
</head>
<body>
  {{>dashboard-nav}}
  
  <div class="container-fluid mt-4">
    <div class="row">
      <div class="col-12">
        <h2>Model Chats Management</h2>
        <p>Generate daily AI character chats for each model in your system.</p>
        
        <!-- Forbidden Words Management Section -->
        <div class="card mb-4">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Forbidden Words Management</h5>
              <button id="loadForbiddenWords" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-arrow-clockwise"></i> Reload
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-8">
                <div class="mb-3">
                  <label for="forbiddenWordsInput" class="form-label">Forbidden Words/Phrases</label>
                  <textarea class="form-control" id="forbiddenWordsInput" rows="4" 
                            placeholder="Enter forbidden words or phrases, one per line. Prompts containing these words will be automatically skipped."></textarea>
                  <div class="form-text">
                    <i class="bi bi-info-circle"></i> Any prompt containing these words will be automatically marked as skipped and never shown again. 
                    Case-insensitive matching. Use phrases like "realistic photo" to block specific combinations.
                  </div>
                </div>
                <button id="saveForbiddenWords" class="btn btn-primary mb-3">
                  <i class="bi bi-floppy"></i> Save Forbidden Words
                </button>
              </div>
              <div class="col-md-4">
                <div class="card">
                  <div class="card-body">
                    <h6 class="card-title">Quick Actions</h6>
                    <div class="d-grid gap-2">
                      <button id="clearForbiddenWords" class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-trash"></i> Clear All
                      </button>
                      <button id="addCommonForbidden" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-plus-circle"></i> Add Common Terms
                      </button>
                    </div>
                    <div class="mt-3">
                      <small class="text-muted">
                        <strong>Current Count:</strong> <span id="forbiddenWordsCount">0</span> words
                      </small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card mb-4">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Cron Job Settings</h5>
            </div>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <form id="cronSettingsForm">
                  <div class="mb-3">
                    <label for="cronSchedule" class="form-label">Cron Schedule</label>
                    <input type="text" class="form-control" id="cronSchedule" value="{{cronSettings.schedule}}" placeholder="0 */2 * * *">
                    <div class="form-text">Format: minute hour day_of_month month day_of_week (e.g. "0 */2 * * *" for every 2 hours)</div>
                  </div>
                  <div class="mb-3">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="cronEnabled" {{#if cronSettings.enabled}}checked{{/if}}>
                      <label class="form-check-label" for="cronEnabled">Enable automatic generation</label>
                    </div>
                  </div>
                  <div class="mb-3">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="cronNsfw" {{#if cronSettings.nsfw}}checked{{/if}}>
                      <label class="form-check-label" for="cronNsfw">Include NSFW content</label>
                    </div>
                  </div>
                  <button type="submit" class="btn btn-primary mb-3">Save Settings</button>
                </form>
              </div>
              <div class="col-md-6">
                <div class="card">
                  <div class="card-body">
                    <h5 class="card-title">Schedule Information</h5>
                    <p><strong>Status:</strong> <span id="jobStatus" class="badge {{#if cronSettings.enabled}}bg-success{{else}}bg-danger{{/if}}">{{#if cronSettings.enabled}}Active{{else}}Inactive{{/if}}</span></p>
                    <p><strong>Next Run:</strong> <span id="nextRun">{{cronSettings.nextRun}}</span></p>
                    <p><strong>Last Run:</strong> <span id="lastRun">{{cronSettings.lastRun}}</span></p>
                    <p><strong>Content Type:</strong> <span id="contentType">{{#if cronSettings.nsfw}}NSFW Included{{else}}SFW Only{{/if}}</span></p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card mb-4">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Available Models</h5>
              <button id="generateAllChats" class="btn btn-primary">Generate All Model Chats</button>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Thumbnail</th>
                    <th>Model</th>
                    <th>Style</th>
                    <th>Version</th>
                    <th>Recent Chats</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {{#each models}} 
                    <tr>
                      <td>
                        <img src="{{image}}" alt="{{model}}" class="rounded-circle img-thumbnail" style="width: 60px;height:60px; object-fit: cover;">
                      </td>
                      <td>{{model}}</td>
                      <td>{{style}}</td>
                      <td>{{version}}</td>
                      <td>
                        <span class="badge {{#if hasRecentChat}}bg-success{{else}}bg-danger{{/if}}">
                          {{#if hasRecentChat}}Generated today{{else}}Not generated today{{/if}}
                        </span>
                        <span class="ms-2">{{chats.length}} recent chats</span>
                      </td>
                      <td>
                        <button class="btn btn-sm btn-outline-primary generate-chat-btn" 
                                data-model-id="{{modelId}}"
                                data-model-name="{{model}}">
                          Generate
                        </button>
                      </td>
                    </tr>
                  {{/each}}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Recently Generated Chats</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Thumbnail</th>
                    <th>Character Name</th>
                    <th>Model</th>
                    <th>Created</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {{#each recentChats}}
                    <tr>
                      <td>
                        <img src="{{chatImageUrl}}" alt="{{model}}" class="rounded-circle img-thumbnail" style="width: 60px;height:60px; object-fit: cover;">
                      </td>
                      <td>{{name}}</td>
                      <td>{{imageModel}}</td>
                      <td>{{formatDate createdAt}}</td>
                      <td>
                        <a href="/character/{{_id}}" class="btn btn-sm btn-secondary" target="_blank">
                          View
                        </a>
                      </td>
                    </tr>
                  {{/each}}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal for character generation preview -->
  <div class="modal fade" id="generateChatModal" tabindex="-1" aria-labelledby="generateChatModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content mx-auto">
        <div class="modal-header">
          <h5 class="modal-title" id="generateChatModalLabel">Generate Character Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0" style="height: 70vh;">
          <div class="container-fluid h-100 d-flex">
            <div class="row h-100 flex-nowrap w-100">
              <!-- Desktop layout - Left column for image -->
              <div class="col-lg-5 d-none d-lg-flex align-items-center justify-content-center border-end" id="imageColumn" style="background-color: #f8f9fa;">
                <div id="loadingPrompt" class="text-center">
                  <div class="spinner-border mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="text-muted">Fetching prompt...</p>
                </div>
                
                <div id="imagePreview" class="d-none text-center">
                  <img id="promptImage" src="" class="img-fluid rounded shadow" alt="Character preview" style="max-height: 400px; max-width: 100%; object-fit: contain;">
                </div>
                
                <div id="noPrompt" class="alert alert-warning d-none">
                  <i class="bi bi-exclamation-triangle"></i> No more unused prompts available for this model.
                </div>
                
                <div id="errorFetching" class="alert alert-danger d-none">
                  <i class="bi bi-exclamation-circle"></i> Error fetching prompt. Please try again.
                </div>
              </div>
              
              <!-- Right column - Content (scrollable) -->
              <div class="col-lg-7 col-12 h-100 d-flex flex-column p-0" id="contentColumn">
                <div class="p-3 border-bottom bg-light">
                  <div class="d-flex justify-content-between align-items-center">
                    <div id="modelInfo">
                      <strong>Model:</strong> <span id="modelName" class="text-primary truncate"></span>
                    </div>
                    <div class="btn-group d-none d-lg-flex bg-transparent shadow-0" role="group">
                      <button id="prevPreview" class="btn btn-sm btn-outline-secondary" disabled>
                        <i class="bi bi-arrow-left"></i> Previous
                      </button>
                      <button id="nextPreview" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-arrow-right"></i> Next
                      </button>
                    </div>
                  </div>
                </div>
                
                <div class="flex-grow-1 overflow-auto p-3" id="scrollableContent" style="height: calc(100% - 60px);">
                  <div id="promptDetails" class="d-none">
                    <!-- Mobile image preview with full width and overlay arrows -->
                    <div class="d-lg-none mb-3 position-relative" id="mobileImageContainer" style="height:55vh; background-color: #f8f9fa; border-radius: 8px; overflow: hidden;">
                      <!-- Loading state for mobile -->
                      <div id="loadingPromptMobile" class="d-flex align-items-center justify-content-center h-100">
                        <div class="text-center">
                          <div class="spinner-border mb-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                          </div>
                          <p class="text-muted small">Fetching prompt...</p>
                        </div>
                      </div>
                      
                      <!-- Image container -->
                      <div id="mobileImageWrapper" class="w-100 h-100 d-flex align-items-center justify-content-center d-none">
                        <img id="promptImageMobile" src="" class="img-fluid" alt="Character preview" style="max-height: 100%; max-width: 100%; width: 100%; object-fit: cover;">
                      </div>
                      
                      <!-- Error states for mobile -->
                      <div id="noPromptMobile" class="d-flex align-items-center justify-content-center h-100 d-none">
                        <div class="alert alert-warning m-3">
                          <i class="bi bi-exclamation-triangle"></i> No more unused prompts available.
                        </div>
                      </div>
                      
                      <div id="errorFetchingMobile" class="d-flex align-items-center justify-content-center h-100 d-none">
                        <div class="alert alert-danger m-3">
                          <i class="bi bi-exclamation-circle"></i> Error fetching prompt.
                        </div>
                      </div>
                      
                      <!-- Navigation arrows overlay -->
                      <div class="position-absolute top-50 start-0 translate-middle-y" style="z-index: 10;">
                        <button id="prevPreviewMobile" class="btn btn-dark btn-lg opacity-75 ms-3" style="border-radius: 50%; width: 50px; height: 50px;" disabled>
                          <i class="bi bi-chevron-left"></i>
                        </button>
                      </div>
                      <div class="position-absolute top-50 end-0 translate-middle-y" style="z-index: 10;">
                        <button id="nextPreviewMobile" class="btn btn-dark btn-lg opacity-75 me-3" style="border-radius: 50%; width: 50px; height: 50px;">
                          <i class="bi bi-chevron-right"></i>
                        </button>
                      </div>
                      
                      <!-- Prompt indicator -->
                      <div class="position-absolute bottom-0 start-50 translate-middle-x mb-3">
                        <span class="badge bg-dark bg-opacity-75" id="promptIndicator">1 / ?</span>
                      </div>
                    </div>
                    
                    <div class="mb-4">
                      <h6 class="fw-bold text-secondary mb-2">
                        <i class="bi bi-chat-text"></i> Prompt
                      </h6>
                      <div class="bg-white border rounded p-3" style="max-height: 150px; overflow-y: auto;">
                        <p id="promptText" class="mb-0 small"></p>
                      </div>
                    </div>
                    
                    <div class="mb-4">
                      <h6 class="fw-bold text-secondary mb-2">
                        <i class="bi bi-x-circle"></i> Negative Prompt
                      </h6>
                      <div class="bg-white border rounded p-3" style="max-height: 150px; overflow-y: auto;">
                        <p id="promptNegative" class="mb-0 small text-muted"></p>
                      </div>
                    </div>
                  </div>
                  
                  <div id="generationResult" class="alert d-none">
                    <div class="d-flex align-items-start">
                      <div class="flex-grow-1">
                        <p id="generationMessage" class="mb-2"></p>
                        <a id="viewCharacterLink" href="#" target="_blank" class="btn btn-primary btn-sm d-none">
                          <i class="bi bi-eye"></i> View Character
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer border-top" style="font-size: 1em !important;">
          <div type="button" class="badge bg-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-lg"></i> Close
          </div>
          <div type="button" id="skipBtn" class="badge bg-warning d-none">
            <i class="bi bi-skip-forward"></i> Skip
          </div>
          <div type="button" id="generateBtn" class="badge bg-primary d-none">
            <i class="bi bi-play-fill"></i> Generate
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading modal for generate all -->
  <div class="modal fade" id="loadingModal" tabindex="-1" aria-labelledby="loadingModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg mx-0">
      <div class="modal-content mx-auto">
        <div class="modal-body text-center py-5">
          <div class="spinner-border mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <h5>Generating chats for all models...</h5>
          <p>This may take several minutes. Please don't close this window.</p>
        </div>
      </div>
    </div>
  </div>
  
  <style>
    @media (max-width: 991.98px) {
      #generateChatModal .modal-dialog {
        margin: 0.5rem;
        max-width: calc(100vw - 1rem);
      }
      
      #generateChatModal .modal-body {
        height: 80vh;
      }
      
      /* Mobile carousel arrows styling */
      #prevPreviewMobile,
      #nextPreviewMobile {
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        transition: opacity 0.2s ease, transform 0.1s ease;
        border: 2px solid rgba(255,255,255,0.3);
      }
      
      #prevPreviewMobile:hover,
      #nextPreviewMobile:hover {
        opacity: 1 !important;
        transform: scale(1.05);
      }
      
      #prevPreviewMobile:disabled,
      #nextPreviewMobile:disabled {
        opacity: 0.3 !important;
        cursor: not-allowed;
        transform: none;
      }
      
      #prevPreviewMobile:active,
      #nextPreviewMobile:active {
        transform: scale(0.95);
      }
    }
    
    #generateChatModal .modal-xl {
      max-width: 1000px;
    }
    
    #scrollableContent::-webkit-scrollbar {
      width: 6px;
    }
    
    #scrollableContent::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }
    
    #scrollableContent::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }
    
    #scrollableContent::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
    
    /* Additional styles for fixing the scrolling issue */
    #generateChatModal .modal-content {
      height: 100%;
    }
    
    #generateChatModal .modal-body {
      overflow: hidden;
    }
    
    #scrollableContent {
      min-height: 0;  /* This is crucial for flex containers with scrolling children */
      overflow-y: auto;
    }
    
    .row.h-100.flex-nowrap {
      margin: 0;
    }
    
    /* Prompt indicator styling */
    #promptIndicator {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }
  </style>
<style>
  .sticky-bottom {display:none;}
</style>
  {{>dashboard-footer}}
  
  <script>
    $(document).ready(function() {
      let currentModelId = null;
      let currentModelName = null;
      let currentNsfw = false;
      let currentPage = 1;
      let currentPromptIndex = 0;
      let currentPromptKey = null;
      let totalPrompts = 0;

      // Cron settings form submission
      $('#cronSettingsForm').on('submit', function(e) {
        e.preventDefault();
        
        const settings = {
          schedule: $('#cronSchedule').val(),
          enabled: $('#cronEnabled').is(':checked'),
          nsfw: $('#cronNsfw').is(':checked')
        };
        
        $.ajax({
          url: '/civitai/model-chats/cron-settings',
          type: 'POST',
          data: settings,
          dataType: 'json',
          success: function(data) {
            if (data.success) {
              Swal.fire({
                title: 'Success!',
                text: 'Cron settings updated successfully.',
                icon: 'success',
                confirmButtonText: 'Great!'
              });
              
              // Update status display
              $('#jobStatus').removeClass('bg-success bg-danger')
                .addClass(settings.enabled ? 'bg-success' : 'bg-danger')
                .text(settings.enabled ? 'Active' : 'Inactive');
              
              $('#contentType').text(settings.nsfw ? 'NSFW Included' : 'SFW Only');
              $('#nextRun').text(data.nextRun || 'N/A');
              $('#lastRun').text(data.lastRun || 'N/A');
            } else {
              Swal.fire({
                title: 'Error!',
                text: data.error || 'Failed to update cron settings',
                icon: 'error',
                confirmButtonText: 'OK'
              });
            }
          },
          error: function(xhr) {
            Swal.fire({
              title: 'Error!',
              text: xhr.responseJSON?.error || 'An unknown error occurred',
              icon: 'error',
              confirmButtonText: 'OK'
            });
          }
        });
      });
      
      // Generate individual chat button click
      $('.generate-chat-btn').on('click', function() {
        const modelId = $(this).data('model-id');
        const modelName = $(this).data('model-name');
        
        // Ask about NSFW first
        Swal.fire({
          title: 'Include NSFW Content?',
          text: 'Do you want to include NSFW content in this chat?',
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Yes, include NSFW',
          cancelButtonText: 'No, SFW only'
        }).then((nsfwResult) => {
          const nsfw = nsfwResult.isConfirmed;
          
          // Store current state
          currentModelId = modelId;
          currentModelName = modelName;
          currentNsfw = nsfw;
          currentPage = 1;
          currentPromptIndex = 0;
          
          // Show modal and fetch preview
          $('#modelName').text(modelName);
          resetModalState();
          $('#generateChatModal').modal('show');
          
          // Fetch first preview
          fetchPreviewPrompt('current');
        });
      });
      
      function resetModalState() {
        console.log('[resetModalState] Resetting modal state');
        
        // Desktop states
        $('#loadingPrompt').removeClass('d-none');
        $('#imagePreview').addClass('d-none');
        $('#noPrompt').addClass('d-none');
        $('#errorFetching').addClass('d-none');
        
        // Mobile states
        $('#loadingPromptMobile').removeClass('d-none');
        $('#mobileImageWrapper').addClass('d-none');
        $('#noPromptMobile').addClass('d-none');
        $('#errorFetchingMobile').addClass('d-none');
        
        // Common states
        $('#promptDetails').addClass('d-none');
        $('#generationResult').addClass('d-none');
        $('#generateBtn').addClass('d-none');
        $('#skipBtn').addClass('d-none');
        $('#prevPreview').prop('disabled', true);
        $('#nextPreview').prop('disabled', false);
        $('#prevPreviewMobile').prop('disabled', true);
        $('#nextPreviewMobile').prop('disabled', false);
        
        currentPromptKey = null;
        totalPrompts = 0;
      }

      // Navigation buttons - Fixed logic
      $('#prevPreview, #prevPreviewMobile').on('click', function() {
        if (!$(this).prop('disabled')) {
          console.log('[prevPreview] Current promptIndex before:', currentPromptIndex);
          if (currentPromptIndex > 0) {
            currentPromptIndex--;
          }
          console.log('[prevPreview] New promptIndex:', currentPromptIndex);
          fetchPreviewPrompt('prev');
        }
      });

      $('#nextPreview, #nextPreviewMobile').on('click', function() {
        if (!$(this).prop('disabled')) {
          console.log('[nextPreview] Current promptIndex before:', currentPromptIndex);
          currentPromptIndex++;
          console.log('[nextPreview] New promptIndex:', currentPromptIndex);
          fetchPreviewPrompt('next');
        }
      });

      // Extract prompt fetching into a separate function that can be reused
      function fetchPreviewPrompt(direction = 'current') {
        console.log(`[fetchPreviewPrompt] Fetching with direction: ${direction}, page: ${currentPage}, promptIndex: ${currentPromptIndex}`);
        
        // Reset loading states
        $('#loadingPrompt').removeClass('d-none');
        $('#imagePreview').addClass('d-none');
        $('#loadingPromptMobile').removeClass('d-none');
        $('#mobileImageWrapper').addClass('d-none');
        $('#promptDetails').addClass('d-none');
        $('#noPrompt').addClass('d-none');
        $('#errorFetching').addClass('d-none');
        $('#noPromptMobile').addClass('d-none');
        $('#errorFetchingMobile').addClass('d-none');
        $('#generationResult').addClass('d-none');
        $('#generateBtn').addClass('d-none');
        $('#skipBtn').addClass('d-none');
        
        // Reset skip button state specifically
        $('#skipBtn').prop('disabled', false).html('<i class="bi bi-skip-forward"></i> Skip');

        $.ajax({
          url: '/api/preview-prompt',
          type: 'POST',
          data: { 
            modelId: currentModelId, 
            modelName: currentModelName, 
            nsfw: currentNsfw, 
            page: currentPage, 
            promptIndex: currentPromptIndex,
            direction: direction
          },
          dataType: 'json',
          success: function(data) {
            console.log('[fetchPreviewPrompt] Response received:', data);
            
            // Hide loading states
            $('#loadingPrompt').addClass('d-none');
            $('#loadingPromptMobile').addClass('d-none');
            
            if (data.error) {
              console.error('[fetchPreviewPrompt] Error in response:', data.error);
              $('#errorFetching').removeClass('d-none');
              $('#errorFetchingMobile').removeClass('d-none');
              return;
            }
            
            if (!data.prompt) {
              console.log('[fetchPreviewPrompt] No prompt data received');
              $('#noPrompt').removeClass('d-none');
              $('#noPromptMobile').removeClass('d-none');
              return;
            }
            
            // Update current state from server response
            currentPage = data.prompt.page;
            currentPromptIndex = data.prompt.promptIndex;
            currentPromptKey = data.promptKey;
            totalPrompts = data.prompt.totalItems || 0;
            
            console.log(`[fetchPreviewPrompt] Updated state - page: ${currentPage}, promptIndex: ${currentPromptIndex}, promptKey: ${currentPromptKey}, totalPrompts: ${totalPrompts}`);
            
            // Show image preview
            $('#imagePreview').removeClass('d-none');
            $('#promptImage').attr('src', data.prompt.imageUrl);
            $('#mobileImageWrapper').removeClass('d-none');
            $('#promptImageMobile').attr('src', data.prompt.imageUrl);
            
            // Update prompt indicator
            $('#promptIndicator').text(`${currentPromptIndex + 1} / ${totalPrompts > 0 ? totalPrompts : '?'}`);
            
            // Show prompt details
            $('#promptDetails').removeClass('d-none');
            $('#promptText').text(data.prompt.prompt);
            $('#promptNegative').text(data.prompt.negativePrompt);
            
            // Show action buttons with proper state reset
            $('#generateBtn').removeClass('d-none')
              .prop('disabled', false)
              .html('<i class="bi bi-play-fill"></i> Generate')
              .data('prompt-key', currentPromptKey);
              
            $('#skipBtn').removeClass('d-none')
              .prop('disabled', false)
              .html('<i class="bi bi-skip-forward"></i> Skip')
              .data('prompt-key', currentPromptKey);
            
            // Update navigation buttons
            const canGoPrev = currentPromptIndex > 0;
            const canGoNext = currentPromptIndex < (totalPrompts - 1) || totalPrompts === 0; // Allow next if we don't know total or if not at end
            
            $('#prevPreview').prop('disabled', !canGoPrev);
            $('#nextPreview').prop('disabled', false); // Always allow next for now, server will handle limits
            $('#prevPreviewMobile').prop('disabled', !canGoPrev);
            $('#nextPreviewMobile').prop('disabled', false); // Always allow next for now
          },
          error: function(xhr, status, error) {
            console.error('[fetchPreviewPrompt] Error:', error);
            $('#loadingPrompt').addClass('d-none');
            $('#loadingPromptMobile').addClass('d-none');
            $('#errorFetching').removeClass('d-none');
            $('#errorFetchingMobile').removeClass('d-none');
            
            // Reset button states on error too
            $('#skipBtn').prop('disabled', false).html('<i class="bi bi-skip-forward"></i> Skip');
            $('#generateBtn').prop('disabled', false).html('<i class="bi bi-play-fill"></i> Generate');
          }
        });
      }
      
      // Skip button functionality
      $('#skipBtn').on('click', function() {
        const promptKey = $(this).data('prompt-key');
        
        if (!promptKey) {
          console.error('[skipBtn] No prompt key available');
          return;
        }
        
        console.log(`[skipBtn] Skipping prompt: ${promptKey}`);
        
        $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Skipping...');
        
        $.ajax({
          url: '/api/skip-prompt',
          type: 'POST',
          data: { promptKey },
          dataType: 'json',
          success: function(data) {
            console.log('[skipBtn] Skip response:', data);
            
            if (data.success) {
              // Fetch next prompt automatically - the fetchPreviewPrompt function will reset button states
              fetchPreviewPrompt('next');
            } else {
              console.error('[skipBtn] Skip failed:', data.error);
              Swal.fire({
                title: 'Error!',
                text: data.error || 'Failed to skip prompt',
                icon: 'error',
                confirmButtonText: 'OK'
              });
              // Reset button state on error
              $('#skipBtn').prop('disabled', false).html('<i class="bi bi-skip-forward"></i> Skip');
            }
          },
          error: function(xhr) {
            console.error('[skipBtn] Skip error:', xhr.responseJSON);
            Swal.fire({
              title: 'Error!',
              text: xhr.responseJSON?.error || 'An error occurred while skipping',
              icon: 'error',
              confirmButtonText: 'OK'
            });
            // Reset button state on error
            $('#skipBtn').prop('disabled', false).html('<i class="bi bi-skip-forward"></i> Skip');
          }
        });
      });
      
      // Generate button in modal click
      $('#generateBtn').on('click', function() {
        const promptKey = $(this).data('prompt-key');
        
        if (!promptKey) {
          console.error('[generateBtn] No prompt key available');
          Swal.fire({
            title: 'Error!',
            text: 'No prompt selected for generation',
            icon: 'error',
            confirmButtonText: 'OK'
          });
          return;
        }
        
        console.log(`[generateBtn] Generating chat with promptKey: ${promptKey}`);
        
        $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...');
        
        // Generate the chat using the cached prompt
        $.ajax({
          url: '/civitai/model-chats/generate',
          type: 'POST',
          data: { 
            modelId: currentModelId, 
            nsfw: currentNsfw, 
            promptKey: promptKey 
          },
          dataType: 'json',
          success: function(data) {
            console.log('[generateBtn] Generation response:', data);
            
            $('#generateBtn').prop('disabled', false).html('<i class="bi bi-play-fill"></i> Generate');
            
            if (data.error) {
              $('#generationResult').removeClass('d-none alert-success').addClass('alert-danger');
              $('#generationMessage').text(data.error);
              return;
            }
            
            if (data.success) {
              const chat = data.chat;
              $('#generationResult').removeClass('d-none alert-danger').addClass('alert-success');
              $('#generationMessage').text('Character generated successfully!');

              if (chat && chat.slug) {
                $('#viewCharacterLink').removeClass('d-none').attr('href', '/character/slug/' + chat.slug);
              }
              
              // Hide generation button since we've successfully generated
              $('#generateBtn').addClass('d-none');
              $('#skipBtn').addClass('d-none');
              
            } else {
              $('#generationResult').removeClass('d-none alert-success').addClass('alert-danger');
              $('#generationMessage').text('Failed to generate character.');
            }
          },
          error: function(xhr) {
            console.error('[generateBtn] Generation error:', xhr.responseJSON);
            
            $('#generateBtn').prop('disabled', false).html('<i class="bi bi-play-fill"></i> Generate');
            $('#generationResult').removeClass('d-none alert-success').addClass('alert-danger');
            $('#generationMessage').text(xhr.responseJSON?.error || 'An unknown error occurred');
          }
        });
      });
      
      // Generate all chats button click
      $('#generateAllChats').on('click', function() {
        console.log('[generateAllChats] Starting generation for all models');
        
        Swal.fire({
          title: 'Generate All Model Chats?',
          text: 'This will generate chats for all models and may take some time.',
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Yes, generate all',
          cancelButtonText: 'Cancel'
        }).then((result) => {
          if (result.isConfirmed) {
            // Ask user about NSFW setting first
            Swal.fire({
              title: 'Include NSFW Content?',
              text: 'Do you want to include NSFW content in generated chats?',
              icon: 'question',
              showCancelButton: true,
              confirmButtonText: 'Yes, include NSFW',
              cancelButtonText: 'No, SFW only'
            }).then((nsfwResult) => {
              const nsfw = nsfwResult.isConfirmed;
              
              console.log(`[generateAllChats] Generating all chats with NSFW: ${nsfw}`);
              
              // Show loading indicator
              $('#loadingModal').modal('show');
              
              $.ajax({
                url: '/civitai/model-chats/generate',
                type: 'POST',
                data: { nsfw },
                dataType: 'json',
                success: function(data) {
                  console.log('[generateAllChats] Generation complete:', data);
                  
                  $('#loadingModal').modal('hide');
                  
                  if (data.success) {
                    const successes = data.results.filter(r => r.status === 'success').length;
                    const failures = data.results.filter(r => r.status !== 'success').length;
                    
                    Swal.fire({
                      title: 'Generation Complete',
                      text: `Successfully generated ${successes} chats. Failed: ${failures}.`,
                      icon: 'success',
                      confirmButtonText: 'Great!'
                    }).then(() => {
                      location.reload();
                    });
                  } else {
                    Swal.fire({
                      title: 'Error!',
                      text: data.error || 'Failed to generate chats',
                      icon: 'error',
                      confirmButtonText: 'OK'
                    });
                  }
                },
                error: function(xhr) {
                  console.error('[generateAllChats] Error:', xhr.responseJSON);
                  
                  $('#loadingModal').modal('hide');
                  
                  Swal.fire({
                    title: 'Error!',
                    text: xhr.responseJSON?.error || 'An unknown error occurred',
                    icon: 'error',
                    confirmButtonText: 'OK'
                  });
                }
              });
            });
          }
        });
      });
      
      // Forbidden Words Management
      let forbiddenWords = [];
      
      // Load forbidden words on page load
      loadForbiddenWords();
      
      function loadForbiddenWords() {
        $.ajax({
          url: '/civitai/forbidden-words',
          type: 'GET',
          dataType: 'json',
          success: function(data) {
            if (data.success) {
              forbiddenWords = data.words || [];
              $('#forbiddenWordsInput').val(forbiddenWords.join('\n'));
              updateForbiddenWordsCount();
            } else {
              console.error('Failed to load forbidden words:', data.error);
            }
          },
          error: function(xhr) {
            console.error('Error loading forbidden words:', xhr.responseJSON);
            Swal.fire({
              title: 'Error!',
              text: 'Failed to load forbidden words',
              icon: 'error',
              confirmButtonText: 'OK'
            });
          }
        });
      }
      
      function updateForbiddenWordsCount() {
        $('#forbiddenWordsCount').text(forbiddenWords.length);
      }
      
      // Reload forbidden words
      $('#loadForbiddenWords').on('click', function() {
        loadForbiddenWords();
      });
      
      // Save forbidden words
      $('#saveForbiddenWords').on('click', function() {
        const wordsText = $('#forbiddenWordsInput').val();
        const words = wordsText.split('\n')
          .map(word => word.trim())
          .filter(word => word.length > 0);
        
        $.ajax({
          url: '/civitai/forbidden-words',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ words: words }),
          dataType: 'json',
          success: function(data) {
            if (data.success) {
              forbiddenWords = data.words;
              updateForbiddenWordsCount();
              Swal.fire({
                title: 'Success!',
                text: `Saved ${data.words.length} forbidden words. Prompts containing these words will be automatically skipped.`,
                icon: 'success',
                confirmButtonText: 'Great!'
              });
            } else {
              Swal.fire({
                title: 'Error!',
                text: data.error || 'Failed to save forbidden words',
                icon: 'error',
                confirmButtonText: 'OK'
              });
            }
          },
          error: function(xhr) {
            Swal.fire({
              title: 'Error!',
              text: xhr.responseJSON?.error || 'An error occurred while saving',
              icon: 'error',
              confirmButtonText: 'OK'
            });
          }
        });
      });
      
      // Clear all forbidden words
      $('#clearForbiddenWords').on('click', function() {
        Swal.fire({
          title: 'Clear All Forbidden Words?',
          text: 'This will remove all forbidden words. Previously skipped prompts will remain skipped.',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'Yes, clear all',
          cancelButtonText: 'Cancel'
        }).then((result) => {
          if (result.isConfirmed) {
            $('#forbiddenWordsInput').val('');
            $('#saveForbiddenWords').click();
          }
        });
      });
      
      // Add common forbidden terms
      $('#addCommonForbidden').on('click', function() {
        const commonTerms = [
          'realistic photo',
          'photograph',
          'real person',
          'photorealistic',
          'hyperrealistic',
          'actual photo'
        ];
        
        const currentText = $('#forbiddenWordsInput').val();
        const newText = currentText ? currentText + '\n' + commonTerms.join('\n') : commonTerms.join('\n');
        $('#forbiddenWordsInput').val(newText);
      });
    });
  </script>
</body>
</html>