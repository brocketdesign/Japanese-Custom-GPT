<!DOCTYPE html>
<html>
{{> dashboard-header}}
<body class="bg-dark">
    {{> dashboard-nav}}
    <link rel="stylesheet" href="/css/dashboard-posts.css">
    <link rel="stylesheet" href="/css/dashboard-schedules.css">
    
    <section class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
                    <div class="flex-grow-1">
                        <h1 class="text-white mb-1">
                            <i class="bi bi-calendar-event me-2"></i>{{translations.dashboard.mySchedules}}
                        </h1>
                        <p class="text-muted mb-0">{{translations.dashboard.mySchedulesDescription}}</p>
                    </div>
                    <div class="d-flex gap-2 w-100 w-md-auto">
                        <button class="btn btn-primary flex-fill flex-md-grow-0" onclick="schedulesDashboard.openCreateModal('single')">
                            <i class="bi bi-calendar-plus me-1"></i>{{translations.dashboard.newSchedule}}
                        </button>
                        <button class="btn btn-outline-warning flex-fill flex-md-grow-0" onclick="schedulesDashboard.openCreateModal('recurring')">
                            <i class="bi bi-arrow-repeat me-1"></i>{{translations.dashboard.newCronJob}}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="row mb-4">
            <div class="col-6 col-md-3">
                <div class="card bg-dark border-primary h-100">
                    <div class="card-body text-center py-3">
                        <i class="bi bi-calendar-check text-primary fs-2"></i>
                        <h3 class="text-white mt-2 mb-0" id="totalSchedules">0</h3>
                        <p class="text-muted mb-0 small">{{translations.dashboard.total}}</p>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card bg-dark border-success h-100">
                    <div class="card-body text-center py-3">
                        <i class="bi bi-play-circle text-success fs-2"></i>
                        <h3 class="text-white mt-2 mb-0" id="activeSchedules">0</h3>
                        <p class="text-muted mb-0 small">{{translations.dashboard.active}}</p>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card bg-dark border-warning h-100">
                    <div class="card-body text-center py-3">
                        <i class="bi bi-pause-circle text-warning fs-2"></i>
                        <h3 class="text-white mt-2 mb-0" id="pausedSchedules">0</h3>
                        <p class="text-muted mb-0 small">{{translations.dashboard.paused}}</p>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card bg-dark border-info h-100">
                    <div class="card-body text-center py-3">
                        <i class="bi bi-check-circle text-info fs-2"></i>
                        <h3 class="text-white mt-2 mb-0" id="completedSchedules">0</h3>
                        <p class="text-muted mb-0 small">{{translations.dashboard.completed}}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label text-white">{{translations.dashboard.type}}</label>
                        <select id="filterType" class="form-select bg-dark text-white border-secondary">
                            <option value="">{{translations.dashboard.all}}</option>
                            <option value="single">{{translations.dashboard.singleSchedule}}</option>
                            <option value="recurring">{{translations.dashboard.recurringCron}}</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">{{translations.dashboard.status}}</label>
                        <select id="filterStatus" class="form-select bg-dark text-white border-secondary">
                            <option value="">{{translations.dashboard.all}}</option>
                            <option value="pending">{{translations.dashboard.pending}}</option>
                            <option value="active">{{translations.dashboard.active}}</option>
                            <option value="paused">{{translations.dashboard.paused}}</option>
                            <option value="completed">{{translations.dashboard.completed}}</option>
                            <option value="failed">{{translations.dashboard.failed}}</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white">{{translations.dashboard.action}}</label>
                        <select id="filterAction" class="form-select bg-dark text-white border-secondary">
                            <option value="">{{translations.dashboard.all}}</option>
                            <option value="generate_image">{{translations.dashboard.generateImage}}</option>
                            <option value="generate_video">{{translations.dashboard.generateVideo}}</option>
                            <option value="publish_post">{{translations.dashboard.publishPost}}</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-outline-info w-100" id="resetFiltersBtn">
                            <i class="bi bi-arrow-clockwise me-1"></i>{{translations.dashboard.reset}}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Schedules List -->
        <div id="schedulesGrid" class="row g-4 mb-4">
            <!-- Schedules will be loaded here via JavaScript -->
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">{{translations.dashboard.loading}}</span>
            </div>
        </div>

        <!-- No Schedules Message -->
        <div id="noSchedules" class="text-center py-5" style="display: none;">
            <i class="bi bi-calendar-x fs-1 text-muted"></i>
            <h3 class="text-white mt-3">{{translations.dashboard.noSchedules}}</h3>
            <p class="text-muted">{{translations.dashboard.noSchedulesDescription}}</p>
            <div class="d-flex justify-content-center gap-2 mt-3">
                <button class="btn btn-primary" onclick="schedulesDashboard.openCreateModal('single')">
                    <i class="bi bi-calendar-plus me-1"></i>{{translations.dashboard.createFirstSchedule}}
                </button>
            </div>
        </div>

        <!-- Pagination -->
        <div id="pagination" class="d-flex justify-content-center mt-4"></div>
    </section>

    <!-- Create/Edit Schedule Modal -->
    <div class="modal fade" id="scheduleModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="false">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="scheduleModalTitle">
                        <i class="bi bi-calendar-plus me-2"></i>{{translations.dashboard.newSchedule}}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="scheduleId">
                    <input type="hidden" id="scheduleType" value="single">
                    
                    <!-- Schedule Type Toggle -->
                    <div class="mb-4">
                        <label class="form-label">{{translations.dashboard.scheduleType}}</label>
                        <div class="segmented-control" role="group">
                            <input type="radio" class="btn-check" name="scheduleTypeRadio" id="typeSingle" value="single" checked>
                            <label class="segment-btn" for="typeSingle">
                                <i class="bi bi-calendar-event"></i>
                                <span>{{translations.dashboard.singleSchedule}}</span>
                            </label>
                            <input type="radio" class="btn-check" name="scheduleTypeRadio" id="typeRecurring" value="recurring">
                            <label class="segment-btn" for="typeRecurring">
                                <i class="bi bi-arrow-repeat"></i>
                                <span>{{translations.dashboard.recurringCron}}</span>
                            </label>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="mb-3">
                        <label class="form-label">{{translations.dashboard.description}}</label>
                        <input type="text" class="form-control bg-secondary text-white border-secondary" id="scheduleDescription" placeholder="{{translations.dashboard.scheduleDescriptionPlaceholder}}">
                    </div>

                    <!-- Action Type -->
                    <div class="mb-3">
                        <label class="form-label">{{translations.dashboard.actionType}}</label>
                        <div class="schedule-action-selector">
                            <button type="button" class="schedule-action-btn active" data-action="generate_image">
                                <i class="bi bi-images"></i>
                                <span>{{translations.dashboard.generateImage}}</span>
                            </button>
                            <button type="button" class="schedule-action-btn" data-action="generate_video">
                                <i class="bi bi-film"></i>
                                <span>{{translations.dashboard.generateVideo}}</span>
                            </button>
                            <button type="button" class="schedule-action-btn" data-action="publish_post">
                                <i class="bi bi-send-fill"></i>
                                <span>{{translations.dashboard.publishPost}}</span>
                            </button>
                        </div>
                        <input type="hidden" id="actionType" value="generate_image">
                    </div>

                    <!-- Single Schedule: Date/Time -->
                    <div id="singleScheduleFields">
                        <div class="mb-3">
                            <label class="form-label">{{translations.dashboard.scheduledFor}}</label>
                            <input type="datetime-local" class="form-control bg-secondary text-white border-secondary" id="scheduledFor">
                        </div>
                    </div>

                    <!-- Recurring Schedule: Cron Expression -->
                    <div id="recurringScheduleFields" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">{{translations.dashboard.cronExpression}}</label>
                            <input type="text" class="form-control bg-secondary text-white border-secondary" id="cronExpression" placeholder="0 9 * * *">
                            <small class="text-muted">{{translations.dashboard.cronExpressionHelp}}</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">{{translations.dashboard.cronPresets}}</label>
                            <div class="d-flex flex-wrap gap-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setCronPreset('0 9 * * *')">Daily 9 AM</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setCronPreset('0 */6 * * *')">Every 6 hours</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setCronPreset('0 12 * * 1-5')">Weekdays noon</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setCronPreset('0 10 * * 6,0')">Weekends 10 AM</button>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{translations.dashboard.maxExecutions}}</label>
                                <input type="number" class="form-control bg-secondary text-white border-secondary" id="maxExecutions" placeholder="{{translations.dashboard.unlimited}}" min="1">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{translations.dashboard.endDate}}</label>
                                <input type="date" class="form-control bg-secondary text-white border-secondary" id="endDate">
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="mutationEnabled">
                                <label class="form-check-label" for="mutationEnabled">
                                    {{translations.dashboard.enablePromptMutation}}
                                </label>
                                <small class="text-muted d-block">{{translations.dashboard.mutationHelp}}</small>
                            </div>
                        </div>
                    </div>

                    <!-- Character Selection -->
                    <div class="mb-3">
                        <label class="form-label">{{translations.dashboard.character}} <span class="text-muted">({{translations.dashboard.optional}})</span></label>
                        <div id="characterSelectionContainer" class="character-selection-list">
                            <!-- Characters loaded dynamically -->
                            <div class="text-center py-3">
                                <div class="spinner-border text-primary spinner-border-sm" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="text-muted mt-2 mb-0 small">Loading characters...</p>
                            </div>
                        </div>
                        <small class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>Select a character to apply character-specific styling to generated images
                        </small>
                    </div>

                    <!-- Prompt Type Selection -->
                    <div class="mb-3">
                        <label class="form-label">{{translations.dashboard.promptType}}</label>
                        <div class="segmented-control" role="group">
                            <input type="radio" class="btn-check" name="promptTypeRadio" id="promptTypeManual" value="manual" checked>
                            <label class="segment-btn" for="promptTypeManual">
                                <i class="bi bi-pencil"></i>
                                <span>{{translations.dashboard.manualPrompt}}</span>
                            </label>
                            <input type="radio" class="btn-check" name="promptTypeRadio" id="promptTypeCustom" value="custom">
                            <label class="segment-btn" for="promptTypeCustom">
                                <i class="bi bi-collection"></i>
                                <span>{{translations.dashboard.customPrompts}}</span>
                            </label>
                        </div>
                        <small class="text-muted d-block mt-1">
                            <i class="bi bi-info-circle me-1"></i>Choose between writing your own prompt or using pre-made custom prompts
                        </small>
                    </div>

                    <!-- Manual Prompt Fields -->
                    <div id="manualPromptFields">
                        <!-- Action Data: Prompt -->
                        <div class="mb-3">
                            <label class="form-label">{{translations.dashboard.prompt}}</label>
                            <textarea class="form-control bg-secondary text-white border-secondary" id="actionPrompt" rows="8" placeholder="{{translations.dashboard.promptPlaceholder}}"></textarea>
                        </div>
                    </div>

                    <!-- Custom Prompts Selection -->
                    <div id="customPromptFields" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">{{translations.dashboard.selectCustomPrompts}}</label>
                            <div id="customPromptsContainer" class="custom-prompts-grid">
                                <!-- Custom prompts loaded dynamically -->
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary spinner-border-sm" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="text-muted mt-2 mb-0 small">Loading custom prompts...</p>
                                </div>
                            </div>
                            <small class="text-muted d-block mt-2">
                                <i class="bi bi-info-circle me-1"></i>Select one or multiple custom prompts. A random one will be used each time the schedule runs.
                            </small>
                            <div id="selectedPromptsInfo" class="mt-2" style="display: none;">
                                <span class="badge bg-info">
                                    <span id="selectedPromptsCount">0</span> prompt(s) selected
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Action Data: Model -->
                    <div class="mb-3" id="modelSelectorSection">
                        <label class="form-label">{{translations.dashboard.model}}</label>
                        <button type="button" class="schedule-model-selector" id="modelSelectorBtn">
                            <div class="model-icon">
                                <i class="bi bi-cpu"></i>
                            </div>
                            <span class="model-name">Select Model</span>
                            <i class="bi bi-chevron-down model-chevron"></i>
                        </button>
                        <input type="hidden" id="actionModel" value="">
                        
                        <!-- Model Dropdown -->
                        <div class="schedule-model-dropdown" id="modelDropdown">
                            <div class="model-dropdown-header">
                                <span>Text to Image Models</span>
                            </div>
                            {{#each scheduleModels}}
                            <div class="model-dropdown-item" data-value="{{this.id}}" data-name="{{this.name}}">
                                <div class="model-item-icon">
                                    <i class="bi bi-image"></i>
                                </div>
                                <div class="model-item-info">
                                    <span class="model-item-name">{{this.name}}</span>
                                    <span class="model-item-badge {{#if this.async}}async{{else}}sync{{/if}}">
                                        {{#if this.async}}Async{{else}}Sync{{/if}}
                                    </span>
                                </div>
                                <i class="bi bi-check-lg model-check"></i>
                            </div>
                            {{/each}}
                            {{#if activeSDModels.length}}
                            <div class="model-dropdown-header">
                                <span>Custom SD Models</span>
                            </div>
                            {{#each activeSDModels}}
                            <div class="model-dropdown-item" data-value="sd-{{this.modelId}}" data-name="{{this.name}}">
                                <div class="model-item-icon sd">
                                    <i class="bi bi-stars"></i>
                                </div>
                                <div class="model-item-info">
                                    <span class="model-item-name">{{this.name}}</span>
                                    <span class="model-item-badge sd">SD</span>
                                </div>
                                <i class="bi bi-check-lg model-check"></i>
                            </div>
                            {{/each}}
                            {{/if}}
                        </div>
                        <small class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>Same models available as in the Image Dashboard
                        </small>
                    </div>

                    <!-- Test Run Preview Section -->
                    <div class="mb-3" id="testRunSection">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">{{translations.dashboard.testRun}}</label>
                            <button type="button" class="btn btn-sm btn-outline-warning" id="testRunBtn" onclick="schedulesDashboard.runTestGeneration()">
                                <i class="bi bi-play-circle me-1"></i>Test Run
                            </button>
                        </div>
                        <div id="testRunPreview" class="test-run-preview" style="display: none;">
                            <div id="testRunLoading" class="text-center py-4" style="display: none;">
                                <div class="spinner-border text-warning" role="status">
                                    <span class="visually-hidden">Generating...</span>
                                </div>
                                <p class="text-muted mt-2 mb-0">Generating test image...</p>
                            </div>
                            <div id="testRunResult" style="display: none;">
                                <div class="position-relative">
                                    <img id="testRunImage" src="" alt="Test Result" class="img-fluid rounded mb-2" style="max-height: 300px; width: 100%; object-fit: contain;">
                                    <button type="button" class="btn btn-sm btn-outline-info position-absolute top-0 end-0 m-2" onclick="schedulesDashboard.expandTestImage()">
                                        <i class="bi bi-arrows-fullscreen"></i>
                                    </button>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted" id="testRunInfo"></small>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="schedulesDashboard.clearTestRun()">
                                        <i class="bi bi-x me-1"></i>Clear
                                    </button>
                                </div>
                            </div>
                            <div id="testRunError" class="alert alert-danger mb-0" style="display: none;">
                                <i class="bi bi-exclamation-triangle me-1"></i>
                                <span id="testRunErrorMsg"></span>
                            </div>
                        </div>
                        <small class="text-muted d-block mt-1">
                            <i class="bi bi-lightbulb me-1"></i>Run a test to preview what will be generated. Generated images are saved to your Posts.
                        </small>
                    </div>

                    <!-- Social Platforms -->
                    <div class="mb-3">
                        <label class="form-label">{{translations.dashboard.autoPublishTo}}</label>
                        <div class="d-flex gap-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="publishInstagram" value="instagram">
                                <label class="form-check-label" for="publishInstagram">
                                    <i class="bi bi-instagram me-1"></i>Instagram
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="publishTwitter" value="twitter">
                                <label class="form-check-label" for="publishTwitter">
                                    <i class="bi bi-twitter-x me-1"></i>X (Twitter)
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        {{translations.dashboard.cancel}}
                    </button>
                    <button type="button" class="btn btn-primary" onclick="schedulesDashboard.saveSchedule()">
                        <i class="bi bi-check me-1"></i>{{translations.dashboard.save}}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Schedule Modal -->
    <div class="modal fade" id="viewScheduleModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="false">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-calendar-event me-2"></i>{{translations.dashboard.scheduleDetails}}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="viewScheduleBody">
                    <!-- Content loaded dynamically -->
                </div>
                <div class="modal-footer border-secondary" id="viewScheduleFooter">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        {{translations.dashboard.close}}
                    </button>
                </div>
            </div>
        </div>
    </div>

    {{> dashboard-footer}}
    <script src="/js/dashboard-schedules.js"></script>
</body>
</html>
