<!DOCTYPE html>
<html>
{{> dashboard-header}}
<body class="bg-dark">
    {{> dashboard-nav}}
    <style>
.card-img-container {
  height: 500px; /* Fixed height for image container */
  overflow: hidden;
  position: relative;
}

.card-img-container img {
  transition: transform 0.3s ease; /* Smooth transition for zoom */
  object-fit: cover;
  height: 100%;
  width: 100%;
}

.card-img-container:hover img {
  transform: scale(1.1); /* Slight zoom on hover */
}

.model-gallery-card .card-img-top {
  transition: transform 0.3s ease-in-out;
}

.model-gallery-card:hover .card-img-top {
  transform: scale(1.1);
}

.model-gallery-card .model-details-panel {
  transition: opacity 0.3s ease-in-out; /* For a fade effect */
  /* For a slide effect with Animate.css, it will be controlled by JS */
}

/* Ensure details panel is above the overlay when visible */
.model-gallery-card:hover .model-details-panel {
  z-index: 3; 
}

.active-model-card .card-img-top {
  transition: transform 0.3s ease-in-out;
}

.active-model-card:hover .card-img-top {
  transform: scale(1.05); /* Smaller zoom for active cards */
}

/* Styling for active model cards to ensure consistency */
#active-models .card {
  border: 1px solid rgba(255, 255, 255, 0.125); /* Subtle border */
}

#active-models .fs-sm {
    font-size: 0.8rem;
}

#active-models .active-model-info-btn i {
    font-size: 0.9rem; /* Adjust icon size */
    vertical-align: middle;
}

#active-models .active-model-info-btn {
    line-height: 1; /* Ensure button padding is consistent */
}
</style>
<section>
  <div class="container py-5">
    <div class="text-center mb-4">
      <h1 class="display-5 text-white">Models Gallery</h1>
      <p class="lead text-white">Explore public models with infinite scroll</p>
    </div>

    <div class="row mb-4">
      <div class="col-md-6 offset-md-3">
        <div class="input-group">
          <input id="searchInput" type="text" class="form-control" placeholder="Search models...">
          <button id="searchBtn" class="btn btn-primary" type="button">
            <i class="bi bi-search"></i>
          </button>
        </div>
      </div>
    </div>

    {{!-- Active Models Horizontal Scroll --}}
    <h4 class="text-white mb-2">Active Models</h4>
    <div id="active-models" class="d-flex flex-row flex-nowrap overflow-auto mb-4 pb-3">
      {{#each models}}
      <div class="active-model-card card bg-dark text-white shadow-sm me-2 position-relative overflow-hidden animate__animated" style="min-width: 180px; width: 180px; height: 180px;">
        <img src="{{image}}" class="card-img-top h-100 w-100" alt="{{model}}" style="object-fit: cover;">
        
        {{!-- Overlay for Name, Switch, and Info Button --}}
        <div class="card-img-overlay d-flex flex-column justify-content-end p-2" style="background-image: linear-gradient(to top, rgba(0,0,0,0.8), rgba(0,0,0,0)); z-index: 1;">
          <h6 class="card-title fs-sm fw-semibold text-truncate mb-1" title="{{model}}">{{model}}</h6>
          <div class="d-flex justify-content-between align-items-center">
            <div class="form-check form-switch">
              <input class="form-check-input model-switch" type="checkbox" checked
                data-model-id="{{modelId}}"
                data-model="{{model}}"
                data-style="{{style}}"
                data-version="{{version}}"
                data-image="{{image}}"
                data-name="{{model}}">
            </div>
            <button class="btn btn-sm btn-outline-light active-model-info-btn p-1" type="button" title="View Details"
              data-model-id="{{modelId}}"
              data-model="{{model}}"
              data-style="{{style}}"
              data-version="{{version}}"
              data-image="{{image}}"
              data-name="{{name}}">
              <i class="bi bi-info-circle"></i>
            </button>
          </div>
        </div>
      </div>
      {{/each}}
    </div>

    {{!-- Infinite Scroll Gallery --}}
    <div id="model-gallery" class="row"></div>
  </div>
</section>

<!-- Model Details Modal -->
<div class="modal fade" id="modelDetailsModal" tabindex="-1" aria-labelledby="modelDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content bg-dark text-white mx-auto">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="modelDetailsModalLabel">Model Details</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-4">
            <img id="modalModelImage" src="" alt="Model Image" class="img-fluid rounded">
          </div>
          <div class="col-md-8">
            <h6 id="modalModelName" class="fw-bold mb-2"></h6>
            <p class="small mb-1"><strong>Model:</strong> <span id="modalModelModel"></span></p>
            <p class="small mb-1"><strong>Style:</strong> <span id="modalModelStyle"></span></p>
            <p class="small mb-1"><strong>Version:</strong> <span id="modalModelVersion"></span></p>
            <p class="small mb-3"><strong>ID:</strong> <span id="modalModelId" class="text-break"></span></p>
            
            <form id="negativePromptForm">
              <div class="mb-3">
                <label for="negativePromptTextarea" class="form-label">Default Negative Prompt</label>
                <textarea id="negativePromptTextarea" class="form-control bg-secondary text-dark border-secondary"  style="min-height: 100px;"
                  rows="10" placeholder="Enter default negative prompt for this model..."></textarea>
                <div class="form-text text-muted">This negative prompt will be used as default when generating images with this model.</div>
              </div>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-save me-1"></i>Save Negative Prompt
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .sticky-bottom {display:none;}
</style>

{{> dashboard-footer}}
<script>
$(document).ready(function(){
    let loading = false;
    let nextCursor = '{{pagination.next_cursor}}';
    let currentModelId = null;

    // Initialize search input from URL query parameter
    const urlParams = new URLSearchParams(window.location.search);
    const initialSearch = urlParams.get('search') || '';
    $('#searchInput').val(initialSearch);

    // If there's an initial search query, load the results
    if (initialSearch) {
        loadModels('', initialSearch);
    }

    // Gallery Card - Info Button Click (slide from left)
    $(document).on('click', '.model-gallery-info-btn', function() {
        const card = $(this).closest('.model-gallery-card');
        const detailsPanel = card.find('.model-details-panel');
        detailsPanel.removeClass('d-none animate__fadeOutLeft').addClass('animate__fadeInLeft');
    });

    // Gallery Card - Close Button Click
    $(document).on('click', '.model-gallery-details-close-btn', function() {
        const detailsPanel = $(this).closest('.model-details-panel');
        detailsPanel.removeClass('animate__fadeInLeft').addClass('animate__fadeOutLeft');
        setTimeout(() => {
            detailsPanel.addClass('d-none');
        }, 500); // Match Animate.css animation duration
    });

    // Remove hover listeners for gallery cards to prevent conflict with button clicks
    /* 
    $(document).on('mouseenter', '.model-gallery-card', function() {
        const detailsPanel = $(this).find('.model-details-panel');
        detailsPanel.removeClass('d-none animate__fadeOutLeft').addClass('animate__fadeInLeft');
    });

    $(document).on('mouseleave', '.model-gallery-card', function() {
        const detailsPanel = $(this).find('.model-details-panel');
        detailsPanel.removeClass('animate__fadeInLeft').addClass('animate__fadeOutLeft');
        setTimeout(() => {
            if (!$(this).is(':hover')) {
                 detailsPanel.addClass('d-none');
            }
        }, 500); 
    });
    */

    // Active Model Card - Info Button Click (open modal)
    $(document).on('click', '.active-model-info-btn', function() {
        const modelId = $(this).data('model-id');
        const model = $(this).data('model');
        const style = $(this).data('style');
        const version = $(this).data('version');
        const image = $(this).data('image');
        const name = $(this).data('name');
        
        currentModelId = modelId;
        
        // Populate modal with basic data
        $('#modalModelImage').attr('src', image);
        $('#modalModelName').text(name || model);
        $('#modalModelModel').text(model);
        $('#modalModelStyle').text(style || 'N/A');
        $('#modalModelVersion').text(version || 'N/A');
        $('#modalModelId').text(modelId);
        
        // Fetch full model details including negative prompt
        $.get(`/admin/models/${modelId}/details`)
            .done(function(data) {
                $('#negativePromptTextarea').val(data.negativePrompt || '');
            })
            .fail(function() {
                $('#negativePromptTextarea').val('');
            });
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('modelDetailsModal'));
        modal.show();
    });

    // Handle negative prompt form submission
    $('#negativePromptForm').on('submit', function(e) {
        e.preventDefault();
        
        if (!currentModelId) {
            window.showNotification('No model selected', 'error');
            return;
        }
        
        const negativePrompt = $('#negativePromptTextarea').val();
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        
        // Show loading state
        submitBtn.html('<i class="bi bi-hourglass-split me-1"></i>Saving...').prop('disabled', true);
        
        $.ajax({
            url: `/admin/models/${currentModelId}/negative-prompt`,
            method: 'PUT',
            data: JSON.stringify({ negativePrompt }),
            contentType: 'application/json',
            success: function(response) {
                window.showNotification(response.message, 'success');
                // Close modal after successful save
                const modal = bootstrap.Modal.getInstance(document.getElementById('modelDetailsModal'));
                modal.hide();
            },
            error: function(xhr) {
                const error = xhr.responseJSON ? xhr.responseJSON.error : 'Error saving negative prompt';
                window.showNotification(error, 'error');
            },
            complete: function() {
                // Restore button state
                submitBtn.html(originalText).prop('disabled', false);
            }
        });
    });

    function loadModels(cursor, searchTerm) {
        let url = '/admin/models?';
        if (cursor) url += 'cursor=' + cursor;
        if (searchTerm) url += '&search=' + encodeURIComponent(searchTerm);

        $.post(url, function(res) {
        if (cursor) {
            $('#model-gallery').append(res.html); // Append results for infinite scroll
        } else {
            $('#model-gallery').html(res.html); // Replace results for new search
        }
        nextCursor = res.pagination.next_cursor;
        loading = false;
        });
    }


  // Handle infinite scrolling
  $(window).on('scroll', function() {
    if (!loading && $(window).scrollTop() + $(window).height() + 50 >= $(document).height()) {
      loading = true;
      if (nextCursor) loadModels(nextCursor, $('#searchInput').val());
    }
  });

  // Handle search by clicking the search button
  $('#searchBtn').on('click', function() {
    performSearch($('#searchInput').val());
  });

  // Handle search by pressing "Enter"
  $('#searchInput').on('keypress', function(e) {
    if (e.which === 13) { // Enter key
      performSearch($(this).val());
    }
  });

  // Perform the search and update the navigation history
  function performSearch(searchTerm) {
    $('#model-gallery').empty(); // Clear existing results
    nextCursor = ''; // Reset the cursor
    loadModels('', searchTerm); // Load new results

    // Update the URL in the browser history
    const newUrl = new URL(window.location.href);
    if (searchTerm) {
      newUrl.searchParams.set('search', searchTerm);
    } else {
      newUrl.searchParams.delete('search');
    }
    history.pushState({}, '', newUrl); // Push the updated URL to the navigation history
  }

  // Handle back/forward navigation
  window.onpopstate = function() {
    const searchTerm = new URL(window.location.href).searchParams.get('search') || '';
    $('#searchInput').val(searchTerm);
    performSearch(searchTerm);
  };

  $(document).on('change', '.model-switch', function() {
    const modelId = $(this).data('model-id');
    const model = $(this).data('model');
    const style = $(this).data('style');
    const image = $(this).data('image');
    const version = $(this).data('version');
    const name = $(this).data('name');
    const url = $(this).is(':checked') ? '/admin/models/add' : '/admin/models/remove';
    
    $.post(url, { modelId, model, style, version, image, name }, function(res) {
      window.showNotification(res.message, "success");
    });
  });
});
</script>
</body>
</html>
