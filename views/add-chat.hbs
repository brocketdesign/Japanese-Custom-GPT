<!DOCTYPE html>
<html lang="ja">
   {{> dashboard-header}}
<body>
    {{> dashboard-nav}}

    <style>
    .style-option {
        width: 75px;
        cursor:pointer;
    }
    .style-option.selected {
        border: 4px solid #8849ff;
    }
    .animated.fadeInDown .swal2-image{
        margin:0;
    }
    .animated.fadeInDown .swal2-close{
        border:0;
    }
    /* Custom animation for sliding in from the bottom */
    .swal2-bottom-slide-in {
        animation: bottom-slide-in 0.5s;
    }

    .swal2-bottom-slide-out {
        animation: bottom-slide-out 0.5s;
    }

    @keyframes bottom-slide-in {
        0% {
            transform: translateY(100%);
            opacity: 0;
        }
        100% {
            transform: translateY(0);
            opacity: 1;
        }
    }

    @keyframes bottom-slide-out {
        0% {
            transform: translateY(0);
            opacity: 1;
        }
        100% {
            transform: translateY(100%);
            opacity: 0;
        }
    }
    .custom-gradient-bg {
        background: linear-gradient(90.9deg, #D2B8FF 2.74%, #8240FF 102.92%);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        transition: color 0.3s ease-in-out;
    }

    .custom-gradient-bg::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 300%;
        height: 300%;
        background: radial-gradient(circle, rgba(255,255,255,0.5) 0%, rgba(255,255,255,0) 80%);
        transform: translate(-50%, -50%) scale(0);
        transition: transform 0.5s ease-in-out;
        z-index: 0;
    }

    .custom-gradient-bg:hover::before {
        transform: translate(-50%, -50%) scale(1);
    }

    .custom-gradient-bg:hover {
        color: #fff;
    }
    #chatImage{
        width: 100px;
        height: 100px; 
        object-fit:cover;
        object-position:top;
    }
    #chatImage.on{
        width: auto !important;
        height: 270px !important;
    }
    .btn-gradient-radius {
        display: inline-block;
        padding: 7px 20px;
        border-radius: 25px;
        text-decoration: none;
        color: #FFF;
        background-image: linear-gradient(45deg, #FFC107 0%, #ff8b5f 100%);
        transition: .4s;
        font-size: 21px;
    }
    label{
        font-size: 14px;
        color: #aaaaaa;
    }
    #sendMessage,
    #chatInput .load {
        border-left: 0 !important;
        border-radius: 0px 30px 30px 0px !important;
        box-shadow: none;
    }
    #userMessage {
        border-radius: 30px 0px 0px 30px !important;
        background-color: #f8f9fa;
    }
    #userMessage:focus {
        outline: none;
        box-shadow: none; /* If there is a box shadow applied on focus */
    }
    .button-group{
        top:0;
        right: 15px;
    }
    .scroll-container {
      display: flex;
      flex-wrap: nowrap;
      overflow-x: auto;
    }
    .scroll-container > * {
      flex: 0 0 auto;
      width: auto;
    }
    .card-text.template{
        font-size: 12px;
    }
    /*Custom css*/
    label{
        font-size: 12px;
        color: #8d8b8b;
    }
    .avatar-xl img {
        width: 110px;
    }
    .rounded-circle {
        border-radius: 50%;
    }
    .rounded-circle.on {
        border-radius: 15px !important;
    }
    img {
        vertical-align: middle;
        border-style: none;
    }
    .text-muted {
        color: #aeb0b4 !important;
    }
    .text-muted {
        font-weight: 300;
    }
    .form-control {
        display: block;
        width: 100%;
        height: calc(1.5em + 0.75rem + 2px);
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        font-weight: 400;
        line-height: 1.5;
        color: #4d5154;
        background-color: #ffffff;
        background-clip: padding-box;
        border: 1px solid #eef0f3;
        border-radius: 0.25rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    #markdownContainer {
        margin-bottom: 20px;
        padding: 20px;
        border: 1px solid #eef0f3;
        border-radius: 4px;
    }
    .auto-gen{
        font-size: 10px;
        border-radius: 50px;
    }
    </style>

<div class="container position-relative rounded shadow p-3 my-4 px-0">
    
    <!-- 1. キャラクター画像 -->
    <div id="step1" class="step">
            <h4 class="container mb-4 text-center stepTitle">{{translations.newCharacter.characterCreationForm}}</h4>

            <!-- Character Creation Form -->
            <div id="characterCreationForm" class="container mt-3">
                
                <div class="row">
                    <!-- Left Column: Prompts and Button -->
                    <div class="col-lg-6 mb-4">
                        <div class="row mb-4">
                            <!-- Image Style Selection -->
                            <div class="col-auto">
                                <label class="form-label">{{translations.newCharacter.image_style}}</label>
                                <div id="imageStyleSelection">
                                    <img src="/img/anime.jpeg" alt="アニメ" class="style-option rounded selected" data-style="anime" data-model="novaAnimeXL_ponyV20_461138" data-version="sdxl">
                                    <img src="/img/real.jpeg" alt="リアリスティック" class="style-option rounded" data-style="realistic" data-model="kanpiromix_v20" data-version="sd">
                                    <img src="/img/real-2.jpeg" alt="リアリスティック" class="style-option rounded" data-style="realistic" data-model="ponyRealism_v22MainVAE_822476" data-version="sdxl">
                                </div>
                                <input type="hidden" id="imageStyle" name="imageStyle" value="anime">
                                <input type="hidden" id="imageModel" name="imageModel" value="novaAnimeXL_ponyV20_461138">
                                <input type="hidden" id="imageVersion" name="imageVersion" value="sdxl">
                            </div>
                            <div class="d-none col-auto">
                                <label for="gender" class="form-label"><i class="fas fa-user"></i> {{translations.newCharacter.genderLabel}}:</label>
                                <select class="form-select w-auto" id="gender" name="gender">
                                    <option value="female" selected>{{translations.newCharacter.female}}</option>
                                    <option value="male">{{translations.newCharacter.male}}</option>
                                </select>
                            </div>
                        </div>
                        <!-- 1. Character Prompt Input -->
                        <div class="mb-2">
                            <label for="characterPrompt" class="form-label">{{translations.newCharacter.character_prompt}}</label>
                            <textarea
                                class="form-control"
                                id="characterPrompt"
                                name="characterPrompt"
                                rows="4"
                                maxlength="500"
                                placeholder="{{translations.newCharacter.character_appearance_description}}"
                            ></textarea>
                        </div>
                        
                        <!-- 2. Enhanced Prompt Display -->
                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="enableEnhancedPrompt" name="enableEnhancedPrompt">
                            <label class="form-check-label" for="enableEnhancedPrompt">{{translations.newCharacter.enable_enhanced_prompt}}</label>
                        </div>
                        <div class="mb-4 d-none">
                            <label for="enhancedPrompt" class="form-label">AI強化プロンプト</label>
                            <textarea
                                class="form-control"
                                id="enhancedPrompt"
                                name="enhancedPrompt"
                                rows="3"
                                readonly
                                placeholder="AIによって強化されたプロンプトがここに表示されます..."
                            ></textarea>
                        </div>

                        <!-- 4. Single Action Button -->
                        <div class="d-grid">
                            <button type="button" id="generateButton" class="btn custom-gradient-bg btn-lg text-white">
                                <i class="fas fa-magic me-2"></i>{{translations.newCharacter.generate_with_AI}}
                            </button>
                            <span class="w-100 text-center text-muted genexp" style="font-size: 12px;display:none;">{{translations.newCharacter.image_generation_message}}</span>
                        </div>
                    </div>
                <!-- Right Column: Generated Image -->
                <div class="col-lg-6 mb-4 d-flex flex-column align-items-center">
                    <!-- 3. Generated Image Display -->
                    <label class="form-label d-block mb-2 text-center">{{translations.newCharacter.generatedImageLabel}}</label>
                    <div id="imageContainer" class="row mb-4 w-100">
                        <img
                            id="generatedImage"
                            src="/img/default-character.png"
                            alt="{{translations.newCharacter.generatedImageAlt}}"
                            class="img-fluid rounded"
                            style="max-height: 300px; width: 100%; object-fit: contain;"
                        >
                    </div>
                    <div id="imageUploaderContainer" class="w-100" style="cursor: pointer;">
                        <!-- You can add an image uploader here if needed -->
                    </div>
                </div>
            </div>
            <button type="button" id="nextStep1" class="btn btn-secondary w-100 nextStep">
                {{translations.newCharacter.nextStep}}
            </button>
        </div>
    </div>

    <!-- 2. キャラクターの性格 -->
    <div id="step2" class="step d-none">
        <h4 class="container mb-4 text-center stepTitle">{{translations.newCharacter.characterPersonalityTitle}}</h4>

        <div id="chatPurpose-container" class="mb-3 mx-3">
            <div class="d-flex justify-content-between">
                <label for="chatPurpose" class="form-label">{{translations.newCharacter.characterDetailsLabel}}</label>
            </div>
            <textarea class="form-control mb-2" id="chatPurpose" name="content" rows="3" placeholder="{{translations.newCharacter.characterDetailsPlaceholder}}"></textarea>

            <input type="text" class="form-control mb-2" id="chatName" name="chatName" placeholder="{{translations.newCharacter.namePlaceholder}}" contenteditable="false" disabled="true" required style="display:none;">
            <textarea class="form-control mb-2" id="chatDescription" style="display:none;" name="chatDescription" rows="3" placeholder="{{translations.newCharacter.descriptionPlaceholder}}" disabled="true" required></textarea>
            <textarea class="form-control mb-2" id="chatStory" style="display:none;" name="chatStory" rows="5" placeholder="" disabled="true"></textarea>

            <button type="button" id="ai-assist" class="btn btn-lg custom-gradient-bg shadow-0 mb-2 w-100">
                <i class="fa fa-spinner fa-spin fa-fw fa-hidden me-2" style="display: none;"></i>
                <i class="fa fa-magic me-2"></i>{{translations.newCharacter.generateWithAI}}
            </button>

            <button type="button" id="submitForm" class="btn btn-secondary btn-large w-100">
                {{translations.newCharacter.complete}}
            </button>     
        </div>
    </div>
</div>

    <style>footer{display: inline !important;}</style>
 {{> dashboard-footer}}
<link type="text/css" rel="stylesheet" href="/css/image-uploader.css">
<script type="text/javascript" src="/js/image-uploader.js"></script>
<script type="text/javascript" src="/js/stability.js"></script>

<script>
    $(document).ready(function() {
        let currentStep = 1;
        let translations = window.translations

        function showStep(step) {
            $(`#nextStep${step}`).addClass('d-none');
            $(`#step${step +1}`).removeClass('d-none')
        }

    function validateStep(step) {
        if (step === 1) {
            if ($('.img-thumbnail.select').length === 0) {
                console.log('Validation failed: No image thumbnail selected.');
            }
            if(!$('#generatedImage').attr('src') || $('#generatedImage').attr('src') == ''){
                console.log('Validation failed: No image generatedImage.');
            }
            return (
                $('.img-thumbnail.select').length > 0 ||
                $('#generatedImage').attr('src') != ''
            );
        } else if (step === 2) {
            if ($('#chatPurpose').val().trim() === '') {
                console.log('Validation failed: Chat purpose is empty.');
            }
            if ($('#chatName').val().trim() === '') {
                console.log('Validation failed: Chat name is empty.');
            }
            if ($('#chatDescription').val().trim() === '') {
                console.log('Validation failed: Chat description is empty.');
            }
            return (
                $('#chatPurpose').val().trim() !== '' &&
                $('#chatName').val().trim() !== '' &&
                $('#chatDescription').val().trim() !== ''
            );
        }
        return true;
    }


        $('.nextStep').click(function() {
            if (validateStep(currentStep)) {
                showStep(currentStep);
                currentStep++;
            } else {
                showNotification(translations.newCharacter.allFieldsRequired, 'error');
            }
        });

        $('.prevStep').click(function() {
            currentStep--;
            showStep(currentStep);
        });

        //showStep(currentStep);
    });
    $(document).ready(function() {
        let currentLang = getLanguageName(localStorage.getItem('currentLang')) || getLanguageName('ja');        
        $('#language').val(currentLang)

        $('#characterPrompt').on('input change', function() {
            $('#enhancedPrompt').val('');
        });
        
        $('.style-option').click(function(){
            $('.style-option').removeClass('selected');
            $(this).addClass('selected');
            const style = $(this).data('style')
            const model = $(this).data('model')
            const version = $(this).data('version')
            $('#imageStyle').val(style);
            $('#imageModel').val(model);
            $('#imageVersion').val(version);
            
        });

        imageStyle = $('.style-option.selected').data('style')
        $('#imageStyle').val(imageStyle);

        imageModel = $('.style-option.selected').data('model')
        $('#imageModel').val(imageModel);

        imageVersion = $('.style-option.selected').data('version')
        $('#imageVersion').val(imageVersion);
    });

</script>
<script>
    
    // Store modified galleries
    const modifiedGalleries = new Set();
    $(document).ready(function() {
        let translations = window.translations
        $('.dropdown-toggle').each(function(e) {
            new mdb.Dropdown($(this)[0]);
        });
        var count = 0
        let chatId = '{{chatId}}';
        const isTemporaryChat = '{{isTemporaryChat}}'
        const user = {{{json user}}}
        const subscriptionStatus = user.subscriptionStatus == 'active'
        let isAutoGen = false
        if(subscriptionStatus){
            $('.is-premium').each(function(){$(this).toggleClass('d-none')})
        }
        $('input, textarea').val('');
        $('#resetForm').on('click',function(){
            $('input, textarea').val('');
            $('input, textarea').prop('disabled', false);
            $('#chatName').hide()
            $('#chatDescription').hide()
            $('#chatPurpose').show()
            $('#chatPurpose-markdownContainer').hide()
            $('#markdownContainer').hide()
            $('#chatPurpose-markdownContainer').html('')
            $('#markdownContainer').html('')
            $('#sendForm').hide()
            $('#sendForm span').html(translations.newCharacter.startChatting)
        })

        const urlParams = new URLSearchParams(window.location.search);
        const chatImageUrl = urlParams.get('chatImage');
        if (chatImageUrl) {
            setTimeout(function(){
                $('#chatImageUrl').val(chatImageUrl).change();
            },500)
            $('#chatImage').attr('src', chatImageUrl).show().addClass('on');
        }

        function checkFieldsAndShowForm() {
            if ($('#chatName').val().trim() !== '' && 
                $('#chatDescription').val().trim() !== '' && 
                $('#chatPurpose').val().trim() !== '') {
                $('#sendForm').show();
            } else {
                $('#sendForm').hide();
            }
        }
        $('#chatName, #chatDescription, #chatPurpose').on('input', checkFieldsAndShowForm);

            if (isTemporaryChat == 'false') {
                fetchchatData(chatId,function(){
                    function observeGalleryChanges(galleryIndex) {
                        const galleryElement = document.querySelector(`#imageGallery-${galleryIndex}`);
                        if (!galleryElement) return;

                        const observer = new MutationObserver(function(mutationsList, observer) {
                            modifiedGalleries.add(galleryIndex);
                        });

                        observer.observe(galleryElement, { childList: true, subtree: true });
                    }

                    $('#galleries .imageGalleryWrapper').each(function(index) {
                        observeGalleryChanges(index);
                    });
                });
            }

            $('textarea').each(function() {
                resizeTextarea(this);
                $(this).on('input change', function() {
                    resizeTextarea(this);
                });
            });

        $('#visibility').val('public')
        $('#visibility').change(function() {
            
            const user = {{{json user}}}
            const userId = user._id
            if(!user){
                fetchUser(function(error, user){
                    user = localStorage.setItem('user',JSON.stringify(user))
                    if(user.subscriptionStatus == 'active'){
                        return
                    }else{
                        if ($(this).val() === 'private') {
                            showUpgradePopup('chat-private');
                            $(this).val('public');
                        }
                    }
                })
            }
            if(user.subscriptionStatus == 'active'){
                return
            }else{
                if ($(this).val() === 'private') {
                    showUpgradePopup('chat-private');
                    $(this).val('public');
                }
            }
        });

        function resizeTextarea(element){
            if($(element).val().trim()!=''){
                element.style.height = 'auto';
                element.style.height = (element.scrollHeight) + 'px';  
            }else{
                element.style.height = 'auto'; 
            }
        }

     function fetchchatData(chatId, callback) {
            $.ajax({
                url: `/api/chat-data/${chatId}`,
                type: 'GET',
                dataType: 'json',
                success: function(chatData) {
                    console.log('Fetched chat data:', chatData);

                    // Populate Step 1: キャラクターの外見
                    if (chatData.imageStyle) {
                        $('#imageStyle').val(chatData.imageStyle);
                    }
                    if (chatData.imageModel) {
                        $('#imageModel').val(chatData.imageModel);
                    }
                    if (chatData.imageVersion) {
                        $('#imageVersion').val(chatData.imageVersion);
                    }

                    if (chatData.characterPrompt) {
                        $('#characterPrompt').val(chatData.characterPrompt);
                        resizeTextarea($('#characterPrompt')[0]);
                    }

                    if (chatData.enhancedPrompt && chatData.enhancedPrompt !== '') {
                        $('#enhancedPrompt').val(chatData.enhancedPrompt);
                    }

                    if (chatData.imageDescription) {
                      $('#enhancedPrompt').val(chatData.imageDescription);
                    }

                    if (chatData.chatImageUrl) {
                        $('#generatedImage').attr('src', chatData.chatImageUrl).show().addClass('on');
                    }

                    if (chatData.language) {
                        $('#language').val(chatData.language);
                    }

                    if (chatData.gender) {
                        $('#gender').val(chatData.gender);
                    }

                    if (chatData.purpose) {
                        $('#chatPurpose').val(chatData.purpose);
                        resizeTextarea($('#chatPurpose')[0]);
                    }

                    if (chatData.name) {
                        $('#chatName').val(chatData.name).show();
                        $('#sendForm span').text(`${chatData.name}とチャットする`);
                    }

                    if (chatData.description) {
                        $('#chatDescription').val(chatData.description).show();
                        resizeTextarea($('#chatDescription')[0]);
                    }

                    if (chatData.base_personality.story) {
                        $('#chatStory').val(chatData.base_personality.story).show();
                        resizeTextarea($('#chatStory')[0]);
                    }

                    // Callback if provided
                    if (typeof callback === 'function') {
                        callback();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching chat data:', error);
                    showNotification('チャットデータの取得に失敗しました。再試行してください。', 'error');
                }
            });
        }

        // Form Submission
        $('#submitForm').on('click', function(e) {
            e.preventDefault();
            $('#sendForm .fa-spinner').toggleClass('d-none');
            window.location = '/chat/' + chatId;
        });
        
      
        function fetchTaskId(enhancedPrompt, aspectRatio, chatId, imageStyle, imageModel, imageVersion) {
            return $.ajax({
                url: '/novita/generate-image',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    prompt: enhancedPrompt,
                    aspectRatio: aspectRatio,
                    chatId: chatId,
                    imageStyle,
                    imageModel,
                    imageVersion
                })
            });
        }

        function saveSelectedImage(imageUrl, characterPrompt, enhancedPrompt, imageStyle, imageModel, imageVersion) {
            const chatId = '{{chatId}}'; // Replace with actual chat ID

            $.ajax({
                url: '/novita/save-image',
                method: 'POST',
                dataType: 'json',
                data: {
                    characterPrompt, 
                    enhancedPrompt, 
                    imageStyle, 
                    imageModel, 
                    imageVersion,
                    imageUrl,
                    chatId
                },
                success: function(response) {
                    showNotification(translations.imageForm.image_saved, 'success');
                },
                error: function(error) {
                    showNotification(translations.imageForm.image_save_failed, 'error');
                }
            });
        }

        function displayGeneratedImages(imageUrls, characterPrompt, enhancedPrompt, imageStyle, imageModel, imageVersion) {
            // Clear the container
            $('#imageContainer').empty();

            // For each image URL, create an image element and append to the container
            imageUrls.forEach(function(data) {
                const url = data.imageUrl
                const colDiv = $('<div>').addClass('col-12 col-md-6 mb-3');
                const imgElement = $('<img>')
                    .attr('src', url)
                    .addClass('img-fluid img-thumbnail')
                    .css('cursor', 'pointer');

                // Add click handler to each image
                imgElement.on('click', function() {
                    $('.img-thumbnail').each(function(){
                        $(this).removeClass('select')
                    })
                    $(this).addClass('select')
                    
                    // Save the selected image (you can implement this function)
                    saveSelectedImage(url, characterPrompt, enhancedPrompt, imageStyle, imageModel, imageVersion);
                });

                colDiv.append(imgElement);
                $('#imageContainer').append(colDiv);
            });
        }

        function checkTaskStatus(taskId, characterPrompt, enhancedPrompt, imageStyle, imageModel, imageVersion) {
            const POLLING_INTERVAL = 10000; // 3 seconds
            const MAX_ATTEMPTS = 30; // up to 90 seconds
            let attempts = 0;

            const intervalId = setInterval(async () => {
                attempts++;
                try {
                    const statusResponse = await $.ajax({
                        url: `/novita/chat-thumb-task-status/${taskId}`,
                        method: 'GET',
                        dataType: 'json'
                    });

                    if (statusResponse.status === 'completed') {
                        clearInterval(intervalId);
                        const { imageUrls } = statusResponse.result;

                        displayGeneratedImages(imageUrls, characterPrompt, enhancedPrompt, imageStyle, imageModel, imageVersion)

                        showNotification('画像が正常に生成されました。', 'success');
                        // Enable buttons and reset text
                        $('#characterPrompt').prop('disabled', false);
                        $('#generateButton').prop('disabled', false);
                        $('#generateButton').html('<i class="fas fa-magic me-2"></i>'+translations.newCharacter.generate_with_AI);

                    } else if (statusResponse.status === 'failed') {
                        clearInterval(intervalId);
                        $('#imageContainer').empty();
                        showNotification(`画像の生成に失敗しました: ${statusResponse.error}`, 'error');
                        // Enable buttons and reset text
                        $('#characterPrompt').prop('disabled', false);
                        $('#generateButton').prop('disabled', false);
                        $('#generateButton').html('<i class="fas fa-magic me-2"></i>'+translations.newCharacter.generate_with_AI);
                    } else {
                        console.log('タスクはまだ処理中です...');
                    }

                    if (attempts >= MAX_ATTEMPTS) {
                        clearInterval(intervalId);
                        $('#imageContainer').empty();
                        showNotification('画像の生成がタイムアウトしました。再試行してください。', 'error');
                        // Enable buttons and reset text
                        $('#characterPrompt').prop('disabled', false);
                        $('#generateButton').prop('disabled', false);
                        $('#generateButton').html('<i class="fas fa-magic me-2"></i>'+translations.newCharacter.generate_with_AI);
                    }

                } catch (error) {
                    console.error('タスクステータスポーリングエラー:', error);
                    clearInterval(intervalId);
                    $('#imageContainer').empty();
                    showNotification('画像の生成中にエラーが発生しました。', 'error');
                    // Enable buttons and reset text
                    $('#characterPrompt').prop('disabled', false);
                    $('#generateButton').prop('disabled', false);
                    $('#generateButton').html('<i class="fas fa-magic me-2"></i>'+translations.newCharacter.generate_with_AI);
                }
            }, POLLING_INTERVAL);
        }
        function checkImg2ImgTaskStatus(taskId) {
            const POLLING_INTERVAL = 10000; // 3 seconds
            const MAX_ATTEMPTS = 30;
            let attempts = 0;

            const intervalId = setInterval(async () => {
                attempts++;
                try {
                    const statusResponse = await $.ajax({
                        url: `/novita/img2img-task-status/${taskId}`,
                        method: 'GET',
                        dataType: 'json'
                    });

                    if (statusResponse.status === 'completed') {
                        clearInterval(intervalId);
                        const { imageUrls } = statusResponse.result;

                        // Display the generated images for selection
                        displayGeneratedImages(imageUrls);

                        showNotification(translations.newCharacter.image_generated_successfully, 'success');
                        $('#characterPrompt').prop('disabled', false);
                        $('#generateButton').prop('disabled', false);
                        $('#generateButton').html('<i class="fas fa-magic me-2"></i>'+translations.newCharacter.generate_with_AI);
                        $('.genexp').fadeOut()

                    } else if (statusResponse.status === 'failed') {
                        clearInterval(intervalId);
                        showNotification(`画像の生成に失敗しました: ${statusResponse.error}`, 'error');
                        $('#characterPrompt').prop('disabled', false);
                        $('#generateButton').prop('disabled', false);
                        $('#generateButton').html('<i class="fas fa-magic me-2"></i>'+translations.newCharacter.generate_with_AI);
                        $('.genexp').fadeOut()
                    } else {
                        console.log('タスクはまだ処理中です...');
                    }

                    if (attempts >= MAX_ATTEMPTS) {
                        clearInterval(intervalId);
                        showNotification('画像の生成がタイムアウトしました。再試行してください。', 'error');
                        $('#characterPrompt').prop('disabled', false);
                        $('#generateButton').prop('disabled', false);
                        $('#generateButton').html('<i class="fas fa-magic me-2"></i>'+translations.newCharacter.generate_with_AI);
                        $('.genexp').fadeOut()
                    }

                } catch (error) {
                    clearInterval(intervalId);
                    console.error('タスクステータスポーリングエラー:', error);
                    showNotification('画像の生成中にエラーが発生しました。', 'error');
                    $('#characterPrompt').prop('disabled', false);
                    $('#generateButton').prop('disabled', false);
                    $('#generateButton').html('<i class="fas fa-magic me-2"></i>'+translations.newCharacter.generate_with_AI);
                    $('.genexp').fadeOut()

                }
            }, POLLING_INTERVAL);
        }
    $('#generateButton').on('click', async function() {

        const isTemporary = user.isTemporary
        if(isTemporary){
            showRegistrationForm()
            return
        }
        const prompt = characterPrompt = $('#characterPrompt').val().trim();

        if (!prompt || !chatId) {
            showNotification(translations.newCharacter.allFieldsRequired, 'error');
            return;
        }
        const gender = $('#gender').val()
        const isEnhanceEnabled = $('#enableEnhancedPrompt').is(':checked');

        const $button = $(this);
        $button.prop('disabled', true);

        // ボタンテキストを更新
        if(isEnhanceEnabled){
            $button.html(`<i class="fas fa-spinner fa-spin me-2"></i>${translations.newCharacter.enhancing_prompt}`);
        } else {
            $button.html(`<i class="fas fa-spinner fa-spin me-2"></i>${translations.imageForm.generatingImages}`);
        }

        $('#characterPrompt').prop('disabled', true);
        
        try {
            let enhanceResponse = {enhancedPrompt:''}

            if(isEnhanceEnabled){
                if($('#enhancedPrompt').val().trim() != ''){
                    enhanceResponse.enhancedPrompt = $('#enhancedPrompt').val()
                }else{
                    // プロンプトを強化するリクエスト
                    enhanceResponse = await $.ajax({
                        url: '/api/enhance-prompt',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ prompt, gender, chatId })
                    });
                }

                if (enhanceResponse && enhanceResponse.enhancedPrompt) {
                    $('#enhancedPrompt').val(enhanceResponse.enhancedPrompt);
                } else {
                    showNotification('プロンプトの生成に失敗しました。再試行してください。', 'error');
                    // ボタンを有効化し、初期状態のテキストに戻す
                    $button.prop('disabled', false);
                    $button.html(`<i class="fas fa-magic me-2"></i>${translations.newCharacter.generate_with_AI}`);
                    $('#characterPrompt').prop('disabled', false);
                    return;
                }
            } else {
                // プロンプトをそのまま使用
                enhanceResponse.enhancedPrompt = prompt;
            }

            // ボタンテキストを「画像を生成中...」に更新
            $button.html(`<i class="fas fa-spinner fa-spin me-2"></i>${translations.imageForm.generatingImages}`);
            $('.genexp').fadeIn()

            const files = $('#imageUploaderContainer')?.find('input[type="file"]')[0]?.files;
            if (files && files.length > 0) {
                const file = files[0];

                // ファイルをBase64として読み込む
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Image = e.target.result.split(',')[1]; // data:image/png;base64, 部分を削除
                    // このBase64画像をバックエンドに送信
                    sendImageToBackend(base64Image);
                };
                reader.readAsDataURL(file);
                return;
            }

            const imageStyle = $('.style-option.selected').data('style')
            const imageModel = $('.style-option.selected').data('model')
            const imageVersion = $('.style-option.selected').data('version')

            // タスクIDを取得するリクエスト
            const taskResponse = await fetchTaskId(enhanceResponse.enhancedPrompt, '9:16', chatId, imageStyle, imageModel, imageVersion);

            if (taskResponse && taskResponse.taskId) {
                showNotification(translations.newCharacter.image_generation_start, 'info');
                // タスクステータスをポーリング
                checkTaskStatus(taskResponse.taskId,characterPrompt, enhanceResponse.enhancedPrompt, imageStyle, imageModel, imageVersion);
            } else {
                showNotification(translations.newCharacter.image_generation_failure, 'error');
                // ボタンを有効化し、初期状態のテキストに戻す
                $button.prop('disabled', false);
                $button.html('<i class="fas fa-magic me-2"></i>'+translations.newCharacter.generate_with_AI);
                $('#characterPrompt').prop('disabled', false);
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification(translations.newCharacter.generation_error, 'error');
            // ボタンを有効化し、初期状態のテキストに戻す
            $button.prop('disabled', false);
            $button.html('<i class="fas fa-magic me-2"></i>'+translations.newCharacter.generate_with_AI);
            $('#characterPrompt').prop('disabled', false);
        }
    });

        function sendImageToBackend(base64Image) {
            const prompt = $('#enhancedPrompt').val().trim();

            if (!prompt) {
                showNotification('プロンプトを入力してください。', 'error');
                return;
            }

            const data = {
                image_base64: base64Image,
                prompt: prompt,
                aspectRatio: '9:16',
                userId: '{{user._id}}', 
                chatId: '{{chatId}}',
            };

            $.ajax({
                url: '/novita/img2img',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    const taskId = response.taskId;
                    showNotification('画像生成タスクを開始しました。ステータスを確認中...', 'info');
                    // Start polling for the task status
                    checkImg2ImgTaskStatus(taskId);
                },
                error: function(error) {
                    console.error('Error starting img2img task:', error);
                    showNotification('画像生成タスクの開始に失敗しました。再試行してください。', 'error');
                    $('#characterPrompt').prop('disabled', false);
                    $('#generateButton').prop('disabled', false);
                    $('#generateButton').html('<i class="fas fa-magic me-2"></i>'+translations.newCharacter.generate_with_AI);
                    $('.genexp').fadeOut()
                }
                
            });
        }

        $('#ai-assist').on('click', function() {

            $('#ai-assist .fa-spinner').show();
            $('#ai-assist .fa-magic').hide();

            if ($('#chatPurpose').val().trim() == '') {
                showNotification('キャラクターの説明は必須項目です。入力してください。', 'error');
                $('#ai-assist .fa-spinner').hide();
                $('#ai-assist .fa-magic').show();
                return;
            }

            $('#chatPurpose').prop('disabled', false);
            $('#chatName').prop('disabled', true);
            $('#chatDescription').prop('disabled', true);

            $('#chatName').val('')
            $('#chatDescription').val('')
            $('#markdownContainer').html('')
            generateCompletion(function() {
                $('#sendForm').show();
                $('.sendForm-text').show();
                $('#ai-assist .fa-spinner').hide();
                $('#ai-assist .fa-magic').show();
            });
        });

        function generateCompletion(callback) {

            const apiUrl = '/api/openai-chat-creation';
        
            let chatId = '{{chatId}}';
            let prompt = $('#chatPurpose').val().trim();
            let gender = $('#gender').val()

            if(prompt.length == 0){
                return
            } 

            $.ajax({
                url: apiUrl,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ chatId, prompt, gender}),
                success: function(response) {
                    console.log(response)
                    showInput();

                    $('#chatName').val(response.name);
                    $('#chatDescription').val(response.short_intro);
                    $('#chatStory').val(response.base_personality.story);

                    updateButtonText()

                    if (typeof callback === 'function') {
                        callback();
                    }
                },
                error: function(error) {
                    console.error('Error:', error);
                    $('#ai-assist .fa-spinner').hide();
                    $('#ai-assist .fa-magic').show();
                }
            });
        }

        function showInput(){
            $('#markdownContainer').show()
            $('#chatDescription').show()
            $('#chatStory').show()
            $('#chatName').show()
            resizeTextarea($('#chatDescription')[0]);
            resizeTextarea($('#chatStory')[0]);
        }

        // Helper function to create the message payload
        function createMessagePayload(base64Image) {
            return [
                {
                    "type": "image_url",
                    "image_url": {
                        "url": `data:image/png;base64,${base64Image}`
                    }
                }
            ];
        }


        function updateButtonText() {
            let chatName = $('#chatName').val().trim();
            $('#sendForm span').html(`${chatName}とチャットする`);
        }
        
       
});
</script>
</body>
</html>
