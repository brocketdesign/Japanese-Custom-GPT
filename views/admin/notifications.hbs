<!DOCTYPE html>
<html lang="ja">
    {{> dashboard-header}}
<body>
    {{> dashboard-nav}}
    <div class="container-fluid mt-4 px-4">
        <!-- Header Section -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-1"><i class="bi bi-bell-fill me-2"></i>Manage Notifications</h2>
                <p class="text-muted mb-0">Send and manage notifications to users</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-danger" id="purgeOldBtn">
                    <i class="bi bi-trash me-1"></i> Purge Old (30+ days)
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModal">
                    <i class="bi bi-plus-lg me-1"></i> Create Notification
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Total Notifications</h6>
                                <h3 class="mb-0" id="totalCount">{{notifications.length}}</h3>
                            </div>
                            <div class="bg-primary bg-opacity-10 p-3 rounded-circle">
                                <i class="bi bi-bell text-primary fs-4"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Sticky Notifications</h6>
                                <h3 class="mb-0" id="stickyCount">0</h3>
                            </div>
                            <div class="bg-warning bg-opacity-10 p-3 rounded-circle">
                                <i class="bi bi-pin-angle text-warning fs-4"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Info Type</h6>
                                <h3 class="mb-0" id="infoCount">0</h3>
                            </div>
                            <div class="bg-info bg-opacity-10 p-3 rounded-circle">
                                <i class="bi bi-info-circle text-info fs-4"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Warning/Error</h6>
                                <h3 class="mb-0" id="alertCount">0</h3>
                            </div>
                            <div class="bg-danger bg-opacity-10 p-3 rounded-circle">
                                <i class="bi bi-exclamation-triangle text-danger fs-4"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications Table -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">All Notifications</h5>
                    <div class="input-group" style="max-width: 300px;">
                        <input type="text" class="form-control" placeholder="Search notifications..." id="searchNotifications">
                        <button class="btn btn-outline-secondary" type="button">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 5%;">#</th>
                                <th style="width: 20%;">Title</th>
                                <th style="width: 30%;">Message</th>
                                <th style="width: 10%;">Type</th>
                                <th style="width: 8%;">Sticky</th>
                                <th style="width: 12%;">Created</th>
                                <th style="width: 8%;">Views</th>
                                <th style="width: 12%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="notificationsTable">
                            {{#each notifications}}
                            <tr data-id="{{this._id}}">
                                <td><small class="text-muted">{{@index}}</small></td>
                                <td>
                                    <strong>{{this.title}}</strong>
                                </td>
                                <td>
                                    <span class="text-truncate d-inline-block" style="max-width: 300px;" title="{{this.message}}">
                                        {{this.message}}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge {{#if (eq this.type 'info')}}bg-info{{else if (eq this.type 'warning')}}bg-warning{{else if (eq this.type 'error')}}bg-danger{{else}}bg-secondary{{/if}}">
                                        {{this.type}}
                                    </span>
                                </td>
                                <td>
                                    {{#if this.sticky}}
                                        <span class="badge bg-warning text-dark"><i class="bi bi-pin-angle-fill"></i> Yes</span>
                                    {{else}}
                                        <span class="text-muted">No</span>
                                    {{/if}}
                                </td>
                                <td><small>{{this.createdAt}}</small></td>
                                <td>
                                    <span class="badge bg-light text-dark">{{this.viewedCount}}</span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary edit-btn" title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-danger delete-btn" title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {{/each}}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Modal -->
    <div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <form id="createForm">
                <div class="modal-content">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title" id="createModalLabel">
                            <i class="bi bi-bell-fill me-2 text-primary"></i>Create Notification
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Target Selection -->
                        <div class="card bg-light border-0 mb-4">
                            <div class="card-body">
                                <h6 class="card-title mb-3"><i class="bi bi-people me-2"></i>Target Recipients</h6>
                                
                                <!-- Target Type Selection -->
                                <div class="btn-group w-100 mb-3" role="group">
                                    <input type="radio" class="btn-check" name="targetType" id="targetAll" value="all" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="targetAll">
                                        <i class="bi bi-globe me-1"></i> All Users
                                    </label>
                                    <input type="radio" class="btn-check" name="targetType" id="targetSpecific" value="specific" autocomplete="off" checked>
                                    <label class="btn btn-outline-primary" for="targetSpecific">
                                        <i class="bi bi-person me-1"></i> Specific Users
                                    </label>
                                    <input type="radio" class="btn-check" name="targetType" id="targetSticky" value="sticky" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="targetSticky">
                                        <i class="bi bi-pin-angle me-1"></i> Sticky (Everyone)
                                    </label>
                                </div>

                                <!-- User Search Section -->
                                <div id="userSearchSection">
                                    <div class="input-group mb-2">
                                        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                                        <input type="text" class="form-control" id="userSearchInput" placeholder="Search by name, email or user ID...">
                                    </div>
                                    <div id="userSearchResults" class="border rounded bg-white mb-3" style="max-height: 200px; overflow-y: auto; display: none;"></div>
                                    
                                    <!-- Selected Users -->
                                    <div id="selectedUsersContainer">
                                        <label class="form-label small text-muted">Selected Users:</label>
                                        <div id="selectedUsersList" class="d-flex flex-wrap gap-2">
                                            <span class="text-muted small" id="noUsersSelected">No users selected</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Notification Content -->
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label class="form-label">Title <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="title" required placeholder="Enter notification title">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Type</label>
                                    <select class="form-select" name="type">
                                        <option value="info">ℹ️ Info</option>
                                        <option value="success">✅ Success</option>
                                        <option value="warning">⚠️ Warning</option>
                                        <option value="error">❌ Error</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Message <span class="text-danger">*</span></label>
                            <textarea class="form-control" name="message" rows="8" required placeholder="Enter notification message"></textarea>
                        </div>

                        <!-- Additional Fields (replaces JSON) -->
                        <div class="card bg-light border-0">
                            <div class="card-body">
                                <h6 class="card-title mb-3"><i class="bi bi-gear me-2"></i>Additional Options</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Link URL <small class="text-muted">(optional)</small></label>
                                            <input type="url" class="form-control" name="link" placeholder="https://example.com/page">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Action Text <small class="text-muted">(optional)</small></label>
                                            <input type="text" class="form-control" name="actionText" placeholder="e.g., View Details">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-0">
                                    <label class="form-label">Image URL <small class="text-muted">(optional)</small></label>
                                    <input type="url" class="form-control" name="imageUrl" placeholder="https://example.com/image.jpg">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-0 pt-0">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-send me-1"></i> Send Notification
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form id="editForm">
                <div class="modal-content">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title" id="editModalLabel">
                            <i class="bi bi-pencil-fill me-2 text-warning"></i>Edit Notification
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="id">
                        <div class="mb-3">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-control" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Message</label>
                            <textarea class="form-control" name="message" rows="8" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Type</label>
                            <select class="form-select" name="type">
                                <option value="info">ℹ️ Info</option>
                                <option value="success">✅ Success</option>
                                <option value="warning">⚠️ Warning</option>
                                <option value="error">❌ Error</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Link URL <small class="text-muted">(optional)</small></label>
                            <input type="url" class="form-control" name="link" placeholder="https://example.com">
                        </div>
                        <div class="form-check form-switch">
                            <input type="checkbox" class="form-check-input" id="editStickyCheckbox" name="sticky">
                            <label class="form-check-label" for="editStickyCheckbox">Sticky Notification</label>
                        </div>
                    </div>
                    <div class="modal-footer border-0 pt-0">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-warning">
                            <i class="bi bi-check-lg me-1"></i> Update
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // State
        let selectedUsers = [];
        let searchTimeout = null;

        // Calculate stats on load
        document.addEventListener('DOMContentLoaded', function() {
            const rows = document.querySelectorAll('#notificationsTable tr');
            let stickyCount = 0, infoCount = 0, alertCount = 0;
            
            rows.forEach(row => {
                const stickyBadge = row.querySelector('.badge.bg-warning');
                const typeBadge = row.querySelector('td:nth-child(5) .badge');
                
                if (stickyBadge && stickyBadge.textContent.includes('Yes')) stickyCount++;
                if (typeBadge) {
                    const type = typeBadge.textContent.trim();
                    if (type === 'info') infoCount++;
                    if (type === 'warning' || type === 'error') alertCount++;
                }
            });
            
            document.getElementById('stickyCount').textContent = stickyCount;
            document.getElementById('infoCount').textContent = infoCount;
            document.getElementById('alertCount').textContent = alertCount;
        });

        // Notification helper
        const showNotification = (message, icon) => {
            Swal.fire({ icon, title: message, timer: 2000, showConfirmButton: false });
        };

        // Target type change handler
        document.querySelectorAll('input[name="targetType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const userSearchSection = document.getElementById('userSearchSection');
                if (this.value === 'specific') {
                    userSearchSection.style.display = 'block';
                } else {
                    userSearchSection.style.display = 'none';
                }
            });
        });

        // User search functionality
        document.getElementById('userSearchInput').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();
            
            if (query.length < 2) {
                document.getElementById('userSearchResults').style.display = 'none';
                return;
            }
            
            searchTimeout = setTimeout(async () => {
                try {
                    const res = await fetch(`/notifications/search-users?q=${encodeURIComponent(query)}`);
                    const users = await res.json();
                    
                    const resultsDiv = document.getElementById('userSearchResults');
                    if (users.length === 0) {
                        resultsDiv.innerHTML = '<div class="p-3 text-muted text-center">No users found</div>';
                    } else {
                        resultsDiv.innerHTML = users.map(user => `
                            <div class="user-search-item p-2 border-bottom d-flex align-items-center" 
                                 data-userid="${user._id}" 
                                 data-name="${user.nickname || user.username || user.email}"
                                 style="cursor: pointer;">
                                <img src="${user.profileUrl || '/img/avatar.png'}" 
                                     class="rounded-circle me-2" width="32" height="32" alt="">
                                <div class="flex-grow-1">
                                    <div class="fw-medium">${user.nickname || user.username || 'Unknown'}</div>
                                    <small class="text-muted">${user.email || user._id}</small>
                                </div>
                                <i class="bi bi-plus-circle text-primary"></i>
                            </div>
                        `).join('');
                        
                        // Add click handlers
                        resultsDiv.querySelectorAll('.user-search-item').forEach(item => {
                            item.addEventListener('click', function() {
                                addSelectedUser(this.dataset.userid, this.dataset.name);
                            });
                        });
                    }
                    resultsDiv.style.display = 'block';
                } catch (err) {
                    console.error('Search error:', err);
                }
            }, 300);
        });

        // Add selected user
        function addSelectedUser(userId, name) {
            if (selectedUsers.find(u => u.id === userId)) return;
            
            selectedUsers.push({ id: userId, name });
            updateSelectedUsersList();
            document.getElementById('userSearchInput').value = '';
            document.getElementById('userSearchResults').style.display = 'none';
        }

        // Remove selected user
        function removeSelectedUser(userId) {
            selectedUsers = selectedUsers.filter(u => u.id !== userId);
            updateSelectedUsersList();
        }

        // Update selected users display
        function updateSelectedUsersList() {
            const container = document.getElementById('selectedUsersList');
            const noUsersMsg = document.getElementById('noUsersSelected');
            
            if (selectedUsers.length === 0) {
                container.innerHTML = '<span class="text-muted small" id="noUsersSelected">No users selected</span>';
                return;
            }
            
            container.innerHTML = selectedUsers.map(user => `
                <span class="badge bg-primary d-flex align-items-center gap-1">
                    ${user.name}
                    <i class="bi bi-x-circle" style="cursor: pointer;" onclick="removeSelectedUser('${user.id}')"></i>
                </span>
            `).join('');
        }

        // Create form submission
        document.getElementById('createForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const targetType = document.querySelector('input[name="targetType"]:checked').value;
            
            let userId;
            let sticky = false;
            
            if (targetType === 'all') {
                userId = 'all';
            } else if (targetType === 'sticky') {
                sticky = true;
            } else {
                if (selectedUsers.length === 0) {
                    showNotification('Please select at least one user', 'error');
                    return;
                }
                userId = selectedUsers.length === 1 ? selectedUsers[0].id : selectedUsers.map(u => u.id);
            }
            
            const data = {
                userId,
                title: form.title.value,
                message: form.message.value,
                type: form.type.value,
                link: form.link.value || undefined,
                actionText: form.actionText.value || undefined,
                imageUrl: form.imageUrl.value || undefined,
                sticky
            };
            
            try {
                const res = await fetch('/notifications', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    const result = await res.json();
                    showNotification(`Notification sent to ${result.count || 1} user(s)`, 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    const err = await res.json();
                    showNotification(err.error, 'error');
                }
            } catch {
                showNotification('Error creating notification', 'error');
            }
        });

        // Edit button handlers
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const tr = e.target.closest('tr');
                const id = tr.getAttribute('data-id');
                const res = await fetch(`/notifications/${id}`);
                if (res.ok) {
                    const data = await res.json();
                    const editModal = new bootstrap.Modal(document.getElementById('editModal'));
                    const form = document.getElementById('editForm');
                    form.id.value = data._id;
                    form.title.value = data.title || '';
                    form.message.value = data.message;
                    form.type.value = data.type;
                    form.link.value = data.data?.link || '';
                    form.sticky.checked = data.sticky || false;
                    editModal.show();
                } else {
                    showNotification('Failed to fetch notification', 'error');
                }
            });
        });

        // Edit form submission
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const id = form.id.value;
            const data = {
                title: form.title.value,
                message: form.message.value,
                type: form.type.value,
                data: { link: form.link.value || undefined },
                sticky: form.sticky.checked
            };
            try {
                const res = await fetch(`/notifications/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showNotification('Notification updated', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    const err = await res.json();
                    showNotification(err.error, 'error');
                }
            } catch {
                showNotification('Error updating notification', 'error');
            }
        });

        // Delete button handlers
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const tr = e.target.closest('tr');
                const id = tr.getAttribute('data-id');
                Swal.fire({
                    title: 'Delete notification?',
                    text: 'This action cannot be undone.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    confirmButtonText: 'Delete'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        const res = await fetch(`/notifications/${id}`, { method: 'DELETE' });
                        if (res.ok) {
                            showNotification('Notification deleted', 'success');
                            tr.remove();
                        } else {
                            const err = await res.json();
                            showNotification(err.error, 'error');
                        }
                    }
                });
            });
        });

        // Purge old notifications
        document.getElementById('purgeOldBtn').addEventListener('click', () => {
            Swal.fire({
                title: 'Purge old notifications?',
                text: 'This will delete all non-sticky notifications older than 30 days.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                confirmButtonText: 'Purge'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const res = await fetch('/notifications/purge-old', { method: 'DELETE' });
                    if (res.ok) {
                        const data = await res.json();
                        showNotification(data.message, 'success');
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showNotification('Failed to purge notifications', 'error');
                    }
                }
            });
        });

        // Search notifications in table
        document.getElementById('searchNotifications').addEventListener('input', function() {
            const query = this.value.toLowerCase();
            document.querySelectorAll('#notificationsTable tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query) ? '' : 'none';
            });
        });
    </script>
</body>
<style>
    .sticky-bottom { display: none; }
    .user-search-item:hover {
        background-color: #f8f9fa;
    }
    .card {
        border-radius: 12px;
    }
    .table th {
        font-weight: 600;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
</style>
{{> dashboard-footer}}
</html>
