<!DOCTYPE html>
<html lang="ja">
    {{> dashboard-header}}
<body>
    {{> dashboard-nav}}
        <div class="container mt-5">
            <h2 class="mb-4">Chats for User {{userId}}</h2>
            <div class="table-responsive">
                <table class="table table-striped table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Date</th>
                            <th>Chat Preview</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each chats}}
                        <tr>
                            <td>{{this.name}}</td>
                            <td class="jp-d">{{this.updatedAt}}</td>
                            <td>
                                <!-- Button to Trigger SweetAlert2 Popup -->
                                <button 
                                    class="btn btn-primary btn-view-chat" 
                                    data-messages='{{json this.messages}}' 
                                    data-name="{{this.name}}" 
                                    data-updatedat="{{this.updatedAt}}"
                                >
                                    <i class="fas fa-eye"></i> Preview
                                </button>
                                <a href="/chat/{{this._id}}"> Open</a>
                            </td>
                        </tr>
                        {{/each}}
                    </tbody>
                </table>
            </div>
            <a href="/admin/users/registered" class="btn btn-secondary mt-3" id="back-to-users">Back to Users</a>
        </div>
    </body>
    {{> dashboard-footer}}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Include SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function() {

            // Function to convert dates to Japanese format
            function convertToJapaneseDate(dateString) {
                var options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
                var date = new Date(dateString);
                return date.toLocaleDateString('ja-JP', options);
            }

            // Convert all dates on the page
            $('.jp-d').each(function() {
                var originalDate = $(this).text();
                var japaneseDate = convertToJapaneseDate(originalDate);
                $(this).text(japaneseDate);
            });

            // Handle click event on 'Preview' buttons
            $('.btn-view-chat').on('click', function() {
                // Retrieve data attributes
                var messages = $(this).data('messages');
                var chatName = $(this).data('name');
                var updatedAt = $(this).data('updatedat');

                // Build HTML content for the popup
                var chatContent = `
                    <div class="chat-preview-container">
                        <div style="background-color: #f9f9f9; padding: 10px; border-radius: 5px;">
                            <h3 class="chat-preview-title">Chat Preview: ${chatName}</h3>
                            <p class="chat-preview-updated"><strong>Last Updated:</strong> ${convertToJapaneseDate(updatedAt)}</p>
                        </div>
                        <div class="chat-preview-messages m-auto" style="text-align: left; max-height: 400px; overflow-y: auto;">
                            ${messages.map(function(message) {
                                // Escape HTML to prevent XSS
                                var content = $('<div>').text(message.content).html().replace(/\n/g, '<br>');
                                var bubbleClass = message.role === 'user' ? 'user-bubble' : 'assistant-bubble';
                                return `
                                    <div class="chat-message ${bubbleClass}">
                                        <p class="chat-message-content">${content}</p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;

                // Display SweetAlert2 popup
                Swal.fire({
                    html: chatContent,
                    width: '800px',
                    showCloseButton: true,
                    focusConfirm: false,
                    showConfirmButton: false,
                    customClass: {
                        popup: 'animated fadeInDown'
                    }
                });
            });

            // Helper function to convert date in popup
            function convertToJapaneseDate(dateString) {
                var options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
                var date = new Date(dateString);
                return date.toLocaleDateString('ja-JP', options);
            }

        });
    </script>
    <style>
        .assistant-bubble {
            background-color: #f0f0f0;
            color: #333;
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            max-width: 70%;
            word-wrap: break-word;
        }
        .user-bubble {
            background-color: #007bff;
            color: #fff;
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            max-width: 70%;
            word-wrap: break-word;
            margin-left: auto;
        }
    </style>
</html>
