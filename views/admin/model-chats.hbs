<!DOCTYPE html>
<html lang="{{lang}}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Model Chats Management - Admin</title>
  {{>dashboard-header}}
</head>
<body>
  {{>dashboard-nav}}
  
  <div class="container-fluid mt-4">
    <div class="row">
      <div class="col-12">
        <h2>Model Chats Management</h2>
        <p>Generate daily AI character chats for each model in your system.</p>
        
        <div class="card mb-4">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Cron Job Settings</h5>
            </div>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <form id="cronSettingsForm">
                  <div class="mb-3">
                    <label for="cronSchedule" class="form-label">Cron Schedule</label>
                    <input type="text" class="form-control" id="cronSchedule" value="{{cronSettings.schedule}}" placeholder="0 */2 * * *">
                    <div class="form-text">Format: minute hour day_of_month month day_of_week (e.g. "0 */2 * * *" for every 2 hours)</div>
                  </div>
                  <div class="mb-3">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="cronEnabled" {{#if cronSettings.enabled}}checked{{/if}}>
                      <label class="form-check-label" for="cronEnabled">Enable automatic generation</label>
                    </div>
                  </div>
                  <div class="mb-3">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="cronNsfw" {{#if cronSettings.nsfw}}checked{{/if}}>
                      <label class="form-check-label" for="cronNsfw">Include NSFW content</label>
                    </div>
                  </div>
                  <button type="submit" class="btn btn-primary">Save Settings</button>
                </form>
              </div>
              <div class="col-md-6">
                <div class="card">
                  <div class="card-body">
                    <h5 class="card-title">Schedule Information</h5>
                    <p><strong>Status:</strong> <span id="jobStatus" class="badge {{#if cronSettings.enabled}}bg-success{{else}}bg-danger{{/if}}">{{#if cronSettings.enabled}}Active{{else}}Inactive{{/if}}</span></p>
                    <p><strong>Next Run:</strong> <span id="nextRun">{{cronSettings.nextRun}}</span></p>
                    <p><strong>Last Run:</strong> <span id="lastRun">{{cronSettings.lastRun}}</span></p>
                    <p><strong>Content Type:</strong> <span id="contentType">{{#if cronSettings.nsfw}}NSFW Included{{else}}SFW Only{{/if}}</span></p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card mb-4">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Available Models</h5>
              <button id="generateAllChats" class="btn btn-primary">Generate All Model Chats</button>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Thumbnail</th>
                    <th>Model</th>
                    <th>Style</th>
                    <th>Version</th>
                    <th>Recent Chats</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {{#each models}} 
                    <tr>
                      <td>
                        <img src="{{image}}" alt="{{model}}" class="rounded-circle img-thumbnail" style="width: 60px;height:60px; object-fit: cover;">
                      </td>
                      <td>{{model}}</td>
                      <td>{{style}}</td>
                      <td>{{version}}</td>
                      <td>
                        <span class="badge {{#if hasRecentChat}}bg-success{{else}}bg-danger{{/if}}">
                          {{#if hasRecentChat}}Generated today{{else}}Not generated today{{/if}}
                        </span>
                        <span class="ms-2">{{chats.length}} recent chats</span>
                      </td>
                      <td>
                        <button class="btn btn-sm btn-outline-primary generate-chat-btn" 
                                data-model-id="{{modelId}}"
                                data-model-name="{{model}}">
                          Generate Chat
                        </button>
                      </td>
                    </tr>
                  {{/each}}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Recently Generated Chats</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Thumbnail</th>
                    <th>Character Name</th>
                    <th>Model</th>
                    <th>Created</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {{#each recentChats}}
                    <tr>
                      <td>
                        <img src="{{chatImageUrl}}" alt="{{model}}" class="rounded-circle img-thumbnail" style="width: 60px;height:60px; object-fit: cover;">
                      </td>
                      <td>{{name}}</td>
                      <td>{{imageModel}}</td>
                      <td>{{formatDate createdAt}}</td>
                      <td>
                        <a href="/character/{{_id}}" class="btn btn-sm btn-outline-secondary" target="_blank">
                          View Character
                        </a>
                      </td>
                    </tr>
                  {{/each}}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal for character generation preview -->
  <div class="modal fade" id="generateChatModal" tabindex="-1" aria-labelledby="generateChatModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content mx-auto">
        <div class="modal-header">
          <h5 class="modal-title" id="generateChatModalLabel">Generating Chat</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0" style="height: 70vh;">
          <div class="container-fluid h-100 d-flex">
            <div class="row h-100 flex-nowrap w-100">
              <!-- Left column - Image preview (fixed on desktop, hidden on mobile when content is shown) -->
              <div class="col-lg-5 d-flex align-items-center justify-content-center border-end" id="imageColumn" style="background-color: #f8f9fa;">
                <div id="loadingPrompt" class="text-center">
                  <div class="spinner-border mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="text-muted">Fetching prompt...</p>
                </div>
                
                <div id="imagePreview" class="d-none text-center">
                  <img id="promptImage" src="" class="img-fluid rounded shadow" alt="Character preview" style="max-height: 400px; max-width: 100%; object-fit: contain;">
                </div>
                
                <div id="noPrompt" class="alert alert-warning d-none">
                  <i class="bi bi-exclamation-triangle"></i> No prompt available.
                </div>
                
                <div id="errorFetching" class="alert alert-danger d-none">
                  <i class="bi bi-exclamation-circle"></i> Error fetching prompt.
                </div>
              </div>
              
              <!-- Right column - Content (scrollable) -->
              <div class="col-lg-7 h-100 d-flex flex-column p-0" id="contentColumn">
                <div class="p-3 border-bottom bg-light">
                  <div class="d-flex justify-content-between align-items-center">
                    <div id="modelInfo">
                      <strong>Model:</strong> <span id="modelName" class="text-primary"></span>
                    </div>
                    <button id="getAnotherPreview" class="btn btn-sm btn-outline-secondary d-none">
                      <i class="bi bi-arrow-repeat"></i> Get Another
                    </button>
                  </div>
                </div>
                
                <div class="flex-grow-1 overflow-auto p-3" id="scrollableContent" style="height: calc(100% - 60px);">
                  <div id="promptDetails" class="d-none">
                    <!-- Mobile image preview (shown only on mobile) -->
                    <div class="d-lg-none mb-3 text-center">
                      <img id="promptImageMobile" src="" class="img-fluid rounded shadow" alt="Character preview" style="max-height: 250px; object-fit: contain;">
                    </div>
                    
                    <div class="mb-4">
                      <h6 class="fw-bold text-secondary mb-2">
                        <i class="bi bi-chat-text"></i> Prompt
                      </h6>
                      <div class="bg-white border rounded p-3" style="max-height: 150px; overflow-y: auto;">
                        <p id="promptText" class="mb-0 small"></p>
                      </div>
                    </div>
                    
                    <div class="mb-4">
                      <h6 class="fw-bold text-secondary mb-2">
                        <i class="bi bi-x-circle"></i> Negative Prompt
                      </h6>
                      <div class="bg-white border rounded p-3" style="max-height: 150px; overflow-y: auto;">
                        <p id="promptNegative" class="mb-0 small text-muted"></p>
                      </div>
                    </div>
                  </div>
                  
                  <div id="generationResult" class="alert d-none">
                    <div class="d-flex align-items-start">
                      <div class="flex-grow-1">
                        <p id="generationMessage" class="mb-2"></p>
                        <a id="viewCharacterLink" href="#" target="_blank" class="btn btn-primary btn-sm d-none">
                          <i class="bi bi-eye"></i> View Character
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer border-top">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-lg"></i> Close
          </button>
          <button type="button" id="generateBtn" class="btn btn-primary d-none">
            <i class="bi bi-play-fill"></i> Generate
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading modal for generate all -->
  <div class="modal fade" id="loadingModal" tabindex="-1" aria-labelledby="loadingModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg mx-0">
      <div class="modal-content mx-auto">
        <div class="modal-body text-center py-5">
          <div class="spinner-border mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <h5>Generating chats for all models...</h5>
          <p>This may take several minutes. Please don't close this window.</p>
        </div>
      </div>
    </div>
  </div>
  
  <style>
    @media (max-width: 991.98px) {
      #generateChatModal .modal-dialog {
        margin: 0.5rem;
      }
      
      #generateChatModal .modal-body {
        height: 80vh;
      }
      
      #imageColumn {
        display: none;
      }
      
      #contentColumn {
        height: 100% !important;
        width: 100% !important;
      }
    }
    
    #generateChatModal .modal-xl {
      max-width: 1000px;
    }
    
    #scrollableContent::-webkit-scrollbar {
      width: 6px;
    }
    
    #scrollableContent::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }
    
    #scrollableContent::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }
    
    #scrollableContent::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
    
    /* Additional styles for fixing the scrolling issue */
    #generateChatModal .modal-content {
      height: 100%;
    }
    
    #generateChatModal .modal-body {
      overflow: hidden;
    }
    
    #scrollableContent {
      min-height: 0;  /* This is crucial for flex containers with scrolling children */
      overflow-y: auto;
    }
    
    .row.h-100.flex-nowrap {
      margin: 0;
    }
  </style>
  {{>dashboard-footer}}
  
  <script>
    $(document).ready(function() {
      // Cron settings form submission
      $('#cronSettingsForm').on('submit', function(e) {
        e.preventDefault();
        
        const settings = {
          schedule: $('#cronSchedule').val(),
          enabled: $('#cronEnabled').is(':checked'),
          nsfw: $('#cronNsfw').is(':checked')
        };
        
        $.ajax({
          url: '/admin/model-chats/cron-settings',
          type: 'POST',
          data: settings,
          dataType: 'json',
          success: function(data) {
            if (data.success) {
              Swal.fire({
                title: 'Success!',
                text: 'Cron settings updated successfully.',
                icon: 'success',
                confirmButtonText: 'Great!'
              });
              
              // Update status display
              $('#jobStatus').removeClass('bg-success bg-danger')
                .addClass(settings.enabled ? 'bg-success' : 'bg-danger')
                .text(settings.enabled ? 'Active' : 'Inactive');
              
              $('#contentType').text(settings.nsfw ? 'NSFW Included' : 'SFW Only');
              $('#nextRun').text(data.nextRun || 'N/A');
              $('#lastRun').text(data.lastRun || 'N/A');
            } else {
              Swal.fire({
                title: 'Error!',
                text: data.error || 'Failed to update cron settings',
                icon: 'error',
                confirmButtonText: 'OK'
              });
            }
          },
          error: function(xhr) {
            Swal.fire({
              title: 'Error!',
              text: xhr.responseJSON?.error || 'An unknown error occurred',
              icon: 'error',
              confirmButtonText: 'OK'
            });
          }
        });
      });
      
      // Generate individual chat button click
      $('.generate-chat-btn').on('click', function() {
        const modelId = $(this).data('model-id');
        const modelName = $(this).data('model-name');
        let promptKey = null;
        
        // Ask about NSFW first
        Swal.fire({
          title: 'Include NSFW Content?',
          text: 'Do you want to include NSFW content in this chat?',
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Yes, include NSFW',
          cancelButtonText: 'No, SFW only'
        }).then((nsfwResult) => {
          const nsfw = nsfwResult.isConfirmed;
          
          // After NSFW choice, show modal and fetch preview
          $('#modelName').text(modelName);
          $('#loadingPrompt').removeClass('d-none');
          $('#promptPreview').addClass('d-none');
          $('#noPrompt').addClass('d-none');
          $('#errorFetching').addClass('d-none');
          $('#generationResult').addClass('d-none');
          $('#generateBtn').addClass('d-none');
          $('#viewCharacterLink').addClass('d-none');
          
          $('#generateChatModal').modal('show');
          
          // Fetch a preview prompt with NSFW parameter
          fetchPreviewPrompt(modelId, modelName, nsfw);
        });
      });
      
      // Extract prompt fetching into a separate function that can be reused
      function fetchPreviewPrompt(modelId, modelName, nsfw) {
        // Reset all states
        $('#loadingPrompt').removeClass('d-none');
        $('#imagePreview').addClass('d-none');
        $('#promptDetails').addClass('d-none');
        $('#noPrompt').addClass('d-none');
        $('#errorFetching').addClass('d-none');
        $('#generationResult').addClass('d-none');
        $('#generateBtn').addClass('d-none');
        $('#getAnotherPreview').addClass('d-none');

        let page = promptIndex = 1;
        const modelJson = JSON.parse(sessionStorage.getItem(`civitai-${modelId}-json`));
        if (modelJson) {
          page = modelJson.page || 1;
          promptIndex = modelJson.promptIndex || 1;
        }
        $.ajax({
          url: '/api/preview-prompt',
          type: 'POST',
          data: { modelId, modelName, nsfw, page, promptIndex},
          dataType: 'json',
          success: function(data) {
            console.log(data)
            $('#loadingPrompt').addClass('d-none');
            
            if (data.error) {
              $('#errorFetching').removeClass('d-none');
              return;
            }
            
            if (!data.prompt) {
              $('#noPrompt').removeClass('d-none');
              return;
            }
            
            // Store the promptKey for later use
            promptKey = data.promptKey;

            console.log(`[Model Chat] new index: ${data.prompt.promptIndex}, page: ${data.prompt.page}, modelId: ${modelId}, promptKey: ${promptKey}`);
            // update the session storage with model data
            sessionStorage.setItem(`civitai-${modelId}-json`, JSON.stringify({
              modelId,
              modelName,
              page: data.prompt.page,
              promptIndex: data.prompt.promptIndex,
              promptKey
            }));
            
            // Show image preview
            $('#imagePreview').removeClass('d-none');
            $('#promptImage').attr('src', data.prompt.imageUrl);
            $('#promptImageMobile').attr('src', data.prompt.imageUrl);
            
            // Show prompt details
            $('#promptDetails').removeClass('d-none');
            $('#promptText').text(data.prompt.prompt);
            $('#promptNegative').text(data.prompt.negativePrompt);
            
            // Show action buttons
            $('#generateBtn').removeClass('d-none')
              .data('model-id', modelId)
              .data('nsfw', nsfw)
              .data('prompt-key', promptKey);
            $('#getAnotherPreview').removeClass('d-none');
          },
          error: function() {
            $('#loadingPrompt').addClass('d-none');
            $('#errorFetching').removeClass('d-none');
          }
        });
      }
      
      // Get another preview button
      $('#getAnotherPreview').on('click', function() {
        const modelId = $('#generateBtn').data('model-id');
        const nsfw = $('#generateBtn').data('nsfw');
        const modelName = $('#modelName').text();
        
        // Fetch another preview for the same model
        fetchPreviewPrompt(modelId, modelName, nsfw);
      });
      
      // Generate button in modal click
      $('#generateBtn').on('click', function() {
        const modelId = $(this).data('model-id');
        const nsfw = $(this).data('nsfw');
        const promptKey = $(this).data('prompt-key');
        
        $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...');
        
        // Generate the chat using the same prompt as the preview
        $.ajax({
          url: '/admin/model-chats/generate',
          type: 'POST',
          data: { modelId, nsfw, promptKey },
          dataType: 'json',
          success: function(data) {
            $('#generateBtn').prop('disabled', false).text('Generate');
            
            if (data.error) {
              $('#generationResult').removeClass('d-none alert-success').addClass('alert-danger');
              $('#generationMessage').text(data.error);
              return;
            }
            
            if (data.success) {
              const chat = data.chat;
              $('#generationResult').removeClass('d-none alert-danger').addClass('alert-success');
              $('#generationMessage').text('Character generated successfully!');
              
              if (chat && chat._id) {
                $('#viewCharacterLink').removeClass('d-none').attr('href', '/character/' + chat._id);
              }
              
            } else {
              $('#generationResult').removeClass('d-none alert-success').addClass('alert-danger');
              $('#generationMessage').text('Failed to generate character.');
            }
          },
          error: function(xhr) {
            $('#generateBtn').prop('disabled', false).text('Generate');
            $('#generationResult').removeClass('d-none alert-success').addClass('alert-danger');
            $('#generationMessage').text(xhr.responseJSON?.error || 'An unknown error occurred');
          }
        });
      });
      
      // Generate all chats button click
      $('#generateAllChats').on('click', function() {
        Swal.fire({
          title: 'Generate All Model Chats?',
          text: 'This will generate chats for all models and may take some time.',
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Yes, generate all',
          cancelButtonText: 'Cancel'
        }).then((result) => {
          if (result.isConfirmed) {
            // Ask user about NSFW setting first
            Swal.fire({
              title: 'Include NSFW Content?',
              text: 'Do you want to include NSFW content in generated chats?',
              icon: 'question',
              showCancelButton: true,
              confirmButtonText: 'Yes, include NSFW',
              cancelButtonText: 'No, SFW only'
            }).then((nsfwResult) => {
              const nsfw = nsfwResult.isConfirmed;
              
              // Show loading indicator
              $('#loadingModal').modal('show');
              
              $.ajax({
                url: '/admin/model-chats/generate',
                type: 'POST',
                data: { nsfw },
                dataType: 'json',
                success: function(data) {
                  $('#loadingModal').modal('hide');
                  
                  if (data.success) {
                    const successes = data.results.filter(r => r.status === 'success').length;
                    const failures = data.results.filter(r => r.status !== 'success').length;
                    
                    Swal.fire({
                      title: 'Generation Complete',
                      text: `Successfully generated ${successes} chats. Failed: ${failures}.`,
                      icon: 'success',
                      confirmButtonText: 'Great!'
                    }).then(() => {
                      location.reload();
                    });
                  } else {
                    Swal.fire({
                      title: 'Error!',
                      text: data.error || 'Failed to generate chats',
                      icon: 'error',
                      confirmButtonText: 'OK'
                    });
                  }
                },
                error: function(xhr) {
                  $('#loadingModal').modal('hide');
                  
                  Swal.fire({
                    title: 'Error!',
                    text: xhr.responseJSON?.error || 'An unknown error occurred',
                    icon: 'error',
                    confirmButtonText: 'OK'
                  });
                }
              });
            });
          }
        });
      });
    });
  </script>
</body>
</html>