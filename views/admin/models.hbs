<!DOCTYPE html>
<html>
{{> dashboard-header}}
<body class="bg-dark">
    {{> dashboard-nav}}
    <style>
.card-img-container {
  height: 500px; /* Fixed height for image container */
  overflow: hidden;
  position: relative;
}

.card-img-container img {
  transition: transform 0.3s ease; /* Smooth transition for zoom */
  object-fit: cover;
  height: 100%;
  width: 100%;
}

.card-img-container:hover img {
  transform: scale(1.1); /* Slight zoom on hover */
}

.model-gallery-card .card-img-top {
  transition: transform 0.3s ease-in-out;
}

.model-gallery-card:hover .card-img-top {
  transform: scale(1.1);
}

.model-gallery-card .model-details-panel {
  transition: opacity 0.3s ease-in-out; /* For a fade effect */
  /* For a slide effect with Animate.css, it will be controlled by JS */
}

/* Ensure details panel is above the overlay when visible */
.model-gallery-card:hover .model-details-panel {
  z-index: 3; 
}

/* Active Models List Styling - Vertical List Design */
#active-models-section .model-selection {
    max-height: 400px;
    overflow-y: auto;
}

#active-models-section .model-checkbox {
    padding: 10px;
    border-radius: 8px;
    transition: background-color 0.2s ease;
}

#active-models-section .model-checkbox:hover {
    background-color: rgba(255, 255, 255, 0.05);
}

#active-models-section .model-thumbnail {
    width: 50px;
    height: 50px;
    object-fit: cover;
    border-radius: 8px;
    flex-shrink: 0;
}

#active-models-section .model-info-btn {
    opacity: 0.7;
    transition: opacity 0.2s ease;
}

#active-models-section .model-info-btn:hover {
    opacity: 1;
}
</style>
<section>
  <div class="container py-5">
    <div class="text-center mb-4">
      <h1 class="display-5 text-white">Models Gallery</h1>
      <p class="lead text-white">Explore public models with infinite scroll</p>
    </div>

    <div class="row mb-4">
      <div class="col-md-6 offset-md-3">
        <div class="input-group">
          <input id="searchInput" type="text" class="form-control" placeholder="Search models...">
          <button id="searchBtn" class="btn btn-primary" type="button">
            <i class="bi bi-search"></i>
          </button>
        </div>
      </div>
    </div>

    {{!-- Active Models Vertical List --}}
    <div id="active-models-section" class="mb-4">
      <div class="card bg-dark border-secondary">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-check-circle me-2"></i>Active Models <span class="badge bg-light text-primary ms-2" id="activeModelsCount">{{models.length}}</span></h5>
        </div>
        <div class="card-body">
          <div class="model-selection" id="active-models">
            {{#each models}}
            <div class="form-check model-checkbox mb-2">
              <input class="form-check-input model-switch" type="checkbox" checked
                value="{{modelId}}"
                id="active-model-{{modelId}}"
                data-model-id="{{modelId}}"
                data-model="{{model}}"
                data-style="{{#if style}}{{style}}{{else}}anime{{/if}}"
                data-version="{{version}}"
                data-image="{{image}}"
                data-name="{{model}}">
              <label class="form-check-label text-white w-100" for="active-model-{{modelId}}">
                <div class="d-flex align-items-center gap-3">
                  {{#if image}}
                  <img src="{{image}}" 
                       alt="{{model}}" 
                       class="model-thumbnail"
                       onerror="this.style.display='none'">
                  {{/if}}
                  <div class="flex-grow-1">
                    <span class="fw-semibold">{{model}}</span>
                    <span class="badge bg-{{#if (eq style 'anime')}}info{{else}}success{{/if}} ms-1">{{#if style}}{{style}}{{else}}anime{{/if}}</span>
                    <span class="badge bg-secondary ms-1">v{{version}}</span>
                    <br>
                    <small class="text-muted">ID: {{modelId}}</small>
                  </div>
                  <button class="btn btn-sm btn-outline-light model-info-btn p-2" type="button" title="View Details"
                    data-model-id="{{modelId}}"
                    data-model="{{model}}"
                    data-style="{{#if style}}{{style}}{{else}}anime{{/if}}"
                    data-version="{{version}}"
                    data-image="{{image}}"
                    data-name="{{name}}">
                    <i class="bi bi-info-circle"></i>
                  </button>
                </div>
              </label>
            </div>
            {{/each}}
          </div>
        </div>
      </div>
    </div>

    {{!-- Infinite Scroll Gallery --}}
    <div id="model-gallery" class="row"></div>
  </div>
</section>

<!-- Model Details Modal -->
<div class="modal fade" id="modelDetailsModal" tabindex="-1" aria-labelledby="modelDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content bg-dark text-white mx-auto modal-dialog-scrollable">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="modelDetailsModalLabel">Model Details</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-4">
            <img id="modalModelImage" src="" alt="Model Image" class="img-fluid rounded" style="max-height: 70vh;">
          </div>
          <div class="col-md-8">
            <h6 id="modalModelName" class="fw-bold mb-2"></h6>
            <p class="small mb-1"><strong>Model:</strong> <span id="modalModelModel"></span></p>
            <p class="small mb-1"><strong>Style:</strong> <span id="modalModelStyle"></span></p>
            <p class="small mb-1"><strong>Version:</strong> <span id="modalModelVersion"></span></p>
            <p class="small mb-3"><strong>ID:</strong> <span id="modalModelId" class="text-break"></span></p>
            
            <form id="styleForm" class="mb-3">
              <div class="mb-3">
                <label class="form-label">Default Style</label>
                <div class="segmented-control segmented-control-light" role="group" aria-label="Style selection">
                  <input type="radio" class="btn-check" name="styleOption" id="styleAnime" value="anime" autocomplete="off">
                  <label class="segment-btn" for="styleAnime">
                    <i class="bi bi-palette"></i>
                    <span>Anime</span>
                  </label>
                  
                  <input type="radio" class="btn-check" name="styleOption" id="stylePhotorealistic" value="photorealistic" autocomplete="off">
                  <label class="segment-btn" for="stylePhotorealistic">
                    <i class="bi bi-camera"></i>
                    <span>Photorealistic</span>
                  </label>
                </div>
                <div class="form-text text-muted">This style will be used as default when generating images with this model.</div>
              </div>
            </form>
            
            <form id="negativePromptForm">
              <div class="mb-3">
                <label for="negativePromptTextarea" class="form-label">Default Negative Prompt</label>
                <textarea id="negativePromptTextarea" class="form-control bg-secondary text-dark border-secondary"  style="min-height: 100px;"
                  rows="10" placeholder="Enter default negative prompt for this model..."></textarea>
                <div class="form-text text-muted">This negative prompt will be used as default when generating images with this model.</div>
              </div>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-save me-1"></i>Save Negative Prompt
              </button>
            </form>
            
            <form id="defaultSamplerForm" class="mt-3">
              <div class="mb-3">
                <label for="defaultSamplerSelect" class="form-label">Default Sampler</label>
                <select id="defaultSamplerSelect" class="form-select bg-secondary text-dark border-secondary">
                  <option value="">Select a sampler...</option>
                  <option value="Euler">Euler</option>
                  <option value="Euler a">Euler a</option>
                  <option value="LMS">LMS</option>
                  <option value="Heun">Heun</option>
                  <option value="DPM2">DPM2</option>
                  <option value="DPM2 a">DPM2 a</option>
                  <option value="DPM++ 2S a">DPM++ 2S a</option>
                  <option value="DPM++ 2M">DPM++ 2M</option>
                  <option value="DPM++ SDE">DPM++ SDE</option>
                  <option value="DPM fast">DPM fast</option>
                  <option value="DPM adaptive">DPM adaptive</option>
                  <option value="LMS Karras">LMS Karras</option>
                  <option value="DPM2 Karras">DPM2 Karras</option>
                  <option value="DPM2 a Karras">DPM2 a Karras</option>
                  <option value="DPM++ 2S a Karras">DPM++ 2S a Karras</option>
                  <option value="DPM++ 2M Karras">DPM++ 2M Karras</option>
                  <option value="DPM++ SDE Karras">DPM++ SDE Karras</option>
                  <option value="DDIM">DDIM</option>
                  <option value="PLMS">PLMS</option>
                  <option value="UniPC">UniPC</option>
                </select>
                <div class="form-text text-muted">This sampler will be used as default when generating images with this model.</div>
              </div>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-save me-1"></i>Save Default Sampler
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .sticky-bottom {display:none;}
  
  /* Custom styling for radio button labels */
  .btn-check:checked + label i.bi-square:before {
    content: "\f26e"; /* bi-check-square-fill */
  }
  
  .btn-check:not(:checked) + label i.bi-square:before {
    content: "\f1c8"; /* bi-square */
  }
  
  /* Custom styling for checked radio buttons */
  .btn-check:checked + label {
    background: linear-gradient(90.9deg, #D2B8FF 2.74%, #8240FF 102.92%) !important;
    color: white !important;
    border-color: #8240FF !important;
  }
</style>

{{> dashboard-footer}}
<script>
$(document).ready(function(){
    let loading = false;
    let nextCursor = '{{pagination.next_cursor}}';
    let currentModelId = null;

    // Initialize search input from URL query parameter
    const urlParams = new URLSearchParams(window.location.search);
    const initialSearch = urlParams.get('search') || '';
    $('#searchInput').val(initialSearch);

    // If there's an initial search query, load the results
    if (initialSearch) {
        loadModels('', initialSearch);
    }

    // Gallery Card - Info Button Click (slide from left)
    $(document).on('click', '.model-gallery-info-btn', function() {
        const card = $(this).closest('.model-gallery-card');
        const detailsPanel = card.find('.model-details-panel');
        detailsPanel.removeClass('d-none animate__fadeOutLeft').addClass('animate__fadeInLeft');
    });

    // Gallery Card - Close Button Click
    $(document).on('click', '.model-gallery-details-close-btn', function() {
        const detailsPanel = $(this).closest('.model-details-panel');
        detailsPanel.removeClass('animate__fadeInLeft').addClass('animate__fadeOutLeft');
        setTimeout(() => {
            detailsPanel.addClass('d-none');
        }, 500); // Match Animate.css animation duration
    });

    // Remove hover listeners for gallery cards to prevent conflict with button clicks
    /* 
    $(document).on('mouseenter', '.model-gallery-card', function() {
        const detailsPanel = $(this).find('.model-details-panel');
        detailsPanel.removeClass('d-none animate__fadeOutLeft').addClass('animate__fadeInLeft');
    });

    $(document).on('mouseleave', '.model-gallery-card', function() {
        const detailsPanel = $(this).find('.model-details-panel');
        detailsPanel.removeClass('animate__fadeInLeft').addClass('animate__fadeOutLeft');
        setTimeout(() => {
            if (!$(this).is(':hover')) {
                 detailsPanel.addClass('d-none');
            }
        }, 500); 
    });
    */

    // Active Model Card - Info Button Click (open modal)
    $(document).on('click', '.model-info-btn', function() {
        const modelId = $(this).data('model-id');
        const model = $(this).data('model');
        const style = $(this).data('style');
        const version = $(this).data('version');
        const image = $(this).data('image');
        const name = $(this).data('name');
        
        console.log('Opening modal for model:', {
            modelId,
            model,
            style,
            version,
            image,
            name
        });
        
        currentModelId = modelId;
        
        // Populate modal with basic data
        $('#modalModelImage').attr('src', image);
        $('#modalModelName').text(name || model);
        $('#modalModelModel').text(model);
        $('#modalModelStyle').text(style || 'N/A');
        $('#modalModelVersion').text(version || 'N/A');
        $('#modalModelId').text(modelId);
        
        // Clear any previous radio button selections and reset icons
        $('input[name="styleOption"]').prop('checked', false);
        updateStyleIcons();
        
        // Set style radio buttons with fallback
        const styleValue = style || 'anime';
        console.log('Setting initial style to:', styleValue);
        $(`input[name="styleOption"][value="${styleValue}"]`).prop('checked', true);
        updateStyleIcons();
        
        // Fetch full model details including negative prompt
        $.get(`/admin/models/${modelId}/details`)
            .done(function(data) {
                console.log('Fetched model details:', data);
                $('#negativePromptTextarea').val(data.negativePrompt || '');
                $('#defaultSamplerSelect').val(data.defaultSampler || '');
                
                // Update style radio buttons with database value if available
                if (data.style) {
                    console.log('Updating style from database to:', data.style);
                    // Clear previous selection
                    $('input[name="styleOption"]').prop('checked', false);
                    // Set new selection
                    $(`input[name="styleOption"][value="${data.style}"]`).prop('checked', true);
                    updateStyleIcons();
                    // Update modal display
                    $('#modalModelStyle').text(data.style === 'anime' ? 'Anime' : 'Photorealistic');
                } else {
                    console.log('No style in database, keeping initial style:', styleValue);
                }
            })
            .fail(function(xhr) {
                console.error('Failed to fetch model details:', xhr);
                $('#negativePromptTextarea').val('');
                $('#defaultSamplerSelect').val('');
            });
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('modelDetailsModal'));
        modal.show();
    });

    // Function to update style button icons
    function updateStyleIcons() {
        $('input[name="styleOption"]').each(function() {
            const icon = $(this).next('label').find('i');
            if ($(this).is(':checked')) {
                icon.removeClass('bi-square').addClass('bi-check-square-fill');
            } else {
                icon.removeClass('bi-check-square-fill').addClass('bi-square');
            }
        });
    }

    // Handle radio button changes
    $(document).on('change', 'input[name="styleOption"]', function() {
        updateStyleIcons();
        
        // Auto-submit the form when style is selected
        if (currentModelId) {
            const style = $(this).val();
            console.log('Auto-submitting style update:', style);
            
            $.ajax({
                url: `/admin/models/${currentModelId}/style`,
                method: 'PUT',
                data: JSON.stringify({ style }),
                contentType: 'application/json',
                success: function(response) {
                    console.log('Style update successful:', response);
                    window.showNotification(response.message, 'success');
                    // Update the style display in modal
                    $('#modalModelStyle').text(style === 'anime' ? 'Anime' : 'Photorealistic');
                    // Update the active model card data attribute
                    $(`.model-info-btn[data-model-id="${currentModelId}"]`).data('style', style);
                    $(`.model-switch[data-model-id="${currentModelId}"]`).data('style', style);
                },
                error: function(xhr) {
                    console.error('Style update failed:', xhr);
                    const error = xhr.responseJSON ? xhr.responseJSON.error : 'Error updating model style';
                    window.showNotification(error, 'error');
                }
            });
        }
    });

    // Handle style form submission (kept for backward compatibility but shouldn't be triggered)
    $('#styleForm').on('submit', function(e) {
        e.preventDefault();
        
        if (!currentModelId) {
            window.showNotification('No model selected', 'error');
            return;
        }
        
        const style = $('input[name="styleOption"]:checked').val();
        console.log('Submitting style update:', style);
        
        if (!style) {
            window.showNotification('Please select a style', 'error');
            return;
        }
        
        $.ajax({
            url: `/admin/models/${currentModelId}/style`,
            method: 'PUT',
            data: JSON.stringify({ style }),
            contentType: 'application/json',
            success: function(response) {
                console.log('Style update successful:', response);
                window.showNotification(response.message, 'success');
                // Update the style display in modal
                $('#modalModelStyle').text(style === 'anime' ? 'Anime' : 'Photorealistic');
                // Update the active model card data attribute
                $(`.model-info-btn[data-model-id="${currentModelId}"]`).data('style', style);
                $(`.model-switch[data-model-id="${currentModelId}"]`).data('style', style);
            },
            error: function(xhr) {
                console.error('Style update failed:', xhr);
                const error = xhr.responseJSON ? xhr.responseJSON.error : 'Error updating model style';
                window.showNotification(error, 'error');
            }
        });
    });

    // Handle negative prompt form submission
    $('#negativePromptForm').on('submit', function(e) {
        e.preventDefault();
        
        if (!currentModelId) {
            window.showNotification('No model selected', 'error');
            return;
        }
        
        const negativePrompt = $('#negativePromptTextarea').val();
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        
        // Show loading state
        submitBtn.html('<i class="bi bi-hourglass-split me-1"></i>Saving...').prop('disabled', true);
        
        $.ajax({
            url: `/admin/models/${currentModelId}/negative-prompt`,
            method: 'PUT',
            data: JSON.stringify({ negativePrompt }),
            contentType: 'application/json',
            success: function(response) {
                window.showNotification(response.message, 'success');
                // Close modal after successful save
                const modal = bootstrap.Modal.getInstance(document.getElementById('modelDetailsModal'));
                modal.hide();
            },
            error: function(xhr) {
                const error = xhr.responseJSON ? xhr.responseJSON.error : 'Error saving negative prompt';
                window.showNotification(error, 'error');
            },
            complete: function() {
                // Restore button state
                submitBtn.html(originalText).prop('disabled', false);
            }
        });
    });

    // Handle default sampler form submission
    $('#defaultSamplerForm').on('submit', function(e) {
        e.preventDefault();
        
        if (!currentModelId) {
            window.showNotification('No model selected', 'error');
            return;
        }
        
        const defaultSampler = $('#defaultSamplerSelect').val();
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        
        // Show loading state
        submitBtn.html('<i class="bi bi-hourglass-split me-1"></i>Saving...').prop('disabled', true);
        
        $.ajax({
            url: `/admin/models/${currentModelId}/default-sampler`,
            method: 'PUT',
            data: JSON.stringify({ defaultSampler }),
            contentType: 'application/json',
            success: function(response) {
                window.showNotification(response.message, 'success');
                // Close modal after successful save
                const modal = bootstrap.Modal.getInstance(document.getElementById('modelDetailsModal'));
                modal.hide();
            },
            error: function(xhr) {
                const error = xhr.responseJSON ? xhr.responseJSON.error : 'Error saving default sampler';
                window.showNotification(error, 'error');
            },
            complete: function() {
                // Restore button state
                submitBtn.html(originalText).prop('disabled', false);
            }
        });
    });

    function loadModels(cursor, searchTerm) {
        let url = '/admin/models?';
        if (cursor) url += 'cursor=' + cursor;
        if (searchTerm) url += '&search=' + encodeURIComponent(searchTerm);

        $.post(url, function(res) {
        if (cursor) {
            $('#model-gallery').append(res.html); // Append results for infinite scroll
        } else {
            $('#model-gallery').html(res.html); // Replace results for new search
        }
        nextCursor = res.pagination.next_cursor;
        loading = false;
        });
    }


  // Handle infinite scrolling
  $(window).on('scroll', function() {
    if (!loading && $(window).scrollTop() + $(window).height() + 50 >= $(document).height()) {
      loading = true;
      if (nextCursor) loadModels(nextCursor, $('#searchInput').val());
    }
  });

  // Handle search by clicking the search button
  $('#searchBtn').on('click', function() {
    performSearch($('#searchInput').val());
  });

  // Handle search by pressing "Enter"
  $('#searchInput').on('keypress', function(e) {
    if (e.which === 13) { // Enter key
      performSearch($(this).val());
    }
  });

  // Perform the search and update the navigation history
  function performSearch(searchTerm) {
    $('#model-gallery').empty(); // Clear existing results
    nextCursor = ''; // Reset the cursor
    loadModels('', searchTerm); // Load new results

    // Update the URL in the browser history
    const newUrl = new URL(window.location.href);
    if (searchTerm) {
      newUrl.searchParams.set('search', searchTerm);
    } else {
      newUrl.searchParams.delete('search');
    }
    history.pushState({}, '', newUrl); // Push the updated URL to the navigation history
  }

  // Handle back/forward navigation
  window.onpopstate = function() {
    const searchTerm = new URL(window.location.href).searchParams.get('search') || '';
    $('#searchInput').val(searchTerm);
    performSearch(searchTerm);
  };

  $(document).on('change', '.model-switch', function() {
    const modelId = $(this).data('model-id');
    const model = $(this).data('model');
    const style = $(this).data('style');
    const image = $(this).data('image');
    const version = $(this).data('version');
    const name = $(this).data('name');
    const url = $(this).is(':checked') ? '/admin/models/add' : '/admin/models/remove';
    
    $.post(url, { modelId, model, style, version, image, name }, function(res) {
      window.showNotification(res.message, "success");
    });
  });
});
</script>
</body>
</html>
