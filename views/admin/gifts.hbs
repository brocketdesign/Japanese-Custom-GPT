<!DOCTYPE html>
<html lang="en">
<head>
  {{> dashboard-header}}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="/css/user-analytics.css">
  <style>
    /* Sortable styles */
    .sortable-ghost {
      opacity: 0.4;
      background-color: #f0f0f0;
    }
    .sortable-chosen {
      /* Styles for the chosen item */
    }
    .handle {
      cursor: grab;
    }
    /* Action button styles */
    .action-btn {
      cursor: pointer;
      transition: transform 0.2s ease-in-out;
    }
    .action-btn:hover {
      transform: scale(1.1);
    }
    /* Inline editing styles */
    .editable-cell {
      cursor: text;
      position: relative;
    }
    .editable-cell:hover {
      background-color: #f9fafb;
      outline: 1px dashed #d1d5db;
    }
    .editable-cell:focus {
      outline: 2px solid #0d6efd;
      background-color: #ffffff;
    }
    .saving-indicator {
      opacity: 0.5;
      pointer-events: none;
    }
  </style>
</head>
<body class="bg-light">
{{> dashboard-nav}}

<div class="analytics-wrapper">
  <div class="container-fluid px-4 py-4">
    <!-- Header Section -->
    <div class="dashboard-header-section mb-4">
      <div class="row align-items-center">
        <div class="col-md-6">
          <div class="page-title-wrapper">
            <div class="icon-wrapper">
              <i class="bi bi-gift-fill"></i>
            </div>
            <div>
              <h1 class="dashboard-title mb-1">Gifts Management</h1>
              <p class="text-muted mb-0">Manage and organize your gift items</p>
            </div>
          </div>
        </div>
        <div class="col-md-6 text-md-end mt-3 mt-md-0">
          <button id="reorderGiftsBtn" class="btn btn-outline-success me-2">
            <i class="bi bi-arrow-down-up me-2"></i>Change Order
          </button>
          <button id="newGiftBtn" class="btn btn-primary btn-shadow">
            <i class="bi bi-plus-circle me-2"></i>New Gift
          </button>
        </div>
      </div>
    </div>

    <!-- Table Section -->
    <div class="section-header mb-3">
      <h5 class="section-title">
        <i class="bi bi-table me-2"></i>All Gifts
      </h5>
    </div>

    <!-- Gifts Table -->
    <div class="chart-card card-shadow">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th class="text-start">Order</th>
              <th class="text-start">Image</th>
              <th class="text-start">Title</th>
              <th class="text-start">Description</th>
              <th class="text-start">Prompt</th>
              <th class="text-start">Cost</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody id="giftsTableBody" class="text-gray-700 text-sm">
            {{! Gifts will be rendered here by JavaScript }}
          </tbody>
        </table>
      </div>
      <div id="emptyState" class="text-center py-5" style="display: none;">
        <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
        <p class="text-muted mt-3 mb-0">No gifts found. Create your first gift to get started.</p>
      </div>
    </div>
  </div>
</div>

<!-- Reorder Modal -->
<div id="reorderModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="reorderModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reorderModalLabel">
          <i class="bi bi-arrow-down-up me-2"></i>Reorder Gifts
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="reorderGiftsGrid" class="row g-3">
          {{! Gift items will be dynamically inserted here for reordering }}
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveOrderBtn">
          <i class="bi bi-check-circle me-2"></i>Save Order
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Preview Modal -->
<div id="previewModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="previewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="previewModalLabel">
          <i class="bi bi-eye me-2"></i>Gift Preview
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <img id="previewImage" src="" alt="Preview" class="img-fluid rounded mb-3">
        <h5 id="previewTitle" class="fw-bold text-dark mb-2"></h5>
        <p id="previewDescription" class="text-muted small mb-2"></p>
        <p id="previewPrompt" class="text-muted small mb-2 fst-italic"></p>
        <p id="previewCost" class="fw-bold text-primary"></p>
      </div>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content modal-dialog-scrollable">
      <div class="modal-header">
        <h5 class="modal-title" id="editModalLabel">
          <i class="bi bi-pencil-square me-2"></i>Edit Gift
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editForm" enctype="multipart/form-data">
        <div class="modal-body space-y-4">
          <input type="hidden" id="editId" name="id">
          <div class="mb-3">
            <label for="editTitle" class="form-label">Title</label>
            <input type="text" class="form-control" id="editTitle" name="title" required>
          </div>
          <div class="mb-3">
            <label for="editDescription" class="form-label">Description</label>
            <textarea class="form-control" id="editDescription" name="description" rows="8"></textarea>
          </div>
          <div class="mb-3">
            <label for="editPrompt" class="form-label">Prompt</label>
            <textarea class="form-control" id="editPrompt" name="prompt" rows="8"></textarea>
          </div>
          <div class="mb-3">
            <label for="editCost" class="form-label">Cost</label>
            <input type="number" class="form-control" id="editCost" name="cost" min="0" step="0.01" placeholder="0.00">
          </div>
          <div class="mb-3">
            <label for="editImage" class="form-label">Image (Upload to change)</label>
            <input type="file" class="form-control" id="editImage" name="image" accept="image/*">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-circle me-2"></i>Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- New Gift Modal -->
<div id="newGiftModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="newGiftModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newGiftModalLabel">
          <i class="bi bi-plus-circle me-2"></i>Create New Gift
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="newGiftForm" enctype="multipart/form-data">
        <div class="modal-body space-y-4">
          <div class="mb-3">
            <label for="newTitle" class="form-label">Title <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="newTitle" name="title" required>
          </div>
          <div class="mb-3">
            <label for="newDescription" class="form-label">Description</label>
            <textarea class="form-control" id="newDescription" name="description" rows="8"></textarea>
          </div>
          <div class="mb-3">
            <label for="newPrompt" class="form-label">Prompt <span class="text-danger">*</span></label>
            <textarea class="form-control" id="newPrompt" name="prompt" rows="8" required></textarea>
          </div>
          <div class="mb-3">
            <label for="newCost" class="form-label">Cost</label>
            <input type="number" class="form-control" id="newCost" name="cost" min="0" step="0.01" placeholder="0.00">
          </div>
          <div class="mb-3">
            <label for="newImage" class="form-label">Image <span class="text-danger">*</span></label>
            <input type="file" class="form-control" id="newImage" name="image" accept="image/*" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-plus-circle me-2"></i>Create Gift
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-danger" id="deleteModalLabel">
          <i class="bi bi-exclamation-triangle me-2"></i>Confirm Delete
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">Are you sure you want to delete this gift? This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
          <i class="bi bi-trash me-2"></i>Delete
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3">
  <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto" id="toastTitle">Notification</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="toastMessage">
      <!-- Message will be inserted here -->
    </div>
  </div>
</div>

<style>
  .sticky-bottom, #footer-toolbar {display:none;}
</style>
{{> dashboard-footer}}

<script>
  // Helper function for notifications (using Bootstrap Toast)
  function showNotification(message, type = 'success') {
    const toast = document.getElementById('notificationToast');
    const toastTitle = document.getElementById('toastTitle');
    const toastMessage = document.getElementById('toastMessage');
    
    toastTitle.textContent = type === 'success' ? 'Success' : 'Error';
    toastMessage.textContent = message;
    
    // Add appropriate classes for styling
    toast.className = `toast ${type === 'success' ? 'text-bg-success' : 'text-bg-danger'}`;
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
  }

  // Store gifts data globally for easier access
  let currentGifts = [];
  let reorderSortable = null;
  let deleteGiftId = null;

  function renderGiftsTable(gifts) {
    const tableBody = $('#giftsTableBody');
    const emptyState = $('#emptyState');
    tableBody.empty();
    
    if (!gifts || gifts.length === 0) {
      emptyState.show();
      return;
    }
    
    emptyState.hide();
    
    // Ensure gifts are sorted by the 'order' field before rendering
    const sortedGifts = gifts.sort((a, b) => (a.order || 0) - (b.order || 0));

    sortedGifts.forEach(gift => {
      const row = `
        <tr data-id="${gift._id}">
          <td class="text-start handle"><i class="bi bi-grip-vertical"></i> ${gift.order !== undefined ? gift.order : 'N/A'}</td>
          <td class="text-start"><img src="${gift.image || '/img/placeholder-image-2.gif'}" alt="${gift.title}" class="img-thumbnail" style="width: 60px; height: 60px; object-fit: cover;"></td>
          <td class="text-start editable-cell" contenteditable="true" data-field="title" data-id="${gift._id}" data-type="text">${gift.title}</td>
          <td class="text-start editable-cell" contenteditable="true" data-field="description" data-id="${gift._id}" data-type="text" style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">${gift.description || ''}</td>
          <td class="text-start editable-cell" contenteditable="true" data-field="prompt" data-id="${gift._id}" data-type="text" style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">${gift.prompt || ''}</td>
          <td class="text-start editable-cell" contenteditable="true" data-field="cost" data-id="${gift._id}" data-type="number">${gift.cost || 0}</td>
          <td class="text-center">
            <button class="btn btn-sm btn-outline-info action-btn preview-btn" data-id="${gift._id}" title="Preview">
              <i class="bi bi-eye"></i>
            </button>
            <button class="btn btn-sm btn-outline-primary action-btn edit-btn" data-id="${gift._id}" title="Edit">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger action-btn delete-btn" data-id="${gift._id}" title="Delete">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      `;
      tableBody.append(row);
    });
    
    attachActionListeners();
    attachInlineEditListeners();
  }

  // Add inline editing functionality
  function attachInlineEditListeners() {
    $(document).off('blur', '.editable-cell').on('blur', '.editable-cell', function() {
      const $cell = $(this);
      const field = $cell.data('field');
      const id = $cell.data('id');
      const type = $cell.data('type');
      let value = $cell.text().trim();
      
      // Validate number fields
      if (type === 'number') {
        const numValue = parseFloat(value);
        if (isNaN(numValue) || numValue < 0) {
          showNotification('Invalid value. Please enter a valid number.', 'error');
          const originalGift = currentGifts.find(g => g._id === id);
          if (originalGift) {
            $cell.text(originalGift[field] || 0);
          }
          return;
        }
        value = numValue;
      }
      
      // Check if value actually changed
      const originalGift = currentGifts.find(g => g._id === id);
      if (originalGift && originalGift[field] === value) {
        return; // No change, don't save
      }
      
      saveGiftFieldUpdate(id, field, value, $cell);
    });

    // Prevent Enter key from creating new lines in single-line fields
    $(document).off('keydown', '.editable-cell').on('keydown', '.editable-cell', function(e) {
      const field = $(this).data('field');
      if (field === 'title' || field === 'cost') {
        if (e.key === 'Enter') {
          e.preventDefault();
          $(this).blur();
        }
      }
    });
  }

  function saveGiftFieldUpdate(id, field, value, $element) {
    $element.addClass('saving-indicator');
    
    const data = {};
    data[field] = value;
    
    $.ajax({
      url: `/api/gifts/${id}/field`,
      type: 'PATCH',
      data: JSON.stringify(data),
      contentType: 'application/json',
      success: function(updatedGift) {
        const index = currentGifts.findIndex(g => g._id === id);
        if (index !== -1) {
          currentGifts[index] = updatedGift;
        }
        
        $element.removeClass('saving-indicator');
        showNotification(`${field.charAt(0).toUpperCase() + field.slice(1)} updated successfully.`, 'success');
      },
      error: function() {
        $element.removeClass('saving-indicator');
        
        const originalGift = currentGifts.find(g => g._id === id);
        if (originalGift) {
          $element.text(originalGift[field] || '');
        }
        
        showNotification(`Error updating ${field}.`, 'error');
      }
    });
  }

  function attachActionListeners() {
    $('.preview-btn').off('click').on('click', function() {
      const id = $(this).data('id');
      $.ajax({
        url: '/api/gifts/' + id,
        type: 'GET',
        success: function(gift) {
          $('#previewImage').attr('src', gift.image || '/img/placeholder-image-2.gif');
          $('#previewTitle').text(gift.title);
          $('#previewDescription').text(gift.description || 'No description available');
          $('#previewPrompt').text(gift.prompt || 'No prompt available');
          $('#previewCost').text('Cost: ' + (gift.cost || 0));
          const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
          previewModal.show();
        },
        error: function() {
          showNotification('Error loading gift preview.', 'error');
        }
      });
    });

    $('.edit-btn').off('click').on('click', function() {
      const id = $(this).data('id');
      $.ajax({
        url: '/api/gifts/' + id,
        type: 'GET',
        success: function(gift) {
          $('#editId').val(gift._id);
          $('#editTitle').val(gift.title);
          $('#editDescription').val(gift.description || '');
          $('#editPrompt').val(gift.prompt || '');
          $('#editCost').val(gift.cost || 0);
          const editModal = new bootstrap.Modal(document.getElementById('editModal'));
          editModal.show();
        },
        error: function() {
          showNotification('Error loading gift.', 'error');
        }
      });
    });

    $('.delete-btn').off('click').on('click', function() {
      deleteGiftId = $(this).data('id');
      const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
      deleteModal.show();
    });

    $('#reorderGiftsBtn').off('click').on('click', function() {
      const grid = $('#reorderGiftsGrid');
      grid.empty();
      const sortedGiftsForModal = [...currentGifts].sort((a, b) => (a.order || 0) - (b.order || 0));

      sortedGiftsForModal.forEach(gift => {
        const item = `
          <div class="col-sm-6 col-md-4 col-lg-3">
            <div class="card" data-id="${gift._id}" style="cursor: grab;">
              <img src="${gift.image || '/img/placeholder-image-2.gif'}" class="card-img-top" alt="${gift.title}" style="height: 150px; object-fit: cover;">
              <div class="card-body p-2">
                <h6 class="card-title text-truncate">${gift.title}</h6>
                <small class="text-muted">Order: ${gift.order || 'N/A'}</small>
              </div>
            </div>
          </div>
        `;
        grid.append(item);
      });

      if (reorderSortable) {
        reorderSortable.destroy();
      }
      reorderSortable = new Sortable(document.getElementById('reorderGiftsGrid'), {
        animation: 150,
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
      });
      const reorderModal = new bootstrap.Modal(document.getElementById('reorderModal'));
      reorderModal.show();
    });

    $('#saveOrderBtn').off('click').on('click', function() {
      if (!reorderSortable) return;
      const orderedIds = reorderSortable.toArray();

      $.ajax({
        url: '/api/gifts/reorder',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ orderedIds: orderedIds }),
        success: function(response) {
          currentGifts = response.sort((a, b) => (a.order || 0) - (b.order || 0));
          renderGiftsTable(currentGifts);
          bootstrap.Modal.getInstance(document.getElementById('reorderModal')).hide();
          showNotification('Gifts reordered successfully.', 'success');
        },
        error: function(xhr) {
          showNotification('Error reordering gifts.', 'error');
        }
      });
    });
  }

  $(document).ready(function() {
    // Load gifts on page load
    $.ajax({
      url: '/api/gifts',
      type: 'GET',
      success: function(gifts) {
        currentGifts = gifts.sort((a, b) => (a.order || 0) - (b.order || 0));
        renderGiftsTable(currentGifts);
      },
      error: function() {
        showNotification('Error fetching gifts.', 'error');
        renderGiftsTable([]);
      }
    });

    $('#newGiftBtn').on('click', function() {
      const newGiftModal = new bootstrap.Modal(document.getElementById('newGiftModal'));
      newGiftModal.show();
    });

    $('#newGiftForm').on('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      
      $.ajax({
        url: '/api/gifts/create',
        type: 'POST',
        data: formData,
        contentType: false,
        processData: false,
        success: function() {
          showNotification('Gift created successfully.', 'success');
          bootstrap.Modal.getInstance(document.getElementById('newGiftModal')).hide();
          setTimeout(() => location.reload(), 1500);
        },
        error: function() {
          showNotification('Error creating gift.', 'error');
        }
      });
    });

    $('#confirmDeleteBtn').on('click', function() {
      if (deleteGiftId) {
        $.ajax({
          url: '/api/gifts/' + deleteGiftId,
          type: 'DELETE',
          success: function() {
            currentGifts = currentGifts.filter(g => g._id !== deleteGiftId);
            renderGiftsTable(currentGifts);
            bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
            showNotification('Gift deleted successfully.', 'success');
          },
          error: function() {
            showNotification('Error deleting gift.', 'error');
          }
        });
      }
    });

    $('#editForm').on('submit', function(e) {
      e.preventDefault();
      const id = $('#editId').val();
      const formData = new FormData(this);

      if ($('#editImage')[0].files.length === 0) {
        formData.delete('image');
      }

      $.ajax({
        url: '/api/gifts/' + id,
        type: 'PUT',
        data: formData,
        processData: false,
        contentType: false,
        success: function(updatedGift) {
          const index = currentGifts.findIndex(g => g._id === id);
          if (index !== -1) {
            currentGifts[index] = updatedGift;
          }
          renderGiftsTable(currentGifts);
          bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
          showNotification('Gift updated successfully.', 'success');
        },
        error: function() {
          showNotification('Error updating gift.', 'error');
        }
      });
    });
  });
</script>
</body>
</html>
