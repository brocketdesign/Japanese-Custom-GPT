<div class="px-2 position-relative onchat-on" style="flex-grow:1;height: auto;">
    <div id="chatInput" class="input-group rounded-0 rounded-bottom" style="position: absolute;bottom: 10px;left: 0;right: 0;padding: 0px 15px 5px 15px;">
        <div class="chat-toolbar-wrapper w-auto mx-auto">
            <div class="chat-toolbar-container">
                <!-- Main Toolbar -->
                <div class="chat-toolbar animate__animated animate__slideInUp">
                    <div id="toolbar-main" class="toolbar-scroll-container mx-2">
                        <button type="button" class="toolbar-btn" id="audio-play">
                            <i class="bi" id="audio-icon"></i>
                            <span class="tool-label">{{translations.toolbar.audio}}</span>
                        </button>
                        <button type="button" class="toolbar-btn" id="text-input-toggle">
                            <i class="bi bi-chat-dots"></i>
                            <span class="tool-label">{{translations.toolbar.chat}}</span>
                        </button>
                        <button type="button" class="toolbar-btn" id="show-personas-btn">
                            <i class="bi bi-person-lines-fill"></i>
                            <span class="tool-label">{{translations.toolbar.persona}}</span>
                        </button>
                        <button type="button" class="toolbar-btn" id="showPrompts">
                            <i class="bi bi-image"></i>
                            <span class="tool-label">{{translations.toolbar.image}}</span>
                        </button>
                        <button type="button" class="toolbar-btn" id="gifts-toggle">
                            <i class="bi bi-gift"></i>
                            <span class="tool-label">{{translations.toolbar.gifts}}</span>
                        </button>
                        <button type="button" class="toolbar-btn" id="emoji-tone-btn">
                            <i class="bi bi-emoji-smile"></i>
                            <span class="tool-label">{{translations.toolbar.emojis}}</span>
                        </button>
                        <button type="button" class="toolbar-btn" id="suggestions-toggle">
                            <i class="bi bi-lightbulb"></i>
                            <span class="tool-label">{{translations.toolbar.ideas}}</span>
                        </button>
                        <button type="button" class="toolbar-btn" id="translation-toggle">
                            <i class="bi bi-translate"></i>
                            <span class="tool-label">{{translations.toolbar.translate}}</span>
                        </button>
                        <button type="button" class="toolbar-btn reset-chat" id="reset-chat-btn" onclick="handleChatReset(this)">
                            <i class="bi bi-plus-square"></i>
                            <span class="tool-label">{{translations.toolbar.reset}}</span>
                        </button>
                        <button type="button" class="toolbar-btn settings-toggle" id="settings-toggle">
                            <i class="bi bi-gear"></i>
                            <span class="tool-label">{{translations.toolbar.settings}}</span>
                        </button>
                    </div>
                    
                    <!-- Tool Content Views -->
                    <!-- Emoji tone view -->
                    <div id="toolbar-emoji-tone" class="toolbar-content-view animate__animated" style="display: none;">
                        <button type="button" class="toolbar-back-btn">
                            <i class="bi bi-arrow-left"></i>
                        </button>
                        <div class="toolbar-title">ÈÅ∏Êäû„Éà„Éº„É≥</div>
                        <div class="emoji-scroll-container mx-2">
                            <button class="emoji-btn" data-tone="happy">üòä</button>
                            <button class="emoji-btn" data-tone="funny">üòÇ</button>
                            <button class="emoji-btn" data-tone="romantic">‚ù§Ô∏è</button>
                            <button class="emoji-btn" data-tone="serious">üßê</button>
                            <button class="emoji-btn" data-tone="sad">üò¢</button>
                            <button class="emoji-btn" data-tone="angry">üò°</button>
                            <button class="emoji-btn" data-tone="surprised">üò≤</button>
                            <button class="emoji-btn" data-tone="confused">üòï</button>
                            <button class="emoji-btn" data-tone="neutral">üòê</button>
                            <button class="emoji-btn" data-tone="excited">ü§©</button>
                            <button class="emoji-btn" data-tone="bored">üò¥</button>
                            <button class="emoji-btn" data-tone="curious">ü§î</button>
                            <button class="emoji-btn" data-tone="playful">üòú</button>
                            <button class="emoji-btn" data-tone="relaxed">üòå</button>
                            <button class="emoji-btn" data-tone="motivated">üí™</button>
                            <button class="emoji-btn" data-tone="inspired">‚ú®</button>
                            <button class="emoji-btn" data-tone="nostalgic">üòå</button>
                            <button class="emoji-btn" data-tone="hopeful">üåü</button>
                            <button class="emoji-btn" data-tone="grateful">üôè</button>
                            <button class="emoji-btn" data-tone="determined">üî•</button>
                        </div>
                    </div>
                    

                    <!-- Suggestions view -->
                    <div id="toolbar-suggestions" class="toolbar-content-view animate__animated" style="display: none;">
                        <button type="button" class="toolbar-back-btn">
                            <i class="bi bi-arrow-left"></i>
                        </button>
                        <div class="toolbar-title">{{translations.toolbar.ideas}}</div>
                        <div class="suggestions-scroll-container mx-2">
                            <!-- Suggestions will be dynamically added here -->
                        </div>
                    </div>
                    
                    <!-- Translation view -->
                    <div id="toolbar-translation" class="toolbar-content-view animate__animated" style="display: none;">
                        <button type="button" class="toolbar-back-btn">
                            <i class="bi bi-arrow-left"></i>
                        </button>
                        <div class="toolbar-title">{{translations.translate}}</div>
                        <div class="translation-scroll-container mx-2">
                            <button class="translation-btn" data-lang="en">{{translations.english}}</button>
                            <button class="translation-btn" data-lang="ja">{{translations.japanese}}</button>
                            <button class="translation-btn" data-lang="ko">{{translations.korean}}</button>
                            <button class="translation-btn" data-lang="zh">{{translations.chinese}}</button>
                            <button class="translation-btn" data-lang="fr">{{translations.french}}</button>
                            <button class="translation-btn" data-lang="de">{{translations.german}}</button>
                        </div>
                    </div>
                    
                    <!-- Text input view -->
                    <div id="toolbar-text-input" class="toolbar-content-view animate__animated" style="display: none;">
                        <button type="button" class="toolbar-back-btn">
                            <i class="bi bi-arrow-left"></i>
                        </button>
                        <div class="input-group w-100">
                            <textarea id="userMessage" class="form-control py-2 border-0 me-1" style="max-height: 80px;" placeholder="„ÉÅ„É£„ÉÉ„Éà„Åó„Çà„ÅÜ"></textarea>
                            <button id="sendImageMessage" class="btn btn-light px-3 border-0 rounded me-1" type="button">
                                <i class="bi bi-image"></i>
                            </button>
                            <button id="sendMessage" class="btn btn-light px-3 border-0 rounded" type="button">
                                <i class="bi bi-send"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div id="suggestionsContainer" class="shadow" style="position: absolute; bottom: -10px; width: 95%; margin: auto; max-height: 55vh; background: rgb(255, 255, 255); overflow-y: auto; left: 0; right: 0; z-index: 10; border-radius: 15px 15px 0 0; display: none;">
            <button id="close-suggestionsContainer" class="btn shadow-0 position-absolute top-0 end-0"><i class="bi bi-x"></i></button>
            <div id="suggestionsList" class="row mx-0 my-5">
                <h4 class="text-center w-100 mt-2">{{translations.toolbar.ideas}}</h4>
                <p class="text-center text-muted w-100">{{translations.loading_suggestions}}</p>
                <div class="loading-spinner text-center mt-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">{{translations.loading}}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="personas-overlay">
            <div id="personas-container" class="shadow" style="position: absolute; bottom: -10px; width: 95%; margin: auto; max-height: 55vh; background: rgb(255, 255, 255); overflow-y: auto; left: 0; right: 0; z-index: 10; border-radius: 15px 15px 0 0; display: none;">
                <button id="close-personas-container" class="btn shadow-0 position-absolute top-0 end-0"><i class="bi bi-x"></i></button>
                <div id="personas-list" class="row mx-0 my-5">
                    <h4 class="text-center w-100 mt-2">{{translations.personas.selectPersona}}</h4>
                    <p class="text-center text-muted w-100">{{translations.personas.selectPersona_description}}</p>
                    <div id="persona-activated-counter" class="d-none text-center fw-bold my-2"></div>
                    <div class="loading-spinner text-center mt-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="promptContainer" class="shadow" style="position: absolute; bottom: -10px; width: 95%; margin: auto; max-height: 55vh; background: rgb(255, 255, 255); overflow-y: auto;left: 0;right: 0;z-index: 10;border-radius: 15px 15px 0 0;display:none;">
            <button id="close-promptContainer" class="btn shadow-0 position-absolute top-0 end-0"><i class="bi bi-x"></i></button>
            <div id="promptList" class="row mx-0 my-5">
                <h4 class="text-center w-100 mt-2">{{translations.selectPose}}</h4>
                <p class="text-center text-muted w-100">{{translations.selectPose_description}}</p>
                <!-- Prompts will be dynamically generated here -->
                {{#each promptData}}
                    <div class="prompt-card col-6 col-sm-4 col-md-3 border-0 shadow-0 mb-3 position-relative d-flex justify-content-center align-items-center"
                        data-id="{{_id}}" 
                        data-nsfw="{{eq nsfw 'on'}}" 
                        style="cursor:pointer;">
                        <div class="modern-prompt-container position-relative overflow-hidden">
                            <div class="prompt-image-wrapper">
                                <img 
                                    src="/img/image-placeholder-1.gif"
                                    data-src="{{image}}" 
                                    class="lazy-image prompt-image"
                                    alt="{{title}}" 
                                    loading="lazy">
                                <div class="prompt-overlay">
                                    <div class="prompt-shine"></div>
                                </div>
                            </div>
                            
                            <div class="prompt-info">
                                <h6 class="prompt-title">{{title}}</h6>
                                <div class="prompt-cost-badge">
                                    {{#if cost}}
                                        <i class="bi bi-coin prompt-coin-icon"></i>
                                        <span class="cost-amount">{{cost}}</span>
                                    {{else}}
                                        <i class="bi bi-image-fill"></i>
                                        <span class="free-label">Free</span>
                                    {{/if}}
                                </div>
                            </div>
                            
                            <div class="prompt-selection-indicator">
                                <i class="bi bi-check-circle-fill"></i>
                            </div>
                        </div>
                    </div>
                {{/each}}

            </div>
        </div>
        <div id="giftsOverlay" class="shadow" style="position: absolute; bottom: -10px; width: 95%; margin: auto; max-height: 55vh; background: rgb(255, 255, 255); overflow-y: auto; left: 0; right: 0; z-index: 10; border-radius: 15px 15px 0 0; display: none;">
            <button id="close-giftsOverlay" class="btn shadow-0 position-absolute top-0 end-0"><i class="bi bi-x"></i></button>
            <div id="giftsList" class="row mx-0 my-5">
                <h4 class="text-center w-100 mt-2">{{translations.gifts.selectGift}}</h4>
                <p class="text-center text-muted w-100">{{translations.gifts.selectGift_description}}</p>
                <!-- Gifts will be dynamically generated here -->
                {{#each giftData}}
                    <div class="gift-card col-6 col-sm-4 col-md-3 border-0 shadow-0 mb-3 position-relative d-flex justify-content-center align-items-center"
                        data-id="{{_id}}" 
                        data-nsfw="{{eq nsfw 'on'}}" 
                        style="cursor:pointer;">
                        <div class="modern-gift-container position-relative overflow-hidden">
                            <div class="gift-image-wrapper">
                                <img 
                                    src="/img/image-placeholder-1.gif"
                                    data-src="{{image}}" 
                                    class="lazy-image gift-image"
                                    alt="{{title}}" 
                                    loading="lazy">
                                <div class="gift-overlay">
                                    <div class="gift-shine"></div>
                                </div>
                            </div>
                            
                            <div class="gift-info">
                                <h6 class="gift-title">{{title}}</h6>
                                <div class="gift-cost-badge">
                                    {{#if cost}}
                                        <i class="bi bi-coin gift-coin-icon"></i>
                                        <span class="cost-amount">{{cost}}</span>
                                    {{else}}
                                        <i class="bi bi-gift-fill"></i>
                                        <span class="free-label">Free</span>
                                    {{/if}}
                                </div>
                            </div>
                            
                            <div class="gift-selection-indicator">
                                <i class="bi bi-check-circle-fill"></i>
                            </div>
                        </div>
                    </div>
                {{/each}}
            </div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div id="settings-modal-overlay" class="settings-modal-overlay">
    <div class="settings-modal">
        <div class="settings-modal-header">
            <h3 class="settings-modal-title">
                <i class="bi bi-gear"></i>
                {{translations.settings.title}}
            </h3>
            <button type="button" class="settings-close-btn" id="settings-close-btn">
                <i class="bi bi-x"></i>
            </button>
        </div>
        <div class="settings-modal-body">
            <!-- Image Settings -->
            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="bi bi-image"></i>
                    {{translations.settings.imageSettings}}
                </div>
                <div class="settings-field">
                    <label class="settings-label" for="min-images-range">
                        {{translations.settings.minImagesToSend}}
                    </label>
                    <div class="settings-range-container">
                        <input type="range" id="min-images-range" class="settings-range" 
                               min="1" max="5" value="1" step="1">
                        <div class="settings-range-value" id="min-images-value">3</div>
                    </div>
                </div>
                
                <!-- Auto Merge Face Switch -->
                <div class="settings-field">
                    <label class="settings-label">{{translations.settings.autoMergeFace}}</label>
                    <div class="settings-switch-container">
                        <span class="settings-switch-description">{{translations.settings.autoMergeFaceDescription}}</span>
                        <label class="settings-switch">
                            <input type="checkbox" id="auto-merge-face-switch" checked>
                            <span class="settings-switch-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Video Settings -->
            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="bi bi-camera-video"></i>
                    {{translations.settings.videoSettings}}
                </div>
                <div class="settings-field">
                    <label class="settings-label" for="video-prompt">
                        {{translations.settings.defaultVideoPrompt}}
                    </label>
                    <textarea id="video-prompt" class="settings-textarea" 
                              placeholder="{{translations.settings.videoPromptPlaceholder}}">{{translations.settings.defaultVideoPromptText}}</textarea>
                </div>
            </div>

            <!-- Tone & Relationship Settings -->
            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="bi bi-heart"></i>
                    {{translations.settings.characterTone}}
                </div>
                <div class="settings-field">
                    <label class="settings-label">{{translations.settings.characterToneLabel}}</label>
                    <div class="settings-tone-grid">
                        <div class="settings-tone-option" data-tone="friendly">
                            üòä {{translations.settings.tones.friendly}}
                        </div>
                        <div class="settings-tone-option selected" data-tone="casual">
                            üòé {{translations.settings.tones.casual}}
                        </div>
                        <div class="settings-tone-option" data-tone="professional">
                            üíº {{translations.settings.tones.professional}}
                        </div>
                        <div class="settings-tone-option" data-tone="playful">
                            üòú {{translations.settings.tones.playful}}
                        </div>
                        <div class="settings-tone-option" data-tone="romantic">
                            ‚ù§Ô∏è {{translations.settings.tones.romantic}}
                        </div>
                        <div class="settings-tone-option" data-tone="mysterious">
                            üåô {{translations.settings.tones.mysterious}}
                        </div>
                    </div>
                </div>
                <div class="settings-field">
                    <label class="settings-label" for="relationship-select">
                        {{translations.settings.relationshipType}}
                    </label>
                    <select id="relationship-select" class="settings-select">
                        <option value="friend">{{translations.settings.relationships.friend}}</option>
                        <option value="companion" selected>{{translations.settings.relationships.companion}}</option>
                        <option value="mentor">{{translations.settings.relationships.mentor}}</option>
                        <option value="partner">{{translations.settings.relationships.partner}}</option>
                        <option value="assistant">{{translations.settings.relationships.assistant}}</option>
                    </select>
                </div>
            </div>

            <!-- Voice Settings -->
            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="bi bi-mic"></i>
                    {{translations.settings.voiceSettings}}
                </div>
                
                <!-- Voice Provider Switch -->
                <div class="settings-field">
                    <label class="settings-label">{{translations.settings.voiceProvider}}</label>
                    <div class="settings-switch-container">
                        <span class="settings-switch-label openai-label">{{translations.settings.openAI}}</span>
                        <label class="settings-switch">
                            <input type="checkbox" id="voice-provider-switch">
                            <span class="settings-switch-slider"></span>
                        </label>
                        <span class="settings-switch-label evenlab-label">{{translations.settings.evenLabs}}</span>
                    </div>
                </div>

                <!-- OpenAI Voices -->
                <div class="settings-field" id="openai-voices">
                    <label class="settings-label">{{translations.settings.selectOpenAIVoice}}</label>
                    <div class="settings-voice-grid">
                        <div class="settings-voice-option selected" data-voice="nova">
                            <div class="settings-voice-name">{{translations.settings.voices.nova.name}}</div>
                            <div class="settings-voice-description">{{translations.settings.voices.nova.description}}</div>
                        </div>
                        <div class="settings-voice-option" data-voice="alloy">
                            <div class="settings-voice-name">{{translations.settings.voices.alloy.name}}</div>
                            <div class="settings-voice-description">{{translations.settings.voices.alloy.description}}</div>
                        </div>
                        <div class="settings-voice-option" data-voice="shimmer">
                            <div class="settings-voice-name">{{translations.settings.voices.shimmer.name}}</div>
                            <div class="settings-voice-description">{{translations.settings.voices.shimmer.description}}</div>
                        </div>
                        <div class="settings-voice-option" data-voice="fable">
                            <div class="settings-voice-name">{{translations.settings.voices.fable.name}}</div>
                            <div class="settings-voice-description">{{translations.settings.voices.fable.description}}</div>
                        </div>
                    </div>
                </div>

                <!-- EvenLabs Voices -->
                <div class="settings-field" id="evenlab-voices" style="display: none;">
                    <label class="settings-label">{{translations.settings.selectEvenLabsVoice}}</label>
                    <div class="settings-voice-grid" id="evenlab-voices-grid">
                        <!-- EvenLab voices will be dynamically loaded here -->
                        <div class="voice-loading-spinner text-center">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading voices...</span>
                            </div>
                            <div class="loading-text">Loading EvenLab voices...</div>
                        </div>
                    </div>
                </div>
            </div>

            <button type="button" class="settings-save-btn" id="settings-save-btn">
                <i class="bi bi-check-circle"></i>
                {{translations.settings.saveSettings}}
            </button>
        </div>
    </div>
</div>


<script>
// Ensure toolbar scrolling works properly on mobile
document.addEventListener('DOMContentLoaded', function() {
    const toolbarContainer = document.getElementById('toolbar-main');
    if (toolbarContainer && window.innerWidth <= 768) {
        // Reset scroll position to start
        toolbarContainer.scrollLeft = 0;
        
        // Add touch scroll enhancement
        let isScrolling = false;
        toolbarContainer.addEventListener('touchstart', () => isScrolling = true);
        toolbarContainer.addEventListener('touchend', () => {
            setTimeout(() => isScrolling = false, 100);
        });
        
        // Prevent click events during scrolling
        toolbarContainer.addEventListener('click', (e) => {
            if (isScrolling) e.preventDefault();
        }, true);
    }
});

// Ensure proper modal management
document.addEventListener('DOMContentLoaded', function() {
    // Handle chat history click from list items
    $(document).on('click', '.user-chat-history', function() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('chatHistoryModal'));
        if (modal) {
            modal.hide();
        }
    });

    // Ensure modal backdrop is properly positioned
    $('#chatHistoryModal').on('show.bs.modal', function() {
        // Force high z-index
        setTimeout(() => {
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
                backdrop.style.zIndex = '1055';
            }
            this.style.zIndex = '1060';
        }, 10);
    });

    // Clean up when modal is hidden
    $('#chatHistoryModal').on('hidden.bs.modal', function() {
        // Clear any loading states
        $('#chat-history-list').empty();
    });
});
</script>

