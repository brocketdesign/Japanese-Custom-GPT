<!DOCTYPE html>
<html lang="{{lang}}">
{{> dashboard-header}}
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="/css/user-profile.css">
    <link rel="stylesheet" href="/css/chat-list-tabs.css">
    <!-- Modal CSS -->
    <link rel="stylesheet" href="/css/user-points.css">
    <link rel="stylesheet" href="/css/chat-footer.css">
    <link rel="stylesheet" href="/css/personas.css">
</head>
<body>
    {{> dashboard-nav}}

    <div id="swup" class="profile-container">
        <!-- Profile Header -->
        <div class="profile-header">
            <div class="profile-cover">
                <div class="profile-avatar-container">
                    <img id="profileImage" src="{{default userData.profileUrl '/img/avatar.png'}}" alt="{{userData.nickname}}" class="profile-avatar">
                    {{#if (or isMyProfile isAdmin)}}
                        <div class="profile-avatar-overlay d-none" id="editProfileImageBtn">
                            <i class="bi bi-pencil"></i>
                        </div>
                    {{/if}}
                </div>
                
                <div class="profile-info">
                    <h1 class="profile-name">{{userData.nickname}}</h1>
                    {{#if userData.bio}}
                        <p class="profile-intro">{{userData.bio}}</p>
                    {{/if}}
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="profile-actions {{#if isMyProfile}}d-none{{/if}}">
            {{#if isMyProfile}}
            {{else}}
                <button class="action-btn action-btn-primary follow-button {{#if userData.follow}}following{{/if}}" 
                        data-user-id="{{userData._id}}"
                        onclick="toggleFollow(this)">
                    <i class="bi bi-person-check-fill"></i>
                    <span class="user-follow fw-bold">
                        {{#if userData.follow}}
                            {{translations.profile.following}}
                        {{else}}
                            {{translations.profile.follow}}
                        {{/if}}
                    </span>
                </button>
            {{/if}}
        </div>

        <!-- Stats Section -->
        <div class="profile-stats">
            <div class="stat-item likes-tab" type="button">
                <span class="stat-number">{{default userData.imageLikeCount 0}}</span>
                <div class="stat-label"><i class="bi bi-heart-fill"></i></div>
            </div>
            <div class="stat-item characters-tab" type="button">
                <span class="stat-number">{{default userData.chatCount 0}}</span>
                <div class="stat-label"><i class="bi bi-chat-dots-fill"></i> </div>
            </div>
            <div class="stat-item">
                <div class="stat-label p-0" data-bs-toggle="modal" data-bs-target="#followingModal" style="color: inherit; text-decoration: none;cursor: pointer;">
                    <span class="stat-number">{{default userData.followCount 0}}</span>
                    <div class="stat-label"><i class="bi bi-person-check-fill"></i></div>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-label p-0" data-bs-toggle="modal" data-bs-target="#followersModal" style="color: inherit; text-decoration: none;cursor: pointer;">
                    <span class="stat-number">{{default userData.followerCount 0}}</span>
                    <div class="stat-label"><i class="bi bi-people-fill"></i></div>
                </div>
            </div>
        </div>

        <!-- Image Moderation Alert -->
        <div id="imageModerationFlagged" class="moderation-alert" style="display: none;">
            <i class="bi bi-exclamation-triangle"></i>
            {{translations.setting.imageModerationFlagged}}
        </div>

        <!-- Content Tabs -->
        <div class="content-tabs">
            <div class="tab-nav">
                <button class="tab-btn active" data-tab="images">
                    <i class="bi bi-heart-fill"></i>
                    {{translations.profile.likes}}
                </button>
                <button class="tab-btn" data-tab="characters">
                    <i class="bi bi-chat-dots-fill"></i>
                    {{translations.profile.characters}}
                </button>
                {{#if isMyProfile}}
                <button class="tab-btn" data-tab="posts">
                    <i class="bi bi-images"></i>
                    {{translations.profile.posts}}
                </button>
                {{/if}}
            </div>
        </div>

        <!-- Content Areas -->
        <div class="tab-content">
            <!-- Likes Tab -->
            <div id="images-tab" class="tab-pane p-3 active">
                <div class="row" id="user-images-gallery">
                    <!-- Images will be loaded here -->
                </div>
                <div id="images-pagination-controls" class="d-flex justify-content-center my-3"></div>
            </div>

            <!-- Characters Tab -->
            <div id="characters-tab" class="tab-pane p-3" style="display: none;">
                <div class="row" id="user-chat-gallery">
                    <!-- Characters will be loaded here -->
                </div>
                <div id="user-chat-pagination-controls" class="d-flex justify-content-center my-3"></div>
            </div>

            <!-- Posts Tab (My Social Posts & Schedules) -->
            {{#if isMyProfile}}
            <div id="posts-tab" class="tab-pane p-3" style="display: none;">
                <!-- Recent Social Posts -->
                <div class="posts-section mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">
                            <i class="bi bi-send-fill me-2 text-primary"></i>{{translations.profile.recentPosts}}
                        </h6>
                        <a href="/dashboard/posts" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-grid me-1"></i>{{translations.profile.viewAll}}
                        </a>
                    </div>
                    <div id="user-social-posts" class="recent-posts-list">
                        <div class="text-center p-4 text-muted">
                            <i class="bi bi-hourglass-split fs-4 mb-2"></i>
                            <p class="mb-0">{{translations.profile.loadingPosts}}</p>
                        </div>
                    </div>
                </div>

                <!-- Scheduled Posts & Cron Jobs -->
                <div class="schedules-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">
                            <i class="bi bi-calendar-event me-2 text-warning"></i>{{translations.profile.scheduledPosts}}
                        </h6>
                        <a href="/dashboard/schedules" class="btn btn-sm btn-outline-warning">
                            <i class="bi bi-calendar-plus me-1"></i>{{translations.profile.manageSchedules}}
                        </a>
                    </div>
                    <div id="user-schedules" class="schedules-list">
                        <div class="text-center p-4 text-muted">
                            <i class="bi bi-hourglass-split fs-4 mb-2"></i>
                            <p class="mb-0">{{translations.profile.loadingSchedules}}</p>
                        </div>
                    </div>
                </div>
            </div>
            {{/if}}
        </div>

        <!-- File Input (Hidden) -->
        {{#if (or isMyProfile isAdmin)}}
            <input type="file" class="form-control" id="profileImageInput" name="profileImageInput" accept="image/*" style="display: none;">
        {{/if}}

        <!-- Followers Modal -->
        <div class="modal fade" id="followersModal" tabindex="-1" aria-labelledby="followersModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="followersModalLabel">{{userData.nickname}} {{translations.followers.followersListTitleFollowers}}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="followers-list" class="container">
                            <!-- Followers will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Following Modal -->
        <div class="modal fade" id="followingModal" tabindex="-1" aria-labelledby="followingModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="followingModalLabel">{{userData.nickname}} {{translations.followers.followingListTitle}}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="following-list" class="container">
                            <!-- Following will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {{> dashboard-footer}}

    <script>
        $(document).ready(function(){
            const isMyProfile = `{{isMyProfile}}` == 'true'
            const isAdmin = `{{isAdmin}}` == 'true'
            const userId = '{{userData._id}}';
            
            if(isMyProfile || isAdmin) {
                // Handle profile image editing
                $('#editProfileImageBtn').on('click', function() {
                    $('#profileImageInput').click();
                });

                $('#profileImageInput').change(function(event) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        $('#profileImage').attr('src', e.target.result).show();
                    }
                    reader.readAsDataURL(event.target.files[0]);

                    const formData = new FormData();
                    const profileImage = $('#profileImageInput')[0].files[0];
                    if (profileImage) {
                        formData.append('profile', profileImage);
                        $.ajax({
                            url: '/user/update-info/' + userId,
                            method: 'POST',
                            data: formData,
                            processData: false,
                            contentType: false,
                            success: function(response) {
                                if (window.Clerk) {
                                    const clerkUserId = Clerk.user.id;
                                    const file = new File([profileImage], profileImage.name, { type: profileImage.type });
                                    Clerk.user.setProfileImage({
                                        userId: clerkUserId,
                                        file
                                    })
                                        .then(response => {
                                            console.log("Clerk user profile image updated:", response);
                                        })
                                        .catch(error => {
                                            console.error("Error updating Clerk user profile image:", error);
                                        });
                                }
                            },
                            error: function(jqXHR) {
                                console.log(jqXHR.responseJSON.error)
                            }
                        });
                    }
                });
            }

            // Tab switching functionality
            $('.tab-btn').on('click', function() {
                const tabName = $(this).data('tab');
                
                // Update active tab button
                $('.tab-btn').removeClass('active');
                $(this).addClass('active');
                
                // Hide all tab panes
                $('.tab-pane').hide();
                
                // Show selected tab pane and load data
                if (tabName === 'images') {
                    $('#images-tab').show();
                    loadUserImages(userId, 1, true);
                } else if (tabName === 'characters') {
                    $('#characters-tab').show();
                    displayUserChats(userId, 1, true);
                } else if (tabName === 'posts') {
                    $('#posts-tab').show();
                    loadUserSocialPosts();
                    loadUserSchedules();
                }
            });
            
            // Load user's social posts
            async function loadUserSocialPosts() {
                const container = $('#user-social-posts');
                try {
                    const response = await fetch('/api/social/posts?limit=5');
                    const data = await response.json();
                    
                    if (!data.success || !data.posts || data.posts.length === 0) {
                        container.html(`
                            <div class="text-center p-4 text-muted">
                                <i class="bi bi-inbox fs-1 mb-2"></i>
                                <p class="mb-0">No posts yet</p>
                            </div>
                        `);
                        return;
                    }
                    
                    container.html(data.posts.map(post => `
                        <div class="recent-post-item">
                            <div class="post-thumbnail">
                                ${post.mediaUrls && post.mediaUrls[0] 
                                    ? `<img src="${post.mediaUrls[0]}" alt="Post" onerror="this.src='/img/placeholder.png'">`
                                    : '<i class="bi bi-image text-muted fs-4"></i>'
                                }
                            </div>
                            <div class="post-details">
                                <div class="post-text">${post.text || 'No caption'}</div>
                                <div class="post-meta">
                                    <span class="post-platforms">
                                        ${(post.platforms || []).map(p => `
                                            <span class="platform-badge">
                                                <i class="bi bi-${p.platform === 'instagram' ? 'instagram' : 'twitter-x'}"></i>
                                            </span>
                                        `).join('')}
                                    </span>
                                    <span class="post-time">
                                        <i class="bi bi-clock me-1"></i>${formatTimeAgo(post.createdAt)}
                                    </span>
                                    <span class="badge ${post.status === 'published' ? 'bg-success' : 'bg-warning'}">${post.status || 'pending'}</span>
                                </div>
                            </div>
                        </div>
                    `).join(''));
                } catch (error) {
                    console.error('Error loading social posts:', error);
                    container.html(`
                        <div class="text-center p-4 text-muted">
                            <i class="bi bi-exclamation-triangle fs-4 mb-2"></i>
                            <p class="mb-0">Failed to load posts</p>
                        </div>
                    `);
                }
            }
            
            // Load user's schedules
            async function loadUserSchedules() {
                const container = $('#user-schedules');
                try {
                    const response = await fetch('/api/schedules?limit=5');
                    const data = await response.json();
                    
                    if (!data.success || !data.schedules || data.schedules.length === 0) {
                        container.html(`
                            <div class="text-center p-4 text-muted">
                                <i class="bi bi-calendar-x fs-1 mb-2"></i>
                                <p class="mb-0">No scheduled posts</p>
                            </div>
                        `);
                        return;
                    }
                    
                    container.html(data.schedules.map(schedule => `
                        <div class="recent-post-item">
                            <div class="post-thumbnail d-flex align-items-center justify-content-center" style="background: rgba(255, 193, 7, 0.1);">
                                <i class="bi bi-${schedule.type === 'recurring' ? 'arrow-repeat' : 'calendar-event'} text-warning fs-4"></i>
                            </div>
                            <div class="post-details">
                                <div class="post-text">${schedule.description || schedule.actionData?.prompt || 'Scheduled task'}</div>
                                <div class="post-meta">
                                    <span>
                                        <i class="bi bi-gear me-1"></i>${schedule.actionType || 'generate_image'}
                                    </span>
                                    ${schedule.type === 'recurring' 
                                        ? `<span><i class="bi bi-arrow-repeat me-1"></i>${schedule.cronExpression || 'Recurring'}</span>`
                                        : `<span><i class="bi bi-calendar me-1"></i>${schedule.scheduledFor ? new Date(schedule.scheduledFor).toLocaleDateString() : 'Pending'}</span>`
                                    }
                                    <span class="badge ${schedule.status === 'active' ? 'bg-success' : schedule.status === 'paused' ? 'bg-warning' : 'bg-secondary'}">${schedule.status || 'pending'}</span>
                                </div>
                            </div>
                        </div>
                    `).join(''));
                } catch (error) {
                    console.error('Error loading schedules:', error);
                    container.html(`
                        <div class="text-center p-4 text-muted">
                            <i class="bi bi-exclamation-triangle fs-4 mb-2"></i>
                            <p class="mb-0">Failed to load schedules</p>
                        </div>
                    `);
                }
            }
            
            // Format time ago helper
            function formatTimeAgo(dateString) {
                if (!dateString) return 'Unknown';
                const date = new Date(dateString);
                const now = new Date();
                const seconds = Math.floor((now - date) / 1000);
                
                if (seconds < 60) return 'Just now';
                if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
                if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
                if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
                return date.toLocaleDateString();
            }

            // Load initial data
            loadUserImages(userId, 1, true);

            // Handle stat tab clicks
            $('.likes-tab').on('click', function() {
                $('.tab-btn[data-tab="images"]').click();
            });

            $('.characters-tab').on('click', function() {
                $('.tab-btn[data-tab="characters"]').click();
            });
        });
    </script>

    <script>
        $(document).ready(function(){
            $(document).on('click', '.open-chat', function(){
                const chatId = $(this).data('id');
                if (window.self !== window.top) {
                    window.parent.postMessage({ event: 'openChat', chatId: chatId }, '*');
                } else {
                    window.location = `/chat/${chatId}`
                }
            });
        });
    </script>

    <script>
        function loadFollowList(type, containerId) {
            const userId = '{{userData._id}}';
            $(`#${containerId}`).html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</div>');
            $.get(`/user/${userId}/followers-or-followings?type=${type}&page=1`, function(data) {
                let html = '<div class="row">';
                if (data.users && data.users.length > 0) {
                    data.users.forEach(user => {
                        console.log(user);
                        html += `
                            <div class="col-md-6 col-lg-4 mb-3" onclick="window.open('/user/${user.userId}')" style="cursor: pointer;">
                                <div class="follower-card">
                                    <div class="follower-info">
                                        <img src="${user.profilePicture || '/img/avatar.png'}" alt="${user.userName}">
                                        <div class="follower-details">
                                            <a href="/user/${user.userId}" class="follower-name">${user.userName}</a>
                                            <div class="follower-stats">
                                                ${user.userBio ? `<p class="mb-1">${user.userBio}</p>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html += '<div class="col-12 text-center">No users found.</div>';
                }
                html += '</div>';
                $(`#${containerId}`).html(html);
            }).fail(function() {
                $(`#${containerId}`).html('<div class="text-center text-danger">Failed to load list.</div>');
            });
        }

        $('#followersModal').on('show.bs.modal', function() {
            loadFollowList('followers', 'followers-list');
        });

        $('#followingModal').on('show.bs.modal', function() {
            loadFollowList('following', 'following-list');
        });
    </script>

    <style>
        footer{display: inline !important;}
        .sticky-bottom{display: inline-block !important;width: 100%;}
        .isLoading .fa-image{
            display: none;
        }
        .isLoading .fa-spin{
            display: inherit !important;
        }
        .avatar{
            object-fit: cover;
            object-position: top;
            width: 32px;
        }
        .card-img-top.girls_avatar {
            object-fit: cover;
            object-position: top;
            width: 100%;  
            margin: auto;
            border-radius: 15px;
            height: 350px;
            padding: 0 5px;  
            background-position: top;
            background-size: cover;
        }
        .swal-image.analyze{
            object-fit: cover;
            object-position: top;
            width: auto !important;
            height: 200px !important;
            border-radius: 6px !important;
        }
        .card-header, .card-footer {
            flex-shrink: 0;
        }
        .card-body {
            flex-grow: 1;
            overflow-y: auto;
            position: relative;
        }
        .chat-contain .card-body{
            width: 100%;
        }
        .character-title{
            font-weight: 600;
            font-size: 16px;
            color: black;
        }
        .character-short-description {
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            font-size: 13px;
        }
        .scroll-horizontal {
            flex-wrap: nowrap;
            width: 100%;
            flex-direction: row;
            overflow-x: scroll;
        }
        @media (max-width: 600px) {
            .chat-contain .card-body{
                width: 100%;
            }
        }
        .follower-card {
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            background-color: #fff;
            box-shadow: 0 2px 8px rgba(130, 64, 255, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .follower-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 16px rgba(130, 64, 255, 0.2);
        }
        .follower-card img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            object-position: top;
            border-radius: 50%;
            margin-right: 16px;
            border: 2px solid #8240FF;
        }
        .follower-info {
            display: flex;
            align-items: center;
        }
        .follower-details {
            flex-grow: 1;
        }
        .follower-name {
            font-weight: 600;
            color: #8240FF;
            text-decoration: none;
            font-size: 16px;
        }
        .follower-name:hover {
            text-decoration: underline;
            color: #6E20F4;
        }
        .follower-stats {
            font-size: 14px;
            color: #6c757d;
        }
        .pagination-controls {
            margin-top: 20px;
        }
        .btn-primary {
            background-color: #8240FF;
            border-color: #8240FF;
        }
        .btn-primary:hover {
            background-color: #6E20F4;
            border-color: #6E20F4;
        }
        @media (max-width: 768px) {
            .follower-card {
                padding: 12px;
            }
            .follower-card img {
                width: 50px;
                height: 50px;
            }
        }
        
        /* Posts Tab Styles - Recent Posts Design */
        .recent-posts-list,
        .schedules-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .recent-post-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 10px;
            transition: background 0.2s;
        }

        .recent-post-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .recent-post-item .post-thumbnail {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .recent-post-item .post-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .recent-post-item .post-details {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .recent-post-item .post-text {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.85);
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.4;
        }

        .recent-post-item .post-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            flex-wrap: wrap;
        }

        .recent-post-item .post-platforms {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .recent-post-item .platform-badge {
            display: inline-flex;
            align-items: center;
            color: rgba(255, 255, 255, 0.7);
        }

        .recent-post-item .post-time {
            display: flex;
            align-items: center;
        }

        .recent-post-item .badge {
            font-size: 10px;
            padding: 2px 6px;
        }
        
        .posts-section,
        .schedules-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(130, 64, 255, 0.1);
        }
    </style>
</body>
</html>