{{> dashboard-modals}}

        
<!-- Browse All Section -->
<div class="browse-section onchat-off">
    <a href="/character" class="browse-link browse-link-primary">
        <i class="bi bi-grid-3x3-gap"></i>
        {{translations.view_all_character}}
    </a>
    <a href="/tags" class="browse-link browse-link-secondary">
        <i class="bi bi-tag"></i>
        {{translations.view_all_tags}}
    </a>
</div>
<div class="sticky-bottom" style="bottom:5px; left:0; right:0;">
    {{> chat-footer promptData=promptData}}
    {{> footer-toolbar translations=translations user=user userPointsTranslations=userPointsTranslations}}
</div>
<footer class="site-footer onchat-off bg-dark text-light py-5 mt-5">
  <div class="px-5 pb-3 bg-dark">
    <!-- Main Footer Content -->
    <div class="row g-4 mb-4">
      <!-- Contact Section -->
      <div class="col-lg-4 col-md-6">
        <div class="footer-section">
          <h5 class="footer-heading text-white mb-3 d-flex align-items-center">
            <i class="bi bi-envelope-heart me-2 text-primary"></i>
            {{translations.contactUs}}
          </h5>
          <p class="text-muted mb-3">
            {{#if translations.contactDescription}}
              {{translations.contactDescription}}
            {{else}}
              Connect with us on social media for updates and support.
            {{/if}}
          </p>
          <div class="social-links d-flex gap-3">
            <a href="https://x.com/3goH4EQPR994998" target="_blank" class="social-link" title="Twitter">
              <i class="bi bi-twitter"></i>
            </a>
            <a href="https://www.instagram.com/animemuseai/" target="_blank" class="social-link" title="Instagram">
              <i class="bi bi-instagram"></i>
            </a>
          </div>
        </div>
      </div>

      <!-- Quick Links Section -->
      <div class="col-lg-4 col-md-6">
        <div class="footer-section">
          <h5 class="footer-heading text-white mb-3 d-flex align-items-center">
            <i class="bi bi-link-45deg me-2 text-primary"></i>
            {{#if translations.quickLinks}}
              {{translations.quickLinks}}
            {{else}}
              Quick Links
            {{/if}}
          </h5>
          <ul class="footer-nav list-unstyled">
            <li class="mb-2">
              <a href="/character" class="footer-link">
                <i class="bi bi-people me-2"></i>{{translations.characters}}
              </a>
            </li>
            <li class="mb-2">
              <a href="/search" class="footer-link">
                <i class="bi bi-search me-2"></i>{{translations.search}}
              </a>
            </li>
            <li class="mb-2">
              <a href="/tags" class="footer-link">
                <i class="bi bi-tags me-2"></i>{{translations.tags}}
              </a>
            </li>
            <li class="mb-2">
              <a href="https://blog.chatlamix.com/%e3%83%96%e3%83%ad%e3%82%b0/" target="_blank" class="footer-link">
                <i class="bi bi-journal-text me-2"></i>{{translations.blog}}
              </a>
            </li>
          </ul>
        </div>
      </div>

      <!-- Legal & Support Section -->
      <div class="col-lg-4 col-md-12">
        <div class="footer-section">
          <h5 class="footer-heading text-white mb-3 d-flex align-items-center">
            <i class="bi bi-shield-check me-2 text-primary"></i>
            {{#if translations.legal}}
              {{translations.legal}}
            {{else}}
              Legal & Support
            {{/if}}
          </h5>
          <ul class="footer-nav list-unstyled">
            <li class="mb-2">
              <a href="/terms" target="_blank" class="footer-link">
                <i class="bi bi-file-text me-2"></i>{{translations.termsOfUse}}
              </a>
            </li>
            <li class="mb-2">
              <a href="/privacy" target="_blank" class="footer-link">
                <i class="bi bi-shield-lock me-2"></i>{{translations.privacyPolicy}}
              </a>
            </li>
            <li class="mb-2">
              <a href="/sitemap" target="_blank" class="footer-link">
                <i class="bi bi-diagram-3 me-2"></i>{{translations.sitemap.title}}
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Footer Bottom -->
    <div class="footer-bottom pt-4 border-top border-secondary">
      <div class="row align-items-center">
        <div class="col-md-6">
          <div class="d-flex align-items-center">
            <div class="brand-logo me-3">
              <i class="bi bi-chat-heart-fill text-white fs-3"></i>
            </div>
            <div>
              <p class="mb-0 text-white fw-bold">Chatlamix</p>
              <small class="text-muted">
                {{#if translations.brandTagline}}
                  {{translations.brandTagline}}
                {{else}}
                  Connect. Create. Experience.
                {{/if}}
              </small>
            </div>
          </div>
        </div>
        <div class="col-md-6 text-md-end mt-3 mt-md-0">
          <p class="copyright-text mb-0 text-muted">
            <i class="bi bi-c-circle me-1"></i>
            2024 Chatlamix. 
            {{#if translations.allRightsReserved}}
              {{translations.allRightsReserved}}
            {{else}}
              All Rights Reserved.
            {{/if}}
          </p>
          <small class="text-muted">
            {{#if translations.madeWithLove}}
              {{translations.madeWithLove}}
            {{else}}
              Made with
            {{/if}}
            <i class="bi bi-heart-fill text-danger"></i>
            {{#if translations.forYou}}
              {{translations.forYou}}
            {{else}}
              for you
            {{/if}}
          </small>
        </div>
      </div>
    </div>
  </div>
</footer>
<script>
    window.API_URL = "{{apiurl}}";
    window.MODE = "{{mode}}";
    window.lang = "{{lang}}";
    window.user = {{{json user}}};
    window.userId = window.user._id;
    window.isAdmin = {{isAdmin}};
    window.imageId = null;
    window.newSubscription = {{#if newSubscription}}{{json newSubscription}}{{else}}null{{/if}};
</script>
{{> translations}}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://js.stripe.com/v3/"></script>
<script src="/js/moment-with-locales.js"></script>
<script src="/js/personas.js"></script>
<script src="/js/dashboard.js"></script>
<script src="/js/user-points.js"></script>
<script src="/js/buy-points.js"></script>
<script src="/js/dashboard-infinite-scroll.js"></script>
<script src="/js/stability.js"></script>
<script src="/js/notifications.js"></script>
<script src="/js/app.js"></script>
<script src="/js/user-analytics.js"></script>
<script src="/js/websocket.js"></script>
<script src="/js/websocket-user-points.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/7.3.2/mdb.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

<script>

document.addEventListener('DOMContentLoaded', function() {
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.remove('hidden'); // Remove the hidden class
                entry.target.classList.add('animate__animated');

                const sanitizedAnimate = entry.target.dataset.animate.replace(/[^a-zA-Z0-9-_]/g, '');
                entry.target.classList.add(sanitizedAnimate); // Apply sanitized animation class

                if (entry.target.dataset.delay && entry.target.dataset.delay !== '') {
                    const sanitizedDelay = entry.target.dataset.delay.replace(/[^a-zA-Z0-9-_]/g, '');
                    entry.target.classList.add(sanitizedDelay); // Apply sanitized delay
                }

                observer.unobserve(entry.target); // Stop observing after animation
            }
        });
    }, {
        threshold: 0.1 // Adjust the threshold as needed
    });

    document.querySelectorAll('[data-animate]').forEach(element => {
        element.classList.add('hidden'); // Add the hidden class initially
        observer.observe(element);
    });
});

window.loadTranslations = async function (lang) {
    const localTranslations = localStorage.getItem('translations');

    const response = await $.ajax({
        url: '/api/user/translations',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ lang })
    });

    if (response.success) {
        window.translations = response.translations;
        window.lang = lang;
    }

}
window.fetchAndAppendModels = function() {
    const chatDiscovery = document.getElementById('chat-discovery');
    const subscriptionStatus = user.subscriptionStatus == 'active' || isAdmin;
    let apiUrl = '/api/models';

    // Fetch models first
    $.get(apiUrl, function(response) {
        if (response.success) {
            // 1. Collect unique styles
            const stylesSet = new Set();
            response.models.forEach(model => {
                stylesSet.add(model.style);
            });

            // 2. Build style filter buttons
            const styleButtons = [];
            // "All" button
            styleButtons.push(`
                <button class="btn btn-outline-secondary btn-sm me-2 style-filter-btn active" data-style="all">
                    ${translations.all || 'All'}
                </button>
            `);
            // Only include "photorealistic" and "anime" styles
            ['photorealistic', 'anime'].forEach(style => {
                if (stylesSet.has(style)) {
                    let styleLabel = (translations[style] || style);
                    styleButtons.push(`
                        <button class="btn btn-outline-secondary btn-sm me-2 style-filter-btn" data-style="${style}">
                            ${styleLabel}
                        </button>
                    `);
                }
            });

            // 3. Insert style filter buttons above the containers
            if ($('#styleFilterContainer').length === 0) {
                const filterHtml = `<div id="styleFilterContainer" class="mb-2 d-flex flex-wrap">${styleButtons.join('')}</div>`;
                if ($('#imageStyleSelectionCharacterCreation').length) {
                    $('#imageStyleSelectionCharacterCreation').before(filterHtml);
                } else if ($('#imageStyleSelection').length) {
                    $('#imageStyleSelection').before(filterHtml);
                }
            }

            // 4. Render model images
            response.models.forEach(model => {
                const premiumIndicator = model.premium 
                    ? `<div class="position-absolute top-0 start-0">
                        <span class="badge custom-gradient-bg">
                            <i class="bi bi-gem"></i>
                        </span>
                    </div>`
                    : '';
                const modelElement = `
                <div class="position-relative model-style-item" data-style="${model.style}">
                    ${premiumIndicator}
                    <img src="${model.image}" alt="${model.style}" 
                        class="${subscriptionStatus || !model.premium ? '' : 'is-premium'} style-option rounded me-2" 
                        data-id="${model.modelId}" 
                        data-style="${model.style}" 
                        data-model="${model.model}" 
                        data-version="${model.version}"
                        data-count="${model.chatCount}"
                        data-premium="${model.premium}"
                    >
                </div>
                `;
                if(!subscriptionStatus){
                    if(subscriptionStatus || !model.premium){
                        $(document).find('#imageStyleSelection').prepend(modelElement);
                        $(document).find('#imageStyleSelectionCharacterCreation').prepend(modelElement);
                    }else{
                        $(document).find('#imageStyleSelection').append(modelElement);
                        $(document).find('#imageStyleSelectionCharacterCreation').append(modelElement);
                    }
                }else{
                    $(document).find('#imageStyleSelection').append(modelElement);
                    $(document).find('#imageStyleSelectionCharacterCreation').append(modelElement);
                }
            });

            // 5. Style filter logic
            $(document).off('click', '.style-filter-btn').on('click', '.style-filter-btn', function() {
                $('.style-filter-btn').removeClass('active');
                $(this).addClass('active');
                const selectedStyle = $(this).data('style');
                if (selectedStyle === 'all') {
                    $('.model-style-item').show();
                } else {
                    $('.model-style-item').each(function() {
                        if ($(this).data('style') === selectedStyle) {
                            $(this).show();
                        } else {
                            $(this).hide();
                        }
                    });
                }
            });

            // 6. Continue with tab logic
            if($(document).find('#imageStyleTabs').length > 0 && !$('#characterCreationModal').hasClass('show')){
                showNavTabs();
            }else{
                // Click on the first model if no imageModel is set in the url 
                const imageModelId = localStorage.getItem('imageModelId');
                if(imageModelId){
                    $(document).find(`#imageStyleSelection .style-option[data-id="${imageModelId}"]`).click();
                }else{
                    $(document).find('#imageStyleSelection .style-option').first().click();
                }
            }
        } else {
            window.showNotification('Failed to fetch models', 'error');
        }
    });
};
let navInit = false;
function showNavTabs(){
    const styleSelection = document.getElementById('imageStyleSelection');
    const tabNav = document.getElementById('imageStyleTabs');
    const chatDiscovery = document.getElementById('chat-discovery');
    const subscriptionStatus = user.subscriptionStatus == 'active'

    if (styleSelection && tabNav) {
        const styleOptions = styleSelection.querySelectorAll('.style-option');

        styleOptions.forEach((option, index) => {
            const style = option.getAttribute('data-style');
            const modelId = option.getAttribute('data-id');
            const model = option.getAttribute('data-model');
            const version = option.getAttribute('data-version');
            const premium = option.getAttribute('data-premium');
            const imgSrc = option.getAttribute('src');
            const altText = option.getAttribute('alt');
            const chatCount = parseInt(option.getAttribute('data-count'), 10) || 0;

            // Skip rendering if `#chat-discovery` exists and count is 0
            if ( !modelId || (chatDiscovery && (chatCount == 0) ) ) return;

            const isActive = index === 0 ? 'active' : '';

            // Add count tag if `#chat-discovery` exists
            const countTag = chatDiscovery
                ? `<span 
                class="badge btn-light text-dark position-absolute top-0 end-0" 
                style="opacity:0.8;">
                ${chatCount}</span>`
                : '';
            // Add premium indicator (gem icon with custom gradient background)
            const premiumIndicator = premium === 'true'
                ? `<div class="position-absolute top-0 start-0">
                    <span class="badge custom-gradient-bg">
                        <i class="bi bi-gem"></i>
                    </span>
                </div>`
                : '';

            const tabItem = `
            <li class="nav-item position-relative" role="presentation" 
                ${chatCount == 0 ? `onclick="window.location='/chat/edit/?modelId=${modelId}'"` : ''}>
                <button class="nav-link ${isActive} rounded" 
                        id="${modelId}-tab" 
                        data-style="${style}" 
                        data-id="${modelId}" 
                        data-model="${model}" 
                        data-version="${version}" 
                        data-premium="${premium}"
                        type="button" role="tab"
                        style="background: url('${imgSrc}') no-repeat center center; background-size: cover;height: 70px;width: 70px;">
                    <span class="d-none">${altText}</span>
                    ${premiumIndicator}
                </button>
                ${countTag}
            </li>
            `;
            tabNav.innerHTML += tabItem;
        });

        if(chatDiscovery){
            tabNav.innerHTML += `
            <li class="nav-item position-relative bg-light rounded" role="presentation" onclick="loadCharacterCreationPage()">
                <button class="nav-link add-more" type="button" role="tab">
                    <i class="bi bi-plus-lg thumb-option d-flex justify-content-center align-items-center" style="font-size: 31px;"></i>
                </button>
            </li>
            `
        }


        $('#imageStyleSelection').remove();
    }

    // Handle tab clicks
    $(document).on('click','#imageStyleTabs button', function () {
        if($(this).hasClass('add-more')){
            return
        }
        $('#chat-gallery .chat-card-container').fadeOut()
        $('#imageStyleTabs button').removeClass('active');
        $(this).addClass('active');

        const modelId = $(this).data('id');
        const premium = $(this).data('premium');
        const model =  $(this).data('model');
        const style =  $(this).data('style');

        if(modelId){
            localStorage.setItem('chat-nav',`${modelId}`)
            let option = {imageStyle:style, imageModel:model, modelId, premium, userId: user._id, modal: true}
            if(chatDiscovery ){ option.userId = false }
            displayPeopleChat(1, option, 
            (ids) => {
            }, true);
        }
    });

    const chatNav_modelId = localStorage.getItem('chat-nav');
    if(navInit){
        return
    }
    if (chatNav_modelId && $(document).find(`#imageStyleTabs`).find(`#${chatNav_modelId}-tab`).length) {
        $(document).find(`#imageStyleTabs`).find(`#${chatNav_modelId}-tab`).click();
        navInit = true;
    } else {
        // Find the first tab with a modelId and click it
        $(document).find(`#imageStyleTabs button[data-id]`).first().click();
        navInit = true;
    }
}
window.updatePlanStatus = function(user){
  $.get('/user/plan/'+user._id,function(data){
      let message = `<span class="ms-1">&#x1F381;</span>`;
      if(!data.plan){
        $('.user-current-plan').each(function(){
          $(this).html(message).show()
        })
        return
      }
      const billingCycle = data.plan.billingCycle
      const currentPlanId = data.plan.currentPlanId

      $.get('/plan/list',function(data){
          const plans = data.plans
          const plan = plans.find((plan) => plan[`${billingCycle}_id`] === currentPlanId);
          if(!plan){
            message = `<span class="ms-1">&#x1F381;</span>`;
          }else{
            switch (plan.id) {
              case 'free':
                message = `<span class="ms-1">&#x1F381;</span>`;
                break;
              case 'premium':
                message = `<span class="ms-1"> &#x1F48E;</span>`;
                break;
              case 'special':
                message = ` <span class="ms-1">&#x1F525;</span>`;
                break;
              default:
                message = `<span class="ms-1">&#x1F381;</span>`;
            }
          }
          $('.user-current-plan').each(function(){
            $(this).html(message).show()
          })
      })
  })
}


window.redirectToChat = function(chatId,chatImage) {
    if($(`#spinner-${chatId}`).hasClass('on')){
        return
    }
    if(chatImage){
        $('#chat-container').css('background-image', chatImage);
    }
    $(`#spinner-${chatId}`).addClass('on').show()
    const user = {{{json user}}}
    const userId = user._id
    // if on chat page fetchChatData else redirect to chat/${chatID}
    if (window.location.pathname.includes('/chat/')) {
        //send message to parent window fetchChatData
        window.parent.postMessage({
            event: 'fetchChatData',
            chatId: chatId,
            userId: userId,
            reset:null
        }, '*');

    } else {
        window.location.href = `/chat/${chatId}`;
    }
}
window.redirectToCharacter = function(characterId, characterSlug) {
    if($(`#spinner-${characterId}`).hasClass('on')){
        return
    }
    $(`#spinner-${characterId}`).addClass('on').show()
    if(characterSlug){
        window.location.href = `/character/slug/${characterSlug}`;
        return
    }
    window.location.href = `/character/${characterId}`;
}

window.toggleChatList = function() {
    if(!window.location.pathname.includes('/chat/')) {
        window.location.href = '/chat/?list=true';
    }
}
window.hideDiscovery = function() {
    
    $('.onchat-off').hide()
    $('.onchat-off').addClass('d-none').css({
        'opacity': 0,
        'pointer-events': 'none',
        'visibility': 'hidden'
    });    
    $('.onchat-on').show()
    $('.onchat-on').removeClass('d-none').css({
        'opacity': '',
        'pointer-events': '',
        'visibility': ''
    }); 
}
    $('.onchat-on').each(function() {
        if ($(this).css('display') === 'flex') {
            $(this).attr('data-display-flex', 'true');
        }
    });
    $('.onchat-off').each(function() {
        if ($(this).css('display') === 'flex') {
            $(this).attr('data-display-flex', 'true');
        }
    });
window.showDashboardFooter = function() {
    $('.site-footer').show();
    $('.site-footer').removeClass('d-none onchat-off').css({
        'opacity': '',
        'pointer-events': '',
        'visibility': ''
    });
}
// == FIXED & FINAL VERSION ‚Äì declare on window ==

window.showChat = function () {
    const $on  = $('.onchat-on');
    const $off = $('.onchat-off');

    // Check if already visible
    console.log(`$('#chatContainer').is(':visible'): ${!!$('#chatContainer').is(':visible')}`);
    if (!!$('#chatContainer').is(':visible')) {
        return;
    }

    console.log('Showing chat interface with slide-in animation');

    // Instantly hide the previous screen
    $off.addClass('d-none');

    // Reset any old transitionend listeners (prevents double-trigger bug)
    $on.off('transitionend webkitTransitionEnd oTransitionEnd');

    // 1. Prepare: off-screen right + no transition yet
    $on.css({
        'transition': 'none',
        'transform': 'translateX(100%)',
        'opacity': '0',
        'pointer-events': 'none',
        'visibility': 'hidden'
    }).removeClass('d-none').show();  // force visible

    // 2. Force reflow ‚Äì THIS IS THE KEY to prevent flicker when re-opening
    void $on[0].offsetHeight;

    // 3. Now enable transition + slide in
    $on.css({
        'transition': 'transform 0.38s cubic-bezier(0.4,0,0.2,1), opacity 0.38s ease',
        'transform': 'translateX(0)',
        'opacity': '1',
        'pointer-events': 'auto',
        'visibility': 'visible'
    });
};

window.hideChat = function () {
    const $on  = $('.onchat-on');
    const $off = $('.onchat-off');

    console.log('Hiding chat interface with slide-out animation');

    // Animate out to the right
    $on.css({
        'transition': 'transform 0.38s cubic-bezier(0.4,0,0.2,1), opacity 0.38s ease',
        'transform': 'translateX(100%)',
        'opacity': '0',
        'pointer-events': 'none'
    });

    // When animation finishes ‚Üí hide and restore previous screen
    $on.one('transitionend webkitTransitionEnd oTransitionEnd', function () {
        $on.addClass('d-none').css({
            'transition': 'none',           // reset for next open
            'transform': 'translateX(100%)'
        });

        $off.removeClass('d-none');

        // Restore flex if needed
        $off.each(function () {
            if ($(this).attr('data-display-flex')) {
                $(this).css('display', 'flex');
            }
        });
    });

    // Make sure off is visible during the animation
    $off.each(function () {
        if ($(this).attr('data-display-flex')) {
            $(this).css('display', 'flex');
        } else {
            $(this).show();
        }
    });
};

// === INITIAL STATE (run once on page load) ===
$(function () {
    $('.onchat-on').addClass('d-none').css({
        'transition': 'none',
        'transform': 'translateX(100%)'
    });
    $('.onchat-off').removeClass('d-none');
});

window.showDiscovery = function() {
    if (!window.location.pathname.includes('/chat/')) {
        window.location.href = '/chat/';
    }
    $('.fullscreen-overlay').fadeOut(); 
    $('body').css('overflow', 'visible');
    
    window.hideChat();

    $('#chat-list').hide();
    $('#promptContainer').slideUp('fast');
    $('.new-chat').each(function(){
        $(this).hide()
    })
    if (typeof resetChatUrl === 'function') {
        resetChatUrl();
    }

    // Hide navbar chat actions when in discovery mode
    if (typeof hideNavbarChatActions === 'function') {
        hideNavbarChatActions();
    }
    
    $('#footer-toolbar').fadeIn();
    window.postMessage('resizeIframe', '*');
}
window.fetchUser = async function() {
    try {
        const url = `${API_URL}/api/user`;
   
        const response = await fetch(url, { 
            method: 'GET',
            credentials: 'include' 
        });

        if (!response.ok) {
            console.error(`[fetchUser] Network response was not ok. Status: ${response.status} ${response.statusText}`);
            throw new Error('Network response was not ok');
        }
        const data = await response.json();

        if (data && data.user) {
        } else {
            console.warn('[fetchUser] No user object found in response:', data);
        }
        return data.user;
    } catch (error) {
        console.error('[fetchUser] Error fetching user:', error);
        return null;
    }
};

window.fetchMode = async function() {
    try {
        const response = await fetch('/api/mode', { 
            method: 'GET',
            credentials: 'include' ,
        });
        if (!response.ok) throw new Error('Network response was not ok');
        const data = await response.json();
        return data.mode;
    } catch (error) {
        console.error('Error fetching mode:', error);
        return null
    }
};
window.logoutUser = async function(Clerk) {
    try {
        // First, sign out with Clerk - this is important to do BEFORE clearing cookies
        // Use the redirectUrl: false option to prevent automatic redirects
        await Clerk.signOut({ redirectUrl: window.location.origin + '/signout-redirection?signOut=true' });
        console.log('Clerk sign out completed');
        
    } catch (error) {
        console.error('Error during logout:', error);
        return Promise.resolve(false);
    }
};
window.handleSignOut = function() {

    // Then clear cookies and localStorage after Clerk signOut completes
    return new Promise((resolve, reject) => {
        $.ajax({
            url: '/user/logout',
            method: 'POST',
            success: function(response) {
                console.log('Server cookies cleared successfully');
                
                // Clear all cookies manually after server-side logout
                Object.keys($.cookie()).forEach(function(cookie) {
                    $.removeCookie(cookie, { path: '/' });
                });
                
                // Clear localStorage and sessionStorage
                localStorage.clear();
                sessionStorage.clear();
                console.log('Local storage cleared');
                
                resolve(true);
            },
            error: function(error) {
                console.error('Failed to clear server cookies:', error);
                // Still resolve to continue logout process
                resolve(false);
            }
        });
    });
}
window.handleClerkSignIn = function(Clerk) {
    if(!Clerk.session){
        return
    }
    // Get session token from Clerk
    const sessionToken = Clerk.session.lastActiveSessionId;
    
    // Send request to backend with Clerk session token
    fetch('/user/clerk-auth', {
        method: 'GET',
        credentials: 'include' ,
        headers: {
            'x-clerk-user-id': Clerk.user.id
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.redirectUrl) {
            window.location.href = data.redirectUrl;
        }
    })
    .catch(error => {
        console.error('Authentication error:', error);
    });
    return false; // Prevent Clerk's default redirect
}
window.handleClerkUserUpdate = function() {
    
    if (!window.Clerk?.user) {
        console.warn('[handleClerkUserUpdate] No Clerk user data available');
        return;
    }
    
    fetch('/user/clerk-update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Clerk-Session-Id': window.Clerk?.session?.id || '',
        },
        credentials: 'include',
        body: JSON.stringify(window.Clerk.user)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status) {
            
            // Refresh user data if needed
            if (window.fetchUser) {
                window.fetchUser().then(userData => {
                    if (userData && !userData.isTemporary) {
                        window.user = userData;
                    } else {
                        console.warn('[handleClerkUserUpdate] User data not available or still temporary');
                    }
                }).catch(error => {
                    console.error('[handleClerkUserUpdate] Error fetching updated user data:', error);
                });
            } else {
                console.error('[handleClerkUserUpdate] User fetch function not available');
            }
        } else if (data.error) {
            console.error('[handleClerkUserUpdate] Server error:', data.error);
        }
    })
    .catch(error => {
        console.error('[handleClerkUserUpdate] Failed to update user data:', error);
    });
}

$(document).ready(function(){
    fetchAndAppendModels();
    
    // Points modal event handlers
    $('#userPointsModal').on('shown.bs.modal', function() {
        if (window.userPointsManager) {
            // Load history by default (active tab)
            window.userPointsManager.loadPointsHistory();
        }
    });
    
    // Tab switching events
    $('#history-tab').on('shown.bs.tab', function() {
        if (window.userPointsManager) {
            window.userPointsManager.loadPointsHistory();
        }
    });
    
    $('#leaderboard-tab').on('shown.bs.tab', function() {
        if (window.userPointsManager) {
            window.userPointsManager.loadLeaderboard();
        }
    });
});
</script>
<script>
     // Parse the URL and get query parameters
    const urlParams = new URLSearchParams(window.location.search);
    
    // Check if 'payment_status' parameter is true
    if (urlParams.get('payment_status') === 'cancelled') {
        // Display notification in Japanese
        window.showNotification(
            `${translations.payment_cancelled}<br>${translations.payment_not_completed}`,
            'info'
        );
        var currentUrl = window.location.href;
        var urlParts = currentUrl.split('?');
        urlParts[urlParts.length - 1] = '';
        var newUrl = urlParts.join('');
        if($('#chat-widget-container').length == 0){
            window.history.replaceState({ path: newUrl }, '', newUrl);
        }
    }

    // Handle points purchase success
    if (urlParams.get('points_purchase') === 'success') {
        const points = urlParams.get('points');
        const packageId = urlParams.get('packageId');
        
        if (points && packageId) {
            const message = window.buyPointsTranslations?.buy_points?.points_added_message
                .replace('{points}', points);
            window.showNotification(message, 'success');
            if (typeof refreshUserPoints === 'function') {
                setTimeout(() => refreshUserPoints(), 500);
            }
        }
        
        // Clean up URL
        const cleanUrl = window.location.href.split('?')[0];
        window.history.replaceState({ path: cleanUrl }, '', cleanUrl);
    }

    // Handle points purchase cancellation
    if (urlParams.get('points_purchase') === 'cancelled') {
        const reason = urlParams.get('reason') || 'unknown';
        
        // Show cancellation notification
        const message = window.buyPointsTranslations?.buy_points?.purchase_cancelled_message || 'Points purchase was cancelled. Please try again.';
        window.showNotification(message, 'warning');
        
        console.log(`[Points Purchase] Cancelled: ${reason}`);
        
        // Clean up URL
        const cleanUrl = window.location.href.split('?')[0];
        window.history.replaceState({ path: cleanUrl }, '', cleanUrl);
    }

    // Handle points purchase failure
    if (urlParams.get('points_purchase') === 'failed') {
        const reason = urlParams.get('reason') || 'unknown';
        
        // Show error notification with reason
        let errorMessage = window.buyPointsTranslations?.buy_points?.purchase_failed_message || 'Points purchase failed.';
        
        // Add specific error message based on reason
        const reasonMessages = {
            'no_session': 'Session information missing',
            'not_authenticated': 'Not authenticated',
            'session_not_found': 'Session not found',
            'payment_not_completed': 'Payment was not completed',
            'invalid_metadata': 'Invalid purchase data',
            'add_points_failed': 'Failed to add points to account',
            'server_error': 'Server error occurred'
        };
        
        if (reasonMessages[reason]) {
            errorMessage = errorMessage + ' (' + reasonMessages[reason] + ')';
        }
        
        window.showNotification(errorMessage, 'error');
        
        console.error(`[Points Purchase] Failed: ${reason}`);
        
        // Clean up URL
        const cleanUrl = window.location.href.split('?')[0];
        window.history.replaceState({ path: cleanUrl }, '', cleanUrl);
    }
</script>
    <script>
        // Open authenticate page in a modal
        window.openLoginForm = function() {
            // Check if user is already signed in
            if (window.Clerk && window.Clerk.user) {
                // User is already signed in, redirect to chat
                window.location.href = '/chat';
                return;
            }
            // Check if url as a language subdomain https://ja.chatlamix.com/
            const langUrl = window.location.hostname.split('.')[0];
            // Use Clerk's provided method instead of direct URL navigation
            if (window.Clerk) {
                Clerk.openSignIn({
                    redirectUrl: window.location.origin + '/signin-redirection?signIn=true',
                    language: window.lang || langUrl || 'ja',
                });
            } else {
                console.error('Clerk is not initialized yet');
                // Fallback option if Clerk isn't loaded
                window.location.href = '/auth/login?redirect=' + encodeURIComponent(window.location.origin + '/signin-redirection?signIn=true');
            }
        };
    </script>
    <script
        async
        crossorigin="anonymous"
        data-clerk-publishable-key="pk_test_Z29vZC10ZXJtaXRlLTU2LmNsZXJrLmFjY291bnRzLmRldiQ"
        src="https://good-termite-56.clerk.accounts.dev/npm/@clerk/clerk-js@5/dist/clerk.browser.js"
        type="text/javascript"
    ></script>

    <script>
        window.addEventListener('load', async function () {
            const clerkLang = Object.keys(clerkTranslations)[0];
            await Clerk.load({localization: clerkTranslations[clerkLang]});
            // Show Clerk action buttons
            $('.clerk-button').each(function() {
                $(this).fadeIn();
            });
            const signOutParam = new URLSearchParams(window.location.search).get('signOut');
            if(signOutParam){
                handleSignOut()
                .then(() => {
                    window.location.href = window.location.origin;
                });
            }
            if(user.isTemporary){
                handleClerkSignIn(Clerk);
            }
            
            // Call route after updating user info
            Clerk.addListener(({ user }) => {
                if (user) {
                    handleClerkUserUpdate();
                }
            });

            // Attach logoutUser to .logout
            $('.logout').on('click', function(e) {
                e.preventDefault(); // Prevent default action
                
                // Show a loading indicator
                const $logoutButton = $(this);
                $logoutButton.prop('disabled', true);
                
                // Implement a forced timeout in case logout hangs
                const logoutTimeout = setTimeout(function() {
                    window.location.href = '/signout-redirection?signOut=true&timeout=true';
                }, 5000); // 5 second timeout
                
                logoutUser(Clerk)
                    .then(() => {
                        clearTimeout(logoutTimeout);
                        console.log('Logout completed successfully, redirecting');
                        window.location.href = '/signout-redirection?signOut=true&timeout=true';
                    })
                    .catch((error) => {
                        clearTimeout(logoutTimeout);
                        console.error('Error during logout:', error);
                    });
            });

            // Assign Clerk to window
            window.Clerk = Clerk;
        })
</script>

<script>
window.loadCharacterUpdateModal = function(chatId) {
    if (!chatId) {
        showNotification('No character ID provided', 'error');
        return;
    }
    
    // Set the character ID in a cookie for the update form
    $.cookie('character-update-id', chatId);
    
    // Load the character update form
    $('#character-update-container').load('/character-update.hbs', function(response, status, xhr) {
        if (status === 'error') {
            console.error('Failed to load character update form:', xhr.status, xhr.statusText);
            showNotification('Failed to load character update form', 'error');
        } else {
            // Show the modal
            $('#characterUpdateModal').modal('show');
        }
    });
};
</script>

<script>
    /**
 * Debug function to showcase all notification styles
 * Call from console: debugNotifications()
 */
window.debugNotifications = function() {
    console.log('üîß Testing all notification styles...');
    
    const notifications = [
        {
            type: 'success',
            message: '‚úÖ Success notification - Operation completed successfully!',
            delay: 0
        },
        {
            type: 'error', 
            message: '‚ùå Error notification - Something went wrong with your request',
            delay: 1000
        },
        {
            type: 'warning',
            message: '‚ö†Ô∏è Warning notification - Please check your input before proceeding',
            delay: 2000
        },
        {
            type: 'info',
            message: '‚ÑπÔ∏è Info notification - Here is some helpful information for you',
            delay: 3000
        },
        {
            type: 'success',
            message: 'Long message test: Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.',
            delay: 4000
        },
        {
            type: 'error',
            message: 'HTML test: <strong>Bold text</strong> and <em>italic text</em> with <br>line breaks',
            delay: 5000
        }
    ];

    // Clear any existing notifications first
    $('#notification-container').empty();

    // Show each notification with delay
    notifications.forEach((notif, index) => {
        setTimeout(() => {
            console.log(`Showing ${notif.type} notification:`, notif.message);
            window.showNotification(notif.message, notif.type);
        }, notif.delay);
    });

    // Show special rewards after basic notifications
    setTimeout(() => {
        console.log('Showing special reward notification...');
        if (window.userPointsManager) {
            window.userPointsManager.debugShowSpecialRewardNotification();
        }
    }, 6500);

    setTimeout(() => {
        console.log('Showing milestone reward notification...');
        if (window.userPointsManager) {
            window.userPointsManager.debugShowMilestoneRewardNotification();
        }
    }, 8000);

    setTimeout(() => {
        console.log('Showing daily bonus notification...');
        if (window.userPointsManager) {
            window.userPointsManager.debugShowDailyBonusNotification();
        }
    }, 9500);

    console.log('All notifications will appear over the next 10 seconds');
    console.log('Types tested: success, error, warning, info, special rewards, milestone, daily bonus');
    
    return 'Debug notifications started! Check the top-right corner of your screen.';
};

// Auto-show help on page load for developers
if (window.MODE === 'development' || window.location.hostname === 'localhost') {
    setTimeout(() => {
        console.log('üîß Notification debug functions loaded! Type debugNotificationsHelp() for help.');
    }, 1000);
}

</script>