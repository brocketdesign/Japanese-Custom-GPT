<!DOCTYPE html>
<html lang="{{lang}}">
{{> dashboard-header seoTitle=seoTitle seoDescription=seoDescription}}
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="/css/explore-gallery.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">
</head>

<body class="explore-body">
    <!-- Hide main nav for immersive experience -->
    <style>#mainNav { display: none !important; }</style>

    <div class="explore-container" id="explorePage">
        <!-- Sticky Search & Filter Bar -->
        <div class="explore-sticky-header">
            <div class="explore-search-bar">
                <!-- Logo on Left -->
                <a href="/" class="explore-logo-link" title="Home">
                    <i class="bi bi-chat-heart-fill explore-logo-icon"></i>
                </a>
                
                <!-- Spacer to push buttons right -->
                <div class="explore-nav-spacer"></div>
                
                <!-- Right-aligned buttons -->
                <div class="explore-nav-actions">
                    <!-- Search Toggle Button -->
                    <button type="button" class="explore-action-btn" id="searchToggleBtn" title="{{translations.searchPlaceholder}}">
                        <i class="bi bi-search"></i>
                    </button>
                    
                    <!-- NSFW Toggle -->
                    <button type="button" id="nsfwToggleBtn" class="nsfw-btn" data-nsfw="{{#if showNSFW}}true{{else}}false{{/if}}">
                        <i class="bi bi-shield-check"></i>
                        <span class="nsfw-label">SFW</span>
                    </button>
                    
                    <!-- Login/Profile Button -->
                    {{#if user.isTemporary}}
                    <button type="button" class="auth-icon-btn" id="loginBtn" title="{{translations.login}}">
                        <i class="bi bi-person-circle"></i>
                    </button>
                    {{else}}
                    <a href="/user/{{user._id}}" class="auth-icon-btn" title="{{translations.profile}}">
                        {{#if user.profileImageUrl}}
                        <img src="{{user.profileImageUrl}}" alt="Profile" class="auth-profile-img">
                        {{else}}
                        <i class="bi bi-person-circle"></i>
                        {{/if}}
                    </a>
                    {{/if}}
                </div>
            </div>
            
            <!-- Expandable Search Bar (below nav) -->
            <div class="explore-search-expanded" id="searchExpanded">
                <form id="search-form" action="/search" method="GET" class="explore-search-form">
                    <div class="search-input-group">
                        <i class="bi bi-search"></i>
                        <input 
                            type="text" 
                            name="q" 
                            id="search-input" 
                            placeholder="{{translations.searchPlaceholder}}" 
                            value="{{query}}"
                            autocomplete="off"
                        >
                        <button type="button" class="search-clear-btn" id="clearSearch">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Main Explore Gallery - Vertical Swiper (Characters) -->
        <div class="explore-gallery-wrapper">
            <div class="swiper explore-vertical-swiper" id="characterSwiper">
                <div class="swiper-wrapper" id="characterSwiperWrapper">
                    <!-- Character slides will be loaded dynamically -->
                </div>
            </div>
            
            <!-- Loading State -->
            <div class="explore-loading" id="exploreLoading">
                <div class="loading-spinner"></div>
                <p>{{translations.loading}}</p>
            </div>
            
            <!-- Empty State -->
            <div class="explore-empty" id="exploreEmpty" style="display: none;">
                <i class="bi bi-search"></i>
                <h3>{{translations.no_results_found_for}}</h3>
                <p>{{translations.start_searching}}</p>
            </div>
        </div>



        <!-- Swipe Hint (shows on first visit) -->
        <div class="swipe-hint" id="swipeHint">
            <div class="swipe-hint-content">
                <div class="swipe-indicator horizontal">
                    <i class="bi bi-chevron-left"></i>
                    <span>Swipe for more images</span>
                    <i class="bi bi-chevron-right"></i>
                </div>
                <div class="swipe-indicator vertical">
                    <i class="bi bi-chevron-up"></i>
                    <span>Swipe for more characters</span>
                    <i class="bi bi-chevron-down"></i>
                </div>
            </div>
        </div>
    </div>

    {{> dashboard-footer}}

    <!-- Swiper JS -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script src="/js/character-infos.js"></script>

    <script>
        // Global configuration
        window.user = {
            _id: '{{user._id}}',
            subscriptionStatus: '{{user.subscriptionStatus}}',
            isTemporary: {{#if user.isTemporary}}true{{else}}false{{/if}},
            lang: '{{user.lang}}'
        };
        window.isAdmin = {{#if isAdmin}}true{{else}}false{{/if}};
        
        // Read showNSFW from storage first, then fall back to server value
        (function() {
            try {
                const sessionValue = sessionStorage.getItem('showNSFW');
                if (sessionValue !== null) {
                    window.showNSFW = sessionValue === 'true';
                    return;
                }
                const localValue = localStorage.getItem('showNSFW');
                if (localValue !== null) {
                    window.showNSFW = localValue === 'true';
                    return;
                }
            } catch (e) {}
            window.showNSFW = {{#if showNSFW}}true{{else}}false{{/if}};
        })();
        window.initialQuery = '{{query}}';
        
        window.translations = {
            loading: '{{translations.loading}}',
            no_results_found: '{{translations.no_results_found_for}}',
            try_different_search: '{{translations.start_searching}}'
        };
        
        // Search toggle functionality
        document.addEventListener('DOMContentLoaded', function() {
            const searchToggleBtn = document.getElementById('searchToggleBtn');
            const searchExpanded = document.getElementById('searchExpanded');
            const searchInput = document.getElementById('search-input');
            const clearSearchBtn = document.getElementById('clearSearch');
            const loginBtn = document.getElementById('loginBtn');
            
            // Toggle search expanded section
            if (searchToggleBtn && searchExpanded) {
                searchToggleBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    searchExpanded.classList.toggle('expanded');
                    searchToggleBtn.classList.toggle('active');
                    if (searchExpanded.classList.contains('expanded')) {
                        searchInput.focus();
                    }
                });
            }
            
            // Clear search
            if (clearSearchBtn) {
                clearSearchBtn.addEventListener('click', function() {
                    searchInput.value = '';
                    searchInput.focus();
                });
            }
            
            // Close search when clicking outside
            document.addEventListener('click', function(e) {
                if (searchExpanded && searchExpanded.classList.contains('expanded')) {
                    const isClickInsideSearch = searchExpanded.contains(e.target);
                    const isClickOnToggle = searchToggleBtn.contains(e.target);
                    if (!isClickInsideSearch && !isClickOnToggle) {
                        searchExpanded.classList.remove('expanded');
                        searchToggleBtn.classList.remove('active');
                    }
                }
            });
            
            // Login button opens clerk modal
            if (loginBtn) {
                loginBtn.addEventListener('click', function() {
                    if (typeof openLoginForm === 'function') {
                        openLoginForm();
                    } else {
                        window.location.href = '/login';
                    }
                });
            }
        });
    </script>
    <script src="/js/content-discovery-tracker.js"></script>
    <script src="/js/explore-gallery.js"></script>
</body>
</html>
